-- version:0.5 -- sdate:17/03/2014 -- edate:17/03/2014 -- issue:765 --desc:droped temp table --doneby:RL
--version:0.4 --sdate:26/02/2014 --edate:26/02/2014 --issue:750 --desc:userstamp changed as uld_id --doneny:RL
--version:0.3 --sdate:22/02/2014 --edate:22/02/2014 --issue:750 --desc:implement pre audit n post audit --doneny:RL
--version:0.2 --sdate:23/01/2014 --edate:23/01/2014 --issue:594 --commentno:54 --doneny:RL
DROP PROCEDURE IF EXISTS SP_OCBC_BANK_RECORDS_INSERT;
CREATE PROCEDURE SP_OCBC_BANK_RECORDS_INSERT(IN OCBC_USERSTAMP VARCHAR(50))
BEGIN
	DECLARE START_TIME TIME;
	DECLARE END_TIME TIME;
	DECLARE DURATION TIME;
	SET START_TIME=(SELECT CURTIME());
	DROP TABLE IF EXISTS OCBC_BANK_RECORDS;
	CREATE TABLE OCBC_BANK_RECORDS(
	OBR_ID BIGINT NOT NULL AUTO_INCREMENT,
	OBR_ACCOUNT_NUMBER BIGINT NOT NULL,	
	OBR_CURRENCY VARCHAR(5) NOT NULL,	
	OBR_OPENING_BALANCE	DECIMAL(10,2) NOT NULL,	
	OBR_CLOSING_BALANCE	DECIMAL(10,2) NOT NULL,	
	OBR_PREVIOUS_BALANCE DECIMAL(10,2) NOT NULL,	
	OBR_DAY_TTL_CREDIT DECIMAL(10,2) NOT NULL,	
	OBR_DAY_TTL_DEBIT DECIMAL(10,2) NOT NULL,	
	OBR_NO_OF_CREDITS INT NULL,		
	OBR_NO_OF_DEBITS DECIMAL(10,2) NULL,			
	OBR_POST_DATE DATE NOT NULL,	
	OBR_TRANS_DATE DATE NOT NULL,	
	OBR_VALUE_DATE DATE NOT NULL,	
	OBR_NET_DAY_BALANCE	INT NOT NULL,	
	OBR_DEBIT_AMOUNT DECIMAL(10,2) NULL,		
	OBR_CREDIT_AMOUNT DECIMAL(10,2) NULL,			
	OBR_TRX_CODE VARCHAR(10) NOT NULL,	
	OBR_CLIENT_REFERENCE VARCHAR(1000) NULL,			
	OBR_TRANSACTION_DESC_DETAILS VARCHAR(1000) NOT NULL,	
	OBR_BANK_REFERENCE VARCHAR(1000) NULL,			
	OBR_REFERENCE CHAR(1) NULL,		
	ULD_ID INTEGER(2) NOT NULL,
	OBR_TIMESTAMP TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
	PRIMARY KEY(OBR_ID),
	FOREIGN KEY(ULD_ID) REFERENCES USER_LOGIN_DETAILS (ULD_ID));
--TEMP TABLE CREATE QUERIES
	DROP TABLE IF EXISTS TEMP_OCBC_SCDB_FORMAT;
	CREATE TABLE TEMP_OCBC_SCDB_FORMAT LIKE OCBC_SCDB_FORMAT;
--TEMP TABLE INSERT QUERIES
	INSERT INTO TEMP_OCBC_SCDB_FORMAT SELECT * FROM OCBC_SCDB_FORMAT;
--TEMP TABLE UPDATE QUERIES	
	UPDATE TEMP_OCBC_SCDB_FORMAT SET USERSTAMP='expatsintegrated@gmail.com' WHERE USERSTAMP IS NULL;
--INSERT QUERY FOR OCBC_BANK_RECORDS
	INSERT INTO OCBC_BANK_RECORDS(OBR_ACCOUNT_NUMBER,OBR_CURRENCY,OBR_OPENING_BALANCE,OBR_CLOSING_BALANCE,
	OBR_PREVIOUS_BALANCE,OBR_DAY_TTL_CREDIT,OBR_DAY_TTL_DEBIT,OBR_NO_OF_CREDITS,OBR_NO_OF_DEBITS,
	OBR_POST_DATE,OBR_TRANS_DATE,OBR_VALUE_DATE,OBR_NET_DAY_BALANCE,OBR_DEBIT_AMOUNT,OBR_CREDIT_AMOUNT,
	OBR_TRX_CODE,OBR_CLIENT_REFERENCE,OBR_TRANSACTION_DESC_DETAILS,OBR_BANK_REFERENCE,OBR_REFERENCE,
	ULD_ID,OBR_TIMESTAMP)
	SELECT T.ACCOUNT_NUMBER, T.TYPE, T.OPENING_BALANCE, T.AMOUNT, T.AMOUNT1, T.AMOUNT2, T.AMOUNT3, T.ID, T.ID1, 
	T.DATE, T.DATE2, T.DATE3, T.DEBITS, T.DEBIT_AMOUNT, T.CREDIT_AMOUNT, T.DATA, T.CLIENT_REFERRENCE, 
	T.TRANSACTION_DESC_DETAILS, T.BANK_REFFERENCE, T.REFERENCE,ULD.ULD_ID,T.TIMESTAMP FROM TEMP_OCBC_SCDB_FORMAT T,
	USER_LOGIN_DETAILS ULD WHERE ULD.ULD_LOGINID=T.USERSTAMP;
	SET END_TIME=(SELECT CURTIME());
	SET DURATION=(SELECT TIMEDIFF(END_TIME,START_TIME));
	SET @COUNT_SCDB_OCBC_BANK_RECORDS=(SELECT COUNT(*) FROM TEMP_OCBC_SCDB_FORMAT);
	SET @COUNT_SPLITTED_OCBC_BANK_RECORDS=(SELECT COUNT(*) FROM OCBC_BANK_RECORDS);
	SET @REJECTION_COUNT=(@COUNT_SCDB_OCBC_BANK_RECORDS-@COUNT_SPLITTED_OCBC_BANK_RECORDS);
--UPDATE QUERY FOR PRE_AUDIT_SUB_PROFILE TABLE		
	UPDATE PRE_AUDIT_SUB_PROFILE SET PREASP_NO_OF_REC=@COUNT_SCDB_OCBC_BANK_RECORDS WHERE PREASP_DATA='OCBC_BANK_RECORDS';
--INSERT QUERY FOR POST_AUDIT_HISTORY TABLE			
	INSERT INTO POST_AUDIT_HISTORY(POSTAP_ID,POSTAH_NO_OF_REC,PREASP_ID,PREAMP_ID,POSTAH_DURATION,POSTAH_NO_OF_REJ,POSTAH_USERSTAMP)
	VALUES((SELECT POSTAP_ID FROM POST_AUDIT_PROFILE WHERE POSTAP_DATA='OCBC_BANK_RECORDS'),@COUNT_SPLITTED_OCBC_BANK_RECORDS,
	(SELECT PREASP_ID FROM PRE_AUDIT_SUB_PROFILE WHERE PREASP_DATA='OCBC_BANK_RECORDS'),
	(SELECT PREAMP_ID FROM PRE_AUDIT_MAIN_PROFILE WHERE PREAMP_DATA='OCBC'),DURATION,@REJECTION_COUNT,OCBC_USERSTAMP);
	DROP TABLE IF EXISTS TEMP_OCBC_SCDB_FORMAT;
END;

CALL SP_OCBC_BANK_RECORDS_INSERT('ww@gmail.com');
