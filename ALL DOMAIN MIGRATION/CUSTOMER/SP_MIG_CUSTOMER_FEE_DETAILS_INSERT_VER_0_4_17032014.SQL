-- version:0.4 -- sdate:17/03/2014 -- edate:17/03/2014 -- issue:765 --desc:droped temp table --doneby:RL
--version:0.3--sdate:20/02/2014 --edate:20/02/2014 --issue:750 -desc:added preaudit and post audit queries done by:dhivya
--VER 0.2 STARTDATE:21/01/2014 ENDDATE:22/01/2014 ISSUE NO:594 COMMENT :#50 DESC:ALL UPDATION DONE IN THE SPLITTED TABLE ITSELF NOT IN THE CUSTOMER SCDB FORMAT TABLE DONE BY:DHIVYA

--INSERT QUERY FOR CUSTOMER_FEE_DETAILS
DROP PROCEDURE IF EXISTS SP_MIG_CUSTOMER_FEE_INSERT;
CREATE PROCEDURE SP_MIG_CUSTOMER_FEE_INSERT(IN CUSTOMER_USERSTAMP VARCHAR(100))
BEGIN
	DECLARE MINCCID INT;
	DECLARE MAXCCID INT;
	DECLARE CUSTID INT;
	DECLARE RECVER INT;
	DECLARE START_TIME TIME;
	DECLARE END_TIME TIME;
	DECLARE DURATION TIME;
	
	SET FOREIGN_KEY_CHECKS=0;
	DROP TABLE IF EXISTS CUSTOMER_FEE_DETAILS;
	CREATE TABLE CUSTOMER_FEE_DETAILS(
	CFD_ID INTEGER NOT NULL	AUTO_INCREMENT,
	CUSTOMER_ID	INTEGER NOT NULL,
	CED_REC_VER	INTEGER NOT NULL,
	CPP_ID INTEGER NOT NULL,
	CFD_AMOUNT DECIMAL(7,2) NOT NULL,
	PRIMARY KEY(CFD_ID),
	FOREIGN KEY(CUSTOMER_ID) REFERENCES CUSTOMER(CUSTOMER_ID),
	FOREIGN KEY(CPP_ID) REFERENCES CUSTOMER_PAYMENT_PROFILE(CPP_ID));	
	
	SET MINCCID =(SELECT MIN(CTD_ID) FROM TEMP_CUSTOMER_TERMINATION_DETAILS);
	SET MAXCCID =(SELECT MAX(CTD_ID) FROM TEMP_CUSTOMER_TERMINATION_DETAILS);
	SET START_TIME=(SELECT CURTIME());
	WHILE MINCCID<=MAXCCID DO
	SET CUSTID=(SELECT CUSTOMER_ID FROM TEMP_CUSTOMER_TERMINATION_DETAILS WHERE CTD_ID=MINCCID);
	SET RECVER=(SELECT CED_REC_VER FROM TEMP_CUSTOMER_TERMINATION_DETAILS WHERE CTD_ID=MINCCID);
		IF EXISTS (SELECT RENT_AMOUNT FROM TEMP_CUSTOMER_TERMINATION_DETAILS WHERE CUSTOMER_ID=CUSTID AND CED_REC_VER=RECVER AND RENT_AMOUNT!=0)THEN
			INSERT INTO CUSTOMER_FEE_DETAILS(CUSTOMER_ID, CED_REC_VER, CPP_ID, CFD_AMOUNT)VALUES(CUSTID,RECVER,1,(SELECT RENT_AMOUNT FROM TEMP_CUSTOMER_TERMINATION_DETAILS WHERE CUSTOMER_ID=CUSTID AND CED_REC_VER=RECVER));
		END IF;
		
		IF EXISTS (SELECT DEPOSIT FROM TEMP_CUSTOMER_TERMINATION_DETAILS WHERE CUSTOMER_ID=CUSTID AND CED_REC_VER=RECVER AND DEPOSIT!=0)THEN
			INSERT INTO CUSTOMER_FEE_DETAILS(CUSTOMER_ID, CED_REC_VER, CPP_ID, CFD_AMOUNT)VALUES(CUSTID,RECVER,2,(SELECT DEPOSIT FROM TEMP_CUSTOMER_TERMINATION_DETAILS WHERE CUSTOMER_ID=CUSTID AND CED_REC_VER=RECVER));
		END IF;
		
		IF EXISTS (SELECT PROCESSING_FEE FROM TEMP_CUSTOMER_TERMINATION_DETAILS WHERE CUSTOMER_ID=CUSTID AND CED_REC_VER=RECVER AND PROCESSING_FEE!=0)THEN
			INSERT INTO CUSTOMER_FEE_DETAILS(CUSTOMER_ID, CED_REC_VER, CPP_ID, CFD_AMOUNT)VALUES(CUSTID,RECVER,3,(SELECT PROCESSING_FEE FROM TEMP_CUSTOMER_TERMINATION_DETAILS WHERE CUSTOMER_ID=CUSTID AND CED_REC_VER=RECVER));
		END IF;
		
		IF EXISTS (SELECT AIRCON_FIXED_FEE FROM TEMP_CUSTOMER_TERMINATION_DETAILS WHERE CUSTOMER_ID=CUSTID AND CED_REC_VER=RECVER AND AIRCON_FIXED_FEE!=0)THEN
			INSERT INTO CUSTOMER_FEE_DETAILS(CUSTOMER_ID, CED_REC_VER, CPP_ID, CFD_AMOUNT)VALUES(CUSTID,RECVER,4,(SELECT AIRCON_FIXED_FEE FROM TEMP_CUSTOMER_TERMINATION_DETAILS WHERE CUSTOMER_ID=CUSTID AND CED_REC_VER=RECVER));
		END IF;
		
		IF EXISTS (SELECT ELECTRICITY_CAP FROM TEMP_CUSTOMER_TERMINATION_DETAILS WHERE CUSTOMER_ID=CUSTID AND CED_REC_VER=RECVER AND ELECTRICITY_CAP!=0)THEN
			INSERT INTO CUSTOMER_FEE_DETAILS(CUSTOMER_ID, CED_REC_VER, CPP_ID, CFD_AMOUNT)VALUES(CUSTID,RECVER,5,(SELECT ELECTRICITY_CAP FROM TEMP_CUSTOMER_TERMINATION_DETAILS WHERE CUSTOMER_ID=CUSTID AND CED_REC_VER=RECVER));
		END IF;
		
		IF EXISTS (SELECT DRYCLEAN_FEE FROM TEMP_CUSTOMER_TERMINATION_DETAILS WHERE CUSTOMER_ID=CUSTID AND CED_REC_VER=RECVER AND DRYCLEAN_FEE!=0)THEN
			INSERT INTO CUSTOMER_FEE_DETAILS(CUSTOMER_ID, CED_REC_VER, CPP_ID, CFD_AMOUNT)VALUES(CUSTID,RECVER,6,(SELECT DRYCLEAN_FEE FROM TEMP_CUSTOMER_TERMINATION_DETAILS WHERE CUSTOMER_ID=CUSTID AND CED_REC_VER=RECVER));
		END IF;
		
		IF EXISTS (SELECT AIRCON_QUARTERLY_FEE FROM TEMP_CUSTOMER_TERMINATION_DETAILS WHERE CUSTOMER_ID=CUSTID AND CED_REC_VER=RECVER AND AIRCON_QUARTERLY_FEE!=0)THEN
			INSERT INTO CUSTOMER_FEE_DETAILS(CUSTOMER_ID, CED_REC_VER, CPP_ID, CFD_AMOUNT)VALUES(CUSTID,RECVER,7,(SELECT AIRCON_QUARTERLY_FEE FROM TEMP_CUSTOMER_TERMINATION_DETAILS WHERE CUSTOMER_ID=CUSTID AND CED_REC_VER=RECVER));
		END IF;
		
		IF EXISTS (SELECT CHECKOUT_CLEANING_FEE FROM TEMP_CUSTOMER_TERMINATION_DETAILS WHERE CUSTOMER_ID=CUSTID AND CED_REC_VER=RECVER AND CHECKOUT_CLEANING_FEE!=0)THEN
			INSERT INTO CUSTOMER_FEE_DETAILS(CUSTOMER_ID, CED_REC_VER, CPP_ID, CFD_AMOUNT)VALUES(CUSTID,RECVER,8,(SELECT CHECKOUT_CLEANING_FEE FROM TEMP_CUSTOMER_TERMINATION_DETAILS WHERE CUSTOMER_ID=CUSTID AND CED_REC_VER=RECVER));
		END IF;
		SET MINCCID=MINCCID+1;
		END WHILE;
		SET END_TIME=(SELECT CURTIME());
		SET DURATION=(SELECT TIMEDIFF(END_TIME,START_TIME));
		
	SET @RENTAMOUNT=(SELECT COUNT(*) FROM CUSTOMER_SCDB_FORMAT WHERE CC_RENT_AMOUNT!=0 AND CC_GUEST_CARD_NO IS NULL);
	SET @DEPOSIT=(SELECT COUNT(*) FROM CUSTOMER_SCDB_FORMAT WHERE CC_DEPOSIT!=0 AND CC_GUEST_CARD_NO IS NULL);
	SET @PROCESS_FEE=(SELECT COUNT(*) FROM CUSTOMER_SCDB_FORMAT WHERE CC_PROCESSING_FEE!=0 AND CC_GUEST_CARD_NO IS NULL);
	SET @AIRCON_FIXED_FEE=(SELECT COUNT(*) FROM CUSTOMER_SCDB_FORMAT WHERE CC_AIRCON_FIXED_FEE!=0 AND CC_GUEST_CARD_NO IS NULL);
	SET @ELECTRICITY_CAP=(SELECT COUNT(*) FROM CUSTOMER_SCDB_FORMAT WHERE CC_ELECTRICITY_CAP!=0 AND CC_GUEST_CARD_NO IS NULL);
	SET @DRYCLEAN_FEE=(SELECT COUNT(*) FROM CUSTOMER_SCDB_FORMAT WHERE CC_DRYCLEAN_FEE!=0 AND CC_GUEST_CARD_NO IS NULL);
	SET @QUARTELY_FEE=(SELECT COUNT(*) FROM CUSTOMER_SCDB_FORMAT WHERE CC_AIRCON_QUARTERLY_FEE!=0 AND CC_GUEST_CARD_NO IS NULL);
	SET @CLEANING_FEE=(SELECT COUNT(*) FROM CUSTOMER_SCDB_FORMAT WHERE CC_CHECKOUT_CLEANING_FEE!=0 AND CC_GUEST_CARD_NO IS NULL);
	SET @COUNT_SCDB_CFD=(SELECT SUM(@RENTAMOUNT+@DEPOSIT+@PROCESS_FEE+@AIRCON_FIXED_FEE+@ELECTRICITY_CAP+@DRYCLEAN_FEE+@QUARTELY_FEE+@CLEANING_FEE));
	SET @SPLITTED_CFD=(SELECT COUNT(*) FROM CUSTOMER_FEE_DETAILS);

	UPDATE PRE_AUDIT_SUB_PROFILE SET PREASP_NO_OF_REC=@COUNT_SCDB_CFD WHERE PREASP_DATA='CUSTOMER_FEE_DETAILS';
	INSERT INTO POST_AUDIT_HISTORY(POSTAP_ID,POSTAH_NO_OF_REC,PREASP_ID,PREAMP_ID,POSTAH_DURATION,POSTAH_NO_OF_REJ,POSTAH_USERSTAMP)
	VALUES((SELECT POSTAP_ID FROM POST_AUDIT_PROFILE WHERE POSTAP_DATA='CUSTOMER_FEE_DETAILS'),@SPLITTED_CFD,(SELECT PREASP_ID FROM PRE_AUDIT_SUB_PROFILE WHERE PREASP_DATA='CUSTOMER_FEE_DETAILS'),
	(SELECT PREAMP_ID FROM PRE_AUDIT_MAIN_PROFILE WHERE PREAMP_DATA='CUSTOMER'),DURATION,@REJECTION_COUNT,CUSTOMER_USERSTAMP);
		
	SET FOREIGN_KEY_CHECKS=1;
	
	END;
	
	
	