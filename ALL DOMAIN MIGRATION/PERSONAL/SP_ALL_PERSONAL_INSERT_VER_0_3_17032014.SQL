-- version:0.3 -- sdate:17/03/2014 -- edate:17/03/2014 -- issue:765 --desc:droped temp table --doneby:RL
--version:0.2--sdate:22/02/2014 --edate:22/02/2014 --issue:750 -desc:added preaudit and post audit queries done by:dhivya
--version:0.1--sdate:22/02/2014 --edate:22/02/2014 --issue:750 -desc:added preaudit and post audit queries done by:dhivya



DROP PROCEDURE IF EXISTS SP_ALL_PERSONAL_INSERT;
CREATE PROCEDURE SP_ALL_PERSONAL_INSERT(IN PERSONAL_USERSTAMP VARCHAR(100))
BEGIN
DECLARE START_TIME TIME;
DECLARE END_TIME TIME;
DECLARE DURATION TIME;
CALL SP_TEMP_PERSONAL_SCDB_FORMAT();
SET START_TIME=(SELECT CURTIME());
--EXPENSE_BABY INSERT
CALL SP_MIG_EXP_BABY_DOUBLE_SLASHN_INVOICE_FROM_ITEM_SPLIT_INSERT();
--QUERY FOR SPLIT SINGLE SLASHN COMMENTS
CREATE OR REPLACE VIEW VW_MIG_TEMP_EXP_BABY_ALL_COMMENTS AS SELECT PE_ID,PE_BABY_COMMENTS,PE_BABY_INVOICE_ITEMS,PE_BABY_INVOICE_FROM 
FROM PERSONAL_SCDB_FORMAT WHERE PE_TYPE_OF_EXPENSE='BABY';
CREATE OR REPLACE VIEW VW_MIG_TEMP_EXP_BABY_REMAINING_COMMENTS AS SELECT RC.PE_ID,RC.PE_BABY_COMMENTS,RC.PE_BABY_INVOICE_ITEMS,RC.PE_BABY_INVOICE_FROM
FROM VW_MIG_TEMP_EXP_BABY_ALL_COMMENTS RC LEFT JOIN TEMP_EXP_BABY_DOUBLE_SLASHN_INVOICE_FROM_ITEM BDSIFI 
ON BDSIFI.PE_ID = RC.PE_ID WHERE BDSIFI.PE_ID IS NULL;
CALL SP_MIG_EXP_BABY_SINGLE_SLASHN_INVOICE_FROM_ITEM_SPLIT_INSERT();
--QUERY FOR SPLIT COMMENTS
CREATE OR REPLACE VIEW VW_MIG_TEMP_EXP_BABY_SINGLE_SLASHN_REMAINING_COMMENTS AS SELECT RC.PE_ID,RC.PE_BABY_COMMENTS,RC.PE_BABY_INVOICE_ITEMS,RC.PE_BABY_INVOICE_FROM
FROM VW_MIG_TEMP_EXP_BABY_REMAINING_COMMENTS RC LEFT JOIN TEMP_EXP_BABY_SINGLE_SLASHN_INVOICE_FROM_ITEM BIFI ON BIFI.PE_ID = RC.PE_ID
WHERE BIFI.PE_ID IS NULL;

CALL SP_MIG_EXP_BABY_SLASHN_INVOICE_FROM_ITEM_SPLIT_INSERT();

CALL SP_BABY_INVOICE_ITEM_FROM_SPLIT();

CALL SP_EXPENSE_BABY_INSERT();

SET END_TIME=(SELECT CURTIME());
		
SET DURATION=(SELECT TIMEDIFF(END_TIME,START_TIME));

SET @COUNT_SCDB_BABY=(SELECT COUNT(*) FROM PERSONAL_SCDB_FORMAT WHERE PE_TYPE_OF_EXPENSE='BABY');
SET @COUNT_SPLITTED_BABY=(SELECT COUNT(*) FROM EXPENSE_BABY);
SET @REJECTION_COUNT=(@COUNT_SCDB_BABY-@COUNT_SPLITTED_BABY);
UPDATE PRE_AUDIT_SUB_PROFILE SET PREASP_NO_OF_REC=@COUNT_SCDB_BABY WHERE PREASP_DATA='EXPENSE_BABY';
INSERT INTO POST_AUDIT_HISTORY(POSTAP_ID,POSTAH_NO_OF_REC,PREASP_ID,PREAMP_ID,POSTAH_DURATION,POSTAH_NO_OF_REJ,POSTAH_USERSTAMP)
VALUES((SELECT POSTAP_ID FROM POST_AUDIT_PROFILE WHERE POSTAP_DATA='EXPENSE_BABY'),@COUNT_SPLITTED_BABY,(SELECT PREASP_ID FROM PRE_AUDIT_SUB_PROFILE WHERE PREASP_DATA='EXPENSE_BABY'),
(SELECT PREAMP_ID FROM PRE_AUDIT_MAIN_PROFILE WHERE PREAMP_DATA='PERSONAL'),DURATION,@REJECTION_COUNT,PERSONAL_USERSTAMP);
DROP TABLE IF EXISTS TEMP_BABY_INVOICE_ITEM_FROM_SPLITTED_TABLE;
--EXPENSE_CAR INSERT
SET START_TIME=(SELECT CURTIME());
CALL SP_EXP_MIG_CAR_DOUBLE_SLASHN_INVOICE_FROM_ITEM_SPLIT_INSERT();
CREATE OR REPLACE VIEW VW_MIG_TEMP_EXP_CAR_ALL_COMMENTS AS SELECT PE_ID,PE_CAR_EXP_COMMENTS,PE_CAR_EXP_INVOICE_ITEMS,PE_CAR_EXP_INVOICE_FROM FROM PERSONAL_SCDB_FORMAT 
WHERE PE_TYPE_OF_EXPENSE='CAR EXPENSE';
CREATE OR REPLACE VIEW VW_MIG_TEMP_EXP_CAR_REMAINING_COMMENTS AS SELECT t1.PE_ID,t1.PE_CAR_EXP_COMMENTS,PE_CAR_EXP_INVOICE_ITEMS,PE_CAR_EXP_INVOICE_FROM
FROM VW_MIG_TEMP_EXP_CAR_ALL_COMMENTS t1
LEFT JOIN TEMP_EXP_CAR_DOUBLE_SLASHN_INVOICE_FROM_ITEM t2 ON t2.PE_ID = t1.PE_ID
WHERE t2.PE_ID IS NULL;
CALL SP_MIG_EXP_CAR_SINGLE_SLASHN_INVOICE_FROM_ITEM_SPLIT_INSERT();
CREATE OR REPLACE VIEW VW_MIG_TEMP_EXP_CAR_SLASHN_REMAINING_COMMENTS  AS SELECT RC.PE_ID,RC.PE_CAR_EXP_COMMENTS,PE_CAR_EXP_INVOICE_ITEMS,PE_CAR_EXP_INVOICE_FROM
FROM VW_MIG_TEMP_EXP_CAR_REMAINING_COMMENTS RC LEFT JOIN TEMP_EXP_CAR_SINGLE_SLASHN_INVOICE_FROM_ITEM SSIFI ON SSIFI.PE_ID = RC.PE_ID
WHERE SSIFI.PE_ID IS NULL;

CALL SP_MIG_EXP_CAR_SLASHN_INVOICE_FROM_ITEM_SPLIT_INSERT();

CALL SP_CAR_INVOICE_ITEM_FROM_SPLITTING();

CALL SP_EXPENSE_CAR_INSERT();

SET END_TIME=(SELECT CURTIME());
		
SET DURATION=(SELECT TIMEDIFF(END_TIME,START_TIME));

SET @COUNT_SCDB_CAR=(SELECT COUNT(*) FROM PERSONAL_SCDB_FORMAT WHERE PE_TYPE_OF_EXPENSE='CAR EXPENSE');
SET @COUNT_SPLITTED_CAR=(SELECT COUNT(*) FROM EXPENSE_CAR);
SET @REJECTION_COUNT=(@COUNT_SCDB_CAR-@COUNT_SPLITTED_CAR);

UPDATE PRE_AUDIT_SUB_PROFILE SET PREASP_NO_OF_REC=@COUNT_SCDB_CAR WHERE PREASP_DATA='EXPENSE_CAR';

INSERT INTO POST_AUDIT_HISTORY(POSTAP_ID,POSTAH_NO_OF_REC,PREASP_ID,PREAMP_ID,POSTAH_DURATION,POSTAH_NO_OF_REJ,POSTAH_USERSTAMP)
VALUES((SELECT POSTAP_ID FROM POST_AUDIT_PROFILE WHERE POSTAP_DATA='EXPENSE_CAR'),@COUNT_SPLITTED_CAR,(SELECT PREASP_ID FROM PRE_AUDIT_SUB_PROFILE WHERE PREASP_DATA='EXPENSE_CAR'),
(SELECT PREAMP_ID FROM PRE_AUDIT_MAIN_PROFILE WHERE PREAMP_DATA='PERSONAL'),DURATION,@REJECTION_COUNT,PERSONAL_USERSTAMP);

DROP TABLE IF EXISTS TEMP_CAR_INVOICE_ITEM_FROM_SPLITTED_TABLE;

--EXPENSE PERSONAL
SET START_TIME=(SELECT CURTIME());

CALL SP_MIG_EXP_PERSONAL_TRIBLE_SLASHN_INVOICE_FROM_ITEM_SPLIT_INSERT();
--VIEW FOR REMAINING COMMENTS
CREATE OR REPLACE VIEW VW_MIG_TEMP_EXP_PERSONAL_ALL_COMMENTS AS SELECT PE_ID,PE_PERSONAL_COMMENTS,PE_PERSONAL_INVOICE_ITEMS,PE_PERSONAL_INVOICE_FROM FROM PERSONAL_SCDB_FORMAT WHERE PE_TYPE_OF_EXPENSE='PERSONAL' AND PE_PERSONAL_COMMENTS IS NOT NULL AND (PE_PERSONAL_INVOICE_ITEMS IS NULL OR PE_PERSONAL_INVOICE_FROM IS NULL);

CREATE OR REPLACE VIEW VW_MIG_TEMP_EXP_PERSONAL_REMAINING_COMMENTS AS SELECT t1.PE_ID,t1.PE_PERSONAL_COMMENTS,PE_PERSONAL_INVOICE_ITEMS,PE_PERSONAL_INVOICE_FROM
FROM VW_MIG_TEMP_EXP_PERSONAL_ALL_COMMENTS t1
LEFT JOIN TEMP_EXP_PERSONAL_TRIBLE_SLASHN_INVOICE_FROM_ITEM t2 ON t2.PE_ID = t1.PE_ID
WHERE t2.PE_ID IS NULL;

CALL SP_MIG_EXP_PERSONAL_DOUBLE_SLASHN_INVOICE_FROM_ITEM_SPLIT_INSERT();

--VIEW FOR REMAINING COMMENTS
CREATE OR REPLACE VIEW VW_MIG_TEMP_EXP_PERSONAL_DOUBLE_SLASHN_REMAINING_COMMENTS AS SELECT t1.PE_ID,t1.PE_PERSONAL_COMMENTS,PE_PERSONAL_INVOICE_ITEMS,PE_PERSONAL_INVOICE_FROM
FROM VW_MIG_TEMP_EXP_PERSONAL_REMAINING_COMMENTS t1
LEFT JOIN TEMP_EXP_PERSONAL_DOUBLE_SLASHN_INVOICE_FROM_ITEM t2 ON t2.PE_ID = t1.PE_ID
WHERE t2.PE_ID IS NULL;

CALL SP_MIG_EXP_PERSONAL_SINGLE_SLASHN_INVOICE_FROM_ITEM_SPLIT_INSERT();

--VIEW FOR REMAINING COMMENTS
CREATE OR REPLACE VIEW VW_MIG_TEMP_EXP_PERSONAL_SINGLE_SLASHN_REMAINING_COMMENTS AS SELECT t1.PE_ID,t1.PE_PERSONAL_COMMENTS,PE_PERSONAL_INVOICE_ITEMS,PE_PERSONAL_INVOICE_FROM
FROM VW_MIG_TEMP_EXP_PERSONAL_DOUBLE_SLASHN_REMAINING_COMMENTS t1
LEFT JOIN TEMP_EXP_PERSONAL_SINGLE_SLASHN_INVOICE_FROM_ITEM t2 ON t2.PE_ID = t1.PE_ID
WHERE t2.PE_ID IS NULL;

CALL SP_MIG_EXP_PERSONAL_SLASHN_INVOICE_FROM_ITEM_SPLIT_INSERT();

--VIEW FOR REMAINING COMMENTS
CREATE OR REPLACE VIEW VW_MIG_TEMP_EXP_PERSONAL_SLASHN_REMAINING_COMMENTS AS SELECT t1.PE_ID,t1.PE_PERSONAL_COMMENTS,PE_PERSONAL_INVOICE_ITEMS,PE_PERSONAL_INVOICE_FROM
FROM VW_MIG_TEMP_EXP_PERSONAL_SINGLE_SLASHN_REMAINING_COMMENTS t1
LEFT JOIN TEMP_EXP_PERSONAL_SLASHN_INVOICE_FROM_ITEM t2 ON t2.PE_ID = t1.PE_ID
WHERE t2.PE_ID IS NULL;

CALL SP_MIG_EXP_PERSONAL_DOUBLE_SLASHN_INVOICE_ITEM_SPLIT_INSERT();

--VIEW FOR REMAINING COMMENTS
CREATE OR REPLACE VIEW VW_MIG_TEMP_EXP_PERSONAL_DOUBLE_SLASHN_INVOICE_ITEM_COMMENTS AS SELECT t1.PE_ID,t1.PE_PERSONAL_COMMENTS,PE_PERSONAL_INVOICE_ITEMS,PE_PERSONAL_INVOICE_FROM
FROM VW_MIG_TEMP_EXP_PERSONAL_SLASHN_REMAINING_COMMENTS t1
LEFT JOIN TEMP_EXP_PERSONAL_DOUBLE_SLASHN_INVOICE_ITEM t2 ON t2.PE_ID = t1.PE_ID
WHERE t2.PE_ID IS NULL;

CALL SP_MIG_EXP_PERSONAL_SINGLE_SLASHN_INVOICE_ITEM_SPLIT_INSERT();
CALL SP_PERSONAL_INVOICE_ITEM_FROM_SPLITTING();
CALL SP_MIG_EXPENSE_PERSONAL_INSERT();

DROP TABLE IF EXISTS TEMP_PERSONAL_INVOICE_ITEM_FROM_SPLITTED_TABLE;

SET END_TIME=(SELECT CURTIME());
		
SET DURATION=(SELECT TIMEDIFF(END_TIME,START_TIME));

SET @COUNT_SCDB_PERSONAL=(SELECT COUNT(*) FROM PERSONAL_SCDB_FORMAT WHERE PE_TYPE_OF_EXPENSE='PERSONAL');
SET @COUNT_SPLITTED_PERSONAL=(SELECT COUNT(*) FROM EXPENSE_PERSONAL);
SET @REJECTION_COUNT=(@COUNT_SCDB_PERSONAL-@COUNT_SPLITTED_PERSONAL);

UPDATE PRE_AUDIT_SUB_PROFILE SET PREASP_NO_OF_REC=@COUNT_SCDB_PERSONAL WHERE PREASP_DATA='EXPENSE_PERSONAL';

INSERT INTO POST_AUDIT_HISTORY(POSTAP_ID,POSTAH_NO_OF_REC,PREASP_ID,PREAMP_ID,POSTAH_DURATION,POSTAH_NO_OF_REJ,POSTAH_USERSTAMP)
VALUES((SELECT POSTAP_ID FROM POST_AUDIT_PROFILE WHERE POSTAP_DATA='EXPENSE_PERSONAL'),@COUNT_SPLITTED_PERSONAL,(SELECT PREASP_ID FROM PRE_AUDIT_SUB_PROFILE WHERE PREASP_DATA='EXPENSE_PERSONAL'),
(SELECT PREAMP_ID FROM PRE_AUDIT_MAIN_PROFILE WHERE PREAMP_DATA='PERSONAL'),DURATION,@REJECTION_COUNT,PERSONAL_USERSTAMP);

--EXPENSE CARLOAN
SET START_TIME=(SELECT CURTIME());
CALL SP_EXPENSE_CARLOAN_TABLE();
CALL SP_EXPENSE_CARLOAN_INSERT();
SET END_TIME=(SELECT CURTIME());
		
SET DURATION=(SELECT TIMEDIFF(END_TIME,START_TIME));

SET @COUNT_SCDB_CARLOAN=(SELECT COUNT(*) FROM PERSONAL_SCDB_FORMAT WHERE PE_TYPE_OF_EXPENSE='CAR LOAN');
SET @COUNT_SPLITTED_CARLOAN=(SELECT COUNT(*) FROM EXPENSE_CAR_LOAN);
SET @REJECTION_COUNT=(@COUNT_SCDB_CARLOAN-@COUNT_SPLITTED_CARLOAN);

UPDATE PRE_AUDIT_SUB_PROFILE SET PREASP_NO_OF_REC=@COUNT_SCDB_CARLOAN WHERE PREASP_DATA='EXPENSE_CAR_LOAN';

INSERT INTO POST_AUDIT_HISTORY(POSTAP_ID,POSTAH_NO_OF_REC,PREASP_ID,PREAMP_ID,POSTAH_DURATION,POSTAH_NO_OF_REJ,POSTAH_USERSTAMP)
VALUES((SELECT POSTAP_ID FROM POST_AUDIT_PROFILE WHERE POSTAP_DATA='EXPENSE_CAR_LOAN'),@COUNT_SPLITTED_CARLOAN,(SELECT PREASP_ID FROM PRE_AUDIT_SUB_PROFILE WHERE PREASP_DATA='EXPENSE_CAR_LOAN'),
(SELECT PREAMP_ID FROM PRE_AUDIT_MAIN_PROFILE WHERE PREAMP_DATA='PERSONAL'),DURATION,@REJECTION_COUNT,PERSONAL_USERSTAMP);
DROP TABLE IF EXISTS TEMP_PERSONAL_SCDB_FORMAT;

END;	

CALL SP_ALL_PERSONAL_INSERT('rajalakshmi.r@ssomens.com');



