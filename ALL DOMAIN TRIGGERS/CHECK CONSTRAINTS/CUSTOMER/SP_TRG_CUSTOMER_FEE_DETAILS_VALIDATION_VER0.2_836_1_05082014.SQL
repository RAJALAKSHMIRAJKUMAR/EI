--issue no:836 startdate:05/08/2014 enddate:05/08/2014 DESC:VALIDATION FOR CUSTOMER_FEE_DETAILS REPLACING HARDCOADEDMESSAGE INTO ID DONE BY:BHAVANI.R
--ISSUE NO:593 VER0.2 STARTDATE:27/06/2014 ENDDATE:28/06/2014 COMMENT NO:100 DESC:CUSTOMER_FEE_DETAILS DONE BY:DHIVYA
DROP PROCEDURE IF EXISTS SP_TRG_CUSTOMER_FEE_DETAILS_VALIDATION;
CREATE PROCEDURE SP_TRG_CUSTOMER_FEE_DETAILS_VALIDATION(
IN NEWCFDID INTEGER,
IN NEWCUSTOMERID INTEGER,
IN NEWCPPID INTEGER,
IN NEWCEDRECVER INTEGER,
IN NEWCFDAMOUNT DECIMAL(7,2),
IN PROCESS TEXT)
BEGIN
DECLARE CFDAMOUNT INTEGER;
DECLARE OLDRECVER INTEGER;
DECLARE OLDCPPID INTEGER;
DECLARE MAXERRORMSG_ELECTRICITYCAP TEXT;
DECLARE MINERRORMSG_ELECTRICITYCAP TEXT;
DECLARE MAXERRORMSG_PAYMENTAMT TEXT;
DECLARE MINERRORMSG_PAYMENTAMT TEXT;
DECLARE MAXERRORMSG_DEPOSITAMT TEXT;
DECLARE MINERRORMSG_DEPOSITAMT TEXT;
DECLARE MAXERRORMSG_PROCESSINGAMT TEXT;
DECLARE MINERRORMSG_PROCESSINGAMT TEXT;
DECLARE MAXERRORMSG_AIRCONAMT TEXT;
DECLARE MINERRORMSG_AIRCONAMT TEXT;
DECLARE ERRORMSG_DRYCLEANAMT TEXT;
DECLARE ERRORMSG_CHECKOUTCLEANINGAMT TEXT;
DECLARE CUSTOMER_NAME TEXT;
DECLARE CUSTOMERNAME TEXT;
DECLARE ERRORMSG_AMOUNT TEXT;
DECLARE AIRCON_ERRORMSG TEXT;
DECLARE AIRCON_FIXED_ERRORMSG TEXT;
SET OLDRECVER=(SELECT CED_REC_VER FROM CUSTOMER_FEE_DETAILS WHERE CFD_ID=NEWCFDID);
SET OLDCPPID=(SELECT CPP_ID FROM CUSTOMER_FEE_DETAILS WHERE CFD_ID=NEWCFDID);
SET CFDAMOUNT=(SELECT SUBSTRING_INDEX(NEWCFDAMOUNT, '.', 1));
SET MAXERRORMSG_ELECTRICITYCAP=(SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=485);
SET MINERRORMSG_ELECTRICITYCAP=(SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=348);
SET MAXERRORMSG_PAYMENTAMT=(SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=486);
SET MINERRORMSG_PAYMENTAMT=(SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=345);
SET MAXERRORMSG_DEPOSITAMT=(SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=487);
SET MINERRORMSG_DEPOSITAMT=(SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=346);
SET MAXERRORMSG_PROCESSINGAMT=(SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=488);
SET MINERRORMSG_PROCESSINGAMT=(SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=347);
SET MAXERRORMSG_AIRCONAMT=(SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=489);
SET MINERRORMSG_AIRCONAMT=(SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=490);
SET ERRORMSG_DRYCLEANAMT=(SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=491);
SET ERRORMSG_CHECKOUTCLEANINGAMT=(SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=492);
SET CUSTOMER_NAME=(SELECT CONCAT(CUSTOMER_FIRST_NAME,' ',CUSTOMER_LAST_NAME) FROM CUSTOMER WHERE CUSTOMER_ID=NEWCUSTOMERID);
SET CUSTOMERNAME=(CONCAT('(',CUSTOMER_NAME,')'));
SET ERRORMSG_AMOUNT=(SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=493);
SET ERRORMSG_AMOUNT=(SELECT REPLACE(ERRORMSG_AMOUNT,'[RECVER]',NEWCEDRECVER));
SET ERRORMSG_AMOUNT=(SELECT REPLACE(ERRORMSG_AMOUNT,'[AMOUNT]',NEWCFDAMOUNT));
SET ERRORMSG_AMOUNT=(SELECT REPLACE(ERRORMSG_AMOUNT,'[CUSTOMER]',CUSTOMERNAME));
SET AIRCON_ERRORMSG=(SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=494);
SET AIRCON_ERRORMSG=(SELECT REPLACE(AIRCON_ERRORMSG,'[CUSTOMER]',CUSTOMERNAME));
SET AIRCON_FIXED_ERRORMSG=(SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=495);
SET AIRCON_FIXED_ERRORMSG=(SELECT REPLACE(AIRCON_FIXED_ERRORMSG,'[CUSTOMER]',CUSTOMERNAME));
IF PROCESS='INSERT' OR PROCESS='UPDATE' THEN
IF NEWCPPID=5 THEN
	IF LENGTH(CFDAMOUNT)>3 THEN
		SIGNAL SQLSTATE '45000'
		SET MESSAGE_TEXT = MAXERRORMSG_ELECTRICITYCAP;
	END IF;  
	IF LENGTH(CFDAMOUNT)<2 THEN
		SIGNAL SQLSTATE '45000'
		SET MESSAGE_TEXT = MINERRORMSG_ELECTRICITYCAP;
	END IF;  
END IF;

IF NEWCPPID=1 THEN
	IF LENGTH(CFDAMOUNT)>5 THEN
		SIGNAL SQLSTATE '45000'
		SET MESSAGE_TEXT = MAXERRORMSG_PAYMENTAMT;
	END IF;  
	IF LENGTH(CFDAMOUNT)<3 THEN
		SIGNAL SQLSTATE '45000'
		SET MESSAGE_TEXT = MINERRORMSG_PAYMENTAMT;
	END IF;  
END IF;

IF NEWCPPID=2 THEN
	IF LENGTH(CFDAMOUNT)>5 THEN
		SIGNAL SQLSTATE '45000'
		SET MESSAGE_TEXT = MAXERRORMSG_DEPOSITAMT;
	END IF;  
	IF LENGTH(CFDAMOUNT)<3 THEN
		SIGNAL SQLSTATE '45000'
		SET MESSAGE_TEXT = MINERRORMSG_DEPOSITAMT;
	END IF;  
END IF;

IF NEWCPPID=3 THEN
	IF LENGTH(CFDAMOUNT)>4 THEN
		SIGNAL SQLSTATE '45000'
		SET MESSAGE_TEXT = MAXERRORMSG_PROCESSINGAMT;
	END IF;  
	IF LENGTH(CFDAMOUNT)<3 THEN
		SIGNAL SQLSTATE '45000'
		SET MESSAGE_TEXT = MINERRORMSG_PROCESSINGAMT;
	END IF;  
END IF;
IF NEWCPPID=4 THEN
	IF LENGTH(CFDAMOUNT)>3 THEN
		SIGNAL SQLSTATE '45000'
		SET MESSAGE_TEXT = MAXERRORMSG_AIRCONAMT;
	END IF; 
END IF; 
IF NEWCPPID=7 THEN
	IF LENGTH(CFDAMOUNT)>3 THEN
		SIGNAL SQLSTATE '45000'
		SET MESSAGE_TEXT = MINERRORMSG_AIRCONAMT;
	END IF; 
END IF; 

IF NEWCPPID=6 THEN
	IF LENGTH(CFDAMOUNT)>3 THEN
		SIGNAL SQLSTATE '45000'
		SET MESSAGE_TEXT = ERRORMSG_DRYCLEANAMT;
	END IF; 
END IF; 
IF NEWCPPID=8 THEN
	IF LENGTH(CFDAMOUNT)>3 THEN
		SIGNAL SQLSTATE '45000'
		SET MESSAGE_TEXT = ERRORMSG_CHECKOUTCLEANINGAMT;
	END IF; 
END IF; 
END IF;

IF PROCESS='INSERT' THEN
	IF EXISTS(SELECT CPP_ID FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=NEWCUSTOMERID AND CED_REC_VER=NEWCEDRECVER AND CPP_ID=NEWCPPID)THEN
		SIGNAL SQLSTATE '45000'
		SET MESSAGE_TEXT = ERRORMSG_AMOUNT;
	END IF;
	IF NEWCPPID=4 THEN
		IF EXISTS(SELECT CPP_ID FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=NEWCUSTOMERID AND CED_REC_VER=NEWCEDRECVER AND CPP_ID=7)THEN
			SIGNAL SQLSTATE '45000'
			SET MESSAGE_TEXT = AIRCON_ERRORMSG;
		END IF;
	END IF;
	IF NEWCPPID=7 THEN
		IF EXISTS(SELECT CPP_ID FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=NEWCUSTOMERID AND CED_REC_VER=NEWCEDRECVER AND CPP_ID=4)THEN
			SIGNAL SQLSTATE '45000'
			SET MESSAGE_TEXT = AIRCON_FIXED_ERRORMSG;
		END IF;
	END IF;
END IF;
IF PROCESS='UPDATE' THEN
	IF NEWCPPID=4 THEN
		IF OLDCPPID!=NEWCPPID THEN
			IF EXISTS(SELECT * FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=NEWCUSTOMERID AND CED_REC_VER=NEWCEDRECVER AND CPP_ID=7 AND CFD_ID!=NEWCFDID)THEN
				SIGNAL SQLSTATE '45000'
				SET MESSAGE_TEXT = AIRCON_ERRORMSG;
			END IF;
		END IF;
	END IF;
	IF NEWCPPID=7 THEN
		IF OLDCPPID!=NEWCPPID THEN
			IF EXISTS(SELECT * FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=NEWCUSTOMERID AND CED_REC_VER=NEWCEDRECVER AND CPP_ID=4 AND CFD_ID!=NEWCFDID)THEN
				SIGNAL SQLSTATE '45000'
				SET MESSAGE_TEXT = AIRCON_FIXED_ERRORMSG;
			END IF;
		END IF;
	END IF; 
	IF OLDRECVER!=NEWCEDRECVER OR OLDCPPID!=NEWCPPID THEN
		IF EXISTS(SELECT * FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=NEWCUSTOMERID AND CED_REC_VER=NEWCEDRECVER AND CPP_ID=NEWCPPID )THEN
			SIGNAL SQLSTATE '45000'
			SET MESSAGE_TEXT = ERRORMSG_AMOUNT;
		END IF;
	END IF;
END IF;
END;