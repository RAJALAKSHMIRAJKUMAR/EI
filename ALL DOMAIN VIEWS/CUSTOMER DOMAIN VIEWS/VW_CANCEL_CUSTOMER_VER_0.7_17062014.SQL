--VER 0.7 STARTDATE:17/06/2014 ENDDATE:17/06/2014 ISSUENO:345 COMMENTNO:#714 DESC:CHANGED THE TEMP VIEW NAME AS SUB  DONE BY:SASIKALA
--VER 0.6 STARTDATE:06/05/2014 ENDDATE:06/05/2014 ISSUENO:790 COMMENTNO:#2 DESC:CHANGED VW_TEMP_ACTIVE_CUSTOMER VIEW NAME AS VW_CANCEL_TEMP_ACTIVE_CUSTOMER  DONE BY:DHIVYA
--VER 0.5 STARTDATE:03/04/2014 ENDDATE:03/04/2014 ISSUENO:797 COMMENTNO:#4 DESC:REPLACED HEADER ND TABLE NAME DONE BY:LALITHA
-->VER 0.4-->ISSUE NO:615 COMMENT NO:#20 START DATE:28/11/2013 ENDDATE:28/11/2013 DESC:added preterminate date is null condition in vw_cancel_customer view DONE BY:DHIVYA.A
-->VER 0.3-->ISSUE NO:636 COMMENT NO:#47 START DATE:10/11/2013 ENDDATE:10/11/2013 DESC:CHANGED VIEW NAME BY RL
-->VER 0.2--->ISSUE NO:345 START DATE:04/11/2013 ENDDATE:04/11/2013 COMMENT NO:#307 DESC:UPDATED SYSDATE() AS CURDATE()  done by:DHIVYA.A
--VER 0.1 ISSUE NO:345 COMMENT NO:#202 START DATE:26/10/2013 END DATE:30/10/2013 DESC:VIEW FOR CANCEL CUSTOMER COMMENT NO:#202 DONE BY:DHIVYA.A

--TEMP_VIEWS FOR GETTING CUSTOMER_ID AND MAX(RECVER) IN CUSTOMER_ENTRY_DETAILS
CREATE OR REPLACE VIEW VW_SUB_CANCEL_CUSTOMER_MAXIMUM_RECVER AS 
SELECT CED.CUSTOMER_ID,MAX(CED.CED_REC_VER) AS RECVER FROM
CUSTOMER_LP_DETAILS CTD ,CUSTOMER_ENTRY_DETAILS CED WHERE CTD.CLP_GUEST_CARD IS NULL AND CTD.CLP_PRETERMINATE_DATE IS NULL 
AND CTD.CUSTOMER_ID=CED.CUSTOMER_ID AND CTD.CED_REC_VER=CED.CED_REC_VER GROUP BY CED.CUSTOMER_ID;

--TEMP VIEW FOR CANCEL_CUSTOMER WITH MAX RECVER CANCELDATE IS NULL
CREATE OR REPLACE VIEW VW_SUB_CANCEL_CUSTOMER AS SELECT CED.CUSTOMER_ID,CED.CED_REC_VER,CTD.CLP_TERMINATE,CTD.CLP_STARTDATE,CTD.CLP_ENDDATE,CTD.CLP_PRETERMINATE_DATE,CTD.UASD_ID,CED.CED_CANCEL_DATE FROM CUSTOMER_LP_DETAILS CTD,CUSTOMER_ENTRY_DETAILS CED,VW_SUB_CANCEL_CUSTOMER_MAXIMUM_RECVER T WHERE CED.CUSTOMER_ID=CTD.CUSTOMER_ID AND
CED.CED_REC_VER=CTD.CED_REC_VER AND T.CUSTOMER_ID=CTD.CUSTOMER_ID AND T.CUSTOMER_ID=CED.CUSTOMER_ID AND T.RECVER=CTD.CED_REC_VER AND T.RECVER=CED.CED_REC_VER AND CTD.CLP_GUEST_CARD IS NULL AND CTD.CLP_TERMINATE IS NULL AND CED.CED_CANCEL_DATE IS NULL AND((CTD.CLP_STARTDATE>CURDATE())OR(CTD.CLP_STARTDATE<=CURDATE() AND CTD.CLP_ENDDATE>=CURDATE() AND CTD.UASD_ID IS NULL ));

--TEMP VIEW FOR FILTERING ACTIVE CUSTOMER
CREATE OR REPLACE VIEW VW_CANCEL_SUB_ACTIVE_CUSTOMER AS
SELECT C1.CUSTOMER_ID AS CUSTOMERID,CONCAT(CUSTOMER_FIRST_NAME,'_',CUSTOMER_LAST_NAME)AS CUSTOMERNAME  
FROM CUSTOMER C1 JOIN CUSTOMER_LP_DETAILS C JOIN CUSTOMER_ENTRY_DETAILS C2  WHERE 
 C.CLP_TERMINATE IS NULL AND C.UASD_ID IS NOT NULL AND C.CLP_STARTDATE<=CURDATE() AND if (C.CLP_PRETERMINATE_DATE IS NOT NULL ,C.CLP_PRETERMINATE_DATE>=CURDATE(),C.CLP_ENDDATE>=CURDATE())AND C.CUSTOMER_ID=C1.CUSTOMER_ID AND
C.CLP_GUEST_CARD IS NULL AND C.CUSTOMER_ID=C2.CUSTOMER_ID AND C2.CED_CANCEL_DATE IS NULL AND C.CED_REC_VER=C2.CED_REC_VER  GROUP BY C.CUSTOMER_ID;

--VIEW FOR CANCEL_CUSTOMER 
CREATE OR REPLACE VIEW VW_CANCEL_CUSTOMER AS
SELECT U.UNIT_ID,U.UNIT_NO,C.CUSTOMER_ID,CED.CED_REC_VER,CONCAT(C.CUSTOMER_FIRST_NAME,'_',C.CUSTOMER_LAST_NAME)AS CUSTOMERNAME
FROM UNIT U JOIN CUSTOMER C JOIN CUSTOMER_ENTRY_DETAILS CED JOIN CUSTOMER_LP_DETAILS CTD JOIN VW_SUB_CANCEL_CUSTOMER T LEFT JOIN VW_CANCEL_SUB_ACTIVE_CUSTOMER V ON C.CUSTOMER_ID = V.CUSTOMERID
WHERE V.CUSTOMERID IS NULL AND
U.UNIT_ID=CED.UNIT_ID AND CED.CUSTOMER_ID=CTD.CUSTOMER_ID AND C.CUSTOMER_ID=CTD.CUSTOMER_ID AND CTD.CLP_GUEST_CARD IS NULL AND
C.CUSTOMER_ID=CED.CUSTOMER_ID AND CED.CED_REC_VER=CTD.CED_REC_VER AND ((CTD.CLP_STARTDATE>CURDATE())OR(CTD.CLP_STARTDATE<=CURDATE() AND CTD.CLP_ENDDATE>=CURDATE() AND CTD.UASD_ID IS NULL ))AND
T.CUSTOMER_ID=CED.CUSTOMER_ID AND T.CUSTOMER_ID=CTD.CUSTOMER_ID AND CTD.CLP_PRETERMINATE_DATE IS NULL GROUP BY C.CUSTOMER_ID ;



