--VER 0.5 STARTDATE:18/06/2014 ENDDATE:18/06/2014 ISSUENO:345 COMMENTNO:#714 DESC:CHANGED TEMP VIEW NAME AS SUB DONE BY:SASIKALA
--VER 0.4 STARTDATE:03/04/2014 ENDDATE:03/04/2014 ISSUENO:797 COMMENTNO:#4 DESC:REPLACED HEADER ND TABLE NAME DONE BY:LALITHA
-->VER 0.3--->ISSUE NO:636 COMMENT NO:#47 START DATE:10/11/2013 ENDDATE:10/11/2013 DESC:CHANGED VIEW NAME BY RL
--VER 0.2--ISSUE NO:649 STARTDATE:06-11-2013 ENDDATE:06-11-2013  DESC:SYSDATE() UPDATED AS CURDATE() DONE BY:DHIVYA.A
--VER 0.1--ISSUE NO:345 STARTDATE:01-11-2013 ENDDATE:04-11-2013 COMMENT NO:#202 DESC:VIEW FOR UNCANCEL CUSTOMER DONE BY:DHIVYA.A

--TEMP UNCANCEL_MAXRECVER
CREATE OR REPLACE VIEW VW_SUB_UNCANCEL_CUSTOMER_MAXIMUM_RECVER AS
SELECT CED.CUSTOMER_ID,MAX(CED.CED_REC_VER) AS CED_REC_VER FROM CUSTOMER_ENTRY_DETAILS CED,CUSTOMER_LP_DETAILS CTD
WHERE CED.CUSTOMER_ID=CTD.CUSTOMER_ID  AND CED.CED_REC_VER=CTD.CED_REC_VER AND CTD.CLP_GUEST_CARD IS NULL
AND CTD.CLP_PRETERMINATE_DATE IS NULL AND CED.CED_EXTENSION IS NULL GROUP BY CTD.CUSTOMER_ID;

--VIEW FOR UNCANCEL_CUSTOMER MIN RECVERSION
CREATE OR REPLACE VIEW VW_SUB_UNCANCEL_CUSTOMER_MINIMUM_RECVER AS
SELECT CTD.CUSTOMER_ID,CTD.CED_REC_VER  FROM CUSTOMER_ENTRY_DETAILS CED,CUSTOMER_LP_DETAILS CTD,VW_SUB_UNCANCEL_CUSTOMER_MAXIMUM_RECVER T
WHERE CED.CUSTOMER_ID=CTD.CUSTOMER_ID AND CED.CUSTOMER_ID=T.CUSTOMER_ID AND CTD.CUSTOMER_ID=T.CUSTOMER_ID AND
CED.CED_REC_VER=CTD.CED_REC_VER AND CED.CED_CANCEL_DATE IS NOT NULL AND CTD.CLP_PRETERMINATE_DATE IS NULL AND T.CED_REC_VER=CED.CED_REC_VER AND T.CED_REC_VER=CTD.CED_REC_VER AND CTD.CLP_GUEST_CARD IS NULL
GROUP BY CTD.CUSTOMER_ID;

--VIEW FOR UNCANCEL_CUSTOMER
CREATE OR REPLACE VIEW VW_UNCANCEL_CUSTOMER AS
SELECT U.UNIT_ID,U.UNIT_NO,C.CUSTOMER_ID,CED.CED_REC_VER,CONCAT(C.CUSTOMER_FIRST_NAME,'_',C.CUSTOMER_LAST_NAME)AS CUSTOMERNAME
FROM UNIT U JOIN CUSTOMER C JOIN CUSTOMER_ENTRY_DETAILS CED JOIN CUSTOMER_LP_DETAILS CTD JOIN VW_SUB_UNCANCEL_CUSTOMER_MINIMUM_RECVER T 
WHERE
U.UNIT_ID=CED.UNIT_ID AND CED.CUSTOMER_ID=CTD.CUSTOMER_ID AND C.CUSTOMER_ID=CTD.CUSTOMER_ID AND
C.CUSTOMER_ID=CED.CUSTOMER_ID AND CED.CED_REC_VER=CTD.CED_REC_VER AND CED.CED_CANCEL_DATE IS NOT NULL AND CTD.CLP_STARTDATE>CURDATE() AND
T.CUSTOMER_ID=CED.CUSTOMER_ID AND T.CUSTOMER_ID=CTD.CUSTOMER_ID AND T.CED_REC_VER=CED.CED_REC_VER AND T.CED_REC_VER=CTD.CED_REC_VER GROUP BY C.CUSTOMER_ID;