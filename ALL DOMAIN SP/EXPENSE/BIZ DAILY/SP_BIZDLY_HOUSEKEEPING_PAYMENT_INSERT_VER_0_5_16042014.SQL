-- version:0.5 --sdate:16/4/2014 --edate:16/4/2014 --issue:535 --commentno#307 --desc:UPDATE ULD_ID in EXPENSE_HOUSEKEEPING_UNIT --doneby:RL
-->version 0.4 -->start date:28/02/2014 end date:28/02/2014 -->issueno:754 commentno:#36 -->description:CHANGING DATATYPE AND USERSTAMP HEADER DONE BY:BHAVANI.R 
-->version 0.3 -->start date:17/02/2014 end date:17/02/2014 -->issueno:749 commentno:#29 -->description:implement flag for success message  -->created by:ABDUL KADER.M
--version 0.2 --startdate:09/11/2013 --endate:09/11/2013 --desc:SP FOR EXPENSE_HOUSEKEEPING_PAYMENT_INSERT(CONDITION CHEACKING FOR BOTH UNIT AND HOUSE KEEPING UNIT TABLES) --doneby:dinesh----issue---535
--version 0.1 --startdate:08/11/2013 --endate:08/11/2013 --desc:SP FOR EXPENSE_HOUSEKEEPING_PAYMENT_INSERT --doneby:dinesh----issue---535
DROP PROCEDURE IF EXISTS SP_BIZDLY_HOUSEKEEPING_PAYMENT_INSERT;
CREATE PROCEDURE SP_BIZDLY_HOUSEKEEPING_PAYMENT_INSERT
(IN UNIT_NUMBER SMALLINT(4),
IN FOR_PERIOD DATE ,
IN PAID_DATE DATE ,
IN AMOUNT DECIMAL(7,2) ,
IN COMMENTS TEXT ,
IN USERSTAMP VARCHAR(50),
OUT HP_FLAG INTEGER(10))
BEGIN
-- variable declaration
	DECLARE UNITID INTEGER;
	DECLARE HOUSEKEEPINGID INTEGER;
	DECLARE USERSTAMP_ID INTEGER(2);
	DECLARE EXIT HANDLER FOR SQLEXCEPTION
BEGIN 
	ROLLBACK; 
END;
	START TRANSACTION;
	SET HP_FLAG=0;
	CALL SP_CHANGE_USERSTAMP_AS_ULDID(USERSTAMP,@ULDID);
SET USERSTAMP_ID = (SELECT @ULDID);
-- set null for non mandatory fields
		IF COMMENTS = '' THEN
			SET COMMENTS=NULL;
		END IF;
		IF (FOR_PERIOD IS NOT NULL AND PAID_DATE IS NOT NULL AND AMOUNT IS NOT NULL AND USERSTAMP IS NOT NULL) THEN
-- insert query for EXPENSE_HOUSEKEEPING_PAYMENT if passing unit_number is exists in unit table
			IF EXISTS(SELECT UNIT_ID FROM UNIT WHERE UNIT_NO=UNIT_NUMBER) THEN
				SET UNITID = (SELECT UNIT_ID FROM UNIT WHERE UNIT_NO=UNIT_NUMBER);
				INSERT INTO EXPENSE_HOUSEKEEPING_PAYMENT(UNIT_ID,EHKP_FOR_PERIOD,EHKP_PAID_DATE,EHKP_AMOUNT,EHKP_COMMENTS,ULD_ID)values(UNITID,FOR_PERIOD,PAID_DATE,AMOUNT,COMMENTS,USERSTAMP_ID);
				SET HP_FLAG=1;
			END IF;
-- insert query for EXPENSE_HOUSEKEEPING_PAYMENT if passing unit_number is exists in EXPENSE_HOUSEKEEPING_UNIT table
			IF EXISTS(SELECT EHKU_ID FROM EXPENSE_HOUSEKEEPING_UNIT WHERE EHKU_UNIT_NO=UNIT_NUMBER)THEN
				SET HOUSEKEEPINGID=(SELECT EHKU_ID FROM EXPENSE_HOUSEKEEPING_UNIT WHERE EHKU_UNIT_NO=UNIT_NUMBER);
				INSERT INTO EXPENSE_HOUSEKEEPING_PAYMENT(EHKU_ID,EHKP_FOR_PERIOD,EHKP_PAID_DATE,EHKP_AMOUNT,EHKP_COMMENTS,ULD_ID)values(HOUSEKEEPINGID,FOR_PERIOD,PAID_DATE,AMOUNT,COMMENTS,USERSTAMP_ID);
				SET HP_FLAG=1;
			END IF;

			IF NOT EXISTS(SELECT UNIT_NO FROM UNIT WHERE UNIT_NO=UNIT_NUMBER) THEN
				IF NOT EXISTS(SELECT EHKU_UNIT_NO FROM EXPENSE_HOUSEKEEPING_UNIT WHERE EHKU_UNIT_NO=UNIT_NUMBER)THEN
					INSERT INTO EXPENSE_HOUSEKEEPING_UNIT (EHKU_UNIT_NO,ULD_ID) values (UNIT_NUMBER,USERSTAMP_ID);
					SET HP_FLAG=1;
					SET HOUSEKEEPINGID=(SELECT EHKU_ID FROM EXPENSE_HOUSEKEEPING_UNIT WHERE EHKU_UNIT_NO=UNIT_NUMBER);
					INSERT INTO EXPENSE_HOUSEKEEPING_PAYMENT(EHKU_ID,EHKP_FOR_PERIOD,EHKP_PAID_DATE,EHKP_AMOUNT,EHKP_COMMENTS,ULD_ID)values(HOUSEKEEPINGID,FOR_PERIOD,PAID_DATE,AMOUNT,COMMENTS,USERSTAMP_ID);
					SET HP_FLAG=1;
				END IF;
			END IF;
		END IF;
	COMMIT;
END;