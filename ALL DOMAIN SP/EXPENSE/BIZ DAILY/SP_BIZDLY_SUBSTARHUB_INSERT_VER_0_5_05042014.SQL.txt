--> VERSION:0.5 -->STARTDATE:05/04/2014 -->ENDDATE05/04/2014 -->ISSUE NO:535 -->COMMENT NO:#300-->DESC:CORRECTED UPDATE QUERY-->DONE BY SARADAMBAL
--> VERSION:0.4 -->STARTDATE:20/03/2014 -->ENDDATE20/03/2014 -->ISSUE NO:535 -->COMMENT NO:#280-->DESC:REPLACED ECN_DATA INTO ECN_ID IN PASSING PARAMETER,BUT SHOW ECN_DATA WHEN THE RECORD IS NOT SAVED-->DONE BY SARADAMBAL
--> VERSION:0.3 -->STARTDATE:17/03/2014 -->ENDDATE17/03/2014 -->ISSUE NO:762 -->COMMENT NO:#8 -->DESC:IMPLEMENTING THE UPDATE SUCCESS FLAG  -->DONEBY:BHAVANI.R
--> VERSION:0.2 -->STARTDATE:15/03/2014 -->ENDDATE15/03/2014 -->ISSUE NO:535 -->COMMENT NO:253 -->DESC:CHECKING MANDATORY FIELDS ARE NULL OR NOT NULL  -->DONEBY:BHAVANI.R
--> VERSION:0.1 -->STARTDATE:13/03/2014 -->ENDDATE14/03/2014 -->ISSUE NO:535 -->COMMENT NO:232 -->DESC:CREATION OF SP SP_SUB_EXPENSE_BIZDLY_STARHUB_INSERT FOR MULTIROW INSERTION  -->DONEBY:BHAVANI.R
DROP PROCEDURE IF EXISTS SP_BIZDLY_SUBSTARHUB_INSERT;
CREATE PROCEDURE SP_BIZDLY_SUBSTARHUB_INSERT(
IN UNIT_NUMBER TEXT,
IN ECN_ID_NEW TEXT,
IN INVOICE_DATE DATE,
IN FROM_PERIOD DATE,
IN TO_PERIOD DATE,
IN AMOUNT DECIMAL(7,2),
IN COMMENTS TEXT,
IN USERSTAMP VARCHAR(50),
OUT STARHUB_SUCCESSFLAG INTEGER,
OUT STARHUB_UPDATEFLAG INTEGER)
BEGIN
-- DECLARING VARIABLES
       DECLARE ECNID TEXT;
       DECLARE EDSHID TEXT;
       DECLARE USERSTAMP_ID INTEGER(2);
-- QUERY FOR ROLLBACK COMMAND
DECLARE EXIT HANDLER FOR SQLEXCEPTION
BEGIN 
ROLLBACK; 
SET STARHUB_SUCCESSFLAG=0;
SET STARHUB_UPDATEFLAG=0;
END;
-- QUERY FOR SET NULL FOR UNIT_NUMBER
	IF(UNIT_NUMBER='' OR UNIT_NUMBER IS NULL)THEN
		SET UNIT_NUMBER = NULL;
	END IF;
-- QUERY FOR SET NULL FOR ECN_ID_NEW
	IF(ECN_ID_NEW='' OR ECN_ID_NEW IS NULL OR ECN_ID_NEW='SELECT')THEN
		SET ECN_ID_NEW = NULL;
	END IF;
-- QUERY FOR SET NULL FOR INVOICE_DATE
	IF(INVOICE_DATE='' OR INVOICE_DATE IS NULL)THEN
		SET INVOICE_DATE = NULL;
	END IF;
-- QUERY FOR SET NULL FOR FROM_PERIOD
	IF(FROM_PERIOD='' OR FROM_PERIOD IS NULL)THEN
		SET FROM_PERIOD = NULL;
	END IF;
-- QUERY FOR SET NULL FOR UNIT_NUMBER	
	IF(TO_PERIOD='' OR TO_PERIOD IS NULL)THEN
		SET TO_PERIOD = NULL;
	END IF;
-- QUERY FOR SET NULL FOR AMOUNT	
	IF(AMOUNT='' OR AMOUNT IS NULL)THEN
		SET AMOUNT = NULL;
	END IF;
-- QUERY FOR SET NULL FOR COMMENTS	
	IF(COMMENTS='' OR COMMENTS IS NULL)THEN
		SET COMMENTS = NULL;
	END IF;
-- QUERY FOR SET NULL FOR USERSTAMP	
	IF(USERSTAMP='' OR USERSTAMP IS NULL)THEN
		SET USERSTAMP = NULL;
	END IF;
-- QUERY FOR START TRANSACTION
START TRANSACTION;
SET STARHUB_SUCCESSFLAG=0;
SET STARHUB_UPDATEFLAG=0;
-- SP FOR CHANGING USERSTAMP INTO ULD_ID
	CALL SP_CHANGE_USERSTAMP_AS_ULDID(USERSTAMP,@ULDID);
    SET USERSTAMP_ID = (SELECT @ULDID);
-- QUERY FOR GETTING ECN_ID AND EDSH_ID
	SET EDSHID = (SELECT MAX(EDSH_ID) FROM EXPENSE_DETAIL_STARHUB WHERE UNIT_ID = (SELECT UNIT_ID FROM UNIT WHERE UNIT_NO=UNIT_NUMBER));
	SET ECNID = (SELECT ECN_ID FROM EXPENSE_DETAIL_STARHUB WHERE EDSH_ID = EDSHID);
-- UPDATE QUERY FOR EXPENSE_DETAIL_STARHUB TABLE
        IF  ECNID IS NULL THEN
            UPDATE EXPENSE_DETAIL_STARHUB SET ECN_ID=ECN_ID_NEW , ULD_ID=USERSTAMP_ID WHERE EDSH_ID=EDSHID ;
            SET STARHUB_UPDATEFLAG=1;
        END IF;
-- INSERT QUERY FOR EXPENSE_STARHUB TABLE
		IF(UNIT_NUMBER IS NOT NULL AND ECN_ID_NEW IS NOT NULL AND INVOICE_DATE IS NOT NULL AND FROM_PERIOD IS NOT NULL AND TO_PERIOD IS NOT NULL AND USERSTAMP IS NOT NULL) THEN  
			INSERT INTO EXPENSE_STARHUB (EDSH_ID,ESH_INVOICE_DATE,ESH_FROM_PERIOD,ESH_TO_PERIOD,ESH_AMOUNT,ESH_COMMENTS,ULD_ID)VALUES (EDSHID,INVOICE_DATE,FROM_PERIOD,TO_PERIOD,AMOUNT,COMMENTS,USERSTAMP_ID);
			SET STARHUB_SUCCESSFLAG=1;
        END IF;
            
    COMMIT;
END;