--version 0.9 --sdate:15/07/2014 --edate:15/07/2014 --issueno:535 COMMENT:#316 --desc:CHANGES IN UPDATE SP FOR INCREMENTING THE NOOFTIMES HEADER  --done by BHAVANI.R
--version 0.8 --sdate:19/05/2014 --edate:19/05/2014 --issueno:807 COMMENT:#11 --desc:ADDED CONDITIONS FOR UPDATING COMMENTS  --done by DHIVYA
--version 0.7 --sdate:16/04/2014 --edate:17/04/2014 --issueno:807 --desc:added tickler part --done by RL
--version 0.6 --startdate:28/02/2014 --enddate:28/02/2014 --issueno:754 COMMENTNO:#22---->ADD DECLARE USERSTAMP VALUES--> BY BALAJI
--version 0.5 --startdate:27/02/2014 --enddate:27/02/2014 --issueno:754 commentno:#22 -->description:CHANGING OF DATATYPE AND COLUMN HEADER FOR USERSTAMP AS ULD_ID -->DONE BY:BHAVANI.R
--version 0.4 --startdate:18/02/2014 --enddate:18/02/2014 --issueno:749 commentno:#40 -->description:implement flag for success message  -->created by:ABDUL KADER.M
--version 0.3 --startdate:20/11/2013 --endate :20/11/2013 --desc:SP FOR EMPLOYEE DETAIL ( UPDATE FORM) --doneby:dinesh -->issueno:253 commentno:#111 -->desc:changed DATA TYPE (INTEGER (7)) FOR ACCESS_CARD 
--version 0.2 --startdate:20/11/2013 --endate :20/11/2013 --desc:SP FOR EMPLOYEE DETAIL ( UPDATE FORM) --doneby:dinesh  correct the error for REMOVE CARD in EMPLOYEE_CARD_DETAILS---ISSUE NO-535, COMMAND NUMBER-94
--version 0.1 --startdate:15/11/2013 --endate:19/11/2013 --desc:SP FOR EMPLOYEE DETAIL (UPDATE FORM) --doneby:dinesh--ISSUE NO-535, COMMAND NUMBER-94

DROP PROCEDURE IF EXISTS SP_EMPDTL_UPDATE;
CREATE PROCEDURE SP_EMPDTL_UPDATE(
 IN EMPID INTEGER,
 IN FIRST_NAME CHAR(30),
 IN LAST_NAME CHAR(30),
 IN DESIGNATION TEXT,
 IN MOBILE  VARCHAR(10),      
 IN EMAIL VARCHAR(40),
 IN COMMENTS TEXT,
 IN USERSTAMP VARCHAR(50),
 IN CARD_NO_REMOVE TEXT,
 IN ACCESS_CARD TEXT,
 OUT EMPDTL_FLAG INTEGER(10))
BEGIN
-- declaring variables
	DECLARE ACCESS_CARD_NO INTEGER(7);
	DECLARE ACCESS_CARD_NO_REMOVE INTEGER(7);
	
	DECLARE USERSTAMP_ID INTEGER(2);
	DECLARE ECDID INTEGER;
	DECLARE UASDID INTEGER;
	DECLARE ECNID INTEGER;
	
	DECLARE OLDFNAME CHAR(30);
	DECLARE OLDLNAME CHAR(30);
	DECLARE OLDECNID INTEGER;
	DECLARE OLDMOBILE  VARCHAR(10);      
	DECLARE OLDEMAIL VARCHAR(40);
	DECLARE OLDCOMMENTS TEXT;
	
	DECLARE EXIT HANDLER FOR SQLEXCEPTION
	BEGIN
		ROLLBACK;
		SET EMPDTL_FLAG=0;
	END;
	
	SET @TEMP_ACCESS_CARDNO = ACCESS_CARD;
	
	SET @TEMP_REMOVE_CARDNO = CARD_NO_REMOVE;
	
	START TRANSACTION;
	
	CALL SP_CHANGE_USERSTAMP_AS_ULDID(USERSTAMP,@ULDID);
	SET USERSTAMP_ID =(SELECT @ULDID);

-- set null for non mandatory fields
	IF CARD_NO_REMOVE = '' THEN
		SET CARD_NO_REMOVE=NULL;
	END IF;
	
	IF ACCESS_CARD = '' THEN
		SET ACCESS_CARD=NULL;
	END IF;
	
	IF COMMENTS = '' THEN
		SET COMMENTS=NULL;
	END IF;
	
	SET ECNID = (SELECT ECN_ID FROM EXPENSE_CONFIGURATION WHERE ECN_DATA=DESIGNATION AND CGN_ID=35);
	
	SET OLDFNAME = (SELECT EMP_FIRST_NAME FROM EMPLOYEE_DETAILS WHERE EMP_ID = EMPID);
	SET OLDLNAME  = (SELECT EMP_LAST_NAME FROM EMPLOYEE_DETAILS WHERE EMP_ID = EMPID);
	SET OLDECNID = (SELECT ECN_ID FROM EMPLOYEE_DETAILS WHERE EMP_ID = EMPID);
	SET OLDMOBILE  = (SELECT EMP_MOBILE FROM EMPLOYEE_DETAILS WHERE EMP_ID = EMPID); 
	SET OLDEMAIL  = (SELECT EMP_EMAIL FROM EMPLOYEE_DETAILS WHERE EMP_ID = EMPID);
	SET OLDCOMMENTS = (SELECT EMP_COMMENTS FROM EMPLOYEE_DETAILS WHERE EMP_ID = EMPID);
	IF OLDCOMMENTS IS NULL THEN
	SET OLDCOMMENTS='NULL';
	END IF;
	IF COMMENTS IS NULL THEN
	SET COMMENTS='NULL';
	END IF;
	
	IF (FIRST_NAME IS NOT NULL AND LAST_NAME IS NOT NULL AND DESIGNATION IS NOT NULL AND MOBILE IS NOT NULL AND USERSTAMP_ID IS NOT NULL ) THEN
-- UPDATE QUERY FOR EMPLOYEE_DETAILS table
		
		IF(CARD_NO_REMOVE IS NULL AND ACCESS_CARD IS NULL) THEN
			IF((OLDFNAME!=FIRST_NAME) OR (OLDLNAME!=LAST_NAME) OR (OLDECNID!=ECNID) OR (OLDMOBILE!=MOBILE) OR (OLDEMAIL!=EMAIL) OR (OLDCOMMENTS!=COMMENTS))THEN

				IF(COMMENTS='NULL')THEN
					SET COMMENTS=NULL;
				END IF;
				UPDATE EMPLOYEE_DETAILS SET EMP_FIRST_NAME=FIRST_NAME,EMP_LAST_NAME=LAST_NAME,ECN_ID=ECNID,EMP_MOBILE=MOBILE,EMP_EMAIL=EMAIL,EMP_COMMENTS=COMMENTS,ULD_ID=USERSTAMP_ID WHERE EMP_ID=EMPID ;
				SET EMPDTL_FLAG=1;
			END IF;
		END IF;
-- UPDATE AND INSERT QUERY FOR EMPLOYEE_DETAILS AND  EMPLOYEE_CARD_DETAILS table 
		
		IF ACCESS_CARD IS NOT NULL AND CARD_NO_REMOVE IS NULL THEN
			
			loop_label:  LOOP
				
				CALL SP_GET_SPECIAL_CHARACTER_SEPERATED_VALUES(',',@TEMP_ACCESS_CARDNO,@VALUE,@REMAINING_STRING);
				SELECT @VALUE INTO ACCESS_CARD_NO;
				SELECT @REMAINING_STRING INTO @TEMP_ACCESS_CARDNO;
				
				IF NOT EXISTS(SELECT UASD_ID FROM EMPLOYEE_CARD_DETAILS WHERE UASD_ID=(SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=ACCESS_CARD_NO))THEN
					
					INSERT INTO EMPLOYEE_CARD_DETAILS (EMP_ID,UASD_ID) VALUES (EMPID,( SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=ACCESS_CARD_NO));
					SET EMPDTL_FLAG=1;
           		
				END IF;
				
				IF @TEMP_ACCESS_CARDNO IS NULL THEN
					LEAVE  loop_label;
				END IF;
			
			END LOOP;
			
			IF((OLDFNAME!=FIRST_NAME) OR (OLDLNAME!=LAST_NAME) OR (OLDECNID!=ECNID) OR (OLDMOBILE!=MOBILE) OR (OLDEMAIL!=EMAIL) OR (OLDCOMMENTS!=COMMENTS))THEN
				IF(COMMENTS='NULL')THEN
					SET COMMENTS=NULL;
				END IF;
				UPDATE EMPLOYEE_DETAILS SET EMP_FIRST_NAME=FIRST_NAME,EMP_LAST_NAME=LAST_NAME,ECN_ID=ECNID,EMP_MOBILE=MOBILE,EMP_EMAIL=EMAIL,EMP_COMMENTS=COMMENTS,ULD_ID=USERSTAMP_ID WHERE EMP_ID=EMPID ;
				SET EMPDTL_FLAG=1;
				
			END IF;
		
		END IF;
-- INSERT AND UPDATE AND DELETE QUERY FOR EMPLOYEE_CARD_DETAILS AND EMPLOYEE_DETAILS TABLES WHILE
		IF CARD_NO_REMOVE IS NOT NULL AND ACCESS_CARD IS NULL THEN
			
			loop_label:  LOOP
				
				CALL SP_GET_SPECIAL_CHARACTER_SEPERATED_VALUES(',',@TEMP_REMOVE_CARDNO,@VALUE,@REMAINING_STRING);
				SELECT @VALUE INTO ACCESS_CARD_NO_REMOVE;
				SELECT @REMAINING_STRING INTO @TEMP_REMOVE_CARDNO;
				
				SET UASDID = (SELECT UASD_ID FROM EMPLOYEE_CARD_DETAILS WHERE UASD_ID=(SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=ACCESS_CARD_NO_REMOVE));
				
				IF (UASDID IS NOT NULL)THEN
				
					SET ECDID = (SELECT ECD_ID FROM EMPLOYEE_CARD_DETAILS WHERE UASD_ID = UASDID);
					
					CALL SP_SINGLE_TABLE_ROW_DELETION(40,ECDID,USERSTAMP,@FLAG);
					
					SET EMPDTL_FLAG=1;
				
				END IF; 

				IF @TEMP_REMOVE_CARDNO IS NULL THEN
					LEAVE  loop_label;
				END IF;
			
			END LOOP;	
			
			IF((OLDFNAME!=FIRST_NAME) OR (OLDLNAME!=LAST_NAME) OR (OLDECNID!=ECNID) OR (OLDMOBILE!=MOBILE) OR (OLDEMAIL!=EMAIL) OR (OLDCOMMENTS!=COMMENTS))THEN
				IF(COMMENTS='NULL')THEN
					SET COMMENTS=NULL;
				END IF;
				UPDATE EMPLOYEE_DETAILS SET EMP_FIRST_NAME=FIRST_NAME,EMP_LAST_NAME=LAST_NAME,ECN_ID=ECNID,EMP_MOBILE=MOBILE,EMP_EMAIL=EMAIL,EMP_COMMENTS=COMMENTS,ULD_ID=USERSTAMP_ID WHERE EMP_ID=EMPID ;
				SET EMPDTL_FLAG=1;
			
			END IF;
		
		END IF;	
		
		IF ACCESS_CARD IS NOT NULL AND CARD_NO_REMOVE IS NOT NULL THEN
			
			loop_label:  LOOP
				
				CALL SP_GET_SPECIAL_CHARACTER_SEPERATED_VALUES(',',@TEMP_ACCESS_CARDNO,@VALUE,@REMAINING_STRING);
				SELECT @VALUE INTO ACCESS_CARD_NO;
				SELECT @REMAINING_STRING INTO @TEMP_ACCESS_CARDNO;
				
				IF NOT EXISTS(SELECT UASD_ID FROM EMPLOYEE_CARD_DETAILS WHERE UASD_ID=(SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=ACCESS_CARD_NO))THEN
					
					INSERT INTO EMPLOYEE_CARD_DETAILS (EMP_ID,UASD_ID) VALUES ( EMPID,( SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=ACCESS_CARD_NO));
					SET EMPDTL_FLAG=1;
				
				END IF; 
				
				IF @TEMP_ACCESS_CARDNO IS NULL THEN
					LEAVE  loop_label;
				END IF;
			
			END LOOP;
		
			loop_label:  LOOP
				
				CALL SP_GET_SPECIAL_CHARACTER_SEPERATED_VALUES(',',@TEMP_REMOVE_CARDNO,@VALUE,@REMAINING_STRING);
				SELECT @VALUE INTO ACCESS_CARD_NO_REMOVE;
				SELECT @REMAINING_STRING INTO @TEMP_REMOVE_CARDNO;
				
				SET UASDID = (SELECT UASD_ID FROM EMPLOYEE_CARD_DETAILS WHERE UASD_ID=(SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=ACCESS_CARD_NO_REMOVE));
				
				IF (UASDID IS NOT NULL)THEN
				
					SET ECDID = (SELECT ECD_ID FROM EMPLOYEE_CARD_DETAILS WHERE UASD_ID = UASDID);
					
					CALL SP_SINGLE_TABLE_ROW_DELETION(40,ECDID,USERSTAMP,@FLAG);
					
					SET EMPDTL_FLAG=1;
				
				END IF; 	

				IF @TEMP_REMOVE_CARDNO IS NULL THEN
					LEAVE  loop_label;
				END IF;
				
				
			END LOOP;	
			
			IF((OLDFNAME!=FIRST_NAME) OR (OLDLNAME!=LAST_NAME) OR (OLDECNID!=ECNID) OR (OLDMOBILE!=MOBILE) OR (OLDEMAIL!=EMAIL) OR (OLDCOMMENTS!=COMMENTS))THEN
				IF(COMMENTS='NULL')THEN
					SET COMMENTS=NULL;
				END IF;
				UPDATE EMPLOYEE_DETAILS SET EMP_FIRST_NAME=FIRST_NAME,EMP_LAST_NAME=LAST_NAME,ECN_ID=ECNID,EMP_MOBILE=MOBILE,EMP_EMAIL=EMAIL,EMP_COMMENTS=COMMENTS,ULD_ID=USERSTAMP_ID WHERE EMP_ID=EMPID ;
				SET EMPDTL_FLAG=1;
				
			END IF;
		
		END IF;
		  CALL SP_EMPLOYEE_DETAILS_ULD_TS_MAXTIMES(EMPID,USERSTAMP_ID);

	END IF;							
COMMIT;
END;