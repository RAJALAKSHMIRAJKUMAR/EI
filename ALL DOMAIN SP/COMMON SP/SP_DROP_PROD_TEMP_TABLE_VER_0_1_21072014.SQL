-- version:0.1 --sdate:21/07/2014 --edate:22/07/2014 --issue:830  --desc: drop the prod temp table --doneby:RL

DROP PROCEDURE IF EXISTS SP_DROP_PROD_TEMP_TABLE;
CREATE PROCEDURE SP_DROP_PROD_TEMP_TABLE(
IN USER_STAMP VARCHAR(50),
OUT FINALTABLE TEXT)
BEGIN
	DECLARE SYS_DATE_TIME DATETIME;
	DECLARE CONFIG_NO_OF_DAYS INTEGER;
	DECLARE SYS_DATE DATE;
	DECLARE CONFIG_SYS_DATE DATE;
	
	DECLARE USERSTAMP_ID INTEGER;
	DECLARE SYSDATEANDTIME VARCHAR(50);
	DECLARE SYSDATEANDULDID VARCHAR(50);
	
	DECLARE MINID INTEGER;
	DECLARE MAXID INTEGER;
	DECLARE DROP_TABLE_NAME TEXT;

	DECLARE EXIT HANDLER FOR SQLEXCEPTION
	BEGIN 
		ROLLBACK;
	END;
	START TRANSACTION;
	
	CALL SP_CHANGE_USERSTAMP_AS_ULDID(USER_STAMP,@ULDID);
	SET USERSTAMP_ID=(SELECT @ULDID);
	
	SET SYSDATEANDTIME=(SELECT SYSDATE());
	SET SYSDATEANDTIME=(SELECT REPLACE(SYSDATEANDTIME,' ',''));
	SET SYSDATEANDTIME=(SELECT REPLACE(SYSDATEANDTIME,'-',''));
	SET SYSDATEANDTIME=(SELECT REPLACE(SYSDATEANDTIME,':',''));
	SET SYSDATEANDULDID=(SELECT CONCAT(SYSDATEANDTIME,'_',USERSTAMP_ID));
	
	SET SYS_DATE_TIME = (SELECT SYSDATE());
	SET CONFIG_NO_OF_DAYS = (SELECT TC_DATA FROM TRIGGER_CONFIGURATION WHERE CGN_ID = 85);
	SET SYS_DATE = (SELECT DATE(SYS_DATE_TIME));
	SET CONFIG_SYS_DATE = (SELECT DATE_SUB(SYS_DATE,INTERVAL (SELECT CONFIG_NO_OF_DAYS) DAY));
	SET @FINALDATE = (SELECT REPLACE(CONFIG_SYS_DATE,'-',''));
	SET @FINAL_DATE = (SELECT CONCAT('%',@FINALDATE,'%'));
	
	SET FINALTABLE = (SELECT CONCAT('TEMP_DROPPPED_PROD_TABLES','_',SYSDATEANDULDID));
		
	SET @FINALTABLE_CREATEQUERY = (SELECT CONCAT('CREATE TABLE ',FINALTABLE,'(
	ID INTEGER AUTO_INCREMENT,
	TABLENAME TEXT,
	PRIMARY KEY(ID))'));
	PREPARE FINALTABLE_CREATEQUERY_STMT FROM @FINALTABLE_CREATEQUERY;
	EXECUTE FINALTABLE_CREATEQUERY_STMT;
	
	SET @FINALTABLE_INSERTQUERY = (SELECT CONCAT('INSERT INTO ',FINALTABLE,'(TABLENAME)
	(SELECT TABLE_NAME FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME LIKE @FINAL_DATE)'));
	PREPARE FINALTABLE_INSERTQUERY_STMT FROM @FINALTABLE_INSERTQUERY;
	EXECUTE FINALTABLE_INSERTQUERY_STMT;
	
	SET @MINIMUMID = (SELECT CONCAT('SELECT MIN(ID) INTO @MIN_ID FROM ',FINALTABLE,''));
	PREPARE MINIMUMID_STMT FROM @MINIMUMID;
	EXECUTE MINIMUMID_STMT;
	
	SET @MAXIMUMID = (SELECT CONCAT('SELECT MAX(ID) INTO @MAX_ID FROM ',FINALTABLE,''));
	PREPARE MAXIMUMID_STMT FROM @MAXIMUMID;
	EXECUTE MAXIMUMID_STMT;
	
	SET MINID = @MIN_ID;
	SET MAXID = @MAX_ID;
	
	WHILE(MINID <= MAXID) DO
	
		SET @DROPTABLE_NAME = (SELECT CONCAT('SELECT TABLENAME INTO @DROPTABLENAME FROM ',FINALTABLE,' WHERE ID = ',MINID,''));
		PREPARE DROPTABLE_NAME_STMT FROM @DROPTABLE_NAME;
		EXECUTE DROPTABLE_NAME_STMT;
	
		SET DROP_TABLE_NAME = @DROPTABLENAME;
	
		SET @DROPQUERY = (SELECT CONCAT('DROP TABLE IF EXISTS ',DROP_TABLE_NAME,''));
		PREPARE DROPQUERY_STMT FROM @DROPQUERY;
		EXECUTE DROPQUERY_STMT;
		
		SET MINID = MINID+1;
		
	END WHILE;
	
COMMIT;
END;