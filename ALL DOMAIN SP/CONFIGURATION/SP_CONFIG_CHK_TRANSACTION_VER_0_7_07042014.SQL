--VER 0.7 STARTDATE:07/04/2014 ENDDATE:07/04/2014 ISSUENO:797 DESC:Changed post_audit_profile As TICKLER_TABID_PROFILE DONE BY:LALITHA
--version 0.6 --sdate:18/03/2014 --edate:18/03/2014 --issue:768  DESC:REMOVED SP_CONFIG_DELETION SP--doneby:DHIVYA	
--version 0.5 --sdate:06/03/2014 --edate:06/03/2014 --issue:754 --comment:22 DESC:changed variable name in single table row deletion sp--doneby:DHIVYA	
--version 0.4 --sdate:28/02/2014 --edate:28/02/2014 --issue:754 --comment:22 --doneby:RL	
--version 0.3 --sdate:27/02/2014 --edate:27/02/2014 --issue:754 --comment:22 --doneby:RL	
--version:0.2 --ISSUE NO:529 COMMENT NO:#118 sd:15/02/2014 --enddate:15/02/2014 --desc:ADDED CONDITION IN TRANSACTION CHECKING SP WHETHER THE INITIALIZE FLAG IS NULL  DONE BY:DHIVYA.A
--version:0.1 --ISSUE NO:529 COMMENT NO:#112 sd:12/02/2014 --enddate:13/02/2014 --desc:SP FOR CONFIGURATION TICKLER DELETION  DONE BY:DHIVYA.A


DROP PROCEDURE IF EXISTS SP_CONFIG_CHECK_TRANSACTION;
CREATE PROCEDURE SP_CONFIG_CHECK_TRANSACTION
(
IN TABLEID INTEGER,
IN ROW_ID INTEGER,
OUT FLAG INTEGER)

BEGIN
DECLARE INITFLAG VARCHAR(50);
DECLARE TABLENAME VARCHAR(70);
DECLARE ID VARCHAR(50);
DECLARE EXIT HANDLER FOR SQLEXCEPTION
BEGIN
ROLLBACK; 
END;
START TRANSACTION;

SET FLAG=0;

--NATIONALITY_CONFIGURATION
IF TABLEID=34  THEN
	IF NOT EXISTS(SELECT * FROM NATIONALITY_CONFIGURATION WHERE NC_INITIALIZE_FLAG IS NOT NULL AND NC_ID=ROW_ID)THEN
		IF NOT EXISTS(SELECT NC_ID FROM CUSTOMER_PERSONAL_DETAILS WHERE NC_ID=ROW_ID)THEN
			IF NOT EXISTS(SELECT NC_ID FROM ERM_ENTRY_DETAILS WHERE NC_ID=ROW_ID)THEN
				SET FLAG=1;
			END IF;
		END IF;
	END IF;
END IF;

--ACCESS_CONFIGURATION
IF TABLEID=28 THEN
	IF NOT EXISTS(SELECT * FROM ACCESS_CONFIGURATION WHERE ACN_INITIALIZE_FLAG IS NOT NULL AND ACN_ID=ROW_ID)THEN
		IF NOT EXISTS(SELECT ACN_ID FROM CUSTOMER_ACCESS_CARD_DETAILS WHERE ACN_ID=ROW_ID)THEN
			SET FLAG=1;
		END IF;
	END IF;
END IF;

--EXPENSE_CONFIGURATION
IF TABLEID=30 THEN
IF NOT EXISTS(SELECT * FROM EXPENSE_CONFIGURATION WHERE ECN_INITIALIZE_FLAG IS NOT NULL AND ECN_ID=ROW_ID)THEN
	IF NOT EXISTS(SELECT ECN_ID FROM EXPENSE_DETAIL_ELECTRICITY WHERE ECN_ID=ROW_ID)THEN
		IF NOT EXISTS(SELECT ECN_ID FROM EXPENSE_DETAIL_DIGITAL_VOICE WHERE ECN_ID=ROW_ID)THEN
			IF NOT EXISTS(SELECT ECN_ID FROM EXPENSE_UNIT WHERE ECN_ID=ROW_ID)THEN
				IF NOT EXISTS(SELECT ECN_ID FROM EXPENSE_ELECTRICITY WHERE ECN_ID=ROW_ID)THEN
					IF NOT EXISTS(SELECT ECN_ID FROM EXPENSE_PERSONAL WHERE ECN_ID=ROW_ID)THEN
						IF NOT EXISTS(SELECT ECN_ID FROM EXPENSE_CAR WHERE ECN_ID=ROW_ID)THEN
							IF NOT EXISTS(SELECT ECN_ID FROM EXPENSE_BABY WHERE ECN_ID=ROW_ID)THEN
								IF NOT EXISTS(SELECT ECN_ID FROM EXPENSE_STAFF WHERE ECN_ID=ROW_ID)THEN
									IF NOT EXISTS(SELECT ECN_ID FROM EXPENSE_DETAIL_STARHUB WHERE ECN_ID=ROW_ID)THEN
										IF NOT EXISTS(SELECT ECN_ID FROM EMPLOYEE_DETAILS WHERE ECN_ID=ROW_ID)THEN
											SET FLAG=1;
										END IF;
									END IF;
								END IF;
							END IF;
						END IF;
					END IF;
				END IF;
			END IF;
		END IF;
	END IF;
END IF;
END IF;

--USER_RIGHTS_CONFIGURATION
IF TABLEID=35 THEN
IF NOT EXISTS(SELECT * FROM USER_RIGHTS_CONFIGURATION WHERE URC_INITIALIZE_FLAG IS NOT NULL AND URC_ID=ROW_ID)THEN
	IF NOT EXISTS(SELECT URC_ID FROM ROLE_CREATION WHERE URC_ID=ROW_ID)THEN
		IF NOT EXISTS(SELECT URC_ID FROM BASIC_ROLE_PROFILE WHERE URC_ID=ROW_ID)THEN
			IF NOT EXISTS(SELECT URC_ID FROM BASIC_MENU_PROFILE WHERE URC_ID=ROW_ID)THEN
				SET FLAG=1;
			END IF;
		END IF;
	END IF;
END IF;
END IF;

--TRIGGER_CONFIGURATION
IF TABLEID=33 THEN
	IF NOT EXISTS(SELECT * FROM TRIGGER_CONFIGURATION WHERE TC_INITIALIZE_FLAG IS NOT NULL AND TC_ID=ROW_ID)THEN
		IF NOT EXISTS(SELECT TC_ID FROM TRIGGER_EXECUTION_DETAILS WHERE TC_ID=ROW_ID)THEN
			SET FLAG=1;
		END IF;
	END IF;
END IF;

--BANKTT_CONFIGURATION
IF TABLEID=37 THEN
	IF NOT EXISTS(SELECT * FROM BANKTT_CONFIGURATION WHERE BCN_INITIALIZE_FLAG IS NOT NULL AND BCN_ID=ROW_ID)THEN
		IF NOT EXISTS(SELECT BCN_ID FROM BANK_TRANSFER_STATUS_DETAILS WHERE BCN_ID=ROW_ID)THEN
			IF NOT EXISTS(SELECT BCN_ID FROM CHEQUE_ENTRY_DETAILS WHERE BCN_ID=ROW_ID)THEN
				SET FLAG=1;
			END IF;
		END IF;
	END IF;
END IF;

IF ((TABLEID=25) OR (TABLEID=26) OR (TABLEID=27) OR (TABLEID=29) OR (TABLEID=31) OR (TABLEID=32) OR (TABLEID=36) OR (TABLEID=38) OR (TABLEID=89)) THEN
SET @TABLENAME=(SELECT TRIM(TTIP_DATA)FROM TICKLER_TABID_PROFILE WHERE TTIP_ID = TABLEID);
SET TABLENAME=@TABLENAME;
SET @INITIALIZEFLAG = (SELECT DISTINCT(COLUMN_NAME) FROM  INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME=TABLENAME AND COLUMN_NAME LIKE '%INITIALIZE_FLAG');
SET INITFLAG=@INITIALIZEFLAG;
SET @ID=(SELECT DISTINCT(COLUMN_NAME) FROM  INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME=TABLENAME AND COLUMN_NAME LIKE '%ID' AND COLUMN_NAME!='CGN_ID' AND COLUMN_NAME!='ULD_ID');
SET ID=@ID;
SET @RESULTSET= CONCAT('SELECT ', INITFLAG ,' INTO @V_VALUE FROM ', TABLENAME,' WHERE ', ID,' = ',ROW_ID);
PREPARE STMT FROM @RESULTSET;
EXECUTE STMT;
IF @V_VALUE IS NULL OR @V_VALUE=' ' THEN
SET FLAG=1;
END IF;
END IF;
COMMIT;
END;
			
		

