-- version:0.9 -- sadte:09/06/2014 -- edate:09/06/2014  -- issue:566 COMMENT:12  --desc: IMPLEMENTED ROLLBACK AND COMMIT --doneby:DHIVYA
--  version:0.8 --  sdate:26/03/2014 --  edate:26/03/2014 --  issue:765 -- desc:dynamically get source nd destination schema -- doneby:RL
--  version:0.7 --  sdate:17/03/2014 --  edate:17/03/2014 --  issue:765 -- desc:droped temp table -- doneby:RL
-- version:0.6 -- sdate:04/03/2014 -- edate:04/03/2014 -- Desc:ISSUE CORRECTED INUNIT EXPENSE- DONE BY SAFI
-- version:0.5 -- sdate:28/02/2014 -- edate:28/02/2014 -- issue:750 -- desc:changed userstamp as ULD_ID and timestamp get from scdb done by:RL
-- version:0.4-- sdate:21/02/2014 -- edate:22/02/2014 -- issue:750 -desc:added preaudit and post audit queries done by:dhivya
-- version:0.3 -- sdate:18/02/2014 -- edate:18/02/2014 -- issue:276 -- commentno:26 -- desc:ADD USERSTAMP N TIMESTAMP IN EXPENSE_HOUSEKEEPING_UNIT -- doneby:RL
-- version:0.2 -- sdate:21/01/2014 -- edate:21/01/2014 -- issue:594 -- commentno:50 & 54 -- doneby:RL

DROP PROCEDURE IF EXISTS SP_EXPENSE_UNIT_INSERT;
CREATE PROCEDURE SP_EXPENSE_UNIT_INSERT(IN DESTINATIONSCHEMA VARCHAR(50))
BEGIN
	DECLARE EXIT HANDLER FOR SQLEXCEPTION
	BEGIN
	ROLLBACK;
	END;
	START TRANSACTION;
	SET FOREIGN_KEY_CHECKS=0;
	SET @EXPUNIT_DROPQUERY=(SELECT CONCAT('DROP TABLE IF EXISTS ',DESTINATIONSCHEMA,'.EXPENSE_UNIT'));
	PREPARE EXPUNIT_DROPQUERYSTMT FROM @EXPUNIT_DROPQUERY;
	EXECUTE EXPUNIT_DROPQUERYSTMT;	
	SET @EXPUNIT_CREATEQUERY = (SELECT CONCAT('CREATE TABLE ',DESTINATIONSCHEMA,'.EXPENSE_UNIT(
	EU_ID INTEGER NOT NULL AUTO_INCREMENT,
	UNIT_ID	INTEGER NOT NULL,
	ECN_ID INTEGER NOT NULL,
	CUSTOMER_ID	INTEGER NULL,
	EU_INVOICE_DATE	DATE NOT NULL,	
	EU_AMOUNT	DECIMAL(7,2) NOT NULL,	
	EU_INVOICE_ITEMS TEXT NOT NULL,	
	EU_INVOICE_FROM	VARCHAR(200) NOT NULL,	
	EU_COMMENTS	TEXT NULL,	
	ULD_ID INTEGER(2) NOT NULL,	
	EU_TIMESTAMP TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
	PRIMARY KEY(EU_ID),
	FOREIGN KEY(UNIT_ID) REFERENCES ',DESTINATIONSCHEMA,'.UNIT (UNIT_ID),
	FOREIGN KEY(ECN_ID) REFERENCES ',DESTINATIONSCHEMA,'.EXPENSE_CONFIGURATION (ECN_ID),
	FOREIGN KEY(ULD_ID) REFERENCES ',DESTINATIONSCHEMA,'.USER_LOGIN_DETAILS (ULD_ID))'));
	PREPARE EXPUNIT_CREATEQUERYSTMT FROM @EXPUNIT_CREATEQUERY;
	EXECUTE EXPUNIT_CREATEQUERYSTMT;	
	SET @EXPUNIT_INSERTQUERY = (SELECT CONCAT('INSERT INTO ',DESTINATIONSCHEMA,'.EXPENSE_UNIT(
	UNIT_ID, CUSTOMER_ID,ECN_ID, EU_INVOICE_DATE, EU_AMOUNT, EU_INVOICE_ITEMS, EU_INVOICE_FROM, EU_COMMENTS, ULD_ID,EU_TIMESTAMP)
	SELECT UNIT_NUMBERID,CUSTOMERID,ECNID,INVOICEDATE,AMOUNT,INVOICEITEMS,INVOICEFROM,COMMENTS,USERSTAMPID,TIME_STAMP
	FROM ',DESTINATIONSCHEMA,'.TEMP_EXPENSE_UNIT'));
	PREPARE EXPUNIT_INSERTQUERYSTMT FROM @EXPUNIT_INSERTQUERY;
	EXECUTE EXPUNIT_INSERTQUERYSTMT;
	SET FOREIGN_KEY_CHECKS=1;
	COMMIT;
END;
