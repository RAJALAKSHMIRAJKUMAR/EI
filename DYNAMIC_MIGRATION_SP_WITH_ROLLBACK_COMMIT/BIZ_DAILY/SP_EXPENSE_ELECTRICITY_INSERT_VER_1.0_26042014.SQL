-- version:1.1 -- sadte:09/06/2014 -- edate:09/06/2014  -- issue:566 COMMENT:12  --desc: IMPLEMENTED ROLLBACK AND COMMIT --doneby:DHIVYA
--  version:1.0 --  sdate:26/04/2014 --  edate:26/04/2014 --  issue:765 -- desc:REMOVE UPDATE TIMESTAMP FOR TEMP_EXPENSE_ELECTRICITY -- doneby:BHAVANI.R
--  version:0.9 --  sdate:23/04/2014 --  edate:23/04/2014 --  issue:765 -- desc:UPDATED TIMESTAMP -- doneby:SASIKALA
--  version:0.8 --  sdate:25/03/2014 --  edate:25/03/2014 --  issue:765 -- desc:dynamically get source nd destination schema -- doneby:RL
--  version:0.7 --  sdate:17/03/2014 --  edate:17/03/2014 --  issue:765 -- desc:droped temp table -- doneby:RL
-- version:0.6 -- sdate:04/03/2014 -- edate:04/03/2014 -- Desc:ISSUE CORRECTED INUNIT EXPENSE- DONE BY SAFI
-- version:0.5 -- sdate:28/02/2014 -- edate:28/02/2014 -- issue:750 -- desc:changed userstamp as ULD_ID and timestamp get from scdb done by:RL
-- version:0.4-- sdate:21/02/2014 -- edate:22/02/2014 -- issue:750 -desc:added preaudit and post audit queries done by:dhivya
-- version:0.3 -- sdate:18/02/2014 -- edate:18/02/2014 -- issue:276 -- commentno:26 -- desc:ADD USERSTAMP N TIMESTAMP IN EXPENSE_HOUSEKEEPING_UNIT -- doneby:RL
-- version:0.2 -- sdate:21/01/2014 -- edate:21/01/2014 -- issue:594 -- commentno:50 & 54 -- doneby:RL
DROP PROCEDURE IF EXISTS SP_EXPENSE_ELECTRICITY_INSERT;
CREATE PROCEDURE SP_EXPENSE_ELECTRICITY_INSERT(IN SOURCESCHEMA VARCHAR(50),IN DESTINATIONSCHEMA VARCHAR(50),IN MIGUSERSTAMP VARCHAR(50))
BEGIN
	DECLARE MINIMUMID INTEGER;
	DECLARE MAXIMUMID INTEGER;
	DECLARE EE_DEPOSITREFUND TEXT;
	DECLARE EE_DEPOSIT TEXT;
	DECLARE EE_INVOICEAMOUNT TEXT;
	DECLARE START_TIME TIME;
	DECLARE END_TIME TIME;
	DECLARE DURATION TIME;	
	DECLARE EXIT HANDLER FOR SQLEXCEPTION
	BEGIN
	ROLLBACK;
	END;
	START TRANSACTION;
	SET @LOGIN_ID=(SELECT CONCAT('SELECT ULD_ID INTO @INPUTUSERID FROM ',DESTINATIONSCHEMA,'.USER_LOGIN_DETAILS WHERE ULD_LOGINID=','"',MIGUSERSTAMP,'"'));
	PREPARE LOGINID FROM @LOGIN_ID;
	EXECUTE LOGINID;	
	SET START_TIME=(SELECT CURTIME());
	SET @TEMP_EXPELECTRICITY_DROPQUERY=(SELECT CONCAT('DROP TABLE IF EXISTS ',DESTINATIONSCHEMA,'.TEMP_EXPENSE_ELECTRICITY'));
	PREPARE TEMP_EXPELECTRICITY_DROPQUERYSTMT FROM @TEMP_EXPELECTRICITY_DROPQUERY;
	EXECUTE TEMP_EXPELECTRICITY_DROPQUERYSTMT;	
	SET @TEMP_EXPELECTRICITY_CREATEQUERY=(SELECT CONCAT('CREATE TABLE ',DESTINATIONSCHEMA,'.TEMP_EXPENSE_ELECTRICITY(
	ID INTEGER AUTO_INCREMENT,
	UNITNO SMALLINT(4),
	UNITNUMBERID INTEGER,
	INVOICETO TEXT,
	EDEID INTEGER,
	INVOICEDATE DATE,
	FROMPERIOD DATE,
	TOPERIOD DATE,
	DEPOSIT TEXT,
	DEPOSITREFUND TEXT,
	AMOUNT DECIMAL(7,2),
	FINALAMOUNT DECIMAL(7,2),
	ECNID INTEGER,
	COMMENTS TEXT,
	USER_STAMP VARCHAR(50),
	USERSTAMPID INTEGER,
	TIME_STAMP VARCHAR(50),
	PRIMARY KEY(ID))'));
	PREPARE TEMP_EXPELECTRICITY_CREATEQUERYSTMT FROM @TEMP_EXPELECTRICITY_CREATEQUERY;
	EXECUTE TEMP_EXPELECTRICITY_CREATEQUERYSTMT;	
	SET @TEMP_EXPELECTRICITY_INSERTQUERY = (SELECT CONCAT('INSERT INTO ',DESTINATIONSCHEMA,'.TEMP_EXPENSE_ELECTRICITY(
	UNITNO,INVOICETO,INVOICEDATE,FROMPERIOD,TOPERIOD,DEPOSIT,AMOUNT,DEPOSITREFUND,COMMENTS,USER_STAMP,TIME_STAMP)
	SELECT EXP_UNIT_NO,EXP_ELC_INVOICE_TO,EXP_ELC_INVOICE_DATE,EXP_ELC_FROM_PERIOD,EXP_ELC_TO_PERIOD,EXP_ELC_DEPOSIT,
	EXP_ELC_AMOUNT,EXP_ELC_DEPOSIT_REFUND,EXP_ELC_COMMENTS,USERSTAMP,TIMESTAMP FROM ',SOURCESCHEMA,'.BIZ_DAILY_SCDB_FORMAT WHERE EXP_TYPE_OF_EXPENSE="ELECTRICITY"'));
	PREPARE TEMP_EXPELECTRICITY_INSERTQUERYSTMT FROM @TEMP_EXPELECTRICITY_INSERTQUERY;
	EXECUTE TEMP_EXPELECTRICITY_INSERTQUERYSTMT;	
	SET @MINID =(SELECT CONCAT('SELECT MIN(ID)INTO @MIN_ID FROM ',DESTINATIONSCHEMA,'.TEMP_EXPENSE_ELECTRICITY'));
	PREPARE MINIDSTMT FROM @MINID;
	EXECUTE MINIDSTMT;	
	SET MINIMUMID = @MIN_ID;	
	SET @MAXID =(SELECT CONCAT('SELECT MAX(ID)INTO @MAX_ID FROM ',DESTINATIONSCHEMA,'.TEMP_EXPENSE_ELECTRICITY'));
	PREPARE MAXIDSTMT FROM @MAXID;
	EXECUTE MAXIDSTMT;	
	SET MAXIMUMID = @MAX_ID;	
	WHILE(MINIMUMID <= MAXIMUMID) DO	
		SET @EEDEPOSITAMT = NULL;
		SET @EEDEPOSITREFUNDAMT = NULL;
		SET @FINALINVOICEAMOUNT = NULL;
		SET @ULDID = NULL;
		SET @UNITID = NULL;
		SET @INVOICEID = NULL;
		SET @MAXIMUM_EDEID = NULL;	
		SET @EEDEPOSIT = (SELECT CONCAT('SELECT DEPOSIT INTO @EEDEPOSITAMT FROM ',DESTINATIONSCHEMA,'.TEMP_EXPENSE_ELECTRICITY
		WHERE ID=',MINIMUMID));
		PREPARE EEDEPOSITSTMT FROM @EEDEPOSIT;
		EXECUTE EEDEPOSITSTMT;
		SET EE_DEPOSIT = @EEDEPOSITAMT;		
		SET @EEDEPOSITREFUND = (SELECT CONCAT('SELECT DEPOSITREFUND INTO @EEDEPOSITREFUNDAMT FROM ',DESTINATIONSCHEMA,'.TEMP_EXPENSE_ELECTRICITY
		WHERE ID=',MINIMUMID));
		PREPARE EEDEPOSITREFUNDSTMT FROM @EEDEPOSITREFUND;
		EXECUTE EEDEPOSITREFUNDSTMT;
		SET EE_DEPOSITREFUND = @EEDEPOSITREFUNDAMT;		
		SET @EEINVOICEAMT = (SELECT CONCAT('SELECT AMOUNT INTO @FINALINVOICEAMOUNT FROM ',DESTINATIONSCHEMA,'.TEMP_EXPENSE_ELECTRICITY
		WHERE ID=',MINIMUMID));
		PREPARE EEINVOICEAMTSTMT FROM @EEINVOICEAMT;
		EXECUTE EEINVOICEAMTSTMT;
		SET EE_INVOICEAMOUNT = @FINALINVOICEAMOUNT;		
		IF(EE_DEPOSIT IS NOT NULL) THEN		
			SET @UPDATEDEPOSITECNID = (SELECT CONCAT('UPDATE ',DESTINATIONSCHEMA,'.TEMP_EXPENSE_ELECTRICITY SET ECNID=135 WHERE ID=',MINIMUMID));
			PREPARE UPDATEDEPOSITECNIDSTMT FROM @UPDATEDEPOSITECNID;
			EXECUTE UPDATEDEPOSITECNIDSTMT;			
			SET @UPDATEDEPOSITAMT = (SELECT CONCAT('UPDATE ',DESTINATIONSCHEMA,'.TEMP_EXPENSE_ELECTRICITY SET FINALAMOUNT=@EEDEPOSITAMT WHERE ID=',MINIMUMID));
			PREPARE UPDATEDEPOSITAMTSTMT FROM @UPDATEDEPOSITAMT;
			EXECUTE UPDATEDEPOSITAMTSTMT;			
		END IF;		
		IF(EE_DEPOSITREFUND IS NOT NULL) THEN		
			SET @UPDATEDEPOSITREFUNDECNID = (SELECT CONCAT('UPDATE ',DESTINATIONSCHEMA,'.TEMP_EXPENSE_ELECTRICITY SET ECNID=134 WHERE ID=',MINIMUMID));
			PREPARE UPDATEDEPOSITREFUNDECNIDSTMT FROM @UPDATEDEPOSITREFUNDECNID;
			EXECUTE UPDATEDEPOSITREFUNDECNIDSTMT;			
			SET @UPDATEDEPOSITREFUNDAMT = (SELECT CONCAT('UPDATE ',DESTINATIONSCHEMA,'.TEMP_EXPENSE_ELECTRICITY SET FINALAMOUNT=@EEDEPOSITREFUNDAMT WHERE ID=',MINIMUMID));
			PREPARE UPDATEDEPOSITREFUNDAMTSTMT FROM @UPDATEDEPOSITREFUNDAMT;
			EXECUTE UPDATEDEPOSITREFUNDAMTSTMT;			
		END IF;		
		IF(EE_INVOICEAMOUNT IS NOT NULL) THEN		
			SET @UPDATEINVOICEAMOUNTECNID = (SELECT CONCAT('UPDATE ',DESTINATIONSCHEMA,'.TEMP_EXPENSE_ELECTRICITY SET ECNID=133 WHERE ID=',MINIMUMID));
			PREPARE UPDATEINVOICEAMOUNTECNIDSTMT FROM @UPDATEINVOICEAMOUNTECNID;
			EXECUTE UPDATEINVOICEAMOUNTECNIDSTMT;			
			SET @UPDATEINVOICEAMOUNT = (SELECT CONCAT('UPDATE ',DESTINATIONSCHEMA,'.TEMP_EXPENSE_ELECTRICITY SET FINALAMOUNT=@FINALINVOICEAMOUNT WHERE ID=',MINIMUMID));
			PREPARE UPDATEINVOICEAMOUNTSTMT FROM @UPDATEINVOICEAMOUNT;
			EXECUTE UPDATEINVOICEAMOUNTSTMT;			
		END IF;		
		SET @USERID =(SELECT CONCAT('SELECT ULD_ID INTO @ULDID FROM ',DESTINATIONSCHEMA,'.USER_LOGIN_DETAILS WHERE ULD_LOGINID=
		(SELECT USER_STAMP FROM ',DESTINATIONSCHEMA,'.TEMP_EXPENSE_ELECTRICITY WHERE ID=',MINIMUMID,')'));
		PREPARE USERIDSTMT FROM @USERID;
		EXECUTE USERIDSTMT;		
		SET@UNITNOID = (SELECT CONCAT('SELECT UNIT_ID INTO @UNITID FROM ',DESTINATIONSCHEMA,'.UNIT WHERE UNIT_NO=
		(SELECT UNITNO FROM ',DESTINATIONSCHEMA,'.TEMP_EXPENSE_ELECTRICITY WHERE ID=',MINIMUMID,')'));
		PREPARE UNITNOIDSTMT FROM @UNITNOID;
		EXECUTE UNITNOIDSTMT;		
		SET @INVOICE_TO =(SELECT CONCAT('SELECT ECN_ID INTO @INVOICEID FROM ',DESTINATIONSCHEMA,'.EXPENSE_CONFIGURATION WHERE ECN_DATA=
		(SELECT INVOICETO FROM ',DESTINATIONSCHEMA,'.TEMP_EXPENSE_ELECTRICITY WHERE ID=',MINIMUMID,') AND CGN_ID=27'));
		PREPARE INVOICETOSTMT FROM @INVOICE_TO;
		EXECUTE INVOICETOSTMT;		
		SET @MAXEDEID = (SELECT CONCAT('SELECT MAX(EDE_ID) INTO @MAXIMUM_EDEID FROM ',DESTINATIONSCHEMA,'.EXPENSE_DETAIL_ELECTRICITY
		WHERE UNIT_ID=@UNITID AND ECN_ID=@INVOICEID'));
		PREPARE MAXEDEIDSTMT FROM @MAXEDEID;
		EXECUTE MAXEDEIDSTMT;		
		SET @UPDATEEDEID = (SELECT CONCAT('UPDATE ',DESTINATIONSCHEMA,'.TEMP_EXPENSE_ELECTRICITY SET EDEID=@MAXIMUM_EDEID WHERE ID=',MINIMUMID));
		PREPARE UPDATEEDEIDSTMT FROM @UPDATEEDEID;
		EXECUTE UPDATEEDEIDSTMT;		
		SET @UPDATEULDID = (SELECT CONCAT('UPDATE ',DESTINATIONSCHEMA,'.TEMP_EXPENSE_ELECTRICITY SET USERSTAMPID=@ULDID WHERE ID=',MINIMUMID));
		PREPARE UPDATEULDIDSTMT FROM @UPDATEULDID;
		EXECUTE UPDATEULDIDSTMT;		
		SET @UPDATEUNITID = (SELECT CONCAT('UPDATE ',DESTINATIONSCHEMA,'.TEMP_EXPENSE_ELECTRICITY SET UNITNUMBERID=@UNITID WHERE ID=',MINIMUMID));
		PREPARE UPDATEUNITIDSTMT FROM @UPDATEUNITID;
		EXECUTE UPDATEUNITIDSTMT;		
	SET MINIMUMID = MINIMUMID+1;	
	END WHILE;	
	SET FOREIGN_KEY_CHECKS=0;	
	SET @EXPENSE_ELECTRICITYDROPQUERY=(SELECT CONCAT('DROP TABLE IF EXISTS ',DESTINATIONSCHEMA,'.EXPENSE_ELECTRICITY'));
	PREPARE EXPENSE_ELECTRICITYDROPQUERYSTMT FROM @EXPENSE_ELECTRICITYDROPQUERY;
	EXECUTE EXPENSE_ELECTRICITYDROPQUERYSTMT;	
	SET @EXPENSE_ELECTRICITYCREATEQUERY=(SELECT CONCAT('CREATE TABLE ',DESTINATIONSCHEMA,'.EXPENSE_ELECTRICITY(
	EE_ID INTEGER NOT NULL	AUTO_INCREMENT,
	EDE_ID INTEGER NOT NULL,
	EE_INVOICE_DATE DATE NOT NULL,	
	EE_FROM_PERIOD DATE NOT NULL,	
	EE_TO_PERIOD DATE NOT NULL,	
	ECN_ID INTEGER NOT NULL,
	EE_AMOUNT DECIMAL(5,2) NOT NULL	,
	EE_COMMENTS	TEXT NULL,
	ULD_ID INTEGER(2) NOT NULL,	
	EE_TIMESTAMP TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
	PRIMARY KEY(EE_ID),
	FOREIGN KEY(EDE_ID) REFERENCES ',DESTINATIONSCHEMA,'.EXPENSE_DETAIL_ELECTRICITY (EDE_ID),
	FOREIGN KEY(ECN_ID) REFERENCES ',DESTINATIONSCHEMA,'.EXPENSE_CONFIGURATION (ECN_ID),
	FOREIGN KEY(ULD_ID) REFERENCES ',DESTINATIONSCHEMA,'.USER_LOGIN_DETAILS (ULD_ID))'));
	PREPARE EXPENSE_ELECTRICITYCREATEQUERYSTMT FROM @EXPENSE_ELECTRICITYCREATEQUERY;
	EXECUTE EXPENSE_ELECTRICITYCREATEQUERYSTMT;	
	SET @EXPENSE_ELECTRICITYINSERTQUERY = (SELECT CONCAT('INSERT INTO ',DESTINATIONSCHEMA,'.EXPENSE_ELECTRICITY
	(EDE_ID, EE_INVOICE_DATE, EE_FROM_PERIOD, EE_TO_PERIOD, ECN_ID, EE_AMOUNT, EE_COMMENTS, ULD_ID , EE_TIMESTAMP) 
	SELECT EDEID,INVOICEDATE,FROMPERIOD,TOPERIOD,ECNID,FINALAMOUNT,COMMENTS,USERSTAMPID,TIME_STAMP FROM 
	',DESTINATIONSCHEMA,'.TEMP_EXPENSE_ELECTRICITY '));
	PREPARE EXPENSE_ELECTRICITYINSERTQUERYSTMT FROM @EXPENSE_ELECTRICITYINSERTQUERY;
	EXECUTE EXPENSE_ELECTRICITYINSERTQUERYSTMT;	
	SET @TEMP_ELECTRICITYDROPQUERY=(SELECT CONCAT('DROP TABLE IF EXISTS ',DESTINATIONSCHEMA,'.TEMP_EXPENSE_ELECTRICITY'));
	PREPARE TEMP_ELECTRICITYDROPQUERYSTMT FROM @TEMP_ELECTRICITYDROPQUERY;
	EXECUTE TEMP_ELECTRICITYDROPQUERYSTMT;	
	SET END_TIME=(SELECT CURTIME());
	SET DURATION=(SELECT TIMEDIFF(END_TIME,START_TIME));	
	SET @COUNT_SCDB_ELECTRICITY=(SELECT COUNT(*) FROM BIZ_DAILY_SCDB_FORMAT WHERE EXP_TYPE_OF_EXPENSE='ELECTRICITY') ;	
	SET @COUNT_SPLITTED_ELECTRICITY=(SELECT CONCAT('SELECT COUNT(*)INTO @SPLITTED_ELECTRICITY FROM ',DESTINATIONSCHEMA,'.EXPENSE_ELECTRICITY'));
	PREPARE COUNT_SPLITTED_ELECTRICITYSTMT FROM @COUNT_SPLITTED_ELECTRICITY;
	EXECUTE COUNT_SPLITTED_ELECTRICITYSTMT;	
	SET @REJECTION_COUNT=(@COUNT_SCDB_ELECTRICITY-@SPLITTED_ELECTRICITY);	
	SET @POSTAPIDSTMT=(SELECT CONCAT('SELECT POSTAP_ID INTO @POSTAPID FROM POST_AUDIT_PROFILE WHERE POSTAP_DATA=',"'EXPENSE_ELECTRICITY'"));
	PREPARE POSTAPSTMT FROM @POSTAPIDSTMT;
	EXECUTE POSTAPSTMT;	
	SET @PREASPSTMT=(SELECT CONCAT('SELECT PREASP_ID INTO @PREASPID FROM PRE_AUDIT_SUB_PROFILE WHERE PREASP_DATA=',"'EXPENSE_ELECTRICITY'"));
	PREPARE PREASPIDSTMT FROM @PREASPSTMT;
	EXECUTE PREASPIDSTMT;	
	SET @PREAMPSTMT=(SELECT CONCAT('SELECT PREAMP_ID INTO @PREAMPID FROM PRE_AUDIT_MAIN_PROFILE WHERE PREAMP_DATA=',"'BIZ DAILY'"));
	PREPARE PREAMPIDSTMT FROM @PREAMPSTMT;
	EXECUTE PREAMPIDSTMT;
	SET @DUR=DURATION;		
	UPDATE PRE_AUDIT_SUB_PROFILE SET PREASP_NO_OF_REC=@COUNT_SCDB_ELECTRICITY WHERE PREASP_DATA='EXPENSE_ELECTRICITY';	
	INSERT INTO POST_AUDIT_HISTORY(POSTAP_ID,POSTAH_NO_OF_REC,PREASP_ID,PREAMP_ID,POSTAH_DURATION,POSTAH_NO_OF_REJ,ULD_ID)
	VALUES(@POSTAPID,@SPLITTED_ELECTRICITY,@PREASPID,@PREAMPID,@DUR,@REJECTION_COUNT,@INPUTUSERID);	
	SET FOREIGN_KEY_CHECKS=1;
	COMMIT;
END;
