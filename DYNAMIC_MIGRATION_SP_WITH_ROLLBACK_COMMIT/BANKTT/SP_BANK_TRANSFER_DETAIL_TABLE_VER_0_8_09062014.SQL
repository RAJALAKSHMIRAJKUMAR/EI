-- VERSION 0.8 -- SDATE:09-06-2014 -- EDATE:09-06-2014 -- ISSUE:566  -- DESC:IMPLEMENTING COMMIT AND ROLLBACK -- DONE BY:BHAVANI.R
-- VERSION 0.7 -- SDATE:05-04-2014 -- EDATE:05-04-2014 -- ISSUE:802  -- DESC:CHANGING SP SP_BANK_TRANSFER_DETAIL_TABLE FOR WRONG MIGRATION OF TIMESTAMP -- DONE BY:BHAVANI.R
-- VERSION 0.6 -- SDATE:26-03-2014 -- EDATE:27-03-2014 -- ISSUE:765  -- COMMENT NO:#8 -- DESC:CHANGING SP SP_BANK_TRANSFER_DETAIL_TABLE AS PREPARED STATEMENTS FOR DYNAMIC RUNNING PURPOSE -- DONE BY:BHAVANI.R
-- version:0.5 -- sdate:17/03/2014 -- edate:17/03/2014 -- issue:765 --desc:droped temp table --doneby:RL
-- version:0.4 --sdate:25/02/2014 --edate:26/02/2014 --issue:750 COMMENT :#30 -desc:CHANGED TIMESTAMP AS SOURCE TIMESTAMP & ALTERED USERSTAMP COLUMN AS ULD_ID done by:dhivya
-- CREATE QUERY FOR BANK_TRANSFER_DETAIL TABLE
DROP PROCEDURE IF EXISTS SP_BANK_TRANSFER_DETAIL_TABLE;
CREATE PROCEDURE SP_BANK_TRANSFER_DETAIL_TABLE(IN SOURCESCHEMA VARCHAR(50),IN DESTINATIONSCHEMA VARCHAR(50),IN MIGUSERSTAMP VARCHAR(50))
BEGIN
DECLARE EXIT HANDLER FOR SQLEXCEPTION
BEGIN 
ROLLBACK;
END;
START TRANSACTION;
SET FOREIGN_KEY_CHECKS=0;

-- STATEMENT FOR DROPPING BANK_TRANSFER_STATUS_DETAILS
	SET @DROP_BANK_TRANSFER_DETAIL=(SELECT CONCAT('DROP TABLE IF EXISTS ',DESTINATIONSCHEMA,'.BANK_TRANSFER_DETAIL'));
	PREPARE DBANKTRANSFERDETAIL FROM @DROP_BANK_TRANSFER_DETAIL;
    EXECUTE DBANKTRANSFERDETAIL;
	SET @CREATE_BANK_TRANSFER_DETAIL=(SELECT CONCAT('CREATE TABLE ',DESTINATIONSCHEMA,'.BANK_TRANSFER_DETAIL( BTD_ID	INTEGER NOT NULL AUTO_INCREMENT,UNIT_ID	INTEGER NOT NULL,CUSTOMER_ID	INTEGER NOT NULL,BT_ID INTEGER NOT NULL,PRIMARY KEY(BTD_ID),FOREIGN KEY(UNIT_ID) REFERENCES ',DESTINATIONSCHEMA,'.UNIT (UNIT_ID),FOREIGN KEY(CUSTOMER_ID) REFERENCES ',DESTINATIONSCHEMA,'.CUSTOMER (CUSTOMER_ID),FOREIGN KEY(BT_ID) REFERENCES ',DESTINATIONSCHEMA,'.BANK_TRANSFER (BT_ID))'));
    PREPARE CBANKTRANSFERDETAIL FROM @CREATE_BANK_TRANSFER_DETAIL;
    EXECUTE CBANKTRANSFERDETAIL;
	
SET FOREIGN_KEY_CHECKS=1;
COMMIT;
END;