-- VERSION 0.8 -- SDATE:09-06-2014 -- EDATE:09-06-2014 -- ISSUE:566  -- DESC:IMPLEMENTING COMMIT AND ROLLBACK -- DONE BY:BHAVANI.R
-- VERSION 0.7 -- SDATE:05-04-2014 -- EDATE:05-04-2014 -- ISSUE:802  -- DESC:CHANGING SP SP_ALL_MIG_BANKTT_INSERT FOR WRONG MIGRATION OF TIMESTAMP -- DONE BY:BHAVANI.R
-- VERSION 0.6 -- SDATE:26-03-2014 -- EDATE:27-03-2014 -- ISSUE:765  -- COMMENT NO:#8 -- DESC:CHANGING SP SP_ALL_MIG_BANKTT_INSERT AS PREPARED STATEMENTS FOR DYNAMIC RUNNING PURPOSE -- DONE BY:BHAVANI.R
-- version:0.5 -- sdate:17/03/2014 -- edate:17/03/2014 -- issue:765 --desc:droped temp table --doneby:RL
-- version:0.4 --sdate:25/02/2014 --edate:26/02/2014 --issue:750 COMMENT :#30 -desc:CHANGED TIMESTAMP AS SOURCE TIMESTAMP & ALTERED USERSTAMP COLUMN AS ULD_ID done by:dhivya
-- OVERALL BANK TT INSERT SP

DROP PROCEDURE IF EXISTS SP_ALL_MIG_BANKTT_INSERT;
CREATE PROCEDURE SP_ALL_MIG_BANKTT_INSERT(IN SOURCESCHEMA VARCHAR(50),IN DESTINATIONSCHEMA VARCHAR(50),IN MIGUSERSTAMP VARCHAR(50))
BEGIN
DECLARE EXIT HANDLER FOR SQLEXCEPTION
BEGIN 
ROLLBACK;
END;
START TRANSACTION;
CALL SP_TEMP_MIG_BANK_TRANSFER(SOURCESCHEMA,DESTINATIONSCHEMA,MIGUSERSTAMP);
CALL SP_BANK_TRANSFER_DURATION(SOURCESCHEMA,DESTINATIONSCHEMA,MIGUSERSTAMP);
CALL SP_BANK_TRANSFER_DETAIL(SOURCESCHEMA,DESTINATIONSCHEMA,MIGUSERSTAMP);
	
 
SET @DROP_TEMP_BANKTT_TABLE=(SELECT CONCAT('DROP TABLE IF EXISTS ',DESTINATIONSCHEMA,'.TEMP_BANKTT_TABLE'));
	PREPARE DTEMPBANKTTTABLE FROM @DROP_TEMP_BANKTT_TABLE;
    EXECUTE DTEMPBANKTTTABLE;
	
	SET @DROP_TEMP_CUSTOMER_SCDB_FORMAT=(SELECT CONCAT('DROP TABLE IF EXISTS ',DESTINATIONSCHEMA,'.TEMP_CUSTOMER_SCDB_FORMAT'));
	PREPARE DTEMPCUSTOMERSCDBFORMAT FROM @DROP_TEMP_CUSTOMER_SCDB_FORMAT;
    EXECUTE DTEMPCUSTOMERSCDBFORMAT;
	
	SET @DROP_TEMP_MIG_BANK_TRANSFER=(SELECT CONCAT('DROP TABLE IF EXISTS ',DESTINATIONSCHEMA,'.TEMP_MIG_BANK_TRANSFER'));
	PREPARE DTEMPMIGBANKTRANSFER FROM @DROP_TEMP_MIG_BANK_TRANSFER;
    EXECUTE DTEMPMIGBANKTRANSFER;
	
	SET @DROP_TEMP_BANK_TRANSFER=(SELECT CONCAT('DROP TABLE IF EXISTS ',DESTINATIONSCHEMA,'.TEMP_BANK_TRANSFER'));
	PREPARE DTEMPBANKTRANSFER FROM @DROP_TEMP_BANK_TRANSFER;
    EXECUTE DTEMPBANKTRANSFER; 
	
	SET @DROP_VW_BANK_TRANSFER=(SELECT CONCAT('DROP VIEW IF EXISTS ',SOURCESCHEMA,'.VW_BANK_TRANSFER'));
	PREPARE DVWBANKTRANSFER FROM @DROP_VW_BANK_TRANSFER;
    EXECUTE DVWBANKTRANSFER;

	SET @DROP_VW_TEMP_BANKTT_CUSTOMER=(SELECT CONCAT('DROP VIEW IF EXISTS ',SOURCESCHEMA,'.VW_TEMP_BANKTT_CUSTOMER'));
	PREPARE DVWTEMPBANKTTCUSTOMER FROM @DROP_VW_TEMP_BANKTT_CUSTOMER;
    EXECUTE DVWTEMPBANKTTCUSTOMER;

	SET @DROP_VW_TEMP_MIG_BANK_TRANSFER=(SELECT CONCAT('DROP VIEW IF EXISTS ',SOURCESCHEMA,'.VW_TEMP_MIG_BANK_TRANSFER'));
	PREPARE DVWTEMPMIGBANKTRANSFER FROM @DROP_VW_TEMP_MIG_BANK_TRANSFER;
    EXECUTE DVWTEMPMIGBANKTRANSFER;
    
    SET @DROP_VW_TEMP_BANK_TRANSFER=(SELECT CONCAT('DROP VIEW IF EXISTS ',SOURCESCHEMA,'.VW_TEMP_BANK_TRANSFER'));
	PREPARE DVWTEMPBANKTRANSFER FROM @DROP_VW_TEMP_BANK_TRANSFER;
    EXECUTE DVWTEMPBANKTRANSFER;
    COMMIT;
  END;

CALL SP_ALL_MIG_BANKTT_INSERT('SOURCE_SCHEMA','DESTINATION_SCHEMA','EXPATSINTEGRATED@GMAIL.COM');
