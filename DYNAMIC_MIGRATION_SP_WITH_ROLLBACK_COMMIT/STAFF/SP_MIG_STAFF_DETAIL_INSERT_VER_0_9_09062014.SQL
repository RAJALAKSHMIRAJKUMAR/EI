-- VER:0.9 STARTDATE:09/06/2014 ENDDATE:09/06/2014 ISSUENO:566 COMMENTNO:#14 DESC:IMPLEMENTING ROLLBACK AND COMMIT  DONE BY:BHAVANI.R
-- VER:0.8 STARTDATE:21/04/2014 ENDDATE:21/04/2014 ISSUENO:765 COMMENTNO:#93 DESC:UPDATED TIMESTAMP DONE BY:SASIKALA
-- VER:0.7 STARTDATE:28/03/2014 ENDDATE:28/03/2014 ISSUENO:765 COMMENTNO:#8 DESC:CHANGED THE SP:SP_MIG_STAFF_DETAIL_INSERT CHANGED THE SCHEMA FOR INSERTION IN POST AUDIT HISTORY AND UPDATION IN PRE AUDIT SUB PROFILE  DONE BY:LALITHA
-- VER:0.6 STARTDATE:19/03/2014 ENDDATE:20/03/2014 ISSUENO:765 COMMENTNO:#8 DESC:CHANGED THE SP:SP_MIG_STAFF_DETAIL_INSERT AS PREPARED STMT FOR DYNAMIC RUNNING PURPOSE  DONE BY:LALITHA
-- version:0.5 -- sdate:17/03/2014 -- edate:17/03/2014 -- issue:765 --desc:droped temp table --doneby:RL
-- VERSION 0.4- sdate:25/02/2014 --edate:25/02/2014--ISSUE:750--DESC-ADDING SOURCE TIMESTAMP AND CHANGING USAERSTAMP TO ULD_ID-SAFI
-- version:0.3 --sdate:22/02/2014 --edate:22/02/2014 --issue:750 --desc:implementing audit queries --done by:RL
-- VER 0.2 ISSUE NO:594 COMMENT NO:#54 STARTDATE:22/01/2014 ENDDATE:22/01/2014 DESC:INVOICE ITEMS AND ITEM FROM UPDATION DONE IN THE TEMP TABLE AND CHANGED MIGRATION.STAFF_DAILY_SCDB_FORMAT AS STAFF_DAILY_SCDB_FORMAT AND  MIGRATION.STAFF_DETAIL_SCDB_FORMAT AS STAFF_DETAIL_SCDB_FORMAT DONE BY DHIVYA

DROP PROCEDURE IF EXISTS SP_MIG_STAFF_DETAIL_INSERT;
CREATE PROCEDURE SP_MIG_STAFF_DETAIL_INSERT(IN SOURCESCHEMA  VARCHAR(40),IN DESTINATIONSCHEMA  VARCHAR(40),IN USER_STAMP VARCHAR(50))
BEGIN
-- DECLARING VARIABLES
	DECLARE START_TIME TIME;
	DECLARE END_TIME TIME;
	DECLARE DURATION TIME;
  DECLARE EXIT HANDLER FOR SQLEXCEPTION
BEGIN 
ROLLBACK;
END;
START TRANSACTION;
	SET FOREIGN_KEY_CHECKS=0;
-- STATEMENT FOR CHANGING USERSTAMP AS ULD_ID
    SET @LOGIN_ID=(SELECT CONCAT('SELECT ULD_ID INTO @ULDID FROM ',DESTINATIONSCHEMA,'.USER_LOGIN_DETAILS WHERE ULD_LOGINID=','"',USER_STAMP,'"'));
    PREPARE LOGINID FROM @LOGIN_ID;
    EXECUTE LOGINID;
-- DROP QUERY FOR EXPENSE_DETAIL_STAFF_SALARY
	SET START_TIME=(SELECT CURTIME());
	SET @DROP_EXPENSE_DETAIL_STAFF_SALARY=(SELECT CONCAT('DROP TABLE IF EXISTS ',DESTINATIONSCHEMA,'. EXPENSE_DETAIL_STAFF_SALARY'));					
	PREPARE DROP_EXPENSE_DETAIL_STAFF_SALARY_STMT FROM @DROP_EXPENSE_DETAIL_STAFF_SALARY;
    EXECUTE DROP_EXPENSE_DETAIL_STAFF_SALARY_STMT;
-- CREATE QUERY FOR EXPENSE_DETAIL_STAFF_SALARY
	SET @CREATE_EXPENSE_DETAIL_STAFF_SALARY=(SELECT CONCAT('CREATE TABLE ',DESTINATIONSCHEMA,'. EXPENSE_DETAIL_STAFF_SALARY(EDSS_ID INTEGER NOT NULL AUTO_INCREMENT,EMP_ID INTEGER NOT NULL,EDSS_CPF_NUMBER	VARCHAR(9) UNIQUE NULL,EDSS_CPF_AMOUNT	DECIMAL(7,2) NULL,EDSS_LEVY_AMOUNT DECIMAL(7,2) NULL,EDSS_SALARY_AMOUNT DECIMAL(7,2) NOT NULL,EDSS_COMMENTS TEXT NULL,ULD_ID INT(2)NOT NULL,EDSS_TIMESTAMP TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,PRIMARY KEY(EDSS_ID),FOREIGN KEY(EMP_ID) REFERENCES ',DESTINATIONSCHEMA,'.EMPLOYEE_DETAILS (EMP_ID),FOREIGN KEY(ULD_ID) REFERENCES ',DESTINATIONSCHEMA,'.USER_LOGIN_DETAILS (ULD_ID ))'));
	PREPARE CREATE_EXPENSE_DETAIL_STAFF_SALARY_STMT FROM @CREATE_EXPENSE_DETAIL_STAFF_SALARY;
    EXECUTE CREATE_EXPENSE_DETAIL_STAFF_SALARY_STMT;
-- INSERT QUERY FOR EXPENSE_DETAIL_STAFF_SALARY
	SET @INSERT_EXPENSE_DETAIL_STAFF_SALARY=(SELECT CONCAT('INSERT INTO ',DESTINATIONSCHEMA,'. EXPENSE_DETAIL_STAFF_SALARY(EMP_ID, EDSS_CPF_NUMBER, EDSS_CPF_AMOUNT, EDSS_LEVY_AMOUNT,EDSS_SALARY_AMOUNT,ULD_ID,EDSS_TIMESTAMP)SELECT EMPDTL.EMP_ID, STAFFDTL.SED_CPF_NUMBER, STAFFDTL.SED_CPF_AMOUNT, STAFFDTL.SED_LEVY_AMOUNT, STAFFDTL.SED_SALARY_AMOUNT, ULD.ULD_ID,STAFFDTL.TIMESTAMP FROM ',DESTINATIONSCHEMA,'.EMPLOYEE_DETAILS EMPDTL INNER JOIN ',SOURCESCHEMA,'.STAFF_DETAIL_SCDB_FORMAT STAFFDTL, ',DESTINATIONSCHEMA,'.USER_LOGIN_DETAILS ULD WHERE STAFFDTL.SED_FIRST_NAME=EMPDTL.EMP_FIRST_NAME AND STAFFDTL.SED_LAST_NAME=EMPDTL.EMP_LAST_NAME AND ULD.ULD_LOGINID=STAFFDTL.USERSTAMP'));
	PREPARE INSERT_EXPENSE_DETAIL_STAFF_SALARY_STMT FROM @INSERT_EXPENSE_DETAIL_STAFF_SALARY;
    EXECUTE INSERT_EXPENSE_DETAIL_STAFF_SALARY_STMT;
      SET @UPDATETIMESTAMP=(SELECT CONCAT('UPDATE ',DESTINATIONSCHEMA,'. EXPENSE_DETAIL_STAFF_SALARY SET EDSS_TIMESTAMP=(SELECT CONVERT_TZ(EDSS_TIMESTAMP, "+08:00","+0:00"))'));
PREPARE UPDATETIMESTAMPSTMT FROM @UPDATETIMESTAMP;
EXECUTE UPDATETIMESTAMPSTMT;
    SET END_TIME=(SELECT CURTIME());
	SET DURATION=(SELECT TIMEDIFF(END_TIME,START_TIME));
-- COUNT CHECKING FOR EXPENSE_DETAIL_STAFF_SALARY DETAILS
	SET @COUNTEXPENSEDETAILSTAFFSALARYSCDBFORMAT=(SELECT CONCAT('SELECT COUNT(*) INTO @COUNT_EXPENSE_DETAILSTAFFSALARYSCDBFORMAT FROM ',SOURCESCHEMA,'. STAFF_DETAIL_SCDB_FORMAT WHERE SED_FIRST_NAME IS NOT NULL AND SED_LAST_NAME IS NOT NULL'));
	PREPARE COUNTEXPENSEDETAILSTAFFSALARYSCDBFORMAT_STMT FROM @COUNTEXPENSEDETAILSTAFFSALARYSCDBFORMAT;
    EXECUTE COUNTEXPENSEDETAILSTAFFSALARYSCDBFORMAT_STMT;
-- COUNT SPLITING FOR EXPENSE_DETAIL_STAFF_SALARY DETAILS 
	SET @COUNTSPLITINGEXPENSEDETAILSTAFFSALARY=(SELECT CONCAT('SELECT COUNT(*) INTO @COUNT_SPLITING_EXPENSE_DETAIL_STAFF_SALARY FROM ',DESTINATIONSCHEMA,'.EXPENSE_DETAIL_STAFF_SALARY'));
	PREPARE COUNTSPLITINGEXPENSEDETAILSTAFFSALARY_STMT FROM @COUNTSPLITINGEXPENSEDETAILSTAFFSALARY;
    EXECUTE COUNTSPLITINGEXPENSEDETAILSTAFFSALARY_STMT;
    SET @REJECTION_COUNT=(@COUNT_EXPENSE_DETAILSTAFFSALARYSCDBFORMAT-@COUNT_SPLITING_EXPENSE_DETAIL_STAFF_SALARY);
-- QUERY FOR INSERT VALUES IN POST_AUDIT_HISTORY TABLE
    SET @POSTAPIDSTMT=(SELECT CONCAT('SELECT POSTAP_ID INTO @POSTAPID FROM POST_AUDIT_PROFILE WHERE POSTAP_DATA=',"'EXPENSE_DETAIL_STAFF_SALARY'"));
    PREPARE POSTAPSTMT FROM @POSTAPIDSTMT;
    EXECUTE POSTAPSTMT;
    SET @PREASPSTMT=(SELECT CONCAT('SELECT PREASP_ID INTO @PREASPID FROM PRE_AUDIT_SUB_PROFILE WHERE PREASP_DATA=',"'EXPENSE_DETAIL_STAFF_SALARY'"));
    PREPARE PREASPIDSTMT FROM @PREASPSTMT;
    EXECUTE PREASPIDSTMT;
    SET @PREAMPSTMT=(SELECT CONCAT('SELECT PREAMP_ID INTO @PREAMPID FROM PRE_AUDIT_MAIN_PROFILE WHERE PREAMP_DATA=',"'STAFF DETAIL'"));
    PREPARE PREAMPIDSTMT FROM @PREAMPSTMT;
	EXECUTE PREAMPIDSTMT;
    SET @DUR=DURATION;
-- QUERY FOR UPDATE VALUES IN PRE_AUDIT_SUB_PROFILE TABLE
	UPDATE PRE_AUDIT_SUB_PROFILE SET PREASP_NO_OF_REC=@COUNT_EXPENSE_DETAILSTAFFSALARYSCDBFORMAT WHERE PREASP_DATA='EXPENSE_DETAIL_STAFF_SALARY';	
	INSERT INTO POST_AUDIT_HISTORY(POSTAP_ID,POSTAH_NO_OF_REC,PREASP_ID,PREAMP_ID,POSTAH_DURATION,POSTAH_NO_OF_REJ,ULD_ID)VALUES(@POSTAPID,@COUNT_SPLITING_EXPENSE_DETAIL_STAFF_SALARY,@PREASPID,@PREAMPID,@DUR,@REJECTION_COUNT,@ULDID);    
	SET FOREIGN_KEY_CHECKS=1;
  COMMIT;
END;

CALL SP_MIG_STAFF_DETAIL_INSERT('SAFI_SOURCE','SAFI_DEST','expatsintegrated@gmail.com')



