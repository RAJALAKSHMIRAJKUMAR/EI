DROP PROCEDURE IF EXISTS SP_BIZDLY_SUBSTARHUB_INSERT;
CREATE PROCEDURE SP_BIZDLY_SUBSTARHUB_INSERT(
IN UNIT_NUMBER TEXT,
IN ECN_ID_NEW TEXT,
IN INVOICE_DATE DATE,
IN FROM_PERIOD DATE,
IN TO_PERIOD DATE,
IN AMOUNT DECIMAL(7,2),
IN COMMENTS TEXT,
IN USERSTAMP VARCHAR(50),
OUT STARHUB_SUCCESSFLAG INTEGER,
OUT STARHUB_UPDATEFLAG INTEGER)
BEGIN
       DECLARE ECNID TEXT;
       DECLARE EDSHID TEXT;
       DECLARE USERSTAMP_ID INTEGER(2);
DECLARE EXIT HANDLER FOR SQLEXCEPTION
BEGIN 
ROLLBACK; 
SET STARHUB_SUCCESSFLAG=0;
SET STARHUB_UPDATEFLAG=0;
END;
    IF(UNIT_NUMBER='' OR UNIT_NUMBER IS NULL)THEN
		SET UNIT_NUMBER = NULL;
	END IF;
	IF(ECN_ID_NEW='' OR ECN_ID_NEW IS NULL OR ECN_ID_NEW='SELECT')THEN
		SET ECN_ID_NEW = NULL;
	END IF;
	IF(INVOICE_DATE='' OR INVOICE_DATE IS NULL)THEN
		SET INVOICE_DATE = NULL;
	END IF;
	IF(FROM_PERIOD='' OR FROM_PERIOD IS NULL)THEN
		SET FROM_PERIOD = NULL;
	END IF;
	IF(TO_PERIOD='' OR TO_PERIOD IS NULL)THEN
		SET TO_PERIOD = NULL;
	END IF;
	IF(AMOUNT='' OR AMOUNT IS NULL)THEN
		SET AMOUNT = NULL;
	END IF;
	IF(COMMENTS='' OR COMMENTS IS NULL)THEN
		SET COMMENTS = NULL;
	END IF;
	IF(USERSTAMP='' OR USERSTAMP IS NULL)THEN
		SET USERSTAMP = NULL;
	END IF;
START TRANSACTION;
SET STARHUB_SUCCESSFLAG=0;
SET STARHUB_UPDATEFLAG=0;
	CALL SP_CHANGE_USERSTAMP_AS_ULDID(USERSTAMP,@ULDID);
    SET USERSTAMP_ID = (SELECT @ULDID);
	SET EDSHID = (SELECT MAX(EDSH_ID) FROM EXPENSE_DETAIL_STARHUB WHERE UNIT_ID = (SELECT UNIT_ID FROM UNIT WHERE UNIT_NO=UNIT_NUMBER));
	SET ECNID = (SELECT ECN_ID FROM EXPENSE_DETAIL_STARHUB WHERE EDSH_ID = EDSHID);
        IF  ECNID IS NULL THEN
            UPDATE EXPENSE_DETAIL_STARHUB SET ECN_ID=ECN_ID_NEW , ULD_ID=USERSTAMP_ID WHERE EDSH_ID=EDSHID ;
            SET STARHUB_UPDATEFLAG=1;
        END IF;
		IF(UNIT_NUMBER IS NOT NULL AND ECN_ID_NEW IS NOT NULL AND INVOICE_DATE IS NOT NULL AND FROM_PERIOD IS NOT NULL AND TO_PERIOD IS NOT NULL AND USERSTAMP IS NOT NULL) THEN  
			INSERT INTO EXPENSE_STARHUB (EDSH_ID,ESH_INVOICE_DATE,ESH_FROM_PERIOD,ESH_TO_PERIOD,ESH_AMOUNT,ESH_COMMENTS,ULD_ID)VALUES (EDSHID,INVOICE_DATE,FROM_PERIOD,TO_PERIOD,AMOUNT,COMMENTS,USERSTAMP_ID);
			SET STARHUB_SUCCESSFLAG=1;
        END IF;
            
    COMMIT;
END;