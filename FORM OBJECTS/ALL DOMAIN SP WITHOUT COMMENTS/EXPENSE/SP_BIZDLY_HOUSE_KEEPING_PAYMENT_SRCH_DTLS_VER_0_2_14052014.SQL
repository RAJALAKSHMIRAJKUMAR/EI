DROP PROCEDURE IF EXISTS SP_BIZDLY_HOUSE_KEEPING_PAYMENT_SRCH_DTLS;
CREATE PROCEDURE SP_BIZDLY_HOUSE_KEEPING_PAYMENT_SRCH_DTLS(
IN USERSTAMP VARCHAR(50),
OUT BIZDLY_HOUSE_KEEPING_PAYMENTDTLS TEXT)
BEGIN
	DECLARE USERSTAMP_ID INTEGER;
	DECLARE SYSDATEANDTIME VARCHAR(50);
	DECLARE SYSDATEANDULDID VARCHAR(50);
	DECLARE EXIT HANDLER FOR SQLEXCEPTION
	BEGIN 
		ROLLBACK; 
	END;
	START TRANSACTION;
	CALL SP_CHANGE_USERSTAMP_AS_ULDID(USERSTAMP,@ULDID);
	SET USERSTAMP_ID=(SELECT @ULDID);
	SET SYSDATEANDTIME=(SELECT SYSDATE());
	SET SYSDATEANDTIME=(SELECT REPLACE(SYSDATEANDTIME,' ',''));
	SET SYSDATEANDTIME=(SELECT REPLACE(SYSDATEANDTIME,'-',''));
	SET SYSDATEANDTIME=(SELECT REPLACE(SYSDATEANDTIME,':',''));
	SET SYSDATEANDULDID=(SELECT CONCAT(SYSDATEANDTIME,'_',USERSTAMP_ID));	
	SET BIZDLY_HOUSE_KEEPING_PAYMENTDTLS=(SELECT CONCAT('TEMP_BIZDLY_HOUSE_KEEPING_PAYMENTDTLS','_',SYSDATEANDULDID));
	SET @HOUSE_KEEPING_PAYMENTDTLS_CREATEQUERY = (SELECT CONCAT('CREATE TABLE ',BIZDLY_HOUSE_KEEPING_PAYMENTDTLS,'(
	EHKP_ID INT NOT NULL,
	UNIT_ID VARCHAR(50),
	UNIT_NO SMALLINT(4) UNSIGNED ZEROFILL,
	EHKP_FOR_PERIOD DATE,
	EHKP_PAID_DATE DATE,
	EHKP_AMOUNT DECIMAL(7,2),
	EHKP_COMMENTS TEXT,
	EHKP_USERSTAMP VARCHAR(50),
	EHKP_TIMESTAMP TIMESTAMP)'));
	PREPARE HOUSE_KEEPING_PAYMENTDTLS_CREATEQUERY_STMT FROM @HOUSE_KEEPING_PAYMENTDTLS_CREATEQUERY;
	EXECUTE HOUSE_KEEPING_PAYMENTDTLS_CREATEQUERY_STMT;
    SET @HOUSE_KEEPING_PAYMENTDTLS_INSERTQUERY = (SELECT CONCAT('INSERT INTO ',BIZDLY_HOUSE_KEEPING_PAYMENTDTLS,'(
	EHKP_ID,UNIT_ID,UNIT_NO,EHKP_FOR_PERIOD,EHKP_PAID_DATE,EHKP_AMOUNT,EHKP_COMMENTS,EHKP_USERSTAMP,EHKP_TIMESTAMP)
	(SELECT EXPENSE_HOUSEKEEPING_PAYMENT.EHKP_ID,CONCAT(EXPENSE_HOUSEKEEPING_PAYMENT.UNIT_ID,'' ' ' '',''UNIT'') AS UNITID,UNIT.UNIT_NO AS UNITNO,
	EXPENSE_HOUSEKEEPING_PAYMENT.EHKP_FOR_PERIOD,EXPENSE_HOUSEKEEPING_PAYMENT.EHKP_PAID_DATE,
	EXPENSE_HOUSEKEEPING_PAYMENT.EHKP_AMOUNT,EXPENSE_HOUSEKEEPING_PAYMENT.EHKP_COMMENTS,ULD.ULD_LOGINID AS EHKP_USERSTAMP, EXPENSE_HOUSEKEEPING_PAYMENT.EHKP_TIMESTAMP 
	FROM EXPENSE_HOUSEKEEPING_PAYMENT  JOIN UNIT ON EXPENSE_HOUSEKEEPING_PAYMENT.UNIT_ID = UNIT.UNIT_ID,USER_LOGIN_DETAILS ULD  WHERE ULD.ULD_ID = EXPENSE_HOUSEKEEPING_PAYMENT.ULD_ID) UNION 
	(SELECT EXPENSE_HOUSEKEEPING_PAYMENT.EHKP_ID,CONCAT(EXPENSE_HOUSEKEEPING_PAYMENT.EHKU_ID,'' ' ' '',''HKUNIT'') AS UNITID,
	EXPENSE_HOUSEKEEPING_UNIT.EHKU_UNIT_NO AS UNITNO,EXPENSE_HOUSEKEEPING_PAYMENT.EHKP_FOR_PERIOD,
	EXPENSE_HOUSEKEEPING_PAYMENT.EHKP_PAID_DATE,EXPENSE_HOUSEKEEPING_PAYMENT.EHKP_AMOUNT,EXPENSE_HOUSEKEEPING_PAYMENT.EHKP_COMMENTS,
	ULD.ULD_LOGINID AS EHKP_USERSTAMP,EXPENSE_HOUSEKEEPING_PAYMENT.EHKP_TIMESTAMP FROM EXPENSE_HOUSEKEEPING_PAYMENT
	JOIN EXPENSE_HOUSEKEEPING_UNIT ON EXPENSE_HOUSEKEEPING_PAYMENT.EHKU_ID = EXPENSE_HOUSEKEEPING_UNIT.EHKU_ID,
	USER_LOGIN_DETAILS ULD  WHERE  ULD.ULD_ID= EXPENSE_HOUSEKEEPING_PAYMENT.ULD_ID)'));
	PREPARE HOUSE_KEEPING_PAYMENTDTLS_INSERTQUERY_STMT FROM @HOUSE_KEEPING_PAYMENTDTLS_INSERTQUERY;
	EXECUTE HOUSE_KEEPING_PAYMENTDTLS_INSERTQUERY_STMT;
COMMIT;
END;