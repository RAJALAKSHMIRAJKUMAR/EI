DROP PROCEDURE IF EXISTS SP_BIZDLY_PURCHASE_NEW_CARD_CHECK_TRANSACTION;
CREATE PROCEDURE SP_BIZDLY_PURCHASE_NEW_CARD_CHECK_TRANSACTION(
IN TABLE_ID INTEGER,
IN DELETING_ROWID INTEGER,
OUT FLAG INTEGER)
BEGIN
	DECLARE EXIT HANDLER FOR SQLEXCEPTION
	BEGIN
		ROLLBACK; 
	END;
	START TRANSACTION;
	SET FLAG=0;
	IF(TABLE_ID=59)THEN
		IF NOT EXISTS(SELECT UASD_ID FROM CUSTOMER_ACCESS_CARD_DETAILS WHERE UASD_ID=(SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=
		(SELECT EPNC_NUMBER FROM EXPENSE_PURCHASE_NEW_CARD WHERE EPNC_ID = DELETING_ROWID)))THEN
        IF NOT EXISTS(SELECT UASD_ID FROM CUSTOMER_ENTRY_DETAILS WHERE UASD_ID=(SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=
			(SELECT EPNC_NUMBER FROM EXPENSE_PURCHASE_NEW_CARD WHERE EPNC_ID = DELETING_ROWID)))THEN
			IF NOT EXISTS(SELECT UASD_ID FROM CUSTOMER_LP_DETAILS WHERE UASD_ID=(SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=
			(SELECT EPNC_NUMBER FROM EXPENSE_PURCHASE_NEW_CARD WHERE EPNC_ID = DELETING_ROWID)))THEN
				SET FLAG = 1;
			END IF;
		END IF;
	END IF;
    END IF;
	COMMIT;
END;