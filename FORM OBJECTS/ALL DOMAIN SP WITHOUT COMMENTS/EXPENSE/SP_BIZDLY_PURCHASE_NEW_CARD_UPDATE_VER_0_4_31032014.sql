DROP PROCEDURE IF EXISTS SP_BIZDLY_PURCHASE_NEW_CARD_UPDATE;
CREATE PROCEDURE SP_BIZDLY_PURCHASE_NEW_CARD_UPDATE(
IN EPNCID INT,
IN CARDNO VARCHAR(7),
IN INVOICEDATE DATE,
IN AMOUNT DECIMAL(7,2),
IN COMMENTS TEXT,
IN USERSTAMP VARCHAR(50),
OUT EPNC_FLAG INTEGER)
BEGIN
DECLARE USERSTAMP_ID INTEGER(2);
DECLARE OLDCARD VARCHAR(7);
DECLARE EXIT HANDLER FOR SQLEXCEPTION
BEGIN
	ROLLBACK;
END;
	START TRANSACTION;
	SET EPNC_FLAG = 0;
	CALL SP_CHANGE_USERSTAMP_AS_ULDID(USERSTAMP,@ULDID);
    SET USERSTAMP_ID = (SELECT @ULDID);
	SET OLDCARD=(SELECT EPNC_NUMBER FROM EXPENSE_PURCHASE_NEW_CARD WHERE EPNC_ID=EPNCID);
	IF(EPNCID IS NOT NULL AND CARDNO IS NOT NULL AND INVOICEDATE IS NOT NULL AND AMOUNT IS NOT NULL AND USERSTAMP IS NOT NULL)THEN
		IF(CARDNO!=OLDCARD)THEN
			IF NOT EXISTS(SELECT EPNC_NUMBER FROM EXPENSE_PURCHASE_NEW_CARD WHERE EPNC_NUMBER=CARDNO)THEN
				IF NOT EXISTS(SELECT UASD_ACCESS_CARD FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=CARDNO)THEN
					UPDATE UNIT_ACCESS_STAMP_DETAILS SET UASD_ACCESS_CARD=CARDNO,ULD_ID=USERSTAMP_ID WHERE 
					UASD_ACCESS_CARD=OLDCARD;
					SET EPNC_FLAG = 1;
					UPDATE EXPENSE_PURCHASE_NEW_CARD SET EPNC_NUMBER=CARDNO,EPNC_INVOICE_DATE=INVOICEDATE,EPNC_AMOUNT=AMOUNT,
					EPNC_COMMENTS=COMMENTS,ULD_ID=USERSTAMP_ID WHERE EPNC_ID=EPNCID;
					SET EPNC_FLAG = 1;
				END IF;
			END IF;
		ELSE
			UPDATE EXPENSE_PURCHASE_NEW_CARD SET EPNC_INVOICE_DATE=INVOICEDATE,EPNC_AMOUNT=AMOUNT,
			EPNC_COMMENTS=COMMENTS,ULD_ID=USERSTAMP_ID WHERE EPNC_ID=EPNCID;
			SET EPNC_FLAG = 1;
		END IF;
	END IF;
COMMIT;
END;