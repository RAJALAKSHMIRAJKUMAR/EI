DROP PROCEDURE IF EXISTS SP_BIZDLY_PURCHASE_NEW_CARD_INSERT;
CREATE PROCEDURE SP_BIZDLY_PURCHASE_NEW_CARD_INSERT(
IN UNITNO SMALLINT(4),
IN CARDNO INTEGER(7),
IN INVOICEDATE DATE,
IN AMOUNT DECIMAL(7,2),
IN COMMENTS TEXT,
IN USERSTAMP VARCHAR(50),
OUT EPNC_FLAG INTEGER(10))
BEGIN
DECLARE USERSTAMP_ID INTEGER(2);
DECLARE EXIT HANDLER FOR SQLEXCEPTION
BEGIN 
ROLLBACK;
END;
SET EPNC_FLAG=0;
CALL SP_CHANGE_USERSTAMP_AS_ULDID(USERSTAMP,@ULDID);
SET USERSTAMP_ID = (SELECT @ULDID);
IF (UNITNO IS NOT NULL AND CARDNO IS NOT NULL AND INVOICEDATE IS NOT NULL AND AMOUNT IS NOT NULL AND USERSTAMP IS NOT NULL) THEN
IF NOT EXISTS(SELECT UASD_ACCESS_CARD FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=CARDNO)THEN
INSERT INTO EXPENSE_PURCHASE_NEW_CARD(UNIT_ID,EPNC_NUMBER,EPNC_INVOICE_DATE,EPNC_AMOUNT,EPNC_COMMENTS,ULD_ID)
VALUES ((SELECT UNIT_ID FROM UNIT WHERE UNIT_NO=UNITNO),CARDNO,INVOICEDATE,AMOUNT,COMMENTS,USERSTAMP_ID);
SET EPNC_FLAG=1;
END IF;
INSERT INTO UNIT_ACCESS_STAMP_DETAILS(UNIT_ID,UASD_ACCESS_CARD,UASD_ACCESS_INVENTORY,UASD_COMMENTS,ULD_ID)
VALUES((SELECT UNIT_ID FROM UNIT WHERE UNIT_NO=UNITNO),CARDNO,'X',COMMENTS,USERSTAMP_ID);
SET EPNC_FLAG=1;
END IF;
COMMIT;
END;