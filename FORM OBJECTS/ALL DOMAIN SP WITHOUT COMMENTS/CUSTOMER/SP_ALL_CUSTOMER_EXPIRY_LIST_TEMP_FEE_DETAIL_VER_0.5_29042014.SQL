DROP PROCEDURE IF EXISTS SP_ALL_CUSTOMER_EXPIRY_LIST_TEMP_FEE_DETAIL;
CREATE PROCEDURE SP_ALL_CUSTOMER_EXPIRY_LIST_TEMP_FEE_DETAIL(IN USERSTAMP VARCHAR(50),OUT CUSTOMER_EXPIRY_FEE_TEMPTBLNAME TEXT,OUT FLAG INTEGER)
BEGIN
DECLARE MAX_CUSTOMER_ID INT;
DECLARE MIN_CUSTOMER_ID INT;
DECLARE REC_VER INT;
DECLARE CUSTOMER_EXPIRY_TEMPTBLNAME TEXT;
DECLARE USERSTAMP_ID INT;
DECLARE EXIT HANDLER FOR SQLEXCEPTION
BEGIN 
ROLLBACK; 
END;
START TRANSACTION;
CALL SP_CHANGE_USERSTAMP_AS_ULDID(USERSTAMP,@ULDID);
SET USERSTAMP_ID=(SELECT @ULDID);
SET CUSTOMER_EXPIRY_TEMPTBLNAME=(SELECT CONCAT('TEMP_ALL_CUSTOMER_EXPIRY_LIST_FEE_DETAIL',SYSDATE()));
SET CUSTOMER_EXPIRY_TEMPTBLNAME=(SELECT REPLACE(CUSTOMER_EXPIRY_TEMPTBLNAME,' ',''));
SET CUSTOMER_EXPIRY_TEMPTBLNAME=(SELECT REPLACE(CUSTOMER_EXPIRY_TEMPTBLNAME,'-',''));
SET CUSTOMER_EXPIRY_TEMPTBLNAME=(SELECT REPLACE(CUSTOMER_EXPIRY_TEMPTBLNAME,':',''));
SET CUSTOMER_EXPIRY_FEE_TEMPTBLNAME=(SELECT CONCAT(CUSTOMER_EXPIRY_TEMPTBLNAME,'_',USERSTAMP_ID)); 
SET @CREATE_CUSTOMER_EXPIRY_FEE_TEMPTBLNAME=(SELECT CONCAT('CREATE TABLE ',CUSTOMER_EXPIRY_FEE_TEMPTBLNAME,'
(
SNO INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
CUSTOMER_ID int,
CUSTOMER_VER int,
CC_PAYMENT_AMOUNT DECIMAL(7,2),
CC_DEPOSIT DECIMAL(7,2),
CC_PROCESSING_FEE DECIMAL(7,2),
CC_AIRCON_FIXED_FEE DECIMAL(7,2),
CC_ELECTRICITY_CAP DECIMAL(7,2),
CC_DRYCLEAN_FEE DECIMAL(7,2),
CC_AIRCON_QUARTERLY_FEE DECIMAL(7,2),
CC_CHECKOUT_CLEANING_FEE DECIMAL(7,2))'));
PREPARE CUSTOMER_EXPIRY_FEE_TEMPTBLNAME_STMT FROM @CREATE_CUSTOMER_EXPIRY_FEE_TEMPTBLNAME;
EXECUTE CUSTOMER_EXPIRY_FEE_TEMPTBLNAME_STMT;
SET MAX_CUSTOMER_ID =(SELECT MAX(CUSTOMER_ID) FROM CUSTOMER_FEE_DETAILS);
SET MIN_CUSTOMER_ID =(SELECT MIN(CUSTOMER_ID) FROM CUSTOMER_FEE_DETAILS);
WHILE MIN_CUSTOMER_ID<= MAX_CUSTOMER_ID DO
SET REC_VER= (SELECT MAX(CED_REC_VER) FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=MIN_CUSTOMER_ID);
WHILE REC_VER != 0 DO
IF EXISTS (SELECT CED_REC_VER FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=MIN_CUSTOMER_ID AND CED_REC_VER=REC_VER) THEN
SET @INSERT_TEMP_CUSTOMER_EXTENSION_FEE_DETAIL=(SELECT CONCAT('INSERT INTO ',CUSTOMER_EXPIRY_FEE_TEMPTBLNAME,' (CUSTOMER_ID,CUSTOMER_VER,CC_PAYMENT_AMOUNT,CC_DEPOSIT,CC_PROCESSING_FEE,CC_AIRCON_FIXED_FEE,CC_ELECTRICITY_CAP,CC_DRYCLEAN_FEE,CC_AIRCON_QUARTERLY_FEE,CC_CHECKOUT_CLEANING_FEE)VALUES (',MIN_CUSTOMER_ID,',',REC_VER,',(SELECT CFD_AMOUNT FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=',MIN_CUSTOMER_ID,' AND CED_REC_VER=',REC_VER,' AND CPP_ID=1),
(SELECT CFD_AMOUNT FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=',MIN_CUSTOMER_ID,' AND CED_REC_VER=',REC_VER,' AND CPP_ID=2),
(SELECT CFD_AMOUNT FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=',MIN_CUSTOMER_ID,' AND CED_REC_VER=',REC_VER,' AND CPP_ID=3),
(SELECT CFD_AMOUNT FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=',MIN_CUSTOMER_ID,' AND CED_REC_VER=',REC_VER,' AND CPP_ID=4),
(SELECT CFD_AMOUNT FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=',MIN_CUSTOMER_ID,' AND CED_REC_VER=',REC_VER,' AND CPP_ID=5),
(SELECT CFD_AMOUNT FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=',MIN_CUSTOMER_ID,' AND CED_REC_VER=',REC_VER,' AND CPP_ID=6),
(SELECT CFD_AMOUNT FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=',MIN_CUSTOMER_ID,' AND CED_REC_VER=',REC_VER,' AND CPP_ID=7),
(SELECT CFD_AMOUNT FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=',MIN_CUSTOMER_ID,' AND CED_REC_VER=',REC_VER,' AND CPP_ID=8))'));
PREPARE INSERT_TEMP_CUSTOMER_EXTENSION_FEE_DETAIL_STMT FROM @INSERT_TEMP_CUSTOMER_EXTENSION_FEE_DETAIL;
EXECUTE INSERT_TEMP_CUSTOMER_EXTENSION_FEE_DETAIL_STMT;
 SET FLAG=5;
 END IF;
SET REC_VER=REC_VER-1;
END WHILE;
SET MIN_CUSTOMER_ID=MIN_CUSTOMER_ID+1;
END WHILE;
COMMIT;
END;