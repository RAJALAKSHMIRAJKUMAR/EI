DROP PROCEDURE IF EXISTS SP_TRG_UNIT_ACCESS_STAMP_DETAILS;
CREATE PROCEDURE SP_TRG_UNIT_ACCESS_STAMP_DETAILS( 
IN UASDID INTEGER,
IN OLDUNITID INTEGER,
IN NEWUNITID INTEGER,     
IN OLDUSDTID INTEGER,
IN NEWUSDTID INTEGER,
IN OLDSTAMPDUTYDATE DATE,
IN NEWSTAMPDUTYDATE DATE,
IN OLDSTAMPDUTYAMT DECIMAL(6,2),
IN NEWSTAMPDUTYAMT DECIMAL(6,2),
IN OLDACCESS_CARD VARCHAR(7),
IN NEWACCESS_CARD VARCHAR(7),
IN OLDACCESS_ACTIVE CHAR(6),
IN NEWACCESS_ACTIVE CHAR(6),
IN OLDACCESS_INVENTORY CHAR(6),
IN NEWACCESS_INVENTORY CHAR(6),
IN OLDACCESS_LOST CHAR(6),
IN NEWACCESS_LOST CHAR(6),
IN OLDURTDID INTEGER,
IN NEWURTDID INTEGER,
IN OLDCOMMENTS TEXT,
IN NEWCOMMENTS TEXT,
IN OLDULDID INTEGER,
IN NEWULDID INTEGER,
IN OLDTIMESTAMP VARCHAR(50),
IN NEWTIMESTAMP VARCHAR(50),
IN TICKLER VARCHAR(30))
BEGIN
	DECLARE OLD_VALUE TEXT DEFAULT '';
	DECLARE NEW_VALUE TEXT DEFAULT '';
	DECLARE MESSAGE_TEXT VARCHAR(100);
	DECLARE CARDNO INTEGER(7);
	DECLARE FLAG INTEGER;
	SET FLAG =0;
	IF(TICKLER='TICKLER_INSERT') THEN
		IF(OLDUSDTID IS NOT NULL AND NEWUSDTID IS NULL) OR (OLDUSDTID IS NULL AND NEWUSDTID IS NOT NULL) OR (OLDUSDTID != NEWUSDTID) OR  
		(OLDSTAMPDUTYDATE IS NOT NULL AND NEWSTAMPDUTYDATE IS NULL) OR (OLDSTAMPDUTYDATE IS NULL AND NEWSTAMPDUTYDATE IS NOT NULL) OR (OLDSTAMPDUTYDATE != NEWSTAMPDUTYDATE) OR 
		(OLDSTAMPDUTYAMT IS NOT NULL AND NEWSTAMPDUTYAMT IS NULL) OR (OLDSTAMPDUTYAMT IS NULL AND NEWSTAMPDUTYAMT IS NOT NULL) OR (OLDSTAMPDUTYAMT != NEWSTAMPDUTYAMT) OR
		(OLDACCESS_CARD IS NOT NULL AND NEWACCESS_CARD IS NULL) OR (OLDACCESS_CARD IS NULL AND NEWACCESS_CARD IS NOT NULL) OR (OLDACCESS_CARD != NEWACCESS_CARD) OR (OLDACCESS_ACTIVE != NEWACCESS_ACTIVE) OR
		(OLDACCESS_INVENTORY IS NOT NULL AND NEWACCESS_INVENTORY IS NULL) OR (OLDACCESS_INVENTORY IS NULL AND NEWACCESS_INVENTORY IS NOT NULL) OR (OLDACCESS_INVENTORY != NEWACCESS_INVENTORY) OR 
		(OLDACCESS_LOST IS NOT NULL AND NEWACCESS_LOST IS NULL) OR (OLDACCESS_LOST IS NULL AND NEWACCESS_LOST IS NOT NULL) OR (OLDACCESS_LOST != NEWACCESS_LOST) OR 
		(OLDURTDID IS NOT NULL AND NEWURTDID IS NULL) OR (OLDURTDID IS NULL AND NEWURTDID IS NOT NULL) OR (OLDURTDID != NEWURTDID) OR
		(OLDCOMMENTS IS NOT NULL AND NEWCOMMENTS IS NULL) OR (OLDCOMMENTS IS NULL AND NEWCOMMENTS IS NOT NULL) OR (OLDCOMMENTS != NEWCOMMENTS)THEN
			IF (UASDID) THEN 
				SET  OLD_VALUE = CONCAT(OLD_VALUE,'UASD_ID=', UASDID,','); 
			END IF;
		END IF;
		IF(OLDACCESS_CARD IS NULL)THEN
			SET OLDACCESS_CARD = '<NULL>';
		ELSE 
			SET OLDACCESS_CARD = OLDACCESS_CARD;
		END IF;
		IF(NEWACCESS_CARD IS NULL)THEN
			SET NEWACCESS_CARD = '<NULL>';
		ELSE
			SET NEWACCESS_CARD = NEWACCESS_CARD;
		END IF;
		IF(OLDACCESS_ACTIVE IS NULL)THEN
			SET OLDACCESS_ACTIVE = '<NULL>';
		ELSE
			SET OLDACCESS_ACTIVE = OLDACCESS_ACTIVE;
		END IF;
		IF(NEWACCESS_ACTIVE IS NULL)THEN
			SET NEWACCESS_ACTIVE = '<NULL>';
		ELSE
			SET NEWACCESS_ACTIVE = NEWACCESS_ACTIVE;
		END IF;
		IF(OLDACCESS_INVENTORY IS NULL)THEN
			SET OLDACCESS_INVENTORY = '<NULL>';
		ELSE
			SET OLDACCESS_INVENTORY = OLDACCESS_INVENTORY;
		END IF;
		IF(NEWACCESS_INVENTORY IS NULL)THEN
			SET NEWACCESS_INVENTORY = '<NULL>';
		ELSE
			SET NEWACCESS_INVENTORY = NEWACCESS_INVENTORY;
		END IF;
		IF(OLDACCESS_LOST IS NULL)THEN
			SET OLDACCESS_LOST = '<NULL>';
		ELSE 
			SET OLDACCESS_LOST = OLDACCESS_LOST;
		END IF;
		IF(NEWACCESS_LOST IS NULL)THEN
			SET NEWACCESS_LOST = '<NULL>';
		ELSE
			SET NEWACCESS_LOST = NEWACCESS_LOST;
		END IF;
		IF(OLDACCESS_ACTIVE IS NULL AND NEWACCESS_ACTIVE IS NOT NULL) OR (OLDACCESS_ACTIVE IS NOT NULL AND NEWACCESS_ACTIVE IS NULL) OR (OLDACCESS_ACTIVE!=NEWACCESS_ACTIVE) OR
		(OLDACCESS_INVENTORY IS NULL AND NEWACCESS_INVENTORY IS NOT NULL) OR (OLDACCESS_INVENTORY IS NOT NULL AND NEWACCESS_INVENTORY IS NULL) OR (OLDACCESS_INVENTORY!=NEWACCESS_INVENTORY) OR
		(OLDACCESS_LOST IS NULL AND NEWACCESS_LOST IS NOT NULL) OR (OLDACCESS_LOST IS NOT NULL AND NEWACCESS_LOST IS NULL) OR (OLDACCESS_LOST!=NEWACCESS_LOST) OR
		(OLDACCESS_CARD!=NEWACCESS_CARD) THEN
			IF (OLDACCESS_CARD IS NULL AND NEWACCESS_CARD IS NOT NULL) THEN
				SET OLD_VALUE=CONCAT(OLD_VALUE,'UASD_ACCESS_CARD=','<NULL>,');
			ELSEIF (OLDACCESS_CARD IS NOT NULL AND NEWACCESS_CARD IS NULL) THEN
				SET OLD_VALUE=CONCAT(OLD_VALUE,'UASD_ACCESS_CARD=',OLDACCESS_CARD,',');
			ELSEIF (OLDACCESS_CARD = NEWACCESS_CARD) THEN 
				SET OLD_VALUE = CONCAT(OLD_VALUE,'UASD_ACCESS_CARD=', OLDACCESS_CARD,','); 
			ELSEIF (OLDACCESS_CARD != NEWACCESS_CARD) THEN 
				SET OLD_VALUE = CONCAT(OLD_VALUE,'UASD_ACCESS_CARD=', OLDACCESS_CARD,',');
			END IF;
		END IF;
		IF (OLDUNITID!= NEWUNITID) THEN 
			SET  OLD_VALUE = CONCAT(OLD_VALUE,'UNIT_ID=', OLDUNITID,','); 
		END IF;
		IF (OLDUNITID!= NEWUNITID) THEN 
			SET  NEW_VALUE = CONCAT(NEW_VALUE,'UNIT_ID=', NEWUNITID,','); 
		END IF;
		IF (OLDUSDTID IS NULL AND NEWUSDTID IS NOT NULL) THEN
			SET OLD_VALUE=CONCAT(OLD_VALUE,'USDT_ID=','<NULL>,');
			SET NEW_VALUE=CONCAT(NEW_VALUE,'USDT_ID=',NEWUSDTID,',');
		ELSEIF (OLDUSDTID IS NOT NULL AND NEWUSDTID IS NULL) THEN
			SET OLD_VALUE=CONCAT(OLD_VALUE,'USDT_ID=',OLDUSDTID,',');
			SET NEW_VALUE=CONCAT(NEW_VALUE,'USDT_ID=','<NULL>,');
		ELSEIF (OLDUSDTID!= NEWUSDTID) THEN 
			SET OLD_VALUE = CONCAT(OLD_VALUE,'USDT_ID=', OLDUSDTID,','); 
			SET NEW_VALUE = CONCAT(NEW_VALUE,'USDT_ID=', NEWUSDTID,','); 
		END IF;
		IF (OLDSTAMPDUTYDATE IS NULL AND NEWSTAMPDUTYDATE IS NOT NULL) THEN
			SET OLD_VALUE=CONCAT(OLD_VALUE,'UASD_STAMPDUTYDATE=','<NULL>,');
			SET NEW_VALUE=CONCAT(NEW_VALUE,'UASD_STAMPDUTYDATE=',NEWSTAMPDUTYDATE,',');
		ELSEIF (OLDSTAMPDUTYDATE IS NOT NULL AND NEWSTAMPDUTYDATE IS NULL) THEN
			SET OLD_VALUE=CONCAT(OLD_VALUE,'UASD_STAMPDUTYDATE=',OLDSTAMPDUTYDATE,',');
			SET NEW_VALUE=CONCAT(NEW_VALUE,'UASD_STAMPDUTYDATE=','<NULL>,');
		ELSEIF (OLDSTAMPDUTYDATE!= NEWSTAMPDUTYDATE) THEN 
			SET OLD_VALUE = CONCAT(OLD_VALUE,'UASD_STAMPDUTYDATE=', OLDSTAMPDUTYDATE,','); 
			SET NEW_VALUE = CONCAT(NEW_VALUE,'UASD_STAMPDUTYDATE=', NEWSTAMPDUTYDATE,','); 
		END IF;
		IF (OLDSTAMPDUTYAMT IS NULL AND NEWSTAMPDUTYAMT IS NOT NULL) THEN
			SET OLD_VALUE=CONCAT(OLD_VALUE,'UASD_STAMPDUTYAMT=','<NULL>,');
			SET NEW_VALUE=CONCAT(NEW_VALUE,'UASD_STAMPDUTYAMT=',NEWSTAMPDUTYAMT,',');
		ELSEIF (OLDSTAMPDUTYAMT IS NOT NULL AND NEWSTAMPDUTYAMT IS NULL) THEN
			SET OLD_VALUE=CONCAT(OLD_VALUE,'UASD_STAMPDUTYAMT=',OLDSTAMPDUTYAMT,',');
			SET NEW_VALUE=CONCAT(NEW_VALUE,'UASD_STAMPDUTYAMT=','<NULL>,');
		ELSEIF (OLDSTAMPDUTYAMT!= NEWSTAMPDUTYAMT) THEN 
			SET OLD_VALUE = CONCAT(OLD_VALUE,'UASD_STAMPDUTYAMT=', OLDSTAMPDUTYAMT,','); 
			SET NEW_VALUE = CONCAT(NEW_VALUE,'UASD_STAMPDUTYAMT=', NEWSTAMPDUTYAMT,','); 
		END IF;
		IF (OLDACCESS_CARD IS NULL AND NEWACCESS_CARD IS NOT NULL) THEN
				SET NEW_VALUE=CONCAT(NEW_VALUE,'UASD_ACCESS_CARD=',NEWACCESS_CARD,',');
			ELSEIF (OLDACCESS_CARD IS NOT NULL AND NEWACCESS_CARD IS NULL) THEN
				SET NEW_VALUE=CONCAT(NEW_VALUE,'UASD_ACCESS_CARD=','<NULL>,');
			ELSEIF(OLDACCESS_CARD!= NEWACCESS_CARD) THEN
				SET NEW_VALUE = CONCAT(NEW_VALUE,'UASD_ACCESS_CARD=', NEWACCESS_CARD,','); 
		END IF;
		IF (OLDACCESS_ACTIVE IS NULL AND NEWACCESS_ACTIVE IS NOT NULL) THEN
			SET OLD_VALUE=CONCAT(OLD_VALUE,'UASD_ACCESS_ACTIVE=','<NULL>,');
			SET NEW_VALUE=CONCAT(NEW_VALUE,'UASD_ACCESS_ACTIVE=',NEWACCESS_ACTIVE,',');
		ELSEIF (OLDACCESS_ACTIVE IS NOT NULL AND NEWACCESS_ACTIVE IS NULL) THEN
			SET OLD_VALUE=CONCAT(OLD_VALUE,'UASD_ACCESS_ACTIVE=',OLDACCESS_ACTIVE,',');
			SET NEW_VALUE=CONCAT(NEW_VALUE,'UASD_ACCESS_ACTIVE=','<NULL>,');
		ELSEIF (OLDACCESS_ACTIVE!= NEWACCESS_ACTIVE) THEN 
			SET OLD_VALUE=CONCAT(OLD_VALUE,'UASD_ACCESS_ACTIVE=',OLDACCESS_ACTIVE,',');
			SET NEW_VALUE = CONCAT(NEW_VALUE,'UASD_ACCESS_ACTIVE=', NEWACCESS_ACTIVE,','); 
		END IF;
		IF (OLDACCESS_INVENTORY IS NULL AND NEWACCESS_INVENTORY IS NOT NULL) THEN
			SET OLD_VALUE=CONCAT(OLD_VALUE,'UASD_ACCESS_INVENTORY=','<NULL>,');
			SET NEW_VALUE=CONCAT(NEW_VALUE,'UASD_ACCESS_INVENTORY=',NEWACCESS_INVENTORY,',');
		ELSEIF (OLDACCESS_INVENTORY IS NOT NULL AND NEWACCESS_INVENTORY IS NULL) THEN
			SET OLD_VALUE=CONCAT(OLD_VALUE,'UASD_ACCESS_INVENTORY=',OLDACCESS_INVENTORY,',');
			SET NEW_VALUE=CONCAT(NEW_VALUE,'UASD_ACCESS_INVENTORY=','<NULL>,');
		ELSEIF (OLDACCESS_INVENTORY!= NEWACCESS_INVENTORY) THEN 
			SET OLD_VALUE = CONCAT(OLD_VALUE,'UASD_ACCESS_INVENTORY=', OLDACCESS_INVENTORY,','); 
			SET NEW_VALUE = CONCAT(NEW_VALUE,'UASD_ACCESS_INVENTORY=', NEWACCESS_INVENTORY,','); 
		END IF;
		IF (OLDACCESS_LOST IS NULL AND NEWACCESS_LOST IS NOT NULL) THEN
			SET OLD_VALUE=CONCAT(OLD_VALUE,'UASD_ACCESS_LOST=','<NULL>,');
			SET NEW_VALUE=CONCAT(NEW_VALUE,'UASD_ACCESS_LOST=',NEWACCESS_LOST,',');
		ELSEIF (OLDACCESS_LOST IS NOT NULL AND NEWACCESS_LOST IS NULL) THEN
			SET OLD_VALUE=CONCAT(OLD_VALUE,'UASD_ACCESS_LOST=',OLDACCESS_LOST,',');
			SET NEW_VALUE=CONCAT(NEW_VALUE,'UASD_ACCESS_LOST=','<NULL>,');
		ELSEIF (OLDACCESS_LOST!= NEWACCESS_LOST) THEN 
			SET OLD_VALUE = CONCAT(OLD_VALUE,'UASD_ACCESS_LOST=', OLDACCESS_LOST,','); 
			SET NEW_VALUE = CONCAT(NEW_VALUE,'UASD_ACCESS_LOST=', NEWACCESS_LOST,','); 
		END IF;
		IF (OLDURTDID IS NULL AND NEWURTDID IS NOT NULL) THEN
			SET OLD_VALUE=CONCAT(OLD_VALUE,'URTD_ID=','<NULL>,');
			SET NEW_VALUE=CONCAT(NEW_VALUE,'URTD_ID=',NEWURTDID,',');
		ELSEIF (OLDURTDID IS NOT NULL AND NEWURTDID IS NULL) THEN
			SET OLD_VALUE=CONCAT(OLD_VALUE,'URTD_ID=',OLDURTDID,',');
			SET NEW_VALUE=CONCAT(NEW_VALUE,'URTD_ID=','<NULL>,');
		ELSEIF (OLDURTDID!= NEWURTDID) THEN 
			SET OLD_VALUE = CONCAT(OLD_VALUE,'URTD_ID=', OLDURTDID,','); 
			SET NEW_VALUE = CONCAT(NEW_VALUE,'URTD_ID=', NEWURTDID,','); 
		END IF;
		IF (OLDCOMMENTS IS NULL AND NEWCOMMENTS IS NOT NULL) THEN
			SET OLD_VALUE=CONCAT(OLD_VALUE,'UASD_COMMENTS=','<NULL>,');
			SET NEW_VALUE=CONCAT(NEW_VALUE,'UASD_COMMENTS=',NEWCOMMENTS,',');
		ELSEIF (OLDCOMMENTS IS NOT NULL AND NEWCOMMENTS IS NULL) THEN
			SET OLD_VALUE=CONCAT(OLD_VALUE,'UASD_COMMENTS=',OLDCOMMENTS,',');
			SET NEW_VALUE=CONCAT(NEW_VALUE,'UASD_COMMENTS=','<NULL>,');
		ELSEIF (OLDCOMMENTS!= NEWCOMMENTS) THEN 
			SET OLD_VALUE = CONCAT(OLD_VALUE,'UASD_COMMENTS=', OLDCOMMENTS,','); 
			SET NEW_VALUE = CONCAT(NEW_VALUE,'UASD_COMMENTS=', NEWCOMMENTS,','); 
		END IF;
		IF(OLDUSDTID IS NOT NULL AND NEWUSDTID IS NULL) OR (OLDUSDTID IS NULL AND NEWUSDTID IS NOT NULL) OR (OLDUSDTID != NEWUSDTID) OR  
		(OLDSTAMPDUTYDATE IS NOT NULL AND NEWSTAMPDUTYDATE IS NULL) OR (OLDSTAMPDUTYDATE IS NULL AND NEWSTAMPDUTYDATE IS NOT NULL) OR (OLDSTAMPDUTYDATE != NEWSTAMPDUTYDATE) OR 
		(OLDSTAMPDUTYAMT IS NOT NULL AND NEWSTAMPDUTYAMT IS NULL) OR (OLDSTAMPDUTYAMT IS NULL AND NEWSTAMPDUTYAMT IS NOT NULL) OR (OLDSTAMPDUTYAMT != NEWSTAMPDUTYAMT) OR
		(OLDACCESS_CARD IS NOT NULL AND NEWACCESS_CARD IS NULL) OR (OLDACCESS_CARD IS NULL AND NEWACCESS_CARD IS NOT NULL) OR (OLDACCESS_CARD != NEWACCESS_CARD) OR (OLDACCESS_ACTIVE != NEWACCESS_ACTIVE) OR
		(OLDACCESS_INVENTORY IS NOT NULL AND NEWACCESS_INVENTORY IS NULL) OR (OLDACCESS_INVENTORY IS NULL AND NEWACCESS_INVENTORY IS NOT NULL) OR (OLDACCESS_INVENTORY != NEWACCESS_INVENTORY) OR 
		(OLDACCESS_LOST IS NOT NULL AND NEWACCESS_LOST IS NULL) OR (OLDACCESS_LOST IS NULL AND NEWACCESS_LOST IS NOT NULL) OR (OLDACCESS_LOST != NEWACCESS_LOST) OR 
		(OLDURTDID IS NOT NULL AND NEWURTDID IS NULL) OR (OLDURTDID IS NULL AND NEWURTDID IS NOT NULL) OR (OLDURTDID != NEWURTDID) OR
		(OLDCOMMENTS IS NOT NULL AND NEWCOMMENTS IS NULL) OR (OLDCOMMENTS IS NULL AND NEWCOMMENTS IS NOT NULL) OR (OLDCOMMENTS != NEWCOMMENTS)THEN
			IF (OLDULDID!= NEWULDID) THEN 
				SET OLD_VALUE = CONCAT(OLD_VALUE,'ULD_ID=', OLDULDID,','); 
			END IF;
			IF (OLDTIMESTAMP!= NEWTIMESTAMP) THEN  
				SET  OLD_VALUE = CONCAT(OLD_VALUE,'UASD_TIMESTAMP=', OLDTIMESTAMP,','); 
			END IF;
		END IF;
		IF (OLD_VALUE!='' AND NEW_VALUE!='') THEN
			IF(OLD_VALUE!=NEW_VALUE)THEN
				SET OLD_VALUE = SUBSTRING(OLD_VALUE,1,CHAR_LENGTH(OLD_VALUE)-1);
				SET NEW_VALUE = SUBSTRING(NEW_VALUE,1,CHAR_LENGTH(NEW_VALUE)-1);
				INSERT INTO TICKLER_HISTORY
				(ULD_ID,TP_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE)VALUES
				((SELECT ULD_ID FROM UNIT_ACCESS_STAMP_DETAILS  WHERE UASD_ID=UASDID),
				(SELECT TP_ID FROM TICKLER_PROFILE WHERE TP_TYPE='UPDATION'),
				(SELECT TTIP_ID FROM TICKLER_TABID_PROFILE WHERE TTIP_DATA='UNIT_ACCESS_STAMP_DETAILS'),OLD_VALUE,NEW_VALUE);
			END IF;
		END IF;
	END IF;
	IF(TICKLER='INSERT') THEN
		IF EXISTS (SELECT USDT_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE USDT_ID=NEWUSDTID AND UNIT_ID=NEWUNITID)THEN
			SIGNAL SQLSTATE '45000'
			SET MESSAGE_TEXT= 'CAN NOT INSERT USDT_ID ';
		END IF;
		IF EXISTS (SELECT URTD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE URTD_ID=NEWURTDID AND UNIT_ID=NEWUNITID)THEN
			SIGNAL SQLSTATE '45000'
			SET MESSAGE_TEXT='CAN NOT INSERT URTD_ID ';
		END IF;
		IF CHAR_LENGTH( NEWACCESS_CARD )>7 THEN
			SIGNAL SQLSTATE '45000'
			SET MESSAGE_TEXT=' ACCESS CARD MUST BE MAXMIMUM 7 DIGITS  ';
        END IF;
	END IF;
	IF(TICKLER='UPDATE') THEN
		IF NEWUSDTID IS NOT NULL THEN
			IF (SELECT COUNT(USDT_ID) FROM UNIT_ACCESS_STAMP_DETAILS WHERE USDT_ID=NEWUSDTID AND UNIT_ID=NEWUNITID AND UASD_ID!=UASDID)>0 THEN
				SIGNAL SQLSTATE '45000'
				SET MESSAGE_TEXT= 'CAN NOT UPDATE USDT_ID';
			END IF; 
		END IF;
		IF NEWURTDID IS NOT NULL THEN
			IF (SELECT COUNT(URTD_ID) FROM UNIT_ACCESS_STAMP_DETAILS WHERE URTD_ID=NEWURTDID AND UNIT_ID=NEWUNITID AND UASD_ID!=UASDID)>0 THEN
				SIGNAL SQLSTATE '45000'
				SET MESSAGE_TEXT= 'CAN NOT UPDATE URDT_ID';
			END IF;
		END IF;
		IF CHAR_LENGTH( NEWACCESS_CARD )>7 THEN
			SIGNAL SQLSTATE '45000'
			SET MESSAGE_TEXT= 'ACCESS CARD MUST BE MAXMIMUM 7 DIGITS ';
        END IF;
	END IF;
END;