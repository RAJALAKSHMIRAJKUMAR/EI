DROP PROCEDURE IF EXISTS SP_DD_FLD_CARD_CALCULATION;
CREATE PROCEDURE SP_DD_FLD_CARD_CALCULATION(
IN ID INTEGER,
IN STARTDATE DATE,
IN ENDDATE DATE,
IN REC_VER INTEGER,
IN TEMP_DD_CALCULATION TEXT,
OUT ACC_COUNT INT,
OUT AMOUNT INT)
BEGIN
DECLARE EXIT HANDLER FOR SQLEXCEPTION
BEGIN 
	ROLLBACK; 
END;
START TRANSACTION;
SET ACC_COUNT = (SELECT COUNT(ACN_ID) FROM CUSTOMER_ACCESS_CARD_DETAILS WHERE  ACN_ID BETWEEN 1 AND 3 AND CACD_VALID_TILL BETWEEN STARTDATE AND ENDDATE AND CUSTOMER_ID=ID);
SET AMOUNT = ACC_COUNT * 50;
IF ACC_COUNT!=0 THEN
			SET @DD_CALC_INSERT_CARDTILLDATE=(SELECT CONCAT('INSERT INTO ',TEMP_DD_CALCULATION ,'(DDCARDTILLDATE,DDRECVER) SELECT CUSTOMER_ACCESS_CARD_DETAILS.CACD_VALID_TILL,',REC_VER,' FROM CUSTOMER_ACCESS_CARD_DETAILS WHERE  ACN_ID BETWEEN 1 AND 3 AND CACD_VALID_TILL BETWEEN ' ,'"',STARTDATE,'"',' AND ' ,'"',ENDDATE,'"',' AND CUSTOMER_ID=',ID));
			PREPARE DD_CALC_INSERT_CARDTILLDATE_STMT FROM @DD_CALC_INSERT_CARDTILLDATE;
			EXECUTE DD_CALC_INSERT_CARDTILLDATE_STMT;
END IF;
COMMIT;
END;