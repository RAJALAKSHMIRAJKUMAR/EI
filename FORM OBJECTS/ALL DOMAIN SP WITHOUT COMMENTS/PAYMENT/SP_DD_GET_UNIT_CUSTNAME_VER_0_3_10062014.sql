DROP PROCEDURE IF EXISTS SP_DD_GET_UNIT_CUSTNAME;
CREATE PROCEDURE SP_DD_GET_UNIT_CUSTNAME(USERSTAMP VARCHAR(50),OUT DD_UNIT_CUST_TEMPTBLNAME TEXT)
BEGIN
DECLARE DD_TEMPTBLNAME TEXT;
DECLARE USERSTAMP_ID INT;
DECLARE EXIT HANDLER FOR SQLEXCEPTION
BEGIN 
    ROLLBACK; 
END;
START TRANSACTION;
CALL SP_CHANGE_USERSTAMP_AS_ULDID(USERSTAMP,@ULDID);
SET USERSTAMP_ID=(SELECT @ULDID);
SET DD_TEMPTBLNAME=(SELECT CONCAT('TEMP_TABLE_DD_GET_UNIT_CUSTNAME_',SYSDATE()));
SET DD_TEMPTBLNAME=(SELECT REPLACE(DD_TEMPTBLNAME,' ',''));
SET DD_TEMPTBLNAME=(SELECT REPLACE(DD_TEMPTBLNAME,'-',''));
SET DD_TEMPTBLNAME=(SELECT REPLACE(DD_TEMPTBLNAME,':',''));
SET DD_UNIT_CUST_TEMPTBLNAME=(SELECT CONCAT(DD_TEMPTBLNAME,'_',USERSTAMP_ID)); 
SET @TEMP_TABLE_DD_GET_UNIT_CUSTNAME=(SELECT CONCAT('CREATE TABLE ',DD_UNIT_CUST_TEMPTBLNAME,'
(ID INTEGER AUTO_INCREMENT PRIMARY KEY,CUSTOMER_ID INTEGER,UNIT_NO SMALLINT(4) UNSIGNED ZEROFILL,CUSTOMER_NAME VARCHAR(200))'));
PREPARE TEMP_DD_GET_UNIT_CUSTNAME FROM @TEMP_TABLE_DD_GET_UNIT_CUSTNAME;
EXECUTE TEMP_DD_GET_UNIT_CUSTNAME;
   SET @INSERT_TEMP_DD_PAYMENT=(SELECT CONCAT('INSERT INTO ',DD_UNIT_CUST_TEMPTBLNAME,' (UNIT_NO,CUSTOMER_ID,CUSTOMER_NAME) SELECT DISTINCT U.UNIT_NO,CED.CUSTOMER_ID,CONCAT(C.CUSTOMER_FIRST_NAME," ",C.CUSTOMER_LAST_NAME) AS NAME FROM PAYMENT_DETAILS PD,UNIT U,CUSTOMER C,CUSTOMER_ENTRY_DETAILS CED WHERE U.UNIT_ID=PD.UNIT_ID AND  C.CUSTOMER_ID=PD.CUSTOMER_ID AND CED.CUSTOMER_ID=PD.CUSTOMER_ID AND CED.CED_REC_VER=PD.CED_REC_VER ORDER BY PD.CUSTOMER_ID,PD.UNIT_ID'));
   PREPARE INSERT_TEMP_PAYMENT_STMT FROM @INSERT_TEMP_DD_PAYMENT;
   EXECUTE INSERT_TEMP_PAYMENT_STMT;
   SET @INSERT_TEMP_DD_UNITEXP=(SELECT CONCAT('INSERT INTO ',DD_UNIT_CUST_TEMPTBLNAME,' (UNIT_NO,CUSTOMER_ID,CUSTOMER_NAME) SELECT DISTINCT U.UNIT_NO,CED.CUSTOMER_ID,CONCAT(C.CUSTOMER_FIRST_NAME," ",C.CUSTOMER_LAST_NAME) AS NAME FROM EXPENSE_UNIT EU,UNIT U,CUSTOMER C,CUSTOMER_ENTRY_DETAILS CED WHERE U.UNIT_ID=EU.UNIT_ID  AND C.CUSTOMER_ID=EU.CUSTOMER_ID AND CED.CUSTOMER_ID=EU.CUSTOMER_ID ORDER BY EU.CUSTOMER_ID,EU.UNIT_ID'));
   PREPARE INSERT_TEMP_UNITEXP_STMT FROM @INSERT_TEMP_DD_UNITEXP;
   EXECUTE INSERT_TEMP_UNITEXP_STMT;
   SET @INSERT_TEMP_DD_CARD=(SELECT CONCAT('INSERT INTO ',DD_UNIT_CUST_TEMPTBLNAME,' (UNIT_NO,CUSTOMER_ID,CUSTOMER_NAME) SELECT DISTINCT U.UNIT_NO,CED.CUSTOMER_ID,CONCAT(C.CUSTOMER_FIRST_NAME," ",C.CUSTOMER_LAST_NAME) AS NAME FROM CUSTOMER_ACCESS_CARD_DETAILS CACD,CUSTOMER_ENTRY_DETAILS CED,UNIT U,CUSTOMER C WHERE ACN_ID!=4 AND CACD.CUSTOMER_ID=CED.CUSTOMER_ID AND C.CUSTOMER_ID=CACD.CUSTOMER_ID AND U.UNIT_ID=CED.UNIT_ID'));
   PREPARE INSERT_TEMP_CARD_TRANSACTION FROM @INSERT_TEMP_DD_CARD;
   EXECUTE INSERT_TEMP_CARD_TRANSACTION;
COMMIT;
END;