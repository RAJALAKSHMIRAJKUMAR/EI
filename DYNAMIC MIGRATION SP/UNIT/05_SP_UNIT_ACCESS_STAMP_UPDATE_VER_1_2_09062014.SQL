--version:1.2 --sdate:09/06/2014 --edate:09/06/2014 --desc:IMPLEMENTING ROLLBACK AND COMMIT --done by:BHAVANI.R --issue:566
--  version:1.1 --  sadte:17/05/2014 --  edate:17/05/2014 --  issue:803 -- desc:UNIT_ACCESS_STAMP_DETAILS TABLE CHANGED AS TEMP_UNIT_ACCESS_STAMP_DETAILS --  doneby:RL
--  version:1.0 --  sadte:20/03/2014 --  edate:20/03/2014 --  issue:765 --  commentno:8 --  desc:dynamically get source nd destination schema --  doneby:RL
--   version:0.9 --   sdate:17/03/2014 --   edate:17/03/2014 --   issue:765 --  desc:droped temp table --  doneby:RL
--  version:0.8 --  sdate:14/03/2014 --  edate:14/03/2014 --  issue:750 --  desc:added comments in unit_access_stamp_details --  doneby:RL
--  version:0.7 --  sdate:26/02/2014 --  edate:26/02/2014 --  issue:750 --  desc:uld_id datatype intger changed as integer(2) --  doneby:RL

DROP PROCEDURE IF EXISTS SP_UNIT_ACCESS_STAMP_UPDATE;
CREATE PROCEDURE SP_UNIT_ACCESS_STAMP_UPDATE(IN DESTINATIONSCHEMA VARCHAR(50))
BEGIN
		DECLARE MINUASDID INTEGER;
		DECLARE MAXUASDID INTEGER;
		DECLARE MIN_UASDID INTEGER;
		DECLARE MAX_UASDID INTEGER;
		DECLARE ROOMTYPEID INTEGER;
		DECLARE STAMPTYPEID INTEGER;
		DECLARE ID_UNIT INTEGER;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
BEGIN 
ROLLBACK;
END;
START TRANSACTION;
		SET @MINID =(SELECT CONCAT('SELECT MIN(UASD_ID)INTO @UASD_MIN_ID FROM ',DESTINATIONSCHEMA,'.TEMP_UNIT_ACCESS_STAMP_DETAILS'));
		PREPARE MINIDSTMT FROM @MINID;
		EXECUTE MINIDSTMT;
		SET MINUASDID = @UASD_MIN_ID;
		SET @MAXID =(SELECT CONCAT('SELECT MAX(UASD_ID)INTO @UASD_MAX_ID FROM ',DESTINATIONSCHEMA,'.TEMP_UNIT_ACCESS_STAMP_DETAILS'));
		PREPARE MAXIDSTMT FROM @MAXID;
		EXECUTE MAXIDSTMT;
		SET MAXUASDID = @UASD_MAX_ID;
		WHILE (MINUASDID <= MAXUASDID) DO
			SET @IDUNIT = NULL;
			SET @URTDID = NULL;
			SET @USDTID = NULL;
			SET @UNITID = (SELECT CONCAT('SELECT UNIT_ID INTO @IDUNIT FROM ',DESTINATIONSCHEMA,'.TEMP_UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ID=',MINUASDID));
			PREPARE UNITIDSTMT FROM @UNITID;
			EXECUTE UNITIDSTMT;
			SET @ROOMID = (SELECT CONCAT('SELECT URTD_ID INTO @URTDID FROM ',DESTINATIONSCHEMA,'.TEMP_UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ID=',MINUASDID));
			PREPARE ROOMIDSTMT FROM @ROOMID;
			EXECUTE ROOMIDSTMT;
			SET @STAMPID = (SELECT CONCAT('SELECT USDT_ID INTO @USDTID FROM ',DESTINATIONSCHEMA,'.TEMP_UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ID=',MINUASDID));
			PREPARE STAMPIDSTMT FROM @STAMPID;
			EXECUTE STAMPIDSTMT;
			SET ROOMTYPEID = @URTDID;
			SET ID_UNIT = @IDUNIT;
			SET STAMPTYPEID = @USDTID;
			IF(ROOMTYPEID IS NOT NULL)THEN
				SET MIN_UASDID = MINUASDID+1;
				SET MAX_UASDID = MAXUASDID;
				WHILE(MIN_UASDID <= MAX_UASDID)DO
						SET @UPDATEUASD = (SELECT CONCAT('UPDATE ',DESTINATIONSCHEMA,'.TEMP_UNIT_ACCESS_STAMP_DETAILS SET URTD_ID=NULL WHERE 
						URTD_ID=',ROOMTYPEID,' AND UNIT_ID=',ID_UNIT,' AND UASD_ID=',MIN_UASDID));
						PREPARE UPDATEUASDSTMT FROM @UPDATEUASD;
						EXECUTE UPDATEUASDSTMT;
						SET MIN_UASDID = MIN_UASDID+1;
				END WHILE;
			END IF;
			IF(STAMPTYPEID IS NOT NULL)THEN
				SET MIN_UASDID = MINUASDID+1;
				SET MAX_UASDID = MAXUASDID;
				WHILE(MIN_UASDID <= MAX_UASDID)DO
					SET @UPDATEUSDT = (SELECT CONCAT('UPDATE ',DESTINATIONSCHEMA,'.TEMP_UNIT_ACCESS_STAMP_DETAILS SET USDT_ID=NULL WHERE 
					USDT_ID=',STAMPTYPEID,' AND UNIT_ID=',ID_UNIT,' AND UASD_ID=',MIN_UASDID));
					PREPARE UPDATEUSDTSTMT FROM @UPDATEUSDT;
					EXECUTE UPDATEUSDTSTMT;
					SET MIN_UASDID = MIN_UASDID+1;
				END WHILE;
			END IF;
		SET MINUASDID = MINUASDID+1;
		END WHILE;
    COMMIT;
END;
