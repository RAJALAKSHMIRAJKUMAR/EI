--version:1.2 --sdate:09/06/2014 --edate:09/06/2014 --desc:IMPLEMENTING ROLLBACK AND COMMIT --done by:BHAVANI.R --issue:566
-- version:1.1 -- sadte:21/04/2014 -- edate:21/04/2014 -- issue:765 -- desc: updated timestamp  -- doneby:sasikala
-- version:1.0 -- sadte:17/03/2014 -- edate:17/03/2014 -- issue:765 -- commentno:8 -- desc:dynamically get source nd destination schema -- doneby:RL
--  version:0.9 --  sdate:17/03/2014 --  edate:17/03/2014 --  issue:765 -- desc:droped temp table -- doneby:RL
-- version:0.8 -- sdate:14/03/2014 -- edate:14/03/2014 -- issue:750 -- desc:added comments in unit_access_stamp_details -- doneby:RL
-- version:0.7 -- sdate:26/02/2014 -- edate:26/02/2014 -- issue:750 -- desc:uld_id datatype intger changed as integer(2) -- doneby:RL
DROP PROCEDURE IF EXISTS SP_TEMP_UNIT_SCDB_FORMAT;
CREATE PROCEDURE SP_TEMP_UNIT_SCDB_FORMAT(IN SOURCESCHEMA VARCHAR(50),IN DESTINATIONSCHEMA VARCHAR(50))
BEGIN
DECLARE EXIT HANDLER FOR SQLEXCEPTION
BEGIN 
ROLLBACK;
END;
START TRANSACTION;
-- QUERY FOR CREATE TEMP_UNIT_SCDB_FORMAT TABLE
	SET @TEMP_UNITSCDB_DROPQUERY=(SELECT CONCAT('DROP TABLE IF EXISTS ',DESTINATIONSCHEMA,'.TEMP_UNIT_SCDB_FORMAT'));
	PREPARE TEMP_UNITSCDB_DROPSTMT FROM @TEMP_UNITSCDB_DROPQUERY;
	EXECUTE TEMP_UNITSCDB_DROPSTMT;

	SET @TEMP_UNITSCDB_CREATEQUERY=(SELECT CONCAT('CREATE TABLE ',DESTINATIONSCHEMA,'.TEMP_UNIT_SCDB_FORMAT(
    LIKE ',SOURCESCHEMA,'.UNIT_SCDB_FORMAT)'));
	PREPARE TEMP_UNITSCDB_CREATESTMT FROM @TEMP_UNITSCDB_CREATEQUERY;
	EXECUTE TEMP_UNITSCDB_CREATESTMT;
	
-- INSERT QUERY FOR  TEMP_UNIT_SCDB_FORMAT TABLE
	SET @TEMP_UNITSCDB_INSERTQUERY=(SELECT CONCAT('INSERT INTO ',DESTINATIONSCHEMA,'.TEMP_UNIT_SCDB_FORMAT SELECT * FROM ',SOURCESCHEMA,'.UNIT_SCDB_FORMAT'));
	PREPARE TEMP_UNIT_SCDB_INSERTSTMT FROM @TEMP_UNITSCDB_INSERTQUERY;
	EXECUTE TEMP_UNIT_SCDB_INSERTSTMT;
	
-- UPDATE QUERY FOR CREATE TEMP_UNIT_SCDB_FORMAT TABLE
	SET @UPDATEStudio1=(SELECT CONCAT('UPDATE ',DESTINATIONSCHEMA,'.TEMP_UNIT_SCDB_FORMAT SET UNIT_ROOM_TYPE=',"'Studio1'",' WHERE UNIT_ROOM_TYPE=',"'STUDIO 1'"));
	PREPARE UPDATEStudio1STMT FROM @UPDATEStudio1;
	EXECUTE UPDATEStudio1STMT;

	SET @UPDATEStudio2=(SELECT CONCAT('UPDATE ',DESTINATIONSCHEMA,'.TEMP_UNIT_SCDB_FORMAT SET UNIT_ROOM_TYPE=',"'Studio2'",' WHERE UNIT_ROOM_TYPE=',"'STUDIO 2'"));
	PREPARE UPDATEStudio2STMT FROM @UPDATEStudio2;
	EXECUTE UPDATEStudio2STMT;
	SET @UPDATETIMESTAMP=(SELECT CONCAT('UPDATE ',DESTINATIONSCHEMA,'.TEMP_UNIT_SCDB_FORMAT SET TIMESTAMP=(SELECT CONVERT_TZ(TIMESTAMP, "+08:00","+0:00"))'));
PREPARE UPDATETIMESTAMPSTMT FROM @UPDATETIMESTAMP;
EXECUTE UPDATETIMESTAMPSTMT;
COMMIT;
END; 
