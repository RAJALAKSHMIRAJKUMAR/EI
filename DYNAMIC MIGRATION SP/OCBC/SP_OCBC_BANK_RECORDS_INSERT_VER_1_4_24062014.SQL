--version:1.4 --sdate:24/06/2014 --edate:24/06/2014 --issue:805 --COMMENT:36 --DESC:added unique constrinats in OBR_REF_ID  COLUMN --doneby:RL
--version:1.3 --sdate:19/06/2014 --edate:19/06/2014 --issue:805 --COMMENT:26,28 --DESC:CHANGED OBR_CURRENCY AND OBR_ACCOUNT_NUMBER DATA TYPE AS INT.
-- OBR_CURRENCY,OBR_ACCOUNT_NUMBER DATA'S insert in OCBC_CONFIGURATION TABLE.AND THESE TWO DATA ID'S NEED TO INSERT IN MAIN OCBC_BANK_RECORDS TABLE CHANGE OBR_TRX_CODE HEADER CHANGED AS OCN_ID DATATYPE ALSO VARCHAR TO INT.--DONE BY:RL
--version:1.2 --sdate:09/06/2014 --edate:09/06/2014 --issue:566 --COMMENT:12 --DESC:IMPLEMETING COMMIT AND ROLLBACK DONE BY:BHAVANI.R
--version:1.1 --sdate:23/04/2014 --edate:23/04/2014 --issue:805--COMMENT:18 --DESC:chaged timestamp datatype as varchar DONE BY:RL
 --version:1.0 --sdate:22/04/2014 --edate:22/04/2014 --issue:765--COMMENT:93 --DESC:UPDATED TIMESTAMP DONE BY:raghu
--version:0.9 --sdate:17/04/2014 --edate:17/04/2014 --issue:805 --
-- version:0.8 -- sdate:10-04-2014 -- edate:10-04-2014 -- issue:805 -- desc:changing header names --done by:RL
-- version:0.7 -- sdate:29-03-2014 -- edate:29-03-2014 -- issue:765 -- comment:#8 -- desc:changing the schema in insertion of podt_audit_history -- done by:Bhavani.R
-- version:0.6 -- sdate:19/03/2014 -- edate:19/03/2014 -- issue:765  --COMMENTNO:#8 --desc:CHANGING SP SP_OCBC_BANK_RECORDS_INSERT FOR DYNAMIC PURPOSE AS PREPARED STATEMENTS  --doneby:BHAVANI.R
-- version:0.5 -- sdate:17/03/2014 -- edate:17/03/2014 -- issue:765 --desc:droped temp table --doneby:RL
--version:0.4 --sdate:26/02/2014 --edate:26/02/2014 --issue:750 --desc:userstamp changed as uld_id --doneny:RL
--version:0.3 --sdate:22/02/2014 --edate:22/02/2014 --issue:750 --desc:implement pre audit n post audit --doneny:RL
--version:0.2 --sdate:23/01/2014 --edate:23/01/2014 --issue:594 --commentno:54 --doneny:RL
DROP PROCEDURE IF EXISTS SP_OCBC_BANK_RECORDS_INSERT;
CREATE PROCEDURE SP_OCBC_BANK_RECORDS_INSERT(IN SOURCESCHEMA VARCHAR(50),IN DESTINATIONSCHEMA VARCHAR(50),IN MIGUSERSTAMP VARCHAR(50))
BEGIN
    DECLARE START_TIME TIME;
	DECLARE END_TIME TIME;
	DECLARE DURATION TIME;
	DECLARE MIN_SNO INTEGER;
	DECLARE MAX_SNO INTEGER;
	DECLARE EXIT HANDLER FOR SQLEXCEPTION
	BEGIN 
	ROLLBACK;
	END;
	START TRANSACTION;
	SET @LOGIN_ID=(SELECT CONCAT('SELECT ULD_ID INTO @ULDID FROM ',DESTINATIONSCHEMA,'.USER_LOGIN_DETAILS WHERE ULD_LOGINID=','"',MIGUSERSTAMP,'"'));
	PREPARE LOGINID FROM @LOGIN_ID;
	EXECUTE LOGINID;
	SET FOREIGN_KEY_CHECKS=0;
	SET START_TIME=(SELECT CURTIME());
	SET @DROP_TEMP_OCBC_SCDB_FORMAT=(SELECT CONCAT('DROP TABLE IF EXISTS ',DESTINATIONSCHEMA,'.TEMP_OCBC_SCDB_FORMAT'));
	PREPARE DTEMPOCBCSCDBFORMAT FROM @DROP_TEMP_OCBC_SCDB_FORMAT;
    EXECUTE DTEMPOCBCSCDBFORMAT;
    SET @CREATE_TEMP_OCBC_SCDB_FORMAT=(SELECT CONCAT('CREATE TABLE ',DESTINATIONSCHEMA,'.TEMP_OCBC_SCDB_FORMAT(
	S_NO INTEGER AUTO_INCREMENT,
	ACCOUNT_NUMBER VARCHAR(255),
	OBR_ACCOUNT_NUMBER INTEGER,
	TYPE VARCHAR(255),
	OBR_CURRENCY INTEGER,
	OPENING_BALANCE VARCHAR(255),
	AMOUNT VARCHAR(255),
	AMOUNT1 VARCHAR(255),
	AMOUNT2 VARCHAR(255),
	ID VARCHAR(255),
	AMOUNT3 VARCHAR(255),
	ID1 VARCHAR(255),
	DATE VARCHAR(255),
	DEBITS VARCHAR(255),
	DATE2 VARCHAR(255),
	DATE3 VARCHAR(255),
	DEBIT_AMOUNT VARCHAR(255),
	CREDIT_AMOUNT VARCHAR(255),
	DATA VARCHAR(255),
	OCN_ID INTEGER,
	CLIENT_REFERRENCE TEXT,
	TRANSACTION_DESC_DETAILS TEXT,
	BANK_REFFERENCE TEXT,
	TRX_YPE VARCHAR(255),
	REFERENCE VARCHAR(255),
	REF_ID VARCHAR(100),
	USERSTAMP VARCHAR(255),
	TIMESTAMP VARCHAR(255),
	PRIMARY KEY(S_NO))'));
	PREPARE CTEMPOCBCSCDBFORMAT FROM @CREATE_TEMP_OCBC_SCDB_FORMAT;
    EXECUTE CTEMPOCBCSCDBFORMAT;
	SET @INSERT_TEMP_OCBC_SCDB_FORMAT=(SELECT CONCAT('INSERT INTO ',DESTINATIONSCHEMA,'.TEMP_OCBC_SCDB_FORMAT
	(ACCOUNT_NUMBER,TYPE,OPENING_BALANCE,AMOUNT,AMOUNT1,AMOUNT2,ID,AMOUNT3,ID1,DATE,DEBITS,DATE2,DATE3,DEBIT_AMOUNT,CREDIT_AMOUNT,DATA,CLIENT_REFERRENCE,TRANSACTION_DESC_DETAILS,BANK_REFFERENCE,TRX_YPE,REFERENCE,REF_ID,USERSTAMP,TIMESTAMP)
	SELECT ACCOUNT_NUMBER,TYPE,OPENING_BALANCE,AMOUNT,AMOUNT1,AMOUNT2,ID,AMOUNT3,ID1,DATE,DEBITS,DATE2,DATE3,DEBIT_AMOUNT,CREDIT_AMOUNT,DATA,CLIENT_REFERRENCE,TRANSACTION_DESC_DETAILS,BANK_REFFERENCE,TRX_YPE,REFERENCE,REF_ID,USERSTAMP,TIMESTAMP
	FROM ',SOURCESCHEMA,'.OCBC_SCDB_FORMAT'));
    PREPARE INSERTTEMPOCBCSCDBFORMAT FROM @INSERT_TEMP_OCBC_SCDB_FORMAT;
    EXECUTE INSERTTEMPOCBCSCDBFORMAT;
	SET @UPDATE_TEMP_OCBC_SCDB_FORMAT=(SELECT CONCAT('UPDATE ',DESTINATIONSCHEMA,'.TEMP_OCBC_SCDB_FORMAT SET USERSTAMP=''EXPATSINTEGRATED@GMAIL.COM'' WHERE USERSTAMP IS NULL'));
    PREPARE UPTEMPOCBCSCDBFORMAT FROM @UPDATE_TEMP_OCBC_SCDB_FORMAT;
    EXECUTE UPTEMPOCBCSCDBFORMAT;
	SET @MINSNO = (SELECT CONCAT('SELECT MIN(S_NO) INTO @MINIMUM_SNO FROM ',DESTINATIONSCHEMA,'.TEMP_OCBC_SCDB_FORMAT'));
	PREPARE MINSNOSTMT FROM @MINSNO;
	EXECUTE MINSNOSTMT;
	SET @MAXSNO = (SELECT CONCAT('SELECT MAX(S_NO) INTO @MAXIMUM_SNO FROM ',DESTINATIONSCHEMA,'.TEMP_OCBC_SCDB_FORMAT'));
	PREPARE MAXSNOSTMT FROM @MAXSNO;
	EXECUTE MAXSNOSTMT;
	SET MIN_SNO = @MINIMUM_SNO;
	SET MAX_SNO = @MAXIMUM_SNO;
	WHILE(MIN_SNO <= MAX_SNO)DO
		SET @ACCOUNTNUMBER = (SELECT CONCAT('SELECT ACCOUNT_NUMBER INTO @ACC_NO FROM ',DESTINATIONSCHEMA,'.TEMP_OCBC_SCDB_FORMAT WHERE S_NO=',MIN_SNO,''));
		PREPARE ACCOUNTNUMBERSTMT FROM @ACCOUNTNUMBER;
		EXECUTE ACCOUNTNUMBERSTMT;
		SET @OBRACCOUNTNUMBERID = (SELECT CONCAT('SELECT OCN_ID INTO @OBRACCOUNTNUMBER_ID FROM ',DESTINATIONSCHEMA,'.OCBC_CONFIGURATION WHERE OCN_DATA=@ACC_NO'));
		PREPARE OBRACCOUNTNUMBERIDSTMT FROM @OBRACCOUNTNUMBERID;
		EXECUTE OBRACCOUNTNUMBERIDSTMT;
		SET @OBRTYPE = (SELECT CONCAT('SELECT TYPE INTO @OBR_TYPE FROM ',DESTINATIONSCHEMA,'.TEMP_OCBC_SCDB_FORMAT WHERE S_NO=',MIN_SNO,''));
		PREPARE OBRTYPESTMT FROM @OBRTYPE;
		EXECUTE OBRTYPESTMT;
		SET @OBR_CURRENCYID = (SELECT CONCAT('SELECT OCN_ID INTO @OBR_CURRENCY_ID FROM ',DESTINATIONSCHEMA,'.OCBC_CONFIGURATION WHERE OCN_DATA=@OBR_TYPE'));
		PREPARE OBR_CURRENCYIDSTMT FROM @OBR_CURRENCYID;
		EXECUTE OBR_CURRENCYIDSTMT;
		SET @OBRDATA = (SELECT CONCAT('SELECT DATA INTO @OBR_DATA FROM ',DESTINATIONSCHEMA,'.TEMP_OCBC_SCDB_FORMAT WHERE S_NO=',MIN_SNO,''));
		PREPARE OBRDATASTMT FROM @OBRDATA;
		EXECUTE OBRDATASTMT;
		SET @OBRDATAID = (SELECT CONCAT('SELECT OCN_ID INTO @OBRDATA_ID FROM ',DESTINATIONSCHEMA,'.OCBC_CONFIGURATION WHERE OCN_DATA=@OBR_DATA'));
		PREPARE OBRDATAIDSTMT FROM @OBRDATAID;
		EXECUTE OBRDATAIDSTMT;
		SET @UPDATETEMPOCBCSCDB = (SELECT CONCAT('UPDATE ',DESTINATIONSCHEMA,'.TEMP_OCBC_SCDB_FORMAT SET OBR_ACCOUNT_NUMBER=@OBRACCOUNTNUMBER_ID,OBR_CURRENCY=@OBR_CURRENCY_ID,OCN_ID=@OBRDATA_ID WHERE S_NO=',MIN_SNO,''));
		PREPARE UPDATETEMPOCBCSCDBSTMT FROM @UPDATETEMPOCBCSCDB;
		EXECUTE UPDATETEMPOCBCSCDBSTMT;
		SET @ACC_NO = NULL;
		SET @OBRACCOUNTNUMBER_ID = NULL;
		SET @OBR_TYPE = NULL;
		SET @OBR_CURRENCY_ID = NULL;
		SET @OBR_DATA = NULL;
		SET @OBRDATA_ID = NULL;
		SET MIN_SNO = MIN_SNO+1;
	END WHILE;
	SET @DROP_OCBC_BANK_RECORDS=(SELECT CONCAT('DROP TABLE IF EXISTS ',DESTINATIONSCHEMA,'.OCBC_BANK_RECORDS'));
	PREPARE DOCBCBANKRECORDS FROM @DROP_OCBC_BANK_RECORDS;
    EXECUTE DOCBCBANKRECORDS;
    SET @CREATE_OCBC_BANK_RECORDS=(SELECT CONCAT('CREATE TABLE  ',DESTINATIONSCHEMA,'.OCBC_BANK_RECORDS(
	OBR_ID BIGINT NOT NULL AUTO_INCREMENT,
	OBR_ACCOUNT_NUMBER INTEGER NOT NULL,
	OBR_CURRENCY INTEGER NOT NULL,
	OBR_PREVIOUS_BALANCE DECIMAL(10,2) NOT NULL,
	OBR_OPENING_BALANCE	DECIMAL(10,2) NOT NULL,
	OBR_CLOSING_BALANCE DECIMAL(10,2) NOT NULL,
	OBR_LAST_BALANCE DECIMAL(10,2) NOT NULL,
	OBR_NO_OF_CREDITS INT NULL,
	OBR_OLD_BALANCE DECIMAL(10,2) NOT NULL,
	OBR_NO_OF_DEBITS DECIMAL(10,2) NULL,
	OBR_TRANS_DATE DATE NOT NULL,	
	OBR_D_AMOUNT INT NOT NULL,
	OBR_POST_DATE DATE NOT NULL,
	OBR_VALUE_DATE DATE NOT NULL,
	OBR_DEBIT_AMOUNT DECIMAL(10,2) NULL,	
	OBR_CREDIT_AMOUNT DECIMAL(10,2) NULL,	
	OCN_ID INTEGER NOT NULL,
	OBR_CLIENT_REFERENCE VARCHAR(1000) NULL,	
	OBR_TRANSACTION_DESC_DETAILS VARCHAR(1000) NOT NULL,
	OBR_BANK_REFERENCE	VARCHAR(1000) NULL,	
	OBR_TRX_TYPE VARCHAR(250) NULL,
	OBR_REF_ID INTEGER NULL UNIQUE,
	OBR_REFERENCE CHAR(1) NULL,		
	ULD_ID	INTEGER(2) NOT NULL,
	OBR_TIMESTAMP TIMESTAMP NOT NULL,
	PRIMARY KEY(OBR_ID), 
	FOREIGN KEY(ULD_ID) REFERENCES ',DESTINATIONSCHEMA,'.USER_LOGIN_DETAILS (ULD_ID),
	FOREIGN KEY(OCN_ID) REFERENCES ',DESTINATIONSCHEMA,'.OCBC_CONFIGURATION (OCN_ID))'));
	PREPARE COCBCBANKRECORDS FROM @CREATE_OCBC_BANK_RECORDS;
    EXECUTE COCBCBANKRECORDS;
	SET @INSERT_OCBC_BANK_RECORDS=(SELECT CONCAT('INSERT INTO ',DESTINATIONSCHEMA,'.OCBC_BANK_RECORDS(
    OBR_ACCOUNT_NUMBER,OBR_CURRENCY,OBR_PREVIOUS_BALANCE,OBR_OPENING_BALANCE,OBR_CLOSING_BALANCE,OBR_LAST_BALANCE,
	OBR_NO_OF_CREDITS,OBR_OLD_BALANCE,OBR_NO_OF_DEBITS,OBR_TRANS_DATE,OBR_D_AMOUNT,OBR_POST_DATE,OBR_VALUE_DATE,
	OBR_DEBIT_AMOUNT,OBR_CREDIT_AMOUNT,OCN_ID,OBR_CLIENT_REFERENCE,OBR_TRANSACTION_DESC_DETAILS,OBR_BANK_REFERENCE,
	OBR_TRX_TYPE,OBR_REF_ID,OBR_REFERENCE,ULD_ID,OBR_TIMESTAMP)
	SELECT T.OBR_ACCOUNT_NUMBER,T.OBR_CURRENCY,T.OPENING_BALANCE,T.AMOUNT,T.AMOUNT1,T.AMOUNT2,
	T.ID,T.AMOUNT3,T.ID1,T.DATE,T.DEBITS,T.DATE2,T.DATE3,
	T.DEBIT_AMOUNT,T.CREDIT_AMOUNT,T.OCN_ID,T.CLIENT_REFERRENCE,T.TRANSACTION_DESC_DETAILS,T.BANK_REFFERENCE,
	T.TRX_YPE,T.REF_ID,T.REFERENCE,ULD.ULD_ID,T.TIMESTAMP FROM ',DESTINATIONSCHEMA,'.TEMP_OCBC_SCDB_FORMAT T, ',DESTINATIONSCHEMA,'.USER_LOGIN_DETAILS ULD WHERE ULD.ULD_LOGINID = T.USERSTAMP'));
	PREPARE INSERTOCBCBANKRECORDS FROM @INSERT_OCBC_BANK_RECORDS;
    EXECUTE INSERTOCBCBANKRECORDS;
	SET @UPDATETIMESTAMP=(SELECT CONCAT('UPDATE ',DESTINATIONSCHEMA,'.OCBC_BANK_RECORDS SET OBR_TIMESTAMP=(SELECT CONVERT_TZ(OBR_TIMESTAMP, "+08:00","+0:00"))'));
	PREPARE UPDATETIMESTAMPSTMT FROM @UPDATETIMESTAMP;
	EXECUTE UPDATETIMESTAMPSTMT;
	SET @ALTEROCBC_BANK_RECORDS = (SELECT CONCAT('ALTER TABLE ',DESTINATIONSCHEMA,'.OCBC_BANK_RECORDS MODIFY COLUMN OBR_TIMESTAMP VARCHAR(50)'));
	PREPARE ALTEROCBC_BANK_RECORDSSTMT FROM @ALTEROCBC_BANK_RECORDS;
	EXECUTE ALTEROCBC_BANK_RECORDSSTMT;
	SET END_TIME=(SELECT CURTIME());
	SET DURATION=(SELECT TIMEDIFF(END_TIME,START_TIME));
	SET @COUNT_SCDB_OCBC_BANK_RECORDS=(SELECT CONCAT('SELECT COUNT(*) INTO @COUNT_SCDB_OCBC_BANK_RECORDS FROM ',DESTINATIONSCHEMA,'.TEMP_OCBC_SCDB_FORMAT'));
	PREPARE COUNTSCDBOCBCBANKRECORDS FROM @COUNT_SCDB_OCBC_BANK_RECORDS;
	EXECUTE COUNTSCDBOCBCBANKRECORDS;
    SET @COUNT_SPLITTED_OCBC_BANK_RECORDS=(SELECT CONCAT('SELECT COUNT(*)INTO @COUNT_SPLITTED_OCBC_BANK_RECORDS FROM ',DESTINATIONSCHEMA,'.OCBC_BANK_RECORDS'));
	PREPARE COUNTSPLITTEDOCBCBANKRECORDS FROM @COUNT_SPLITTED_OCBC_BANK_RECORDS;
    EXECUTE COUNTSPLITTEDOCBCBANKRECORDS;
    SET @REJECTION_COUNT=(@COUNT_SCDB_OCBC_BANK_RECORDS-@COUNT_SPLITTED_OCBC_BANK_RECORDS);
    UPDATE PRE_AUDIT_SUB_PROFILE SET PREASP_NO_OF_REC=@COUNT_SCDB_OCBC_BANK_RECORDS WHERE PREASP_DATA='OCBC_BANK_RECORDS';
	SET @POSTAPID = (SELECT POSTAP_ID FROM POST_AUDIT_PROFILE WHERE POSTAP_DATA="OCBC_BANK_RECORDS");
	SET @PREASPID = (SELECT PREASP_ID FROM PRE_AUDIT_SUB_PROFILE WHERE PREASP_DATA="OCBC_BANK_RECORDS");
	SET @PREAMPID = (SELECT PREAMP_ID FROM PRE_AUDIT_MAIN_PROFILE WHERE PREAMP_DATA="OCBC");
	SET @DUR=DURATION;
	INSERT INTO POST_AUDIT_HISTORY(POSTAP_ID,POSTAH_NO_OF_REC,PREASP_ID,PREAMP_ID,POSTAH_DURATION,POSTAH_NO_OF_REJ,ULD_ID)VALUES
	(@POSTAPID,@COUNT_SPLITTED_OCBC_BANK_RECORDS,@PREASPID,@PREAMPID,@DUR,@REJECTION_COUNT,@ULDID);
	SET @DROP_TOCBC=(SELECT CONCAT('DROP TABLE IF EXISTS ',DESTINATIONSCHEMA,'.TEMP_OCBC_SCDB_FORMAT'));
	PREPARE DROP_TOCBC_STMT FROM @DROP_TOCBC;
	EXECUTE DROP_TOCBC_STMT; 
	SET FOREIGN_KEY_CHECKS =1;
	COMMIT;
END;
CALL SP_OCBC_BANK_RECORDS_INSERT(SOURCESCHEMA,DESTINATIONSCHEMA,MIGUSERSTAMP);