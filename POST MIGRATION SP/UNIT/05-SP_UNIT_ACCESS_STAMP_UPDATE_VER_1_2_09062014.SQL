DROP PROCEDURE IF EXISTS SP_UNIT_ACCESS_STAMP_UPDATE;
CREATE PROCEDURE SP_UNIT_ACCESS_STAMP_UPDATE(IN DESTINATIONSCHEMA VARCHAR(50))
BEGIN
		DECLARE MINUASDID INTEGER;
		DECLARE MAXUASDID INTEGER;
		DECLARE MIN_UASDID INTEGER;
		DECLARE MAX_UASDID INTEGER;
		DECLARE ROOMTYPEID INTEGER;
		DECLARE STAMPTYPEID INTEGER;
		DECLARE ID_UNIT INTEGER;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
BEGIN 
ROLLBACK;
END;
START TRANSACTION;
		SET @MINID =(SELECT CONCAT('SELECT MIN(UASD_ID)INTO @UASD_MIN_ID FROM ',DESTINATIONSCHEMA,'.TEMP_UNIT_ACCESS_STAMP_DETAILS'));
		PREPARE MINIDSTMT FROM @MINID;
		EXECUTE MINIDSTMT;
		SET MINUASDID = @UASD_MIN_ID;
		SET @MAXID =(SELECT CONCAT('SELECT MAX(UASD_ID)INTO @UASD_MAX_ID FROM ',DESTINATIONSCHEMA,'.TEMP_UNIT_ACCESS_STAMP_DETAILS'));
		PREPARE MAXIDSTMT FROM @MAXID;
		EXECUTE MAXIDSTMT;
		SET MAXUASDID = @UASD_MAX_ID;
		WHILE (MINUASDID <= MAXUASDID) DO
			SET @IDUNIT = NULL;
			SET @URTDID = NULL;
			SET @USDTID = NULL;
			SET @UNITID = (SELECT CONCAT('SELECT UNIT_ID INTO @IDUNIT FROM ',DESTINATIONSCHEMA,'.TEMP_UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ID=',MINUASDID));
			PREPARE UNITIDSTMT FROM @UNITID;
			EXECUTE UNITIDSTMT;
			SET @ROOMID = (SELECT CONCAT('SELECT URTD_ID INTO @URTDID FROM ',DESTINATIONSCHEMA,'.TEMP_UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ID=',MINUASDID));
			PREPARE ROOMIDSTMT FROM @ROOMID;
			EXECUTE ROOMIDSTMT;
			SET @STAMPID = (SELECT CONCAT('SELECT USDT_ID INTO @USDTID FROM ',DESTINATIONSCHEMA,'.TEMP_UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ID=',MINUASDID));
			PREPARE STAMPIDSTMT FROM @STAMPID;
			EXECUTE STAMPIDSTMT;
			SET ROOMTYPEID = @URTDID;
			SET ID_UNIT = @IDUNIT;
			SET STAMPTYPEID = @USDTID;
			IF(ROOMTYPEID IS NOT NULL)THEN
				SET MIN_UASDID = MINUASDID+1;
				SET MAX_UASDID = MAXUASDID;
				WHILE(MIN_UASDID <= MAX_UASDID)DO
						SET @UPDATEUASD = (SELECT CONCAT('UPDATE ',DESTINATIONSCHEMA,'.TEMP_UNIT_ACCESS_STAMP_DETAILS SET URTD_ID=NULL WHERE 
						URTD_ID=',ROOMTYPEID,' AND UNIT_ID=',ID_UNIT,' AND UASD_ID=',MIN_UASDID));
						PREPARE UPDATEUASDSTMT FROM @UPDATEUASD;
						EXECUTE UPDATEUASDSTMT;
						SET MIN_UASDID = MIN_UASDID+1;
				END WHILE;
			END IF;
			IF(STAMPTYPEID IS NOT NULL)THEN
				SET MIN_UASDID = MINUASDID+1;
				SET MAX_UASDID = MAXUASDID;
				WHILE(MIN_UASDID <= MAX_UASDID)DO
					SET @UPDATEUSDT = (SELECT CONCAT('UPDATE ',DESTINATIONSCHEMA,'.TEMP_UNIT_ACCESS_STAMP_DETAILS SET USDT_ID=NULL WHERE 
					USDT_ID=',STAMPTYPEID,' AND UNIT_ID=',ID_UNIT,' AND UASD_ID=',MIN_UASDID));
					PREPARE UPDATEUSDTSTMT FROM @UPDATEUSDT;
					EXECUTE UPDATEUSDTSTMT;
					SET MIN_UASDID = MIN_UASDID+1;
				END WHILE;
			END IF;
		SET MINUASDID = MINUASDID+1;
		END WHILE;
    COMMIT;
END;
