  DROP PROCEDURE IF EXISTS SP_PRE_AUDIT_HISTORY;
  CREATE PROCEDURE SP_PRE_AUDIT_HISTORY(IN ID INTEGER,
  IN PROJ_KEY VARCHAR(50),
  IN STATUS INTEGER,
  IN SCDB_REC_BDUMP INTEGER,
  IN SCDB_AREC INTEGER,
  IN SQL_REC INTEGER,
  IN PSTIME VARCHAR(15),
  IN PETIME VARCHAR(15),
  IN USER_STAMP VARCHAR(50),  
  IN DESTINATIONSCHEMA VARCHAR(50)
 )
  BEGIN
  DECLARE TIME_DIFF TIME;
  DECLARE USERSTAMP_ID INT(2);
  DECLARE EXIT HANDLER FOR SQLEXCEPTION
  BEGIN
  ROLLBACK;
  END;
  START TRANSACTION;
  SET FOREIGN_KEY_CHECKS=0;
SET @LOGIN_ID=(SELECT CONCAT('SELECT ULD_ID INTO @ULDID FROM ',DESTINATIONSCHEMA,'.USER_LOGIN_DETAILS WHERE ULD_LOGINID=','"',USER_STAMP,'"'));
PREPARE LOGINID FROM @LOGIN_ID;
EXECUTE LOGINID;
SET USERSTAMP_ID = (SELECT @ULDID);
SET TIME_DIFF=(SELECT TIMEDIFF(PETIME,PSTIME));
INSERT INTO PRE_AUDIT_HISTORY(PREAMP_ID,PREAMP_PROJ_KEY,PREAMP_STATUS,PREAMP_SCDB_REC_BDUMP,PREAMP_SCDB_AREC,PREAMP_SQL_REC,PREAMP_PSTIME,PREAMP_PETIME,PREAMP_EXE_TIME,ULD_ID)
VALUES(ID,PROJ_KEY,STATUS,SCDB_REC_BDUMP,SCDB_AREC,SQL_REC,PSTIME,PETIME,TIME_DIFF,USERSTAMP_ID);
SET FOREIGN_KEY_CHECKS=1;
COMMIT;
END;
  