DROP PROCEDURE IF EXISTS SP_POST_MIGRATION_MODULE_HISTORY;
CREATE PROCEDURE SP_POST_MIGRATION_MODULE_HISTORY(
IN MODULENAME VARCHAR(50),
IN PSTIME VARCHAR(15),
IN PETIME VARCHAR(15),
IN STATUS VARCHAR(15),
IN USERSTAMP VARCHAR(40),
IN DESTINATIONSCHEMA VARCHAR(50)
)
BEGIN
DECLARE USERSTAMP_ID INTEGER;
DECLARE TIME_DIFF TIME;
DECLARE EXIT HANDLER FOR SQLEXCEPTION
  BEGIN
  ROLLBACK;
  END;
  START TRANSACTION;
SET @LOGIN_ID=(SELECT CONCAT('SELECT ULD_ID INTO @ULDID FROM ',DESTINATIONSCHEMA,'.USER_LOGIN_DETAILS WHERE ULD_LOGINID=','"',USERSTAMP,'"'));
PREPARE LOGINID FROM @LOGIN_ID;
EXECUTE LOGINID;
SET USERSTAMP_ID = (SELECT @ULDID);
SET TIME_DIFF=(SELECT TIMEDIFF(PETIME,PSTIME));
INSERT INTO POST_MIGRATION_MODULE_HISTORY(PMM_ID,PMM_EXC_TIME,STATUS,ULD_ID)VALUES((SELECT PMM_ID FROM POST_MIGRATION_MODULE WHERE PMM_MODULE_NAME=MODULENAME),TIME_DIFF,STATUS,USERSTAMP_ID);
COMMIT;
END;
 