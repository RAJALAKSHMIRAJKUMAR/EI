DROP PROCEDURE IF EXISTS SP_POST_MIGRATION_MODULE_OBJECTCREATION_HISTORY;
CREATE PROCEDURE SP_POST_MIGRATION_MODULE_OBJECTCREATION_HISTORY(
IN MODULENAME VARCHAR(50),
IN PSTIME VARCHAR(15),
IN PETIME VARCHAR(15),
IN SP_STATUS TEXT,
IN USERSTAMP VARCHAR(40),
IN DESTINATIONSCHEMA VARCHAR(50))
BEGIN
DECLARE USERSTAMP_ID INTEGER;
DECLARE TIME_DIFF TIME;
DECLARE EXIT HANDLER FOR SQLEXCEPTION
  BEGIN
  ROLLBACK;
  END;
  START TRANSACTION;
SET TIME_DIFF=(SELECT TIMEDIFF(PETIME,PSTIME));
SET @LOGIN_ID=(SELECT CONCAT('SELECT ULD_ID INTO @ULDID FROM ',DESTINATIONSCHEMA,'.USER_LOGIN_DETAILS WHERE ULD_LOGINID=','"',USERSTAMP,'"'));
PREPARE LOGINID FROM @LOGIN_ID;
EXECUTE LOGINID;
SET USERSTAMP_ID = (SELECT @ULDID);
INSERT INTO POST_MIGRATION_MODULE_OBJECTCREATION_HISTORY(PMOC_ID,PMMOCH_EXC_TIME,PMOC_STATUS,ULD_ID)VALUES
((SELECT PMOC_ID FROM POST_MIGRATION_OBJECT_CREATION WHERE PMOC_MODULE_NAME=MODULENAME),TIME_DIFF,SP_STATUS,USERSTAMP_ID);
COMMIT;
END;
