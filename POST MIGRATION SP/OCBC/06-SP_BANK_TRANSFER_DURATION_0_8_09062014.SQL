DROP PROCEDURE IF EXISTS SP_BANK_TRANSFER_DURATION;
CREATE PROCEDURE SP_BANK_TRANSFER_DURATION(IN SOURCESCHEMA VARCHAR(50),IN DESTINATIONSCHEMA VARCHAR(50),IN MIGUSERSTAMP VARCHAR(50))
BEGIN
DECLARE START_TIME TIME;
DECLARE END_TIME TIME;
DECLARE DURATION TIME;
DECLARE EXIT HANDLER FOR SQLEXCEPTION
BEGIN 
ROLLBACK;
END;
START TRANSACTION;
SET START_TIME=(SELECT CURTIME());
CALL SP_BANK_TRANSFER_TABLE(SOURCESCHEMA,DESTINATIONSCHEMA,MIGUSERSTAMP);
CALL SP_TEMP_BANK_TRANSFER(SOURCESCHEMA,DESTINATIONSCHEMA,MIGUSERSTAMP);
CALL SP_MIG_BANKTT(SOURCESCHEMA,DESTINATIONSCHEMA,MIGUSERSTAMP);
	SET END_TIME=(SELECT CURTIME());
	SET DURATION=(SELECT TIMEDIFF(END_TIME,START_TIME));
	SET @LOGIN_ID=(SELECT CONCAT('SELECT ULD_ID INTO @ULDID FROM ',DESTINATIONSCHEMA,'.USER_LOGIN_DETAILS WHERE ULD_LOGINID=','"',MIGUSERSTAMP,'"'));
	PREPARE LOGINID FROM @LOGIN_ID;
	EXECUTE LOGINID;
	SET @COUNT_SCDB_BANK_TRANSFER=(SELECT CONCAT('SELECT COUNT(*) INTO @COUNT_SCDB_BANK_TRANSFER FROM ',SOURCESCHEMA,'.MIG_BANK_TRANSFER'));
	PREPARE COUNTSCDBBANKTRANSFER FROM @COUNT_SCDB_BANK_TRANSFER;
	EXECUTE COUNTSCDBBANKTRANSFER;
	SET @COUNT_SPLITTED_BANK_TRANSFER=(SELECT CONCAT('SELECT COUNT(*) INTO @COUNT_SPLITTED_BANK_TRANSFER FROM ',DESTINATIONSCHEMA,'.BANK_TRANSFER'));
	PREPARE COUNTSPLITTEDBANKTRANSFER FROM @COUNT_SPLITTED_BANK_TRANSFER;
	EXECUTE COUNTSPLITTEDBANKTRANSFER;
	SET @REJECTION_COUNT=(@COUNT_SCDB_BANK_TRANSFER-@COUNT_SPLITTED_BANK_TRANSFER);
	UPDATE PRE_AUDIT_SUB_PROFILE SET PREASP_NO_OF_REC=@COUNT_SCDB_BANK_TRANSFER WHERE PREASP_DATA='BANK_TRANSFER';
    SET @POSTAPIDSTMT=(SELECT CONCAT('SELECT POSTAP_ID INTO @POSTAPID FROM POST_AUDIT_PROFILE WHERE POSTAP_DATA=',"'BANK_TRANSFER'"));
    PREPARE POSTAPSTMT FROM @POSTAPIDSTMT;
    EXECUTE POSTAPSTMT;
    SET @PREASPSTMT=(SELECT CONCAT('SELECT PREASP_ID INTO @PREASPID FROM PRE_AUDIT_SUB_PROFILE WHERE PREASP_DATA=',"'BANK_TRANSFER'"));
    PREPARE PREASPIDSTMT FROM @PREASPSTMT;
    EXECUTE PREASPIDSTMT;
    SET @PREAMPSTMT=(SELECT CONCAT('SELECT PREAMP_ID INTO @PREAMPID FROM PRE_AUDIT_MAIN_PROFILE WHERE PREAMP_DATA=',"'BANKTT'"));
    PREPARE PREAMPIDSTMT FROM @PREAMPSTMT;
    EXECUTE PREAMPIDSTMT;
    SET @DUR=DURATION;
	INSERT INTO POST_AUDIT_HISTORY(POSTAP_ID,POSTAH_NO_OF_REC,PREASP_ID,PREAMP_ID,POSTAH_DURATION,POSTAH_NO_OF_REJ,ULD_ID)VALUES(@POSTAPID,@COUNT_SPLITTED_BANK_TRANSFER,@PREASPID,@PREAMPID,@DUR,@REJECTION_COUNT,@ULDID);
	SET @GIRO=(SELECT CONCAT('SELECT COUNT(*) INTO @GIRO FROM ',SOURCESCHEMA,'.MIG_BANK_TRANSFER WHERE BT_TRANSACTION_TYPE='"'GIRO'"));
	PREPARE GIRO_STMT FROM @GIRO;
	EXECUTE GIRO_STMT;
	SET @TT=(SELECT CONCAT('SELECT COUNT(*) INTO @TT FROM ',SOURCESCHEMA,'.MIG_BANK_TRANSFER WHERE BT_TRANSACTION_TYPE='"'TT'"));
	PREPARE TT_STMT FROM @TT;
	EXECUTE TT_STMT;
	SET @BTSID=(SELECT CONCAT('SELECT COUNT(*) INTO @BTSID FROM ',SOURCESCHEMA,'.MIG_BANK_TRANSFER WHERE BTS_ID IS NOT NULL'));
	PREPARE BTSID_STMT FROM @BTSID;
	EXECUTE BTSID_STMT;
	SET @BTCBID=(SELECT CONCAT('SELECT COUNT(*) INTO @BTCBID FROM ',SOURCESCHEMA,'.MIG_BANK_TRANSFER WHERE  BTCB_ID!=1 AND BTCB_ID IS NOT NULL'));
	PREPARE BTCBID_STMT FROM @BTCBID;
	EXECUTE BTCBID_STMT;
	SET @BTCTID=(SELECT CONCAT('SELECT COUNT(*) INTO @BTCTID FROM ',SOURCESCHEMA,'.MIG_BANK_TRANSFER WHERE BTCT_ID!=1 AND BTCT_ID IS NOT NULL'));
	PREPARE BTCTID_STMT FROM @BTCTID;
	EXECUTE BTCTID_STMT;
	SET @COUNT_SCDB_BTSD=(SELECT SUM(@GIRO+@TT+@BTSID+@BTCBID+@BTCTID));
	SET @COUNT_SPLITTED_BTSD=(SELECT CONCAT('SELECT COUNT(*) INTO @COUNT_SPLITTED_BTSD FROM ',DESTINATIONSCHEMA,'.BANK_TRANSFER_STATUS_DETAILS'));
	PREPARE COUNTSPLITTEDBTSD FROM @COUNT_SPLITTED_BTSD;
	EXECUTE COUNTSPLITTEDBTSD;
	SET @REJECTION_COUNT=(@COUNT_SCDB_BTSD-@COUNT_SPLITTED_BTSD);
	UPDATE PRE_AUDIT_SUB_PROFILE SET PREASP_NO_OF_REC=@COUNT_SCDB_BTSD WHERE PREASP_DATA='BANK_TRANSFER_STATUS_DETAILS';
    SET @POSTAPIDSTMT=(SELECT CONCAT('SELECT POSTAP_ID INTO @POSTAPID FROM POST_AUDIT_PROFILE WHERE POSTAP_DATA=',"'BANK_TRANSFER_STATUS_DETAILS'"));
    PREPARE POSTAPSTMT FROM @POSTAPIDSTMT;
    EXECUTE POSTAPSTMT;
    SET @PREASPSTMT=(SELECT CONCAT('SELECT PREASP_ID INTO @PREASPID FROM PRE_AUDIT_SUB_PROFILE WHERE PREASP_DATA=',"'BANK_TRANSFER_STATUS_DETAILS'"));
    PREPARE PREASPIDSTMT FROM @PREASPSTMT;
    EXECUTE PREASPIDSTMT;
    SET @PREAMPSTMT=(SELECT CONCAT('SELECT PREAMP_ID INTO @PREAMPID FROM PRE_AUDIT_MAIN_PROFILE WHERE PREAMP_DATA=',"'BANKTT'"));
    PREPARE PREAMPIDSTMT FROM @PREAMPSTMT;
    EXECUTE PREAMPIDSTMT;
    SET @DUR=DURATION;
	INSERT INTO POST_AUDIT_HISTORY(POSTAP_ID,POSTAH_NO_OF_REC,PREASP_ID,PREAMP_ID,POSTAH_DURATION,POSTAH_NO_OF_REJ,ULD_ID)VALUES(@POSTAPID,@COUNT_SPLITTED_BTSD,@PREASPID,@PREAMPID,@DUR,@REJECTION_COUNT,@ULDID);
COMMIT;
END;
