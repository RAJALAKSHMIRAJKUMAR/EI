DROP PROCEDURE IF EXISTS SP_BANK_TRANSFER_TABLE;
CREATE PROCEDURE SP_BANK_TRANSFER_TABLE(IN SOURCESCHEMA VARCHAR(50),IN DESTINATIONSCHEMA VARCHAR(50),IN MIGUSERSTAMP VARCHAR(50))
BEGIN
DECLARE EXIT HANDLER FOR SQLEXCEPTION
BEGIN 
ROLLBACK;
END;
START TRANSACTION;
SET FOREIGN_KEY_CHECKS=0;
	SET @LOGIN_ID=(SELECT CONCAT('SELECT ULD_ID INTO @ULDID FROM ',DESTINATIONSCHEMA,'.USER_LOGIN_DETAILS WHERE ULD_LOGINID=','"',MIGUSERSTAMP,'"'));
	PREPARE LOGINID FROM @LOGIN_ID;
	EXECUTE LOGINID;
	SET @DROP_BANK_TRANSFER=(SELECT CONCAT('DROP TABLE IF EXISTS ',DESTINATIONSCHEMA,'.BANK_TRANSFER'));
	PREPARE DBANKTRANSFER FROM @DROP_BANK_TRANSFER;
    EXECUTE DBANKTRANSFER;
    SET @CREATE_BANK_TRANSFER=(SELECT CONCAT('CREATE TABLE ',DESTINATIONSCHEMA,'.BANK_TRANSFER( 
	BT_ID INTEGER NOT NULL AUTO_INCREMENT,
	BTM_ID INTEGER,	
	BT_DATE	DATE NOT NULL,
	BT_AMOUNT DECIMAL(7,2) NOT NULL,
	BT_ACC_NAME	VARCHAR(40),
	BT_ACC_NO VARCHAR(25),
	BT_BANK_CODE VARCHAR(4),
	BT_BRANCH_CODE VARCHAR(3),
	BT_BANK_ADDRESS VARCHAR(250),
	BT_SWIFT_CODE VARCHAR(12),
	BT_CUST_REF	VARCHAR(200),
	BT_INV_DETAILS TEXT,
	BT_DEBITED_ON DATE,BT_COMMENTS	TEXT,
	ULD_ID INT(2) NOT NULL,
	BT_TIMESTAMP TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
	PRIMARY KEY(BT_ID),
	FOREIGN KEY(ULD_ID) REFERENCES USER_LOGIN_DETAILS(ULD_ID))'));
    PREPARE CBANKTRANSFER FROM @CREATE_BANK_TRANSFER;
    EXECUTE CBANKTRANSFER;
	SET @DROP_BANK_TRANSFER_STATUS_DETAILS=(SELECT CONCAT('DROP TABLE IF EXISTS ',DESTINATIONSCHEMA,'.BANK_TRANSFER_STATUS_DETAILS'));
	PREPARE DBANKTRANSFERSTATUSDETAILS FROM @DROP_BANK_TRANSFER_STATUS_DETAILS;
    EXECUTE DBANKTRANSFERSTATUSDETAILS;
    SET @CREATE_BANK_TRANSFER_STATUS_DETAILS=(SELECT CONCAT('CREATE TABLE ',DESTINATIONSCHEMA,'.BANK_TRANSFER_STATUS_DETAILS( 
	BTSD_ID INTEGER NOT NULL AUTO_INCREMENT,
	BT_ID INTEGER NOT NULL,
	BCN_ID INTEGER NOT NULL,
	CGN_ID INTEGER NOT NULL,
	PRIMARY KEY(BTSD_ID),
	FOREIGN KEY(BT_ID) REFERENCES BANK_TRANSFER(BT_ID),
	FOREIGN KEY(BCN_ID) REFERENCES BANKTT_CONFIGURATION(BCN_ID),
	FOREIGN KEY(CGN_ID) REFERENCES CONFIGURATION(CGN_ID))'));
    PREPARE CBANKTRANSFERSTATUSDETAILS FROM @CREATE_BANK_TRANSFER_STATUS_DETAILS;
    EXECUTE CBANKTRANSFERSTATUSDETAILS;
SET FOREIGN_KEY_CHECKS=1;
COMMIT;
END;
CALL SP_BANK_TRANSFER_TABLE(SOURCESCHEMA,DESTINATIONSCHEMA,MIGUSERSTAMP);