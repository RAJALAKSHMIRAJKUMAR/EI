DROP PROCEDURE IF EXISTS SP_MIG_EMPLOYEE_DETAILS_INSERT;
CREATE PROCEDURE SP_MIG_EMPLOYEE_DETAILS_INSERT(IN SOURCESCHEMA  VARCHAR(40),IN DESTINATIONSCHEMA  VARCHAR(40),IN USER_STAMP VARCHAR(50))
BEGIN
	DECLARE START_TIME TIME;
	DECLARE END_TIME TIME;
	DECLARE DURATION TIME;
  DECLARE EXIT HANDLER FOR SQLEXCEPTION
BEGIN 
ROLLBACK;
END;
START TRANSACTION;
	SET FOREIGN_KEY_CHECKS=0;
	SET @LOGIN_ID=(SELECT CONCAT('SELECT ULD_ID INTO @ULDID FROM ',DESTINATIONSCHEMA,'.USER_LOGIN_DETAILS WHERE ULD_LOGINID=','"',USER_STAMP,'"'));
    PREPARE LOGINID FROM @LOGIN_ID;
    EXECUTE LOGINID;
	SET START_TIME = (SELECT CURTIME());
	SET @DROP_TEMP_EMPLOYEE_SCDB_FORMAT=(SELECT CONCAT('DROP TABLE IF EXISTS ',DESTINATIONSCHEMA,'.TEMP_EMPLOYEE_SCDB_FORMAT'));
	PREPARE DROP_TEMP_EMPLOYEE_SCDB_FORMAT_STMT FROM @DROP_TEMP_EMPLOYEE_SCDB_FORMAT;
    EXECUTE DROP_TEMP_EMPLOYEE_SCDB_FORMAT_STMT;
	SET @CREATE_TEMP_EMPLOYEE_SCDB_FORMAT=(SELECT CONCAT('CREATE TABLE ',DESTINATIONSCHEMA,'.TEMP_EMPLOYEE_SCDB_FORMAT(TEMP_ID INTEGER NOT NULL AUTO_INCREMENT,TEMP_FIRST_NAME CHAR(30) NOT NULL,TEMP_LAST_NAME CHAR(30) NULL,TEMP_DESIGNATION VARCHAR(255) NOT NULL,TEMP_MOBILE VARCHAR(10) NOT NULL,TEMP_EMAIL VARCHAR(40) NULL,TEMP_COMMENTS TEXT NULL,ULD_ID INT(2)  NOT NULL,TEMP_TIMESTAMP VARCHAR(50) NOT NULL ,PRIMARY KEY(TEMP_ID))'));
	PREPARE CREATE_TEMP_EMPLOYEE_SCDB_FORMAT_STMT FROM @CREATE_TEMP_EMPLOYEE_SCDB_FORMAT;
    EXECUTE CREATE_TEMP_EMPLOYEE_SCDB_FORMAT_STMT;
	SET @INSERT_TEMP_EMPLOYEE_SCDB_FORMAT=(SELECT CONCAT('INSERT INTO ',DESTINATIONSCHEMA,'.TEMP_EMPLOYEE_SCDB_FORMAT(TEMP_FIRST_NAME,TEMP_LAST_NAME,TEMP_DESIGNATION,TEMP_MOBILE,TEMP_EMAIL,TEMP_COMMENTS,ULD_ID,TEMP_TIMESTAMP)SELECT S.SED_FIRST_NAME,S.SED_LAST_NAME,"STAFF","111111",NULL,NULL,ULD.ULD_ID,S.TIMESTAMP FROM ',SOURCESCHEMA,'.STAFF_DETAIL_SCDB_FORMAT S,',DESTINATIONSCHEMA,'.USER_LOGIN_DETAILS ULD WHERE ULD.ULD_LOGINID=S.USERSTAMP '));
    PREPARE INSERT_TEMP_EMPLOYEE_SCDB_FORMAT_STMT FROM @INSERT_TEMP_EMPLOYEE_SCDB_FORMAT;
    EXECUTE INSERT_TEMP_EMPLOYEE_SCDB_FORMAT_STMT;
    SET @INSERT_TEMP_EMPLOYEE_SCDB_FORMAT=(SELECT CONCAT('INSERT INTO ',DESTINATIONSCHEMA,'. TEMP_EMPLOYEE_SCDB_FORMAT(TEMP_FIRST_NAME,TEMP_LAST_NAME,TEMP_DESIGNATION,TEMP_MOBILE,TEMP_EMAIL,TEMP_COMMENTS,ULD_ID,TEMP_TIMESTAMP)SELECT DISTINCT(B.EXP_HK_CLEANER_NAME),NULL,"CLEANER" ,"222222",NULL,NULL,ULD.ULD_ID,B.TIMESTAMP FROM ',SOURCESCHEMA,'. BIZ_DAILY_SCDB_FORMAT B,',DESTINATIONSCHEMA,'.USER_LOGIN_DETAILS ULD WHERE ULD.ULD_LOGINID=B.USERSTAMP AND EXP_HK_CLEANER_NAME IS NOT NULL  GROUP BY B.EXP_HK_CLEANER_NAME'));
	PREPARE INSERT_TEMP_EMPLOYEE_SCDB_FORMAT_STMT FROM @INSERT_TEMP_EMPLOYEE_SCDB_FORMAT;
    EXECUTE INSERT_TEMP_EMPLOYEE_SCDB_FORMAT_STMT;
    SET @UPDATE_TEMP_EMPLOYEE_SCDB_FORMAT=(SELECT CONCAT('UPDATE ',DESTINATIONSCHEMA,'. TEMP_EMPLOYEE_SCDB_FORMAT SET TEMP_LAST_NAME = TEMP_FIRST_NAME WHERE TEMP_LAST_NAME IS NULL'));
	PREPARE UPDATE_TEMP_EMPLOYEE_SCDB_FORMAT_STMT FROM @UPDATE_TEMP_EMPLOYEE_SCDB_FORMAT;
    EXECUTE UPDATE_TEMP_EMPLOYEE_SCDB_FORMAT_STMT;
    SET @DROP_EMPLOYEE_CARD_DETAILS=(SELECT CONCAT('DROP TABLE IF EXISTS ',DESTINATIONSCHEMA,'. EMPLOYEE_CARD_DETAILS'));
    PREPARE DROP_EMPLOYEE_CARD_DETAILS_STMT FROM @DROP_EMPLOYEE_CARD_DETAILS;
    EXECUTE DROP_EMPLOYEE_CARD_DETAILS_STMT;
	SET @CREATE_EMPLOYEE_CARD_DETAILS=(SELECT CONCAT('CREATE TABLE ',DESTINATIONSCHEMA,'. EMPLOYEE_CARD_DETAILS(ECD_ID INTEGER NOT NULL
    AUTO_INCREMENT,EMP_ID INTEGER NOT NULL,UASD_ID INTEGER NOT NULL,PRIMARY KEY(ECD_ID),FOREIGN KEY(EMP_ID) REFERENCES ',DESTINATIONSCHEMA,'.EMPLOYEE_DETAILS (EMP_ID),FOREIGN KEY(UASD_ID) REFERENCES ',DESTINATIONSCHEMA,'.UNIT_ACCESS_STAMP_DETAILS (UASD_ID ))'));
	PREPARE CREATE_EMPLOYEE_CARD_DETAILS_STMT FROM @CREATE_EMPLOYEE_CARD_DETAILS;
    EXECUTE CREATE_EMPLOYEE_CARD_DETAILS_STMT;
	SET @DROP_EMPLOYEE_DETAILS=(SELECT CONCAT('DROP TABLE IF EXISTS ',DESTINATIONSCHEMA,'. EMPLOYEE_DETAILS'));
	PREPARE DROP_EMPLOYEE_DETAILS_STMT FROM @DROP_EMPLOYEE_DETAILS;
    EXECUTE DROP_EMPLOYEE_DETAILS_STMT;
    SET @CREATE_EMPLOYEE_DETAILS=(SELECT CONCAT('CREATE TABLE ',DESTINATIONSCHEMA,'.EMPLOYEE_DETAILS(EMP_ID INTEGER NOT NULL AUTO_INCREMENT,EMP_FIRST_NAME CHAR(30) NOT NULL,EMP_LAST_NAME CHAR(30) NOT NULL,ECN_ID INTEGER NOT NULL,EMP_MOBILE VARCHAR(10) NOT NULL,EMP_EMAIL VARCHAR(40) NULL,EMP_COMMENTS TEXT NULL,ULD_TS_MAXTIMES INTEGER NOT NULL DEFAULT 1,ULD_ID INT(2) NOT NULL,EMP_TIMESTAMP TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,PRIMARY KEY(EMP_ID),FOREIGN KEY(ECN_ID) REFERENCES ',DESTINATIONSCHEMA,'.EXPENSE_CONFIGURATION (ECN_ID),FOREIGN KEY(ULD_ID) REFERENCES ',DESTINATIONSCHEMA,'.USER_LOGIN_DETAILS(ULD_ID))'));
	PREPARE CREATE_EMPLOYEE_DETAILS_STMT FROM @CREATE_EMPLOYEE_DETAILS;
    EXECUTE CREATE_EMPLOYEE_DETAILS_STMT;
	SET @INSERT_EMPLOYEE_DETAILS=(SELECT CONCAT('INSERT INTO ',DESTINATIONSCHEMA,'.EMPLOYEE_DETAILS(EMP_FIRST_NAME,EMP_LAST_NAME,ECN_ID,EMP_MOBILE,EMP_EMAIL,EMP_COMMENTS,ULD_ID,EMP_TIMESTAMP) 
	SELECT TESB.TEMP_FIRST_NAME, TESB.TEMP_LAST_NAME, EC.ECN_ID, TESB.TEMP_MOBILE, TESB.TEMP_EMAIL, TESB.TEMP_COMMENTS,TESB.ULD_ID,TESB.TEMP_TIMESTAMP FROM ',DESTINATIONSCHEMA,'.TEMP_EMPLOYEE_SCDB_FORMAT TESB INNER JOIN ',DESTINATIONSCHEMA,'.EXPENSE_CONFIGURATION EC WHERE EC.ECN_DATA=TESB.TEMP_DESIGNATION AND EC.CGN_ID=35'));
	PREPARE INSERT_EMPLOYEE_DETAILS_STMT FROM @INSERT_EMPLOYEE_DETAILS;
    EXECUTE INSERT_EMPLOYEE_DETAILS_STMT;
    SET END_TIME = (SELECT CURTIME());
	SET DURATION=(SELECT TIMEDIFF(END_TIME,START_TIME));
	SET @UPDATETIMESTAMP=(SELECT CONCAT('UPDATE ',DESTINATIONSCHEMA,'. EMPLOYEE_DETAILS SET EMP_TIMESTAMP=(SELECT CONVERT_TZ(EMP_TIMESTAMP, "+08:00","+0:00"))'));
	PREPARE UPDATETIMESTAMPSTMT FROM @UPDATETIMESTAMP;
	EXECUTE UPDATETIMESTAMPSTMT;
	SET @COUNTEMPLOYEE_SCDB_FORMAT = (SELECT CONCAT('SELECT COUNT(*) INTO @COUNT_EMPLOYEE_SCDB_FORMAT FROM ',DESTINATIONSCHEMA,'.TEMP_EMPLOYEE_SCDB_FORMAT WHERE TEMP_FIRST_NAME IS NOT NULL AND TEMP_LAST_NAME IS NOT NULL '));
	PREPARE COUNTEMPLOYEE_SCDB_FORMAT_STMT FROM @COUNTEMPLOYEE_SCDB_FORMAT;
    EXECUTE COUNTEMPLOYEE_SCDB_FORMAT_STMT ;
    SET @COUNTSPLITING_EMPLOYEE_DETAILS = (SELECT CONCAT('SELECT COUNT(*) INTO @COUNT_SPLITTED_EMPLOYEE FROM ',DESTINATIONSCHEMA,'.EMPLOYEE_DETAILS'));
	PREPARE COUNTSPLITING_EMPLOYEE_DETAILS_STMT FROM @COUNTSPLITING_EMPLOYEE_DETAILS ;
    EXECUTE COUNTSPLITING_EMPLOYEE_DETAILS_STMT ;
	SET @REJECTION_COUNT=(@COUNT_EMPLOYEE_SCDB_FORMAT-@COUNT_SPLITTED_EMPLOYEE);
    SET @POSTAPIDSTMT=(SELECT CONCAT('SELECT POSTAP_ID INTO @POSTAPID FROM POST_AUDIT_PROFILE WHERE POSTAP_DATA=',"'EMPLOYEE_DETAILS'"));
    PREPARE POSTAPSTMT FROM @POSTAPIDSTMT;
    EXECUTE POSTAPSTMT;
    SET @PREASPSTMT=(SELECT CONCAT('SELECT PREASP_ID INTO @PREASPID FROM PRE_AUDIT_SUB_PROFILE WHERE PREASP_DATA=',"'EMPLOYEE_DETAILS'"));
    PREPARE PREASPIDSTMT FROM @PREASPSTMT;
    EXECUTE PREASPIDSTMT;
    SET @PREAMPSTMT=(SELECT CONCAT('SELECT PREAMP_ID INTO @PREAMPID FROM PRE_AUDIT_MAIN_PROFILE WHERE PREAMP_DATA=',"'EMPLOYEE'"));
    PREPARE PREAMPIDSTMT FROM @PREAMPSTMT;
	EXECUTE PREAMPIDSTMT;
    SET @DUR=DURATION;
	UPDATE PRE_AUDIT_SUB_PROFILE SET PREASP_NO_OF_REC=@COUNT_EMPLOYEE_SCDB_FORMAT WHERE PREASP_DATA='EMPLOYEE_DETAILS';	
	INSERT INTO POST_AUDIT_HISTORY(POSTAP_ID,POSTAH_NO_OF_REC,PREASP_ID,PREAMP_ID,POSTAH_DURATION,POSTAH_NO_OF_REJ,ULD_ID)VALUES(@POSTAPID,@COUNT_SPLITTED_EMPLOYEE,@PREASPID,@PREAMPID,@DUR,@REJECTION_COUNT,@ULDID);     
    SET @DROP_TEMP_EMPLOYEE_SCDB_FORMAT=(SELECT CONCAT('DROP TABLE IF EXISTS ',DESTINATIONSCHEMA,'. TEMP_EMPLOYEE_SCDB_FORMAT'));
	PREPARE DROP_TEMP_EMPLOYEE_SCDB_FORMAT_STMT FROM @DROP_TEMP_EMPLOYEE_SCDB_FORMAT;
    EXECUTE DROP_TEMP_EMPLOYEE_SCDB_FORMAT_STMT;
    SET FOREIGN_KEY_CHECKS=1;
   COMMIT; 
END;
CALL SP_MIG_EMPLOYEE_DETAILS_INSERT(SOURCESCHEMA,DESTINATIONSCHEMA,MIGUSERSTAMP)