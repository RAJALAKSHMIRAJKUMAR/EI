DROP PROCEDURE IF EXISTS SP_MIG_STAFF_DETAIL_INSERT;
CREATE PROCEDURE SP_MIG_STAFF_DETAIL_INSERT(IN SOURCESCHEMA  VARCHAR(40),IN DESTINATIONSCHEMA  VARCHAR(40),IN USER_STAMP VARCHAR(50))
BEGIN
	DECLARE START_TIME TIME;
	DECLARE END_TIME TIME;
	DECLARE DURATION TIME;
  DECLARE EXIT HANDLER FOR SQLEXCEPTION
BEGIN 
ROLLBACK;
END;
START TRANSACTION;
	SET FOREIGN_KEY_CHECKS=0;
    SET @LOGIN_ID=(SELECT CONCAT('SELECT ULD_ID INTO @ULDID FROM ',DESTINATIONSCHEMA,'.USER_LOGIN_DETAILS WHERE ULD_LOGINID=','"',USER_STAMP,'"'));
    PREPARE LOGINID FROM @LOGIN_ID;
    EXECUTE LOGINID;
	SET START_TIME=(SELECT CURTIME());
	SET @DROP_EXPENSE_DETAIL_STAFF_SALARY=(SELECT CONCAT('DROP TABLE IF EXISTS ',DESTINATIONSCHEMA,'. EXPENSE_DETAIL_STAFF_SALARY'));					
	PREPARE DROP_EXPENSE_DETAIL_STAFF_SALARY_STMT FROM @DROP_EXPENSE_DETAIL_STAFF_SALARY;
    EXECUTE DROP_EXPENSE_DETAIL_STAFF_SALARY_STMT;
	SET @CREATE_EXPENSE_DETAIL_STAFF_SALARY=(SELECT CONCAT('CREATE TABLE ',DESTINATIONSCHEMA,'. EXPENSE_DETAIL_STAFF_SALARY(EDSS_ID INTEGER NOT NULL AUTO_INCREMENT,EMP_ID INTEGER NOT NULL,EDSS_CPF_NUMBER	VARCHAR(9) UNIQUE NULL,EDSS_CPF_AMOUNT	DECIMAL(7,2) NULL,EDSS_LEVY_AMOUNT DECIMAL(7,2) NULL,EDSS_SALARY_AMOUNT DECIMAL(7,2) NOT NULL,EDSS_COMMENTS TEXT NULL,ULD_ID INT(2)NOT NULL,EDSS_TIMESTAMP TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,PRIMARY KEY(EDSS_ID),FOREIGN KEY(EMP_ID) REFERENCES ',DESTINATIONSCHEMA,'.EMPLOYEE_DETAILS (EMP_ID),FOREIGN KEY(ULD_ID) REFERENCES ',DESTINATIONSCHEMA,'.USER_LOGIN_DETAILS (ULD_ID ))'));
	PREPARE CREATE_EXPENSE_DETAIL_STAFF_SALARY_STMT FROM @CREATE_EXPENSE_DETAIL_STAFF_SALARY;
    EXECUTE CREATE_EXPENSE_DETAIL_STAFF_SALARY_STMT;
	SET @INSERT_EXPENSE_DETAIL_STAFF_SALARY=(SELECT CONCAT('INSERT INTO ',DESTINATIONSCHEMA,'. EXPENSE_DETAIL_STAFF_SALARY(EMP_ID, EDSS_CPF_NUMBER, EDSS_CPF_AMOUNT, EDSS_LEVY_AMOUNT,EDSS_SALARY_AMOUNT,ULD_ID,EDSS_TIMESTAMP)SELECT EMPDTL.EMP_ID, STAFFDTL.SED_CPF_NUMBER, STAFFDTL.SED_CPF_AMOUNT, STAFFDTL.SED_LEVY_AMOUNT, STAFFDTL.SED_SALARY_AMOUNT, ULD.ULD_ID,STAFFDTL.TIMESTAMP FROM ',DESTINATIONSCHEMA,'.EMPLOYEE_DETAILS EMPDTL INNER JOIN ',SOURCESCHEMA,'.STAFF_DETAIL_SCDB_FORMAT STAFFDTL, ',DESTINATIONSCHEMA,'.USER_LOGIN_DETAILS ULD WHERE STAFFDTL.SED_FIRST_NAME=EMPDTL.EMP_FIRST_NAME AND STAFFDTL.SED_LAST_NAME=EMPDTL.EMP_LAST_NAME AND ULD.ULD_LOGINID=STAFFDTL.USERSTAMP'));
	PREPARE INSERT_EXPENSE_DETAIL_STAFF_SALARY_STMT FROM @INSERT_EXPENSE_DETAIL_STAFF_SALARY;
    EXECUTE INSERT_EXPENSE_DETAIL_STAFF_SALARY_STMT;
      SET @UPDATETIMESTAMP=(SELECT CONCAT('UPDATE ',DESTINATIONSCHEMA,'. EXPENSE_DETAIL_STAFF_SALARY SET EDSS_TIMESTAMP=(SELECT CONVERT_TZ(EDSS_TIMESTAMP, "+08:00","+0:00"))'));
PREPARE UPDATETIMESTAMPSTMT FROM @UPDATETIMESTAMP;
EXECUTE UPDATETIMESTAMPSTMT;
    SET END_TIME=(SELECT CURTIME());
	SET DURATION=(SELECT TIMEDIFF(END_TIME,START_TIME));
	SET @COUNTEXPENSEDETAILSTAFFSALARYSCDBFORMAT=(SELECT CONCAT('SELECT COUNT(*) INTO @COUNT_EXPENSE_DETAILSTAFFSALARYSCDBFORMAT FROM ',SOURCESCHEMA,'. STAFF_DETAIL_SCDB_FORMAT WHERE SED_FIRST_NAME IS NOT NULL AND SED_LAST_NAME IS NOT NULL'));
	PREPARE COUNTEXPENSEDETAILSTAFFSALARYSCDBFORMAT_STMT FROM @COUNTEXPENSEDETAILSTAFFSALARYSCDBFORMAT;
    EXECUTE COUNTEXPENSEDETAILSTAFFSALARYSCDBFORMAT_STMT;
	SET @COUNTSPLITINGEXPENSEDETAILSTAFFSALARY=(SELECT CONCAT('SELECT COUNT(*) INTO @COUNT_SPLITING_EXPENSE_DETAIL_STAFF_SALARY FROM ',DESTINATIONSCHEMA,'.EXPENSE_DETAIL_STAFF_SALARY'));
	PREPARE COUNTSPLITINGEXPENSEDETAILSTAFFSALARY_STMT FROM @COUNTSPLITINGEXPENSEDETAILSTAFFSALARY;
    EXECUTE COUNTSPLITINGEXPENSEDETAILSTAFFSALARY_STMT;
    SET @REJECTION_COUNT=(@COUNT_EXPENSE_DETAILSTAFFSALARYSCDBFORMAT-@COUNT_SPLITING_EXPENSE_DETAIL_STAFF_SALARY);
    SET @POSTAPIDSTMT=(SELECT CONCAT('SELECT POSTAP_ID INTO @POSTAPID FROM POST_AUDIT_PROFILE WHERE POSTAP_DATA=',"'EXPENSE_DETAIL_STAFF_SALARY'"));
    PREPARE POSTAPSTMT FROM @POSTAPIDSTMT;
    EXECUTE POSTAPSTMT;
    SET @PREASPSTMT=(SELECT CONCAT('SELECT PREASP_ID INTO @PREASPID FROM PRE_AUDIT_SUB_PROFILE WHERE PREASP_DATA=',"'EXPENSE_DETAIL_STAFF_SALARY'"));
    PREPARE PREASPIDSTMT FROM @PREASPSTMT;
    EXECUTE PREASPIDSTMT;
    SET @PREAMPSTMT=(SELECT CONCAT('SELECT PREAMP_ID INTO @PREAMPID FROM PRE_AUDIT_MAIN_PROFILE WHERE PREAMP_DATA=',"'STAFF DETAIL'"));
    PREPARE PREAMPIDSTMT FROM @PREAMPSTMT;
	EXECUTE PREAMPIDSTMT;
    SET @DUR=DURATION;
	UPDATE PRE_AUDIT_SUB_PROFILE SET PREASP_NO_OF_REC=@COUNT_EXPENSE_DETAILSTAFFSALARYSCDBFORMAT WHERE PREASP_DATA='EXPENSE_DETAIL_STAFF_SALARY';	
	INSERT INTO POST_AUDIT_HISTORY(POSTAP_ID,POSTAH_NO_OF_REC,PREASP_ID,PREAMP_ID,POSTAH_DURATION,POSTAH_NO_OF_REJ,ULD_ID)VALUES(@POSTAPID,@COUNT_SPLITING_EXPENSE_DETAIL_STAFF_SALARY,@PREASPID,@PREAMPID,@DUR,@REJECTION_COUNT,@ULDID);    
	SET FOREIGN_KEY_CHECKS=1;
  COMMIT;
END;
CALL SP_MIG_STAFF_DETAIL_INSERT(SOURCESCHEMA,DESTINATIONSCHEMA,MIGUSERSTAMP)