-- VERSION:0.02 --DATE:08/05/2015 --DESC:ADDED TICKLER PART --DONE BY:RL

DROP PROCEDURE IF EXISTS SP_CUSTOMER_SEARCH_FEE_DTLS_UPDATE;
CREATE PROCEDURE SP_CUSTOMER_SEARCH_FEE_DTLS_UPDATE(
IN CUST_ID INTEGER,
IN CUSTOMER_RECORD_VERSION INTEGER,
IN RENT DECIMAL(7,2),
IN DEPOSIT DECIMAL(7,2),
IN PROCESSING_FEE DECIMAL(7,2),
IN AIRCON_FIXED_FEE DECIMAL(7,2),
IN AIRCON_QUARTELY_FEE DECIMAL(7,2),
IN ELECTRICITY_CAP DECIMAL(7,2),
IN CHECKOUT_CLEANING_FEE DECIMAL(7,2),
IN DRYCLEAN_FEE DECIMAL(7,2),
IN USERSTAMP VARCHAR(50),
OUT SUCCESS_FLAG INTEGER)

BEGIN

	DECLARE USERSTAMP_ID INTEGER;

	DECLARE OLD_RENT_CFDID TEXT;
	DECLARE OLD_RENT_AMT TEXT;
	DECLARE OLD_DEPOSIT_CFDID TEXT;
	DECLARE OLD_DEPOSIT_AMT TEXT;
	DECLARE OLD_PROCESSINGFEE_CFDID TEXT;
	DECLARE OLD_PROCESSINGFEE_AMT TEXT;
	DECLARE OLD_AIRCON_FIXED_CFDID TEXT;
	DECLARE OLD_AIRCON_FIXED_FEE TEXT;
	DECLARE OLD_ELECTRICITY_CAP_CFDID TEXT;
	DECLARE OLD_ELECTRICITY_CAP_AMT TEXT;
	DECLARE OLD_DRYCLEAN_CFDID TEXT;
	DECLARE OLD_DRYCLEAN_AMT TEXT;
	DECLARE OLD_AIRCON_QUARTELY_CFDID TEXT;
	DECLARE OLD_AIRCON_QUARTELY_FEE TEXT;
	DECLARE OLD_CLEANING_FEE_CFDID TEXT;
	DECLARE OLD_CLEANING_FEE_AMT TEXT;

	DECLARE OLD_AIRCON_CFDID TEXT;
	DECLARE OLD_AIRCON_AMT TEXT;
	DECLARE OLD_AIRCONCPPID TEXT;

	DECLARE AIRCONEXSISTID INT;
	DECLARE AIRCONAMOUNT DECIMAL(7,2);
	DECLARE AIRCONID INT;

	IF(DEPOSIT='' OR DEPOSIT IS NULL) THEN
		SET DEPOSIT=NULL;
	END IF;

	IF(PROCESSING_FEE='' OR PROCESSING_FEE IS NULL) THEN
		SET PROCESSING_FEE=NULL;
	END IF;

	IF(AIRCON_FIXED_FEE='' OR AIRCON_FIXED_FEE IS NULL) THEN
		SET AIRCON_FIXED_FEE=NULL;
	END IF;

	IF(AIRCON_QUARTELY_FEE='' OR AIRCON_QUARTELY_FEE IS NULL) THEN
		SET AIRCON_QUARTELY_FEE=NULL;
	END IF;

	IF(CHECKOUT_CLEANING_FEE='' OR CHECKOUT_CLEANING_FEE IS NULL) THEN
		SET CHECKOUT_CLEANING_FEE=NULL;
	END IF;

	IF(ELECTRICITY_CAP='' OR ELECTRICITY_CAP IS NULL) THEN
		SET ELECTRICITY_CAP=NULL;
	END IF;

	IF(DRYCLEAN_FEE='' OR DRYCLEAN_FEE IS NULL) THEN
		SET DRYCLEAN_FEE=NULL;
	END IF;

	CALL SP_CHANGE_USERSTAMP_AS_ULDID(USERSTAMP,@ULDID);
    SET USERSTAMP_ID = (SELECT @ULDID);

	SET OLD_RENT_CFDID = (SELECT CFD_ID FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=CUST_ID AND CED_REC_VER= CUSTOMER_RECORD_VERSION AND CPP_ID=1);
	SET OLD_RENT_AMT = (SELECT CFD_AMOUNT FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=CUST_ID AND CED_REC_VER= CUSTOMER_RECORD_VERSION AND CPP_ID=1);
	
	SET OLD_DEPOSIT_CFDID = (SELECT CFD_ID FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=CUST_ID AND CED_REC_VER= CUSTOMER_RECORD_VERSION AND CPP_ID=2);
	SET OLD_DEPOSIT_AMT = (SELECT CFD_AMOUNT FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=CUST_ID AND CED_REC_VER= CUSTOMER_RECORD_VERSION AND CPP_ID=2);
	
	SET OLD_PROCESSINGFEE_CFDID = (SELECT CFD_ID FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=CUST_ID AND CED_REC_VER= CUSTOMER_RECORD_VERSION AND CPP_ID=3);
	SET OLD_PROCESSINGFEE_AMT = (SELECT CFD_AMOUNT FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=CUST_ID AND CED_REC_VER= CUSTOMER_RECORD_VERSION AND CPP_ID=3);

	SET OLD_AIRCON_FIXED_CFDID = (SELECT CFD_ID FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=CUST_ID AND CED_REC_VER= CUSTOMER_RECORD_VERSION AND CPP_ID=4);
	SET OLD_AIRCON_FIXED_FEE = (SELECT CFD_AMOUNT FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=CUST_ID AND CED_REC_VER= CUSTOMER_RECORD_VERSION AND CPP_ID=4);

	SET OLD_ELECTRICITY_CAP_CFDID = (SELECT CFD_ID FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=CUST_ID AND CED_REC_VER= CUSTOMER_RECORD_VERSION AND CPP_ID=5);
	SET OLD_ELECTRICITY_CAP_AMT = (SELECT CFD_AMOUNT FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=CUST_ID AND CED_REC_VER= CUSTOMER_RECORD_VERSION AND CPP_ID=5);
	
	SET OLD_DRYCLEAN_CFDID = (SELECT CFD_ID FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=CUST_ID AND CED_REC_VER= CUSTOMER_RECORD_VERSION AND CPP_ID=6);
	SET OLD_DRYCLEAN_AMT = (SELECT CFD_AMOUNT FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=CUST_ID AND CED_REC_VER= CUSTOMER_RECORD_VERSION AND CPP_ID=6);

	SET OLD_AIRCON_QUARTELY_CFDID = (SELECT CFD_ID FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=CUST_ID AND CED_REC_VER= CUSTOMER_RECORD_VERSION AND CPP_ID=7);
	SET OLD_AIRCON_QUARTELY_FEE = (SELECT CFD_AMOUNT FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=CUST_ID AND CED_REC_VER= CUSTOMER_RECORD_VERSION AND CPP_ID=7);
	
	SET OLD_CLEANING_FEE_CFDID = (SELECT CFD_ID FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=CUST_ID AND CED_REC_VER= CUSTOMER_RECORD_VERSION AND CPP_ID=8);
	SET OLD_CLEANING_FEE_AMT = (SELECT CFD_AMOUNT FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=CUST_ID AND CED_REC_VER= CUSTOMER_RECORD_VERSION AND CPP_ID=8);

-- RENT AMOUNT UPDATE
	IF(RENT IS NOT NULL AND OLD_RENT_AMT!=RENT) THEN

		INSERT INTO TICKLER_HISTORY(TP_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,ULD_ID,CUSTOMER_ID)VALUES
		((SELECT TP_ID FROM TICKLER_PROFILE WHERE TP_TYPE='UPDATION'),
		(SELECT TTIP_ID FROM TICKLER_TABID_PROFILE WHERE TTIP_DATA='CUSTOMER_FEE_DETAILS'),
		(SELECT CONCAT('CFD_ID=',OLD_RENT_CFDID,',','CED_REC_VER=',CUSTOMER_RECORD_VERSION,',','CPP_ID=1',',','CFD_AMOUNT=',OLD_RENT_AMT)),
		(SELECT CONCAT('CFD_AMOUNT=',RENT)),USERSTAMP_ID,CUST_ID);

		UPDATE CUSTOMER_FEE_DETAILS SET CFD_AMOUNT=RENT WHERE CUSTOMER_ID=CUST_ID AND CED_REC_VER=CUSTOMER_RECORD_VERSION AND CPP_ID=1;
		SET SUCCESS_FLAG=1;

	END IF;

-- -- DEPOSIT AMOUNT UPDATE
	IF(DEPOSIT IS NOT NULL) THEN

  		IF EXISTS(SELECT CPP_ID FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=CUST_ID AND CED_REC_VER=CUSTOMER_RECORD_VERSION AND CPP_ID=2) THEN

  			IF(OLD_DEPOSIT_AMT!=DEPOSIT) THEN

	  			INSERT INTO TICKLER_HISTORY(TP_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,ULD_ID,CUSTOMER_ID)VALUES
				((SELECT TP_ID FROM TICKLER_PROFILE WHERE TP_TYPE='UPDATION'),
				(SELECT TTIP_ID FROM TICKLER_TABID_PROFILE WHERE TTIP_DATA='CUSTOMER_FEE_DETAILS'),
				(SELECT CONCAT('CFD_ID=',OLD_DEPOSIT_CFDID,',','CED_REC_VER=',CUSTOMER_RECORD_VERSION,',','CPP_ID=2',',','CFD_AMOUNT=',OLD_DEPOSIT_AMT)),
				(SELECT CONCAT('CFD_AMOUNT=',DEPOSIT)),USERSTAMP_ID,CUST_ID);

	  			UPDATE CUSTOMER_FEE_DETAILS SET CFD_AMOUNT=DEPOSIT WHERE CUSTOMER_ID=CUST_ID AND CED_REC_VER= CUSTOMER_RECORD_VERSION AND CPP_ID=2;
	  			SET SUCCESS_FLAG=1;

	  		END IF;

  		END IF;

  		IF NOT EXISTS (SELECT CPP_ID FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=CUST_ID AND CED_REC_VER= CUSTOMER_RECORD_VERSION AND CPP_ID=2) THEN
  
  			INSERT INTO CUSTOMER_FEE_DETAILS (CUSTOMER_ID,CED_REC_VER,CPP_ID,CFD_AMOUNT) VALUES (CUST_ID,CUSTOMER_RECORD_VERSION,2,DEPOSIT);
  			SET SUCCESS_FLAG=1;

  		END IF;

	END IF;

	IF(OLD_DEPOSIT_AMT IS NOT NULL AND DEPOSIT IS NULL) THEN

		INSERT INTO TICKLER_HISTORY(TP_ID,TTIP_ID,TH_OLD_VALUE,ULD_ID,CUSTOMER_ID)VALUES
		((SELECT TP_ID FROM TICKLER_PROFILE WHERE TP_TYPE='DELETION'),
		(SELECT TTIP_ID FROM TICKLER_TABID_PROFILE WHERE TTIP_DATA='CUSTOMER_FEE_DETAILS'),
		(SELECT CONCAT('CFD_ID=',OLD_DEPOSIT_CFDID,',','CED_REC_VER=',CUSTOMER_RECORD_VERSION,',','CPP_ID=2',',','CFD_AMOUNT=',OLD_DEPOSIT_AMT)),
		USERSTAMP_ID,CUST_ID);
		
		DELETE FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=CUST_ID AND CED_REC_VER= CUSTOMER_RECORD_VERSION AND CPP_ID=2;
		SET SUCCESS_FLAG=1;

	END IF;

-- -- PROCESSING_FEE AMOUNT UPDATE
	IF(PROCESSING_FEE IS NOT NULL) THEN

		IF EXISTS(SELECT CPP_ID FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=CUST_ID AND CED_REC_VER= CUSTOMER_RECORD_VERSION AND CPP_ID=3) THEN

			IF(OLD_PROCESSINGFEE_AMT!=PROCESSING_FEE) THEN

				INSERT INTO TICKLER_HISTORY(TP_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,ULD_ID,CUSTOMER_ID)VALUES
				((SELECT TP_ID FROM TICKLER_PROFILE WHERE TP_TYPE='UPDATION'),
				(SELECT TTIP_ID FROM TICKLER_TABID_PROFILE WHERE TTIP_DATA='CUSTOMER_FEE_DETAILS'),
				(SELECT CONCAT('CFD_ID=',OLD_PROCESSINGFEE_CFDID,',','CED_REC_VER=',CUSTOMER_RECORD_VERSION,',','CPP_ID=3',',','CFD_AMOUNT=',OLD_PROCESSINGFEE_AMT)),
				(SELECT CONCAT('CFD_AMOUNT=',PROCESSING_FEE)),USERSTAMP_ID,CUST_ID);

				UPDATE CUSTOMER_FEE_DETAILS SET CFD_AMOUNT=PROCESSING_FEE WHERE CUSTOMER_ID=CUST_ID AND CED_REC_VER= CUSTOMER_RECORD_VERSION AND CPP_ID=3;
				SET SUCCESS_FLAG=1;

			END IF;

		END IF;

		IF NOT EXISTS (SELECT CPP_ID FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=CUST_ID AND CED_REC_VER= CUSTOMER_RECORD_VERSION AND CPP_ID=3) THEN

			INSERT INTO CUSTOMER_FEE_DETAILS (CUSTOMER_ID,CED_REC_VER,CPP_ID,CFD_AMOUNT) VALUES (CUST_ID,CUSTOMER_RECORD_VERSION,3,PROCESSING_FEE);
			SET SUCCESS_FLAG=1;

		END IF;

	END IF;

	IF(OLD_PROCESSINGFEE_AMT IS NOT NULL AND PROCESSING_FEE IS NULL) THEN

		INSERT INTO TICKLER_HISTORY(TP_ID,TTIP_ID,TH_OLD_VALUE,ULD_ID,CUSTOMER_ID)VALUES
		((SELECT TP_ID FROM TICKLER_PROFILE WHERE TP_TYPE='DELETION'),
		(SELECT TTIP_ID FROM TICKLER_TABID_PROFILE WHERE TTIP_DATA='CUSTOMER_FEE_DETAILS'),
		(SELECT CONCAT('CFD_ID=',OLD_PROCESSINGFEE_CFDID,',','CED_REC_VER=',CUSTOMER_RECORD_VERSION,',','CPP_ID=3',',','CFD_AMOUNT=',OLD_PROCESSINGFEE_AMT)),
		USERSTAMP_ID,CUST_ID);

		DELETE FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=CUST_ID AND CED_REC_VER= CUSTOMER_RECORD_VERSION AND CPP_ID=3;
		SET SUCCESS_FLAG=1;
		
	END IF;

-- ELECTRICITY_CAP AMOUNT UPDATE
	IF(ELECTRICITY_CAP IS NOT NULL) THEN

		IF EXISTS(SELECT CPP_ID FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=CUST_ID AND CED_REC_VER= CUSTOMER_RECORD_VERSION AND CPP_ID=5) THEN

			IF(OLD_ELECTRICITY_CAP_AMT!=ELECTRICITY_CAP) THEN

				INSERT INTO TICKLER_HISTORY(TP_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,ULD_ID,CUSTOMER_ID)VALUES
				((SELECT TP_ID FROM TICKLER_PROFILE WHERE TP_TYPE='UPDATION'),
				(SELECT TTIP_ID FROM TICKLER_TABID_PROFILE WHERE TTIP_DATA='CUSTOMER_FEE_DETAILS'),
				(SELECT CONCAT('CFD_ID=',OLD_ELECTRICITY_CAP_CFDID,',','CED_REC_VER=',CUSTOMER_RECORD_VERSION,',','CPP_ID=5',',','CFD_AMOUNT=',OLD_ELECTRICITY_CAP_AMT)),
				(SELECT CONCAT('CFD_AMOUNT=',ELECTRICITY_CAP)),USERSTAMP_ID,CUST_ID);

				UPDATE CUSTOMER_FEE_DETAILS SET CFD_AMOUNT=ELECTRICITY_CAP WHERE CUSTOMER_ID=CUST_ID AND CED_REC_VER= CUSTOMER_RECORD_VERSION AND CPP_ID=5;
				SET SUCCESS_FLAG=1;

			END IF;

		END IF;

		IF NOT EXISTS (SELECT CPP_ID FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=CUST_ID AND CED_REC_VER= CUSTOMER_RECORD_VERSION AND CPP_ID=5) THEN

			INSERT INTO CUSTOMER_FEE_DETAILS (CUSTOMER_ID,CED_REC_VER,CPP_ID,CFD_AMOUNT) VALUES (CUST_ID,CUSTOMER_RECORD_VERSION,5,ELECTRICITY_CAP);
			SET SUCCESS_FLAG=1;

		END IF;

	END IF;

	IF(OLD_ELECTRICITY_CAP_AMT IS NOT NULL AND ELECTRICITY_CAP IS NULL) THEN

		INSERT INTO TICKLER_HISTORY(TP_ID,TTIP_ID,TH_OLD_VALUE,ULD_ID,CUSTOMER_ID)VALUES
		((SELECT TP_ID FROM TICKLER_PROFILE WHERE TP_TYPE='DELETION'),
		(SELECT TTIP_ID FROM TICKLER_TABID_PROFILE WHERE TTIP_DATA='CUSTOMER_FEE_DETAILS'),
		(SELECT CONCAT('CFD_ID=',OLD_ELECTRICITY_CAP_CFDID,',','CED_REC_VER=',CUSTOMER_RECORD_VERSION,',','CPP_ID=5',',','CFD_AMOUNT=',OLD_ELECTRICITY_CAP_AMT)),
		USERSTAMP_ID,CUST_ID);

		DELETE FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=CUST_ID AND CED_REC_VER= CUSTOMER_RECORD_VERSION AND CPP_ID=5;
		SET SUCCESS_FLAG=1;
		
	END IF;

-- DRYCLEAN_FEE AMOUNT UPDATE
	IF(DRYCLEAN_FEE IS NOT NULL) THEN

		IF EXISTS(SELECT CPP_ID FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=CUST_ID AND CED_REC_VER= CUSTOMER_RECORD_VERSION AND CPP_ID=6) THEN

			IF(OLD_DRYCLEAN_AMT!=DRYCLEAN_FEE) THEN

				INSERT INTO TICKLER_HISTORY(TP_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,ULD_ID,CUSTOMER_ID)VALUES
				((SELECT TP_ID FROM TICKLER_PROFILE WHERE TP_TYPE='UPDATION'),
				(SELECT TTIP_ID FROM TICKLER_TABID_PROFILE WHERE TTIP_DATA='CUSTOMER_FEE_DETAILS'),
				(SELECT CONCAT('CFD_ID=',OLD_DRYCLEAN_CFDID,',','CED_REC_VER=',CUSTOMER_RECORD_VERSION,',','CPP_ID=6',',','CFD_AMOUNT=',OLD_DRYCLEAN_AMT)),
				(SELECT CONCAT('CFD_AMOUNT=',DRYCLEAN_FEE)),USERSTAMP_ID,CUST_ID);

				UPDATE CUSTOMER_FEE_DETAILS SET CFD_AMOUNT=DRYCLEAN_FEE WHERE CUSTOMER_ID=CUST_ID AND CED_REC_VER= CUSTOMER_RECORD_VERSION AND CPP_ID=6;
				SET SUCCESS_FLAG=1;

			END IF;

		END IF;

		IF NOT EXISTS (SELECT CPP_ID FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=CUST_ID AND CED_REC_VER= CUSTOMER_RECORD_VERSION AND CPP_ID=6) THEN

			INSERT INTO CUSTOMER_FEE_DETAILS (CUSTOMER_ID,CED_REC_VER,CPP_ID,CFD_AMOUNT) VALUES (CUST_ID,CUSTOMER_RECORD_VERSION,6,DRYCLEAN_FEE);
			SET SUCCESS_FLAG=1;
		END IF;

	END IF;

	IF(OLD_DRYCLEAN_AMT IS NOT NULL AND DRYCLEAN_FEE IS NULL) THEN

		INSERT INTO TICKLER_HISTORY(TP_ID,TTIP_ID,TH_OLD_VALUE,ULD_ID,CUSTOMER_ID)VALUES
		((SELECT TP_ID FROM TICKLER_PROFILE WHERE TP_TYPE='DELETION'),
		(SELECT TTIP_ID FROM TICKLER_TABID_PROFILE WHERE TTIP_DATA='CUSTOMER_FEE_DETAILS'),
		(SELECT CONCAT('CFD_ID=',OLD_DRYCLEAN_CFDID,',','CED_REC_VER=',CUSTOMER_RECORD_VERSION,',','CPP_ID=6',',','CFD_AMOUNT=',OLD_DRYCLEAN_AMT)),
		USERSTAMP_ID,CUST_ID);

		DELETE FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=CUST_ID AND CED_REC_VER= CUSTOMER_RECORD_VERSION AND CPP_ID=6;
		SET SUCCESS_FLAG=1;
		
	END IF;

-- CHECKOUT_CLEANING_FEE AMOUNT UPDATE
	IF(CHECKOUT_CLEANING_FEE IS NOT NULL) THEN

		IF EXISTS(SELECT CPP_ID FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=CUST_ID AND CED_REC_VER= CUSTOMER_RECORD_VERSION AND CPP_ID=8) THEN

			IF(OLD_CLEANING_FEE_AMT!=CHECKOUT_CLEANING_FEE) THEN

				INSERT INTO TICKLER_HISTORY(TP_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,ULD_ID,CUSTOMER_ID)VALUES
				((SELECT TP_ID FROM TICKLER_PROFILE WHERE TP_TYPE='UPDATION'),
				(SELECT TTIP_ID FROM TICKLER_TABID_PROFILE WHERE TTIP_DATA='CUSTOMER_FEE_DETAILS'),
				(SELECT CONCAT('CFD_ID=',OLD_CLEANING_FEE_CFDID,',','CED_REC_VER=',CUSTOMER_RECORD_VERSION,',','CPP_ID=8',',','CFD_AMOUNT=',OLD_CLEANING_FEE_AMT)),
				(SELECT CONCAT('CFD_AMOUNT=',CHECKOUT_CLEANING_FEE)),USERSTAMP_ID,CUST_ID);

				UPDATE CUSTOMER_FEE_DETAILS SET CFD_AMOUNT = CHECKOUT_CLEANING_FEE WHERE CUSTOMER_ID=CUST_ID AND CED_REC_VER= CUSTOMER_RECORD_VERSION AND CPP_ID=8;
				SET SUCCESS_FLAG=1;

			END IF;

		END IF;

		IF NOT EXISTS (SELECT CPP_ID FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=CUST_ID AND CED_REC_VER= CUSTOMER_RECORD_VERSION AND CPP_ID=8) THEN

			INSERT INTO CUSTOMER_FEE_DETAILS (CUSTOMER_ID,CED_REC_VER,CPP_ID,CFD_AMOUNT) VALUES (CUST_ID,CUSTOMER_RECORD_VERSION,8,CHECKOUT_CLEANING_FEE);
			SET SUCCESS_FLAG=1;

		END IF;

	END IF;

	IF(OLD_CLEANING_FEE_AMT IS NOT NULL AND CHECKOUT_CLEANING_FEE IS NULL) THEN

		INSERT INTO TICKLER_HISTORY(TP_ID,TTIP_ID,TH_OLD_VALUE,ULD_ID,CUSTOMER_ID)VALUES
		((SELECT TP_ID FROM TICKLER_PROFILE WHERE TP_TYPE='DELETION'),
		(SELECT TTIP_ID FROM TICKLER_TABID_PROFILE WHERE TTIP_DATA='CUSTOMER_FEE_DETAILS'),
		(SELECT CONCAT('CFD_ID=',OLD_CLEANING_FEE_CFDID,',','CED_REC_VER=',CUSTOMER_RECORD_VERSION,',','CPP_ID=8',',','CFD_AMOUNT=',OLD_CLEANING_FEE_AMT)),
		USERSTAMP_ID,CUST_ID);

		DELETE FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=CUST_ID AND CED_REC_VER= CUSTOMER_RECORD_VERSION AND CPP_ID=8;
		SET SUCCESS_FLAG=1;
		
	END IF;

-- AIRCON AMOUNT UPDATE

	SET AIRCONEXSISTID=(SELECT CFD_ID FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=CUST_ID AND CED_REC_VER=CUSTOMER_RECORD_VERSION AND (CPP_ID=4 OR CPP_ID=7));
	SET OLD_AIRCON_CFDID=(SELECT CFD_ID FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=CUST_ID AND CED_REC_VER=CUSTOMER_RECORD_VERSION AND (CPP_ID=4 OR CPP_ID=7));
	SET OLD_AIRCON_AMT=(SELECT CFD_AMOUNT FROM CUSTOMER_FEE_DETAILS WHERE CFD_ID=OLD_AIRCON_CFDID);
	SET OLD_AIRCONCPPID=(SELECT CPP_ID FROM CUSTOMER_FEE_DETAILS WHERE CFD_ID=OLD_AIRCON_CFDID);

	IF(AIRCON_FIXED_FEE IS NULL AND OLD_AIRCON_FIXED_CFDID IS NOT NULL) THEN

		INSERT INTO TICKLER_HISTORY(TP_ID,TTIP_ID,TH_OLD_VALUE,ULD_ID,CUSTOMER_ID)VALUES
		((SELECT TP_ID FROM TICKLER_PROFILE WHERE TP_TYPE='DELETION'),
		(SELECT TTIP_ID FROM TICKLER_TABID_PROFILE WHERE TTIP_DATA='CUSTOMER_FEE_DETAILS'),
		(SELECT CONCAT('CFD_ID=',OLD_AIRCON_FIXED_CFDID,',','CED_REC_VER=',CUSTOMER_RECORD_VERSION,',','CPP_ID=4',',','CFD_AMOUNT=',OLD_AIRCON_FIXED_FEE)),
		USERSTAMP_ID,CUST_ID);

		DELETE FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=CUST_ID AND CED_REC_VER= CUSTOMER_RECORD_VERSION AND CPP_ID=4;
		SET SUCCESS_FLAG=1;
			
	END IF;

	IF(AIRCON_QUARTELY_FEE IS NULL AND OLD_AIRCON_QUARTELY_CFDID IS NOT NULL) THEN

		INSERT INTO TICKLER_HISTORY(TP_ID,TTIP_ID,TH_OLD_VALUE,ULD_ID,CUSTOMER_ID)VALUES
		((SELECT TP_ID FROM TICKLER_PROFILE WHERE TP_TYPE='DELETION'),
		(SELECT TTIP_ID FROM TICKLER_TABID_PROFILE WHERE TTIP_DATA='CUSTOMER_FEE_DETAILS'),
		(SELECT CONCAT('CFD_ID=',OLD_AIRCON_QUARTELY_CFDID,',','CED_REC_VER=',CUSTOMER_RECORD_VERSION,',','CPP_ID=7',',','CFD_AMOUNT=',OLD_AIRCON_QUARTELY_FEE)),
		USERSTAMP_ID,CUST_ID);

		DELETE FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=CUST_ID AND CED_REC_VER= CUSTOMER_RECORD_VERSION AND CPP_ID=7;
		SET SUCCESS_FLAG=1;
			
	END IF;

	IF(AIRCON_FIXED_FEE IS NOT NULL OR AIRCON_QUARTELY_FEE IS NOT NULL) THEN

		IF(AIRCON_FIXED_FEE IS NOT NULL) THEN

			SET AIRCONID=4;
			SET AIRCONAMOUNT=AIRCON_FIXED_FEE;
		
	  	END IF;

	  	IF(AIRCON_QUARTELY_FEE IS NOT NULL) THEN

	    	SET AIRCONID=7;
			SET AIRCONAMOUNT=AIRCON_QUARTELY_FEE;
		
	  	END IF;

	  	IF(OLD_AIRCONCPPID!=AIRCONID) OR (OLD_AIRCONCPPID IS NULL) THEN
	  	
	  		SET AIRCONEXSISTID = NULL;

	  	END IF;

  		IF(AIRCONEXSISTID IS NOT NULL AND OLD_AIRCON_AMT!=AIRCONAMOUNT AND OLD_AIRCONCPPID=AIRCONID) THEN

	  		INSERT INTO TICKLER_HISTORY(TP_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,ULD_ID,CUSTOMER_ID)VALUES
			((SELECT TP_ID FROM TICKLER_PROFILE WHERE TP_TYPE='UPDATION'),
			(SELECT TTIP_ID FROM TICKLER_TABID_PROFILE WHERE TTIP_DATA='CUSTOMER_FEE_DETAILS'),
			(SELECT CONCAT('CFD_ID=',OLD_AIRCON_CFDID,',','CED_REC_VER=',CUSTOMER_RECORD_VERSION,',','CPP_ID=',OLD_AIRCONCPPID,',','CFD_AMOUNT=',OLD_AIRCON_AMT)),
			(SELECT CONCAT('CFD_AMOUNT=',AIRCONAMOUNT)),USERSTAMP_ID,CUST_ID);

			UPDATE CUSTOMER_FEE_DETAILS SET CFD_AMOUNT=AIRCONAMOUNT,CPP_ID=AIRCONID WHERE CUSTOMER_ID=CUST_ID AND CED_REC_VER= CUSTOMER_RECORD_VERSION AND CFD_ID=AIRCONEXSISTID;
	     	SET SUCCESS_FLAG=1;

	    END IF;

	    IF(AIRCONEXSISTID IS NULL) THEN

			INSERT INTO CUSTOMER_FEE_DETAILS (CUSTOMER_ID,CED_REC_VER,CPP_ID,CFD_AMOUNT) VALUES (CUST_ID,CUSTOMER_RECORD_VERSION,AIRCONID,AIRCONAMOUNT);
			SET SUCCESS_FLAG=1;

		END IF;

	END IF;
	
END;
