-- VERSION:0.02 --DATE:08/05/2015 --DESC:ADDED TICKLER PART --DONE BY:RL

DROP PROCEDURE IF EXISTS SP_CUSTOMER_SEARCH_CUSTOMER_TABLE_UPDATE;
CREATE PROCEDURE SP_CUSTOMER_SEARCH_CUSTOMER_TABLE_UPDATE(
IN CUST_ID INTEGER,
IN FIRST_NAME CHAR(30),
IN LAST_NAME CHAR(30),
IN USERSTAMP VARCHAR(50),
OUT SUCCESS_FLAG INTEGER)

BEGIN

	DECLARE USERSTAMP_ID INTEGER;
	
    DECLARE OLD_FIRST_NAME CHAR(30);
	DECLARE OLD_LAST_NAME CHAR(30);

	DECLARE NEW_FIRST_NAME CHAR(30);
	DECLARE NEW_LAST_NAME CHAR(30);
	
	DECLARE CUSTOMERTABLE_ID VARCHAR(30);
	DECLARE CUSTOMERDETAILHEADERNAMES TEXT;
	DECLARE OLD_CUSTOMERTABLEDETAILS TEXT;
	DECLARE NEW_CUSTOMERTABLEDETAILS TEXT;
	DECLARE OLDCUSTOMERDETAILRECORDS TEXT;
	DECLARE NEWCUSTOMERDETAILRECORDS TEXT;
	DECLARE CUSTOMERDETAILHEADNAME TEXT;
	DECLARE OLD_CUSTOMERDETAILS TEXT;
	DECLARE NEW_CUSTOMERDETAILS TEXT;
	DECLARE CUSTOMERDETAIL_LENGTH INTEGER;
	DECLARE OLDCUSTOMERDETAILPOSITION INTEGER;
	DECLARE OLD_CUSTOMERDETAIL TEXT;
	DECLARE NEWCUSTOMERDETAILPOSITION INTEGER;
	DECLARE NEW_CUSTOMERDETAIL TEXT;
	DECLARE CUSTOMERDETAILHEADPOSITION INTEGER;
	DECLARE CHEADNAME TEXT;
	DECLARE CUSTOMER_LOCATION INTEGER;

	CALL SP_CHANGE_USERSTAMP_AS_ULDID(USERSTAMP,@ULDID);
	SET USERSTAMP_ID=(SELECT @ULDID);

-- PROCESS FOR CUSTOMER TABLE
	SET CUSTOMERTABLE_ID = '';
	SET OLD_FIRST_NAME = (SELECT CUSTOMER_FIRST_NAME FROM CUSTOMER WHERE CUSTOMER_ID = CUST_ID);
	SET OLD_LAST_NAME = (SELECT CUSTOMER_LAST_NAME FROM CUSTOMER WHERE CUSTOMER_ID = CUST_ID);
	SET NEW_FIRST_NAME = FIRST_NAME;
	SET NEW_LAST_NAME = LAST_NAME;

	SET CUSTOMERDETAILHEADERNAMES = 'CUSTOMER_ID,CUSTOMER_FIRST_NAME,CUSTOMER_LAST_NAME';
	SET OLD_CUSTOMERTABLEDETAILS = (SELECT CONCAT(CUST_ID,'^','^',OLD_FIRST_NAME,'^','^',OLD_LAST_NAME));
	SET NEW_CUSTOMERTABLEDETAILS = (SELECT CONCAT(CUST_ID,'^','^',NEW_FIRST_NAME,'^','^',NEW_LAST_NAME));

	IF(OLD_CUSTOMERTABLEDETAILS != NEW_CUSTOMERTABLEDETAILS)THEN
				
		SET OLDCUSTOMERDETAILRECORDS = OLD_CUSTOMERTABLEDETAILS;
		SET NEWCUSTOMERDETAILRECORDS = NEW_CUSTOMERTABLEDETAILS;
		SET CUSTOMERDETAILHEADNAME = CUSTOMERDETAILHEADERNAMES;
		SET OLD_CUSTOMERDETAILS = (SELECT CONCAT('CUSTOMER_ID=',CUST_ID));
		SET NEW_CUSTOMERDETAILS = '';
		SET CUSTOMERDETAIL_LENGTH = 1;
				
		loop_label : LOOP
					
			SET OLDCUSTOMERDETAILPOSITION = (SELECT LOCATE('^^',OLDCUSTOMERDETAILRECORDS,CUSTOMERDETAIL_LENGTH));
			IF (OLDCUSTOMERDETAILPOSITION=0) THEN
				SET OLD_CUSTOMERDETAIL = OLDCUSTOMERDETAILRECORDS;
			ELSE
				SET OLD_CUSTOMERDETAIL =(SELECT SUBSTRING(OLDCUSTOMERDETAILRECORDS,CUSTOMERDETAIL_LENGTH,OLDCUSTOMERDETAILPOSITION-1));
				SET OLDCUSTOMERDETAILRECORDS=(SELECT SUBSTRING(OLDCUSTOMERDETAILRECORDS,OLDCUSTOMERDETAILPOSITION+2));
			END IF;

			SET NEWCUSTOMERDETAILPOSITION = (SELECT LOCATE('^^',NEWCUSTOMERDETAILRECORDS,CUSTOMERDETAIL_LENGTH));
			IF (NEWCUSTOMERDETAILPOSITION=0) THEN
				SET NEW_CUSTOMERDETAIL = NEWCUSTOMERDETAILRECORDS;
			ELSE
				SET NEW_CUSTOMERDETAIL=(SELECT SUBSTRING(NEWCUSTOMERDETAILRECORDS,CUSTOMERDETAIL_LENGTH,NEWCUSTOMERDETAILPOSITION-1));
				SET NEWCUSTOMERDETAILRECORDS=(SELECT SUBSTRING(NEWCUSTOMERDETAILRECORDS,NEWCUSTOMERDETAILPOSITION+2));
			END IF;

			SET CUSTOMERDETAILHEADPOSITION = (SELECT LOCATE(',',CUSTOMERDETAILHEADNAME,CUSTOMERDETAIL_LENGTH));
			IF (CUSTOMERDETAILHEADPOSITION=0) THEN
				SET CHEADNAME = CUSTOMERDETAILHEADNAME;
			ELSE
				SET CHEADNAME=(SELECT SUBSTRING(CUSTOMERDETAILHEADNAME,CUSTOMERDETAIL_LENGTH,CUSTOMERDETAILHEADPOSITION-1));
				SET CUSTOMERDETAILHEADNAME=(SELECT SUBSTRING(CUSTOMERDETAILHEADNAME,CUSTOMERDETAILHEADPOSITION+1));
			END IF;

			IF(OLD_CUSTOMERDETAIL != NEW_CUSTOMERDETAIL)THEN
				SET OLD_CUSTOMERDETAIL=(SELECT CONCAT(CHEADNAME, '=', OLD_CUSTOMERDETAIL));
				SET NEW_CUSTOMERDETAIL=(SELECT CONCAT(CHEADNAME, '=' ,NEW_CUSTOMERDETAIL));
				SET NEW_CUSTOMERDETAILS=(SELECT CONCAT(NEW_CUSTOMERDETAILS,',',NEW_CUSTOMERDETAIL));
				SET OLD_CUSTOMERDETAILS=(SELECT CONCAT(OLD_CUSTOMERDETAILS,',',OLD_CUSTOMERDETAIL));
			END IF;  

			IF (CUSTOMERDETAILHEADPOSITION<=0) THEN
				LEAVE  loop_label;
			END IF;
			
		END LOOP;

		SET CUSTOMER_LOCATION=(SELECT LOCATE(',', NEW_CUSTOMERDETAILS,1));
		SET NEW_CUSTOMERDETAILS=(SELECT SUBSTRING(NEW_CUSTOMERDETAILS,CUSTOMER_LOCATION+1));

		IF(FIRST_NAME IS NOT NULL AND LAST_NAME IS NOT NULL) THEN

			INSERT INTO TICKLER_HISTORY(TP_ID,CUSTOMER_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,ULD_ID)VALUES
			((SELECT TP_ID FROM TICKLER_PROFILE WHERE TP_TYPE='UPDATION'),CUST_ID,
			(SELECT TTIP_ID FROM TICKLER_TABID_PROFILE WHERE TTIP_DATA='CUSTOMER'),
			OLD_CUSTOMERDETAILS,NEW_CUSTOMERDETAILS,USERSTAMP_ID);

			UPDATE CUSTOMER SET CUSTOMER_FIRST_NAME = FIRST_NAME, CUSTOMER_LAST_NAME = LAST_NAME WHERE CUSTOMER_ID=CUST_ID;
			
			SET SUCCESS_FLAG = 1;

		END IF;

	END IF;

END;
