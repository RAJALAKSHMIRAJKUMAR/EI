-- VERSION:0.02 --DATE:08/05/2015 --DESC:ADDED TICKLER PART --DONE BY:RL

DROP PROCEDURE IF EXISTS SP_CUSTOMER_SEARCH_COMPANY_DTLS_UPDATE;
CREATE PROCEDURE SP_CUSTOMER_SEARCH_COMPANY_DTLS_UPDATE(
IN CUST_ID INTEGER,
IN COMPANY_NAME VARCHAR(50),
IN COMPANY_ADDRESS VARCHAR(50),
IN POSTAL_CODE VARCHAR(6),
IN OFFICE_NO VARCHAR(8),
IN USERSTAMP VARCHAR(50),
OUT SUCCESS_FLAG INTEGER)

BEGIN

	DECLARE USERSTAMP_ID INTEGER;
	
	DECLARE OLD_CCDID INTEGER;
    DECLARE OLD_COMPANYNAME TEXT;
    DECLARE OLD_COMPANYADDR TEXT;
	DECLARE OLD_POSTALCODE TEXT;
	DECLARE OLD_OFFICENO TEXT;	

    DECLARE NEW_COMPANYNAME TEXT;
    DECLARE NEW_COMPANYADDR TEXT;
	DECLARE NEW_POSTALCODE TEXT;
	DECLARE NEW_OFFICENO TEXT;
	
    DECLARE OLD_COMPANYTABLEDETAILS TEXT;
    DECLARE NEW_COMPANYTABLEDETAILS TEXT;
    DECLARE COMPANY_HEADERNAME TEXT;
    DECLARE CCD_LENGTH INTEGER;
    DECLARE OLDCOMPANYPOSITION INTEGER;
    DECLARE OLD_COMPANYS TEXT;
    DECLARE NEWCOMPANYPOSITION INTEGER;
    DECLARE NEW_COMPANYS TEXT;
    DECLARE COMPANYHEADPOSITION INTEGER;
    DECLARE COMPANYHEADNAME TEXT;
    DECLARE NEWCOMPANYRECORDS TEXT ;
    DECLARE OLDCOMPANYRECORDS TEXT ;
    DECLARE COMPANYHEADERNAMES TEXT;
    DECLARE CUSTCOMPANY_ID VARCHAR(30);
    DECLARE OLD_COMPANYDTL TEXT;
    DECLARE NEW_COMPANYDTL TEXT;
    DECLARE CUSTCOMPANYHEADERNAME TEXT;
    DECLARE COMPANY_LOCATION INTEGER;	
	DECLARE CCDID INTEGER;
    DECLARE THID INTEGER;	

	CALL SP_CHANGE_USERSTAMP_AS_ULDID(USERSTAMP,@ULDID);
	SET USERSTAMP_ID = (SELECT @ULDID);	

-- set null for non mandatory fields in CUSTOMER_COMPANY_DETAILS table
	IF COMPANY_NAME='' THEN
		SET COMPANY_NAME=NULL;
	END IF;
	IF COMPANY_ADDRESS='' THEN
		SET COMPANY_ADDRESS=NULL;
	END IF;
	IF POSTAL_CODE='' THEN
		SET POSTAL_CODE=NULL;
	END IF;
	IF OFFICE_NO='' THEN
		SET OFFICE_NO=NULL;
	END IF;

	SET CUSTCOMPANY_ID = '';	   
	SET OLD_CCDID = (SELECT CCD_ID FROM CUSTOMER_COMPANY_DETAILS WHERE CUSTOMER_ID = CUST_ID);	   
	
	SET OLD_COMPANYNAME = (SELECT CCD_COMPANY_NAME FROM CUSTOMER_COMPANY_DETAILS WHERE CUSTOMER_ID = CUST_ID);
	IF(OLD_COMPANYNAME IS NULL)THEN
		SET OLD_COMPANYNAME = 'NULL';
	END IF;	

	SET OLD_COMPANYADDR = (SELECT CCD_COMPANY_ADDR FROM CUSTOMER_COMPANY_DETAILS WHERE CUSTOMER_ID = CUST_ID);
	IF(OLD_COMPANYADDR IS NULL)THEN
		SET OLD_COMPANYADDR = 'NULL';
	END IF;	

	SET OLD_POSTALCODE = (SELECT CCD_POSTAL_CODE FROM CUSTOMER_COMPANY_DETAILS WHERE CUSTOMER_ID = CUST_ID);
	IF(OLD_POSTALCODE IS NULL)THEN
		SET OLD_POSTALCODE = 'NULL';
	END IF;		

	SET OLD_OFFICENO = (SELECT CCD_OFFICE_NO FROM CUSTOMER_COMPANY_DETAILS WHERE CUSTOMER_ID = CUST_ID);
	IF(OLD_OFFICENO IS NULL)THEN
		SET OLD_OFFICENO = 'NULL';
	END IF;	

	SET NEW_COMPANYNAME = COMPANY_NAME;
	IF(NEW_COMPANYNAME IS NULL)THEN
		SET NEW_COMPANYNAME = 'NULL';
	END IF;		
	SET NEW_COMPANYADDR = COMPANY_ADDRESS;
	IF(NEW_COMPANYADDR IS NULL)THEN
		SET NEW_COMPANYADDR = 'NULL';
	END IF;		
	SET NEW_POSTALCODE = POSTAL_CODE;
	IF(NEW_POSTALCODE IS NULL)THEN
		SET NEW_POSTALCODE = 'NULL';
	END IF;		
	SET NEW_OFFICENO = OFFICE_NO;
	IF(NEW_OFFICENO IS NULL)THEN
		SET NEW_OFFICENO = 'NULL';
	END IF;	

	IF(COMPANY_NAME IS NULL AND COMPANY_ADDRESS IS NULL AND POSTAL_CODE IS NULL AND OFFICE_NO IS NULL) THEN

		IF EXISTS(SELECT CUSTOMER_ID FROM CUSTOMER_COMPANY_DETAILS WHERE CUSTOMER_ID=CUST_ID) THEN			
			
			SET CCDID = (SELECT CCD_ID FROM CUSTOMER_COMPANY_DETAILS WHERE CUSTOMER_ID=CUST_ID);				
			CALL SP_CUSTOMER_ROW_DELETION(9,CCDID,USERSTAMP_ID);				
			SET SUCCESS_FLAG=1;		

		END IF;	

	ELSEIF (COMPANY_NAME IS NOT NULL OR COMPANY_ADDRESS IS NOT NULL OR POSTAL_CODE IS NULL OR OFFICE_NO IS NOT NULL) THEN	   
		
		SET COMPANYHEADERNAMES = 'CCD_ID,CCD_COMPANY_NAME,CCD_COMPANY_ADDR,CCD_POSTAL_CODE,CCD_OFFICE_NO';
		SET OLD_COMPANYTABLEDETAILS = (SELECT CONCAT(OLD_CCDID,'^','^',OLD_COMPANYNAME,'^','^',OLD_COMPANYADDR,'^','^',OLD_POSTALCODE,'^','^',OLD_OFFICENO));
		SET NEW_COMPANYTABLEDETAILS = (SELECT CONCAT(OLD_CCDID,'^','^',NEW_COMPANYNAME,'^','^',NEW_COMPANYADDR,'^','^',NEW_POSTALCODE,'^','^',NEW_OFFICENO));	   
	
		IF(OLD_COMPANYTABLEDETAILS != NEW_COMPANYTABLEDETAILS)THEN	

			SET OLDCOMPANYRECORDS = OLD_COMPANYTABLEDETAILS;
			SET NEWCOMPANYRECORDS = NEW_COMPANYTABLEDETAILS;
			SET COMPANYHEADNAME = COMPANYHEADERNAMES;
			SET OLD_COMPANYS = (SELECT CONCAT('CCD_ID=',OLD_CCDID));
			SET NEW_COMPANYS = '';
			SET CCD_LENGTH = 1;			
		
			loop_label : LOOP	

				SET OLDCOMPANYPOSITION = (SELECT LOCATE('^^',OLDCOMPANYRECORDS,CCD_LENGTH));
				IF (OLDCOMPANYPOSITION=0) THEN
					SET OLD_COMPANYDTL = OLDCOMPANYRECORDS;
				ELSE
					SET OLD_COMPANYDTL =(SELECT SUBSTRING(OLDCOMPANYRECORDS,CCD_LENGTH,OLDCOMPANYPOSITION-1));
					SET OLDCOMPANYRECORDS=(SELECT SUBSTRING(OLDCOMPANYRECORDS,OLDCOMPANYPOSITION+2));
				END IF;		

				SET NEWCOMPANYPOSITION = (SELECT LOCATE('^^',NEWCOMPANYRECORDS,CCD_LENGTH));
				IF (NEWCOMPANYPOSITION=0) THEN
					SET NEW_COMPANYDTL = NEWCOMPANYRECORDS;
				ELSE
					SET NEW_COMPANYDTL=(SELECT SUBSTRING(NEWCOMPANYRECORDS,CCD_LENGTH,NEWCOMPANYPOSITION-1));
					SET NEWCOMPANYRECORDS=(SELECT SUBSTRING(NEWCOMPANYRECORDS,NEWCOMPANYPOSITION+2));
				END IF;	

				SET COMPANYHEADPOSITION = (SELECT LOCATE(',',COMPANYHEADNAME,CCD_LENGTH));
				IF (COMPANYHEADPOSITION=0) THEN
					SET CUSTCOMPANYHEADERNAME = COMPANYHEADNAME;
				ELSE
					SET CUSTCOMPANYHEADERNAME=(SELECT SUBSTRING(COMPANYHEADNAME,CCD_LENGTH,COMPANYHEADPOSITION-1));
					SET COMPANYHEADNAME=(SELECT SUBSTRING(COMPANYHEADNAME,COMPANYHEADPOSITION+1));
				END IF;	

				IF(OLD_COMPANYDTL != NEW_COMPANYDTL)THEN
					SET OLD_COMPANYDTL=(SELECT CONCAT(CUSTCOMPANYHEADERNAME, '=', OLD_COMPANYDTL));
					SET NEW_COMPANYDTL=(SELECT CONCAT(CUSTCOMPANYHEADERNAME, '=' ,NEW_COMPANYDTL));
					SET NEW_COMPANYS=(SELECT CONCAT(NEW_COMPANYS,',',NEW_COMPANYDTL));
					SET OLD_COMPANYS=(SELECT CONCAT(OLD_COMPANYS,',',OLD_COMPANYDTL));
				END IF; 

				IF (COMPANYHEADPOSITION<=0) THEN
					LEAVE  loop_label;
				END IF;	

			END LOOP;		  
		
			SET COMPANY_LOCATION=(SELECT LOCATE(',', NEW_COMPANYS,1));
			SET NEW_COMPANYS=(SELECT SUBSTRING(NEW_COMPANYS,COMPANY_LOCATION+1));		   
-- UPDATE QUERY FOR CUSTOMER_COMPANY_DETAILS (CUSTOMER_ID EXISTS)
			IF EXISTS(SELECT CUSTOMER_ID FROM CUSTOMER_COMPANY_DETAILS WHERE CUSTOMER_ID=CUST_ID) THEN
			
				INSERT INTO TICKLER_HISTORY(TP_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,ULD_ID,CUSTOMER_ID)VALUES
				((SELECT TP_ID FROM TICKLER_PROFILE WHERE TP_TYPE='UPDATION'),
				(SELECT TTIP_ID FROM TICKLER_TABID_PROFILE WHERE TTIP_DATA='CUSTOMER_COMPANY_DETAILS'),
				OLD_COMPANYS,NEW_COMPANYS,USERSTAMP_ID,CUST_ID);

				UPDATE CUSTOMER_COMPANY_DETAILS SET CCD_COMPANY_NAME=COMPANY_NAME,CCD_COMPANY_ADDR=COMPANY_ADDRESS, CCD_POSTAL_CODE=POSTAL_CODE,CCD_OFFICE_NO=OFFICE_NO WHERE CUSTOMER_ID=CUST_ID;
			
				SET SUCCESS_FLAG = 1;	

			END IF;			   
	
		END IF;	
	
	END IF;	

	IF NOT EXISTS(SELECT CUSTOMER_ID FROM CUSTOMER_COMPANY_DETAILS WHERE CUSTOMER_ID=CUST_ID)THEN

		IF(COMPANY_NAME IS NOT NULL OR COMPANY_ADDRESS IS NOT NULL OR POSTAL_CODE IS NOT NULL OR OFFICE_NO IS NOT NULL) THEN

			INSERT INTO CUSTOMER_COMPANY_DETAILS(CUSTOMER_ID,CCD_COMPANY_NAME,CCD_COMPANY_ADDR,CCD_POSTAL_CODE,CCD_OFFICE_NO) VALUES(CUST_ID,COMPANY_NAME,COMPANY_ADDRESS,POSTAL_CODE,OFFICE_NO);
			SET SUCCESS_FLAG=1;

		END IF;

	END IF;

END;
