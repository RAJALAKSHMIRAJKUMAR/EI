-- VERSION:0.02 --DATE:09/05/2015 --DESC:ADDED TICKLER PART --DONE BY:RL


DROP PROCEDURE IF EXISTS SP_CUSTOMER_SEARCH_ACCESS_TERMINATION_DTLS_UPDATE;
CREATE PROCEDURE SP_CUSTOMER_SEARCH_ACCESS_TERMINATION_DTLS_UPDATE(
IN CUST_ID INTEGER,
IN CUSTOMER_RECORD_VERSION INTEGER,
IN UNIT_NUMBER INTEGER,
IN START_DATE DATE,
IN END_DATE DATE,
IN ACCESS_CARD TEXT,
IN ACCESS_CARD_DATES TEXT,
IN USERSTAMP VARCHAR(50),
OUT SUCCESS_FLAG INTEGER)

BEGIN

	DECLARE CARD_VALID_FROM DATE;
	DECLARE OLD_TEMP_ACCESS_CARD TEXT;
	DECLARE OLD_ACCESS_CARD_NO VARCHAR(7);
	DECLARE OLD_ACCESS_POSITION INTEGER;
	DECLARE OLD_ACCESS_LOCATION INTEGER;
	DECLARE OLD_ACCESS_LENGTH INTEGER;

	DECLARE NEW_TEMP_ACCESS_CARD TEXT;
	DECLARE NEW_ACCESS_POSITION INTEGER;
	DECLARE NEW_ACCESS_LOCATION INTEGER;
	DECLARE NEW_ACCESS_LENGTH INTEGER;
	DECLARE NEW_GUEST_ACCESS_LENGTH INTEGER;
	DECLARE NEW_GUEST_FLAG CHAR(1);

	DECLARE ACCESS_CARD_FULL_LENGTH INTEGER;
	DECLARE ACCESS_FULL_CARD VARCHAR(50);
	DECLARE CARD_NO VARCHAR(10);
	DECLARE CARD_STARTDATE VARCHAR(15);
	DECLARE ACCESS_CARD_LENGTH INTEGER;
	DECLARE TEMP_ACCESS_CARD TEXT;
	DECLARE ACCESS_POSITION INTEGER;

	DECLARE ACCESS_CARD_NO TEXT;
	DECLARE ACCESS_LENGTH INTEGER;
	DECLARE CARD_DATE_SPLIT INTEGER;
	DECLARE ACCESSCARD_STARTDATE VARCHAR(12);
	DECLARE ACCESSCARD_ENDDATE VARCHAR(12);
	DECLARE TEMP_ACCESS_CARD_LENGTH INTEGER;

	DECLARE CARDNO_POSITION INTEGER;
	DECLARE CARDDATE_POSITION INTEGER;
	DECLARE CARD_STARTDATE_POSITION INTEGER;
	DECLARE CARD_ENDDATE_POSITION INTEGER;
	DECLARE CARD_START_DATE VARCHAR(15);
	DECLARE CARD_END_DATE VARCHAR(15);
	DECLARE USERSTAMP_ID INTEGER(2);

	DECLARE PTDDATE DATE;
	DECLARE ULDTSMAXTIMES INT;
	
	DECLARE OLDCACD_ID TEXT;
	DECLARE OLD_ULDID TEXT;
	DECLARE OLD_CARD_FROMDATE TEXT;
	DECLARE OLD_CACD_TIMESTAMP TEXT;
	DECLARE OLD_UASDID TEXT;

	DECLARE OLDCLPID TEXT;
	DECLARE OLD_CLPUASDID TEXT;
	DECLARE OLD_CLPSDATE TEXT;
	DECLARE OLD_CLPEDATE TEXT;
	DECLARE OLD_CLP_ULDID TEXT;
	DECLARE OLD_CLP_TIMESTAMP TEXT;
	DECLARE OLDCLPUASD_ID TEXT;

	CALL SP_CHANGE_USERSTAMP_AS_ULDID(USERSTAMP,@ULDID);
	SET USERSTAMP_ID=(SELECT @ULDID);

	SET PTDDATE=(SELECT CLP_PRETERMINATE_DATE FROM CUSTOMER_LP_DETAILS WHERE CUSTOMER_ID=CUST_ID AND CED_REC_VER=CUSTOMER_RECORD_VERSION AND CLP_GUEST_CARD IS NULL);

	IF ACCESS_CARD IS NOT NULL THEN

       SET TEMP_ACCESS_CARD = ACCESS_CARD;
       SET ACCESS_LENGTH=1;
   
   		loop_label : LOOP

       		SET CARDNO_POSITION=(SELECT LOCATE(',',TEMP_ACCESS_CARD,ACCESS_LENGTH));
       		SET CARD_NO = (SELECT SUBSTRING(TEMP_ACCESS_CARD,ACCESS_LENGTH,CARDNO_POSITION-1));
       		SET TEMP_ACCESS_CARD = (SELECT SUBSTRING(TEMP_ACCESS_CARD,CARDNO_POSITION+1));
       		SET CARDDATE_POSITION = (SELECT LOCATE(',',TEMP_ACCESS_CARD,ACCESS_LENGTH));
            
            IF(CARDDATE_POSITION=0) THEN
                SET CARD_STARTDATE = TEMP_ACCESS_CARD;
            ELSE
           		SET CARD_STARTDATE=(SELECT SUBSTRING(TEMP_ACCESS_CARD,ACCESS_LENGTH,CARDDATE_POSITION-1));
       		END IF;

       		SET TEMP_ACCESS_CARD = (SELECT SUBSTRING(TEMP_ACCESS_CARD,CARDDATE_POSITION+1));

       		IF(CARD_NO IS NOT NULL) THEN

	       		SET OLDCACD_ID = (SELECT CACD_ID FROM CUSTOMER_ACCESS_CARD_DETAILS WHERE CUSTOMER_ID=CUST_ID AND UASD_ID=(SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=CARD_NO)); 
	       		SET OLD_UASDID = (SELECT UASD_ID FROM CUSTOMER_ACCESS_CARD_DETAILS WHERE CUSTOMER_ID=CUST_ID AND UASD_ID=(SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=CARD_NO));
	       		SET OLD_CARD_FROMDATE = (SELECT CACD_VALID_FROM FROM CUSTOMER_ACCESS_CARD_DETAILS WHERE CUSTOMER_ID=CUST_ID AND UASD_ID=(SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=CARD_NO));
	       		SET OLD_ULDID = (SELECT ULD_ID FROM CUSTOMER_ACCESS_CARD_DETAILS WHERE CUSTOMER_ID=CUST_ID AND UASD_ID=(SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=CARD_NO)); 
	       		SET OLD_CACD_TIMESTAMP =(SELECT CACD_TIMESTAMP FROM CUSTOMER_ACCESS_CARD_DETAILS WHERE CUSTOMER_ID=CUST_ID AND UASD_ID=(SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=CARD_NO));

	       	END IF;

       		IF(OLD_CARD_FROMDATE!=CARD_STARTDATE AND OLD_ULDID!=USERSTAMP_ID AND OLD_CARD_FROMDATE!='0000-00-00' AND CARD_STARTDATE IS NOT NULL AND CARD_STARTDATE!='0000-00-00') THEN

       			INSERT INTO TICKLER_HISTORY(TP_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,ULD_ID,CUSTOMER_ID)VALUES
				((SELECT TP_ID FROM TICKLER_PROFILE WHERE TP_TYPE='UPDATION'),
				(SELECT TTIP_ID FROM TICKLER_TABID_PROFILE WHERE TTIP_DATA='CUSTOMER_ACCESS_CARD_DETAILS'),
				(SELECT CONCAT('CACD_ID=',OLDCACD_ID,',','UASD_ID=',OLD_UASDID,',','CACD_VALID_FROM=',OLD_CARD_FROMDATE,',','ULD_ID=',OLD_ULDID,',','OLD_CACD_TIMESTAMP=',OLD_CACD_TIMESTAMP)),
				(SELECT CONCAT('CACD_VALID_FROM=',CARD_STARTDATE)),USERSTAMP_ID,CUST_ID);

			END IF;

			IF(OLD_CARD_FROMDATE!=CARD_STARTDATE AND OLD_ULDID=USERSTAMP_ID AND OLD_CARD_FROMDATE!='0000-00-00' AND CARD_STARTDATE IS NOT NULL AND CARD_STARTDATE!='0000-00-00') THEN

				INSERT INTO TICKLER_HISTORY(TP_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,ULD_ID,CUSTOMER_ID)VALUES
				((SELECT TP_ID FROM TICKLER_PROFILE WHERE TP_TYPE='UPDATION'),
				(SELECT TTIP_ID FROM TICKLER_TABID_PROFILE WHERE TTIP_DATA='CUSTOMER_ACCESS_CARD_DETAILS'),
				(SELECT CONCAT('CACD_ID=',OLDCACD_ID,',','UASD_ID=',OLD_UASDID,',','CACD_VALID_FROM=',OLD_CARD_FROMDATE,',','OLD_CACD_TIMESTAMP=',OLD_CACD_TIMESTAMP)),
				(SELECT CONCAT('CACD_VALID_FROM=',CARD_STARTDATE)),USERSTAMP_ID,CUST_ID);

			END IF;

			IF(CARD_STARTDATE IS NOT NULL AND CARD_STARTDATE!='0000-00-00') THEN
            
            	UPDATE CUSTOMER_ACCESS_CARD_DETAILS SET CACD_VALID_FROM=CARD_STARTDATE,ULD_ID=USERSTAMP_ID WHERE CUSTOMER_ID=CUST_ID AND ACN_ID IS NULL AND UASD_ID=(SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=CARD_NO AND UNIT_ID=(SELECT UNIT_ID FROM UNIT WHERE UNIT_NO=UNIT_NUMBER));
			
				SET SUCCESS_FLAG=1;

			END IF;

       		IF CARDDATE_POSITION<=0 THEN
           		LEAVE  loop_label;
       		END IF;
   
   		END LOOP;

	END IF;

	IF START_DATE IS NOT NULL AND END_DATE IS NOT NULL THEN

		SET TEMP_ACCESS_CARD = ACCESS_CARD_DATES;
		SET ACCESS_LENGTH = 1;
    
    	loop_label : LOOP

	        SET CARDNO_POSITION=(SELECT LOCATE(',',TEMP_ACCESS_CARD,ACCESS_LENGTH));
	        SET CARD_NO = (SELECT SUBSTRING(TEMP_ACCESS_CARD,ACCESS_LENGTH,CARDNO_POSITION-1));
	        SET TEMP_ACCESS_CARD = (SELECT SUBSTRING(TEMP_ACCESS_CARD,CARDNO_POSITION+1));
	        SET CARD_STARTDATE_POSITION = (SELECT LOCATE(',',TEMP_ACCESS_CARD,ACCESS_LENGTH));
	        SET CARD_START_DATE= (SELECT SUBSTRING(TEMP_ACCESS_CARD,ACCESS_LENGTH,CARD_STARTDATE_POSITION-1));
	        SET TEMP_ACCESS_CARD = (SELECT SUBSTRING(TEMP_ACCESS_CARD,CARD_STARTDATE_POSITION+1));
	        SET CARD_ENDDATE_POSITION = (SELECT LOCATE(',',TEMP_ACCESS_CARD,ACCESS_LENGTH));   
        
	        IF (CARD_ENDDATE_POSITION=0) THEN
	            SET CARD_END_DATE = TEMP_ACCESS_CARD;
	        ELSE
	            SET CARD_END_DATE=(SELECT SUBSTRING(TEMP_ACCESS_CARD,ACCESS_LENGTH,CARD_ENDDATE_POSITION-1));
	        END IF;

        	SET TEMP_ACCESS_CARD = (SELECT SUBSTRING(TEMP_ACCESS_CARD,CARD_ENDDATE_POSITION+1));

        	SET OLDCLPID = (SELECT CLP_ID FROM CUSTOMER_LP_DETAILS WHERE CUSTOMER_ID=CUST_ID AND CED_REC_VER=CUSTOMER_RECORD_VERSION AND UASD_ID=(SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=CARD_NO AND UNIT_ID=(SELECT UNIT_ID FROM UNIT WHERE UNIT_NO=UNIT_NUMBER)));
			SET OLD_CLPUASDID = (SELECT UASD_ID FROM CUSTOMER_LP_DETAILS WHERE CUSTOMER_ID=CUST_ID AND CED_REC_VER=CUSTOMER_RECORD_VERSION AND UASD_ID=(SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=CARD_NO AND UNIT_ID=(SELECT UNIT_ID FROM UNIT WHERE UNIT_NO=UNIT_NUMBER)));
			SET OLDCLPUASD_ID = OLD_CLPUASDID;
			IF(OLD_CLPUASDID IS NULL OR OLD_CLPUASDID=' ' OR OLD_CLPUASDID='') THEN
				SET OLD_CLPUASDID='NULL';
			END IF;
			SET OLD_CLPSDATE = (SELECT CLP_STARTDATE FROM CUSTOMER_LP_DETAILS WHERE CUSTOMER_ID=CUST_ID AND CED_REC_VER=CUSTOMER_RECORD_VERSION AND UASD_ID=(SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=CARD_NO AND UNIT_ID=(SELECT UNIT_ID FROM UNIT WHERE UNIT_NO=UNIT_NUMBER)));
			SET OLD_CLPEDATE = (SELECT CLP_ENDDATE FROM CUSTOMER_LP_DETAILS WHERE CUSTOMER_ID=CUST_ID AND CED_REC_VER=CUSTOMER_RECORD_VERSION AND UASD_ID=(SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=CARD_NO AND UNIT_ID=(SELECT UNIT_ID FROM UNIT WHERE UNIT_NO=UNIT_NUMBER)));
			SET OLD_CLP_ULDID = (SELECT ULD_ID FROM CUSTOMER_LP_DETAILS WHERE CUSTOMER_ID=CUST_ID AND CED_REC_VER=CUSTOMER_RECORD_VERSION AND UASD_ID=(SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=CARD_NO AND UNIT_ID=(SELECT UNIT_ID FROM UNIT WHERE UNIT_NO=UNIT_NUMBER)));
			SET OLD_CLP_TIMESTAMP = (SELECT CLP_TIMESTAMP FROM CUSTOMER_LP_DETAILS WHERE CUSTOMER_ID=CUST_ID AND CED_REC_VER=CUSTOMER_RECORD_VERSION AND UASD_ID=(SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=CARD_NO AND UNIT_ID=(SELECT UNIT_ID FROM UNIT WHERE UNIT_NO=UNIT_NUMBER)));
        
        	IF(OLDCLPUASD_ID IS NOT NULL) THEN

	        	IF (OLD_CLPSDATE!=CARD_START_DATE AND OLD_CLPEDATE!=CARD_END_DATE AND OLD_CLP_ULDID!=USERSTAMP_ID)THEN

	        		INSERT INTO TICKLER_HISTORY(TP_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,ULD_ID,CUSTOMER_ID)VALUES
					((SELECT TP_ID FROM TICKLER_PROFILE WHERE TP_TYPE='UPDATION'),
					(SELECT TTIP_ID FROM TICKLER_TABID_PROFILE WHERE TTIP_DATA='CUSTOMER_LP_DETAILS'),
					(SELECT CONCAT('CLP_ID=',OLDCLPID,',','CED_REC_VER=',CUSTOMER_RECORD_VERSION,',','UASD_ID=',OLD_CLPUASDID,',','CLP_STARTDATE=',OLD_CLPSDATE,
					',','CLP_ENDDATE=',OLD_CLPEDATE,',','ULD_ID=',OLD_CLP_ULDID,',','CLP_TIMESTAMP=',OLD_CLP_TIMESTAMP)),
					(SELECT CONCAT('CLP_STARTDATE=',CARD_START_DATE,',','CLP_ENDDATE=',CARD_END_DATE)),USERSTAMP_ID,CUST_ID);

				END IF;

				IF (OLD_CLPSDATE!=CARD_START_DATE AND OLD_CLPEDATE!=CARD_END_DATE AND OLD_CLP_ULDID=USERSTAMP_ID)THEN

	        		INSERT INTO TICKLER_HISTORY(TP_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,ULD_ID,CUSTOMER_ID)VALUES
					((SELECT TP_ID FROM TICKLER_PROFILE WHERE TP_TYPE='UPDATION'),
					(SELECT TTIP_ID FROM TICKLER_TABID_PROFILE WHERE TTIP_DATA='CUSTOMER_LP_DETAILS'),
					(SELECT CONCAT('CLP_ID=',OLDCLPID,',','CED_REC_VER=',CUSTOMER_RECORD_VERSION,',','UASD_ID=',OLD_CLPUASDID,',','CLP_STARTDATE=',OLD_CLPSDATE,
					',','CLP_ENDDATE=',OLD_CLPEDATE,',','CLP_TIMESTAMP=',OLD_CLP_TIMESTAMP)),
					(SELECT CONCAT('CLP_STARTDATE=',CARD_START_DATE,',','CLP_ENDDATE=',CARD_END_DATE)),USERSTAMP_ID,CUST_ID);

				END IF;


				IF (OLD_CLPSDATE!=CARD_START_DATE AND OLD_CLPEDATE=CARD_END_DATE AND OLD_CLP_ULDID!=USERSTAMP_ID)THEN

	        		INSERT INTO TICKLER_HISTORY(TP_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,ULD_ID,CUSTOMER_ID)VALUES
					((SELECT TP_ID FROM TICKLER_PROFILE WHERE TP_TYPE='UPDATION'),
					(SELECT TTIP_ID FROM TICKLER_TABID_PROFILE WHERE TTIP_DATA='CUSTOMER_LP_DETAILS'),
					(SELECT CONCAT('CLP_ID=',OLDCLPID,',','CED_REC_VER=',CUSTOMER_RECORD_VERSION,',','UASD_ID=',OLD_CLPUASDID,',','CLP_STARTDATE=',OLD_CLPSDATE,
					',','ULD_ID=',OLD_CLP_ULDID,',','CLP_TIMESTAMP=',OLD_CLP_TIMESTAMP)),
					(SELECT CONCAT('CLP_STARTDATE=',CARD_START_DATE)),USERSTAMP_ID,CUST_ID);

				END IF;

				IF (OLD_CLPSDATE!=CARD_START_DATE AND OLD_CLPEDATE=CARD_END_DATE AND OLD_CLP_ULDID=USERSTAMP_ID)THEN

	        		INSERT INTO TICKLER_HISTORY(TP_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,ULD_ID,CUSTOMER_ID)VALUES
					((SELECT TP_ID FROM TICKLER_PROFILE WHERE TP_TYPE='UPDATION'),
					(SELECT TTIP_ID FROM TICKLER_TABID_PROFILE WHERE TTIP_DATA='CUSTOMER_LP_DETAILS'),
					(SELECT CONCAT('CLP_ID=',OLDCLPID,',','CED_REC_VER=',CUSTOMER_RECORD_VERSION,',','UASD_ID=',OLD_CLPUASDID,',','CLP_STARTDATE=',OLD_CLPSDATE,
					',','CLP_TIMESTAMP=',OLD_CLP_TIMESTAMP)),
					(SELECT CONCAT('CLP_STARTDATE=',CARD_START_DATE)),USERSTAMP_ID,CUST_ID);

				END IF;

				IF (OLD_CLPSDATE=CARD_START_DATE AND OLD_CLPEDATE!=CARD_END_DATE AND OLD_CLP_ULDID!=USERSTAMP_ID)THEN

	        		INSERT INTO TICKLER_HISTORY(TP_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,ULD_ID,CUSTOMER_ID)VALUES
					((SELECT TP_ID FROM TICKLER_PROFILE WHERE TP_TYPE='UPDATION'),
					(SELECT TTIP_ID FROM TICKLER_TABID_PROFILE WHERE TTIP_DATA='CUSTOMER_LP_DETAILS'),
					(SELECT CONCAT('CLP_ID=',OLDCLPID,',','CED_REC_VER=',CUSTOMER_RECORD_VERSION,',','UASD_ID=',OLD_CLPUASDID,
					',','CLP_ENDDATE=',OLD_CLPEDATE,',','ULD_ID=',OLD_CLP_ULDID,',','CLP_TIMESTAMP=',OLD_CLP_TIMESTAMP)),
					(SELECT CONCAT('CLP_ENDDATE=',CARD_END_DATE)),USERSTAMP_ID,CUST_ID);

				END IF;

				IF (OLD_CLPSDATE=CARD_START_DATE AND OLD_CLPEDATE!=CARD_END_DATE AND OLD_CLP_ULDID=USERSTAMP_ID)THEN

	        		INSERT INTO TICKLER_HISTORY(TP_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,ULD_ID,CUSTOMER_ID)VALUES
					((SELECT TP_ID FROM TICKLER_PROFILE WHERE TP_TYPE='UPDATION'),
					(SELECT TTIP_ID FROM TICKLER_TABID_PROFILE WHERE TTIP_DATA='CUSTOMER_LP_DETAILS'),
					(SELECT CONCAT('CLP_ID=',OLDCLPID,',','CED_REC_VER=',CUSTOMER_RECORD_VERSION,',','UASD_ID=',OLD_CLPUASDID,
					',','CLP_ENDDATE=',OLD_CLPEDATE,',','CLP_TIMESTAMP=',OLD_CLP_TIMESTAMP)),
					(SELECT CONCAT('CLP_ENDDATE=',CARD_END_DATE)),USERSTAMP_ID,CUST_ID);

				END IF;

			END IF;

			IF(OLDCLPUASD_ID IS NULL) THEN

	        	IF (OLD_CLPSDATE!=CARD_START_DATE AND OLD_CLPEDATE!=CARD_END_DATE AND OLD_CLP_ULDID!=USERSTAMP_ID)THEN

	        		INSERT INTO TICKLER_HISTORY(TP_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,ULD_ID,CUSTOMER_ID)VALUES
					((SELECT TP_ID FROM TICKLER_PROFILE WHERE TP_TYPE='UPDATION'),
					(SELECT TTIP_ID FROM TICKLER_TABID_PROFILE WHERE TTIP_DATA='CUSTOMER_LP_DETAILS'),
					(SELECT CONCAT('CLP_ID=',OLDCLPID,',','CED_REC_VER=',CUSTOMER_RECORD_VERSION,',','CLP_STARTDATE=',OLD_CLPSDATE,
					',','CLP_ENDDATE=',OLD_CLPEDATE,',','ULD_ID=',OLD_CLP_ULDID,',','CLP_TIMESTAMP=',OLD_CLP_TIMESTAMP)),
					(SELECT CONCAT('CLP_STARTDATE=',CARD_START_DATE,',','CLP_ENDDATE=',CARD_END_DATE)),USERSTAMP_ID,CUST_ID);

				END IF;

				IF (OLD_CLPSDATE!=CARD_START_DATE AND OLD_CLPEDATE!=CARD_END_DATE AND OLD_CLP_ULDID=USERSTAMP_ID)THEN

	        		INSERT INTO TICKLER_HISTORY(TP_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,ULD_ID,CUSTOMER_ID)VALUES
					((SELECT TP_ID FROM TICKLER_PROFILE WHERE TP_TYPE='UPDATION'),
					(SELECT TTIP_ID FROM TICKLER_TABID_PROFILE WHERE TTIP_DATA='CUSTOMER_LP_DETAILS'),
					(SELECT CONCAT('CLP_ID=',OLDCLPID,',','CED_REC_VER=',CUSTOMER_RECORD_VERSION,',','CLP_STARTDATE=',OLD_CLPSDATE,
					',','CLP_ENDDATE=',OLD_CLPEDATE,',','CLP_TIMESTAMP=',OLD_CLP_TIMESTAMP)),
					(SELECT CONCAT('CLP_STARTDATE=',CARD_START_DATE,',','CLP_ENDDATE=',CARD_END_DATE)),USERSTAMP_ID,CUST_ID);

				END IF;


				IF (OLD_CLPSDATE!=CARD_START_DATE AND OLD_CLPEDATE=CARD_END_DATE AND OLD_CLP_ULDID!=USERSTAMP_ID)THEN

	        		INSERT INTO TICKLER_HISTORY(TP_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,ULD_ID,CUSTOMER_ID)VALUES
					((SELECT TP_ID FROM TICKLER_PROFILE WHERE TP_TYPE='UPDATION'),
					(SELECT TTIP_ID FROM TICKLER_TABID_PROFILE WHERE TTIP_DATA='CUSTOMER_LP_DETAILS'),
					(SELECT CONCAT('CLP_ID=',OLDCLPID,',','CED_REC_VER=',CUSTOMER_RECORD_VERSION,',','CLP_STARTDATE=',OLD_CLPSDATE,
					',','ULD_ID=',OLD_CLP_ULDID,',','CLP_TIMESTAMP=',OLD_CLP_TIMESTAMP)),
					(SELECT CONCAT('CLP_STARTDATE=',CARD_START_DATE)),USERSTAMP_ID,CUST_ID);

				END IF;

				IF (OLD_CLPSDATE!=CARD_START_DATE AND OLD_CLPEDATE=CARD_END_DATE AND OLD_CLP_ULDID=USERSTAMP_ID)THEN

	        		INSERT INTO TICKLER_HISTORY(TP_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,ULD_ID,CUSTOMER_ID)VALUES
					((SELECT TP_ID FROM TICKLER_PROFILE WHERE TP_TYPE='UPDATION'),
					(SELECT TTIP_ID FROM TICKLER_TABID_PROFILE WHERE TTIP_DATA='CUSTOMER_LP_DETAILS'),
					(SELECT CONCAT('CLP_ID=',OLDCLPID,',','CED_REC_VER=',CUSTOMER_RECORD_VERSION,',','CLP_STARTDATE=',OLD_CLPSDATE,
					',','CLP_TIMESTAMP=',OLD_CLP_TIMESTAMP)),
					(SELECT CONCAT('CLP_STARTDATE=',CARD_START_DATE)),USERSTAMP_ID,CUST_ID);

				END IF;

				IF (OLD_CLPSDATE=CARD_START_DATE AND OLD_CLPEDATE!=CARD_END_DATE AND OLD_CLP_ULDID!=USERSTAMP_ID)THEN

	        		INSERT INTO TICKLER_HISTORY(TP_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,ULD_ID,CUSTOMER_ID)VALUES
					((SELECT TP_ID FROM TICKLER_PROFILE WHERE TP_TYPE='UPDATION'),
					(SELECT TTIP_ID FROM TICKLER_TABID_PROFILE WHERE TTIP_DATA='CUSTOMER_LP_DETAILS'),
					(SELECT CONCAT('CLP_ID=',OLDCLPID,',','CED_REC_VER=',CUSTOMER_RECORD_VERSION,
					',','CLP_ENDDATE=',OLD_CLPEDATE,',','ULD_ID=',OLD_CLP_ULDID,',','CLP_TIMESTAMP=',OLD_CLP_TIMESTAMP)),
					(SELECT CONCAT('CLP_ENDDATE=',CARD_END_DATE)),USERSTAMP_ID,CUST_ID);

				END IF;

				IF (OLD_CLPSDATE=CARD_START_DATE AND OLD_CLPEDATE!=CARD_END_DATE AND OLD_CLP_ULDID=USERSTAMP_ID)THEN

	        		INSERT INTO TICKLER_HISTORY(TP_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,ULD_ID,CUSTOMER_ID)VALUES
					((SELECT TP_ID FROM TICKLER_PROFILE WHERE TP_TYPE='UPDATION'),
					(SELECT TTIP_ID FROM TICKLER_TABID_PROFILE WHERE TTIP_DATA='CUSTOMER_LP_DETAILS'),
					(SELECT CONCAT('CLP_ID=',OLDCLPID,',','CED_REC_VER=',CUSTOMER_RECORD_VERSION,
					',','CLP_ENDDATE=',OLD_CLPEDATE,',','CLP_TIMESTAMP=',OLD_CLP_TIMESTAMP)),
					(SELECT CONCAT('CLP_ENDDATE=',CARD_END_DATE)),USERSTAMP_ID,CUST_ID);

				END IF;

			END IF;

        	IF ACCESS_CARD IS NOT NULL AND PTDDATE IS NULL THEN
        		UPDATE CUSTOMER_LP_DETAILS SET CLP_STARTDATE=CARD_START_DATE,CLP_ENDDATE=CARD_END_DATE WHERE CUSTOMER_ID=CUST_ID AND CED_REC_VER=CUSTOMER_RECORD_VERSION AND UASD_ID=(SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=CARD_NO AND UNIT_ID=(SELECT UNIT_ID FROM UNIT WHERE UNIT_NO=UNIT_NUMBER));
        	END IF;

			IF ACCESS_CARD IS NULL AND PTDDATE IS NULL THEN
        		UPDATE CUSTOMER_LP_DETAILS SET CLP_STARTDATE=CARD_START_DATE,CLP_ENDDATE=CARD_END_DATE WHERE CUSTOMER_ID=CUST_ID AND CED_REC_VER=CUSTOMER_RECORD_VERSION ;
        	END IF;

			IF ACCESS_CARD IS NOT NULL AND PTDDATE IS NOT NULL THEN
        		UPDATE CUSTOMER_LP_DETAILS SET CLP_STARTDATE=CARD_START_DATE WHERE CUSTOMER_ID=CUST_ID AND CED_REC_VER=CUSTOMER_RECORD_VERSION AND UASD_ID=(SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=CARD_NO AND UNIT_ID=(SELECT UNIT_ID FROM UNIT WHERE UNIT_NO=UNIT_NUMBER));
        	END IF;

			IF ACCESS_CARD IS NULL AND PTDDATE IS NOT NULL THEN
        		UPDATE CUSTOMER_LP_DETAILS SET CLP_STARTDATE=CARD_START_DATE WHERE CUSTOMER_ID=CUST_ID AND CED_REC_VER=CUSTOMER_RECORD_VERSION ;
        	END IF;

        	SET SUCCESS_FLAG=1;
        
        	IF CARD_ENDDATE_POSITION<=0 THEN
            	LEAVE  loop_label;
        	END IF;

    	END LOOP;

  	END IF;

  	SET ULDTSMAXTIMES=(SELECT ULD_TS_MAXTIMES FROM CUSTOMER_LP_DETAILS WHERE CUSTOMER_ID=CUST_ID AND CED_REC_VER=CUSTOMER_RECORD_VERSION AND CLP_GUEST_CARD IS NULL);
  	UPDATE CUSTOMER_LP_DETAILS SET ULD_TS_MAXTIMES=(ULDTSMAXTIMES+1),ULD_ID=USERSTAMP_ID WHERE CUSTOMER_ID=CUST_ID AND CED_REC_VER=CUSTOMER_RECORD_VERSION;

END;