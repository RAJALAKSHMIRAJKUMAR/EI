DROP PROCEDURE IF EXISTS SP_TRG_CUSTOMER_ENTRY_DETAILS_VALIDATION;
CREATE PROCEDURE SP_TRG_CUSTOMER_ENTRY_DETAILS_VALIDATION(
IN NEWCEDID INTEGER,
IN NEWCUSTOMERID INTEGER,
IN NEWRECVER INTEGER,
IN PROCESS TEXT)
BEGIN
DECLARE MESSAGE_TEXT TEXT;
DECLARE OLDRECVER INTEGER;
DECLARE ERRORMSG TEXT;
DECLARE CUSTOMER_NAME TEXT;
DECLARE CUSTOMERNAME TEXT;
SET OLDRECVER=(SELECT CED_REC_VER FROM CUSTOMER_ENTRY_DETAILS WHERE CED_ID=NEWCEDID);
SET ERRORMSG=(SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=484);
SET CUSTOMER_NAME=(SELECT CONCAT(CUSTOMER_FIRST_NAME,' ',CUSTOMER_LAST_NAME) FROM CUSTOMER WHERE CUSTOMER_ID=NEWCUSTOMERID);
SET CUSTOMERNAME=(CONCAT('(',CUSTOMER_NAME,')'));
SET ERRORMSG=(SELECT REPLACE(ERRORMSG,'[REC VER]',NEWRECVER));
SET ERRORMSG=(SELECT REPLACE(ERRORMSG,'[CUSTOMER]',CUSTOMERNAME));
IF PROCESS='INSERT' THEN
    IF EXISTS(SELECT * FROM CUSTOMER_ENTRY_DETAILS WHERE CUSTOMER_ID=NEWCUSTOMERID AND CED_REC_VER=NEWRECVER)THEN
		SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = ERRORMSG;
	END IF;
END IF;
IF PROCESS='UPDATE' THEN
	IF OLDRECVER!=NEWRECVER THEN
	IF EXISTS(SELECT * FROM CUSTOMER_ENTRY_DETAILS WHERE CUSTOMER_ID=NEWCUSTOMERID AND CED_REC_VER=NEWRECVER)THEN
		SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = ERRORMSG;
	END IF;
	END IF;
END IF;
END;
