DROP PROCEDURE IF EXISTS SP_CUSTOMER_EXTENSION_PERSONAL_DTLS_INSERT;
CREATE PROCEDURE SP_CUSTOMER_EXTENSION_PERSONAL_DTLS_INSERT(
IN EX_CUSTOMER_ID INTEGER,
IN EX_NATIONALITY TEXT,
IN EX_MOBILE VARCHAR(8),
IN EX_INTL_MOBILE VARCHAR(20),
IN EX_EMAIL VARCHAR(40),
IN EX_PASSPORT_NO VARCHAR(15),
IN EX_PASSPORT_DATE DATE,
IN EX_DOB DATE,
IN EX_EP_NO VARCHAR(15),
IN EX_EP_DATE DATE,
IN EX_COMMENTS TEXT,
IN USERSTAMP VARCHAR(50),
OUT EX_SUCCESSFLAG TEXT)
BEGIN 
	DECLARE NATIONALITY_DETAILS INT;
	DECLARE OLD_CPDID INTEGER;
	DECLARE OLD_NCID TEXT;
	DECLARE OLD_MOBILE TEXT;
	DECLARE OLD_INTL_MOBILE TEXT;
	DECLARE OLD_EMAIL TEXT;
	DECLARE OLD_PASSPORTNO TEXT;
	DECLARE OLD_PASSPORTDATE TEXT;
	DECLARE OLD_DOB TEXT;
	DECLARE OLD_EPNO TEXT;
	DECLARE OLD_EPDATE TEXT;
	DECLARE OLD_COMMENTS TEXT;	
    DECLARE NEW_NCID TEXT;
    DECLARE NEW_MOBILE TEXT;
	DECLARE NEW_INTL_MOBILE TEXT;
	DECLARE NEW_EMAIL TEXT;
	DECLARE NEW_PASSPORTNO TEXT;
	DECLARE NEW_PASSPORTDATE TEXT;
	DECLARE NEW_DOB TEXT;
	DECLARE NEW_EPNO TEXT;
	DECLARE NEW_EPDATE TEXT;
	DECLARE NEW_COMMENTS TEXT;
    DECLARE OLD_PERSONALTABLEDETAILS TEXT;
    DECLARE NEW_PERSONALTABLEDETAILS TEXT;
    DECLARE PERSONAL_HEADERNAME TEXT;
    DECLARE CPD_LENGTH INTEGER;
    DECLARE OLDPERSONALPOSITION INTEGER;
    DECLARE OLD_CUSTOMERPERSONALS TEXT;
    DECLARE NEWPERSONALPOSITION INTEGER;
    DECLARE NEW_CUSTOMERPERSONALS TEXT;
    DECLARE PERSONALHEADPOSITION INTEGER;
    DECLARE PERSONALHEADNAME TEXT;
    DECLARE NEWPERSONALRECORDS TEXT ;
    DECLARE OLDPERSONALRECORDS TEXT ;
    DECLARE PERSONALHEADERNAMES TEXT;
    DECLARE CUSTPERSONAL_ID VARCHAR(30);
    DECLARE OLD_PERSONALDTL TEXT;
    DECLARE NEW_PERSONALDTL TEXT;
    DECLARE CUSTPERSONALHEADERNAME TEXT;
    DECLARE PERSONAL_LOCATION INTEGER;
	DECLARE USERSTAMP_ID INTEGER;	
	CALL SP_CHANGE_USERSTAMP_AS_ULDID(USERSTAMP,@ULDID);
	SET USERSTAMP_ID = (SELECT @ULDID);		
	IF EX_MOBILE='' THEN
		SET EX_MOBILE=NULL;
	END IF;
	IF EX_INTL_MOBILE='' THEN
		SET EX_INTL_MOBILE=NULL;
	END IF;
	IF EX_PASSPORT_NO='' THEN
		SET EX_PASSPORT_NO=NULL;
	END IF;
	IF EX_EP_NO='' THEN
		SET EX_EP_NO=NULL;
	END IF;	
	IF EX_COMMENTS='' THEN
		SET EX_COMMENTS=NULL;
	END IF;	
	SET NATIONALITY_DETAILS=(SELECT NC_ID FROM NATIONALITY_CONFIGURATION WHERE NC_DATA=EX_NATIONALITY);	
	SET CUSTPERSONAL_ID = '';	   
	SET OLD_CPDID = (SELECT CPD_ID FROM CUSTOMER_PERSONAL_DETAILS WHERE CUSTOMER_ID = EX_CUSTOMER_ID);	   
	SET OLD_NCID = (SELECT NC_ID FROM CUSTOMER_PERSONAL_DETAILS WHERE CUSTOMER_ID = EX_CUSTOMER_ID);		
	SET OLD_EMAIL = (SELECT CPD_EMAIL FROM CUSTOMER_PERSONAL_DETAILS WHERE CUSTOMER_ID = EX_CUSTOMER_ID);	 
	SET OLD_MOBILE = (SELECT CPD_MOBILE FROM CUSTOMER_PERSONAL_DETAILS WHERE CUSTOMER_ID = EX_CUSTOMER_ID);
	IF(OLD_MOBILE IS NULL)THEN
		SET OLD_MOBILE = 'null';
	END IF;		
	SET OLD_INTL_MOBILE = (SELECT CPD_INTL_MOBILE FROM CUSTOMER_PERSONAL_DETAILS WHERE CUSTOMER_ID = EX_CUSTOMER_ID);
	IF(OLD_INTL_MOBILE IS NULL)THEN
		SET OLD_INTL_MOBILE = 'null';
	END IF;		
	SET OLD_PASSPORTNO = (SELECT CPD_PASSPORT_NO FROM CUSTOMER_PERSONAL_DETAILS WHERE CUSTOMER_ID = EX_CUSTOMER_ID);
	IF(OLD_PASSPORTNO IS NULL)THEN
		SET OLD_PASSPORTNO = 'null';
	END IF;		
	SET OLD_PASSPORTDATE = (SELECT CPD_PASSPORT_DATE FROM CUSTOMER_PERSONAL_DETAILS WHERE CUSTOMER_ID = EX_CUSTOMER_ID);
	IF(OLD_PASSPORTDATE IS NULL)THEN
		SET OLD_PASSPORTDATE = 'null';
	END IF;		
	SET OLD_DOB = (SELECT CPD_DOB FROM CUSTOMER_PERSONAL_DETAILS WHERE CUSTOMER_ID = EX_CUSTOMER_ID);
	IF(OLD_DOB IS NULL)THEN
		SET OLD_DOB = 'null';
	END IF;		
	SET OLD_EPNO = (SELECT CPD_EP_NO FROM CUSTOMER_PERSONAL_DETAILS WHERE CUSTOMER_ID = EX_CUSTOMER_ID);
	IF(OLD_EPNO IS NULL)THEN
		SET OLD_EPNO = 'null';
	END IF;		
	SET OLD_EPDATE = (SELECT CPD_EP_DATE FROM CUSTOMER_PERSONAL_DETAILS WHERE CUSTOMER_ID = EX_CUSTOMER_ID);
	IF(OLD_EPDATE IS NULL)THEN
		SET OLD_EPDATE = 'null';
	END IF;		
	SET OLD_COMMENTS = (SELECT CPD_COMMENTS FROM CUSTOMER_PERSONAL_DETAILS WHERE CUSTOMER_ID = EX_CUSTOMER_ID);
	IF(OLD_COMMENTS IS NULL)THEN
		SET OLD_COMMENTS = 'null';
	END IF;		
	SET NEW_NCID = NATIONALITY_DETAILS;		
	SET NEW_EMAIL = EX_EMAIL;		
	SET NEW_MOBILE = EX_MOBILE;
	IF(NEW_MOBILE IS NULL)THEN
		SET NEW_MOBILE = 'null';
	END IF;		
	SET NEW_INTL_MOBILE = EX_INTL_MOBILE;
	IF(NEW_INTL_MOBILE IS NULL)THEN
		SET NEW_INTL_MOBILE = 'null';
	END IF;		
	SET NEW_PASSPORTNO = EX_PASSPORT_NO;
	IF(NEW_PASSPORTNO IS NULL)THEN
		SET NEW_PASSPORTNO = 'null';
	END IF;		
	SET NEW_PASSPORTDATE = EX_PASSPORT_DATE;
	IF(NEW_PASSPORTDATE IS NULL)THEN
		SET NEW_PASSPORTDATE = 'null';
	END IF;		
	SET NEW_DOB = EX_DOB;
	IF(NEW_DOB IS NULL)THEN
		SET NEW_DOB = 'null';
	END IF;		
	SET NEW_EPNO = EX_EP_NO;
	IF(NEW_EPNO IS NULL)THEN
		SET NEW_EPNO = 'null';
	END IF;		
	SET NEW_EPDATE = EX_EP_DATE;
	IF(NEW_EPDATE IS NULL)THEN
		SET NEW_EPDATE = 'null';
	END IF;		
	SET NEW_COMMENTS = EX_COMMENTS;
	IF(NEW_COMMENTS IS NULL)THEN
		SET NEW_COMMENTS = 'null';
	END IF;	   
	SET PERSONALHEADERNAMES = 'CPD_ID,NC_ID,CPD_MOBILE,CPD_INTL_MOBILE,CPD_EMAIL,CPD_PASSPORT_NO,CPD_PASSPORT_DATE,CPD_DOB,CPD_EP_NO,CPD_EP_DATE,CPD_COMMENTS';
	SET OLD_PERSONALTABLEDETAILS = (SELECT CONCAT(OLD_CPDID,'^','^',OLD_NCID,'^','^',OLD_MOBILE,'^','^',OLD_INTL_MOBILE,'^','^',OLD_EMAIL,'^','^',OLD_PASSPORTNO,'^','^',OLD_PASSPORTDATE,'^','^',OLD_DOB,'^','^',OLD_EPNO,'^','^',OLD_EPDATE,'^','^',OLD_COMMENTS));
	SET NEW_PERSONALTABLEDETAILS = (SELECT CONCAT(OLD_CPDID,'^','^',NEW_NCID,'^','^',NEW_MOBILE,'^','^',NEW_INTL_MOBILE,'^','^',NEW_EMAIL,'^','^',NEW_PASSPORTNO,'^','^',NEW_PASSPORTDATE,'^','^',NEW_DOB,'^','^',NEW_EPNO,'^','^',NEW_EPDATE,'^','^',NEW_COMMENTS));	   
	IF(OLD_PERSONALTABLEDETAILS != NEW_PERSONALTABLEDETAILS)THEN			
		SET OLDPERSONALRECORDS = OLD_PERSONALTABLEDETAILS;
		SET NEWPERSONALRECORDS = NEW_PERSONALTABLEDETAILS;
		SET PERSONALHEADNAME = PERSONALHEADERNAMES;
		SET OLD_CUSTOMERPERSONALS = (SELECT CONCAT('CPD_ID=',OLD_CPDID));
		SET NEW_CUSTOMERPERSONALS = '';
		SET CPD_LENGTH = 1;			
		loop_label : LOOP			   
			SET OLDPERSONALPOSITION = (SELECT LOCATE('^^',OLDPERSONALRECORDS,CPD_LENGTH));
			IF (OLDPERSONALPOSITION=0) THEN
				SET OLD_PERSONALDTL = OLDPERSONALRECORDS;
			ELSE
				SET OLD_PERSONALDTL =(SELECT SUBSTRING(OLDPERSONALRECORDS,CPD_LENGTH,OLDPERSONALPOSITION-1));
				SET OLDPERSONALRECORDS=(SELECT SUBSTRING(OLDPERSONALRECORDS,OLDPERSONALPOSITION+2));
			END IF;			   
			SET NEWPERSONALPOSITION = (SELECT LOCATE('^^',NEWPERSONALRECORDS,CPD_LENGTH));
			IF (NEWPERSONALPOSITION=0) THEN
				SET NEW_PERSONALDTL = NEWPERSONALRECORDS;
			ELSE
				SET NEW_PERSONALDTL=(SELECT SUBSTRING(NEWPERSONALRECORDS,CPD_LENGTH,NEWPERSONALPOSITION-1));
				SET NEWPERSONALRECORDS=(SELECT SUBSTRING(NEWPERSONALRECORDS,NEWPERSONALPOSITION+2));
			END IF;			   
			SET PERSONALHEADPOSITION = (SELECT LOCATE(',',PERSONALHEADNAME,CPD_LENGTH));
			IF (PERSONALHEADPOSITION=0) THEN
				SET CUSTPERSONALHEADERNAME = PERSONALHEADNAME;
			ELSE
				SET CUSTPERSONALHEADERNAME=(SELECT SUBSTRING(PERSONALHEADNAME,CPD_LENGTH,PERSONALHEADPOSITION-1));
				SET PERSONALHEADNAME=(SELECT SUBSTRING(PERSONALHEADNAME,PERSONALHEADPOSITION+1));
			END IF;			   
			IF(OLD_PERSONALDTL != NEW_PERSONALDTL)THEN
				SET OLD_PERSONALDTL=(SELECT CONCAT(CUSTPERSONALHEADERNAME, '=', OLD_PERSONALDTL));
				SET NEW_PERSONALDTL=(SELECT CONCAT(CUSTPERSONALHEADERNAME, '=' ,NEW_PERSONALDTL));
				SET NEW_CUSTOMERPERSONALS=(SELECT CONCAT(NEW_CUSTOMERPERSONALS,',',NEW_PERSONALDTL));
				SET OLD_CUSTOMERPERSONALS=(SELECT CONCAT(OLD_CUSTOMERPERSONALS,',',OLD_PERSONALDTL));
			END IF; 			   
			IF (PERSONALHEADPOSITION<=0) THEN
				LEAVE  loop_label;
			END IF;			
		END LOOP;		  
		SET PERSONAL_LOCATION=(SELECT LOCATE(',', NEW_CUSTOMERPERSONALS,1));
		SET NEW_CUSTOMERPERSONALS=(SELECT SUBSTRING(NEW_CUSTOMERPERSONALS,PERSONAL_LOCATION+1));			
		IF EXISTS(SELECT CUSTOMER_ID FROM CUSTOMER_PERSONAL_DETAILS WHERE CUSTOMER_ID=EX_CUSTOMER_ID) THEN
			INSERT INTO TICKLER_HISTORY(TP_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,ULD_ID,CUSTOMER_ID)VALUES
			((SELECT TP_ID FROM TICKLER_PROFILE WHERE TP_TYPE='UPDATION'),
			(SELECT TTIP_ID FROM TICKLER_TABID_PROFILE WHERE TTIP_DATA='CUSTOMER_PERSONAL_DETAILS'),
			OLD_CUSTOMERPERSONALS,NEW_CUSTOMERPERSONALS,USERSTAMP_ID,EX_CUSTOMER_ID);			   
			UPDATE CUSTOMER_PERSONAL_DETAILS SET NC_ID=NATIONALITY_DETAILS, CPD_MOBILE=EX_MOBILE, CPD_INTL_MOBILE=EX_INTL_MOBILE, CPD_EMAIL=EX_EMAIL, CPD_PASSPORT_NO=EX_PASSPORT_NO, CPD_PASSPORT_DATE=EX_PASSPORT_DATE, CPD_DOB=EX_DOB, CPD_EP_NO=EX_EP_NO, CPD_EP_DATE=EX_EP_DATE, CPD_COMMENTS=EX_COMMENTS WHERE CUSTOMER_ID=EX_CUSTOMER_ID;
			SET EX_SUCCESSFLAG=1;			   
		END IF;			   
	END IF;	
END;
