DROP PROCEDURE IF EXISTS SP_CUSTOMER_AUTO_TERMINATION;
CREATE PROCEDURE SP_CUSTOMER_AUTO_TERMINATION(IN TDAYDATE VARCHAR(50),IN TERM_USERSTAMP VARCHAR(50))
BEGIN
	DECLARE TADC_MAX_RECVER INTEGER;
	DECLARE TFTDC_MAX_RECVER INTEGER;
	DECLARE TFTDC_MINID INTEGER;
	DECLARE TFTDC_MAXID INTEGER;
	DECLARE TUTDC_MINID INTEGER;
	DECLARE TUTDC_MAXID INTEGER;
	DECLARE PTDDATE DATE;
	DECLARE ENDDATE DATE;
	DECLARE CCNDATA TEXT;
	DECLARE COMMENTS TEXT;
	DECLARE OLDCOMMENTS TEXT;
	DECLARE NEWCOMMENTS TEXT;
	DECLARE TADC_COUNT VARCHAR(20);
	DECLARE TFTDCUASDID INTEGER;
	DECLARE TICK_OLD_VALUE  TEXT;
	DECLARE TICK_NEW_VALUE  TEXT;
	DECLARE TICK_OLD_TERMVALUE  TEXT;
	DECLARE TICK_NEW_TERMVALUE  TEXT;
	DECLARE TICK_OLD_COMTVALUE  TEXT;
	DECLARE TICK_NEW_COMTVALUE  TEXT;
	DECLARE TICK_UNIT_NO  INTEGER;
	DECLARE TICK_REC_VER  INTEGER;
	DECLARE TICK_CARD_NO  VARCHAR(7);
	DECLARE TICK_GUEST_CARD  VARCHAR(10);
	DECLARE TICK_PTD TEXT;
	DECLARE TICK_ENDDATE TEXT;
	DECLARE TICK_FLAG INTEGER DEFAULT 0;
	DECLARE TICK_TERMFLAG INTEGER DEFAULT 0;
	DECLARE TICK_TERM_FLAG INTEGER DEFAULT 0;
	DECLARE COMMENTCARDNO TEXT;
	DECLARE MIN_CUSTID INTEGER;
	DECLARE MAX_CUSTID INTEGER;
	DECLARE USERSTAMP VARCHAR(50);
	DECLARE USERSTAMP_ID INTEGER(2);
	DECLARE OLD_ULD_ID INTEGER(2);	
	DECLARE CTDID INTEGER;
	DECLARE UASDID INTEGER;
	DECLARE CACDID INTEGER;
	DECLARE TCTDID INTEGER;
	DECLARE TUASDID INTEGER;
	DECLARE TEMP_FINAL_TERMINATED_DATE_CUSTOMER TEXT;
	DECLARE TEMP_FINAL_AUTO_TERM_CUSTOMER TEXT;
	DECLARE TEMP_AUTO_UNTERM_CUSTOMER TEXT;
	DECLARE TEMP_TERMINATED_DATE_CUSTOMER TEXT;
	DECLARE TEMP_ACTIVE_DATE_CUSTOMER  TEXT;
	DECLARE TEMP_NON_TERMINATED_CUSTOMER TEXT;
	DECLARE D_TEMP_AUTO_UNTERM_CUSTOMER TEXT;
	DECLARE COUNT_FINAL_TERM_CUS INTEGER;
	DECLARE COUNT_UNTERM_CUS INTEGER;
	DECLARE COUNT_AUTO_UNTERM_CUS INTEGER;
	DECLARE COUNT_NULL_CARD INTEGER;
	DECLARE COUNT_AUTO_TERM INTEGER;
	DECLARE COUNT_NULL_AUTO_TERM INTEGER;
	DECLARE CUST_LP_RV INTEGER;
	DECLARE CUST_LP_CARDNO VARCHAR(7);
	DECLARE NTMONTHS INTEGER;
	DECLARE EXIT HANDLER FOR SQLEXCEPTION
	BEGIN 
		ROLLBACK;
		SET @DROP_TEMP_AUTO_FINAL=(SELECT CONCAT('DROP TABLE IF EXISTS ',TEMP_FINAL_AUTO_TERM_CUSTOMER));
		PREPARE DROP_TEMP_AUTO_FINAL_STMT FROM @DROP_TEMP_AUTO_FINAL;
		EXECUTE DROP_TEMP_AUTO_FINAL_STMT;	
		IF TEMP_AUTO_UNTERM_CUSTOMER IS NOT NULL THEN	
			SET @DROP_TEMP_AUTO_UNTERM=(SELECT CONCAT('DROP TABLE IF EXISTS ',TEMP_AUTO_UNTERM_CUSTOMER));
			PREPARE DROP_TEMP_AUTO_UNTERM_STMT FROM @DROP_TEMP_AUTO_UNTERM;
			EXECUTE DROP_TEMP_AUTO_UNTERM_STMT;
		END IF;
		SET @DROP_TEMP_FINAL=(SELECT CONCAT('DROP TABLE IF EXISTS ',TEMP_FINAL_TERMINATED_DATE_CUSTOMER));
		PREPARE DROP_TEMP_FINAL_STMT FROM @DROP_TEMP_FINAL;
		EXECUTE DROP_TEMP_FINAL_STMT;
		SET @DROP_TEMP_TERM_DATE_CUS=(SELECT CONCAT('DROP TABLE IF EXISTS ',TEMP_TERMINATED_DATE_CUSTOMER));
		PREPARE DROP_TEMP_TERM_DATE_CUS_STMT FROM @DROP_TEMP_TERM_DATE_CUS;
		EXECUTE DROP_TEMP_TERM_DATE_CUS_STMT;
		SET @DROP_TEMP_ACTIVE_CUSTOMER=(SELECT CONCAT('DROP TABLE IF EXISTS ',TEMP_ACTIVE_DATE_CUSTOMER));
		PREPARE DROP_TEMP_ACTIVE_CUSTOMER_STMT FROM @DROP_TEMP_ACTIVE_CUSTOMER;
		EXECUTE DROP_TEMP_ACTIVE_CUSTOMER_STMT;
		SET @DROP_TEMP_NON_TERM_CUSTOMER=(SELECT CONCAT('DROP TABLE IF EXISTS ',TEMP_NON_TERMINATED_CUSTOMER));
		PREPARE DROP_TEMP_NON_TERM_CUSTOMER_STMT FROM @DROP_TEMP_NON_TERM_CUSTOMER;
		EXECUTE DROP_TEMP_NON_TERM_CUSTOMER_STMT;
	END;
	START TRANSACTION;
	SET AUTOCOMMIT=0;
	SET USERSTAMP=(SELECT EL_EMAIL_ID FROM EMAIL_LIST WHERE EP_ID=21);
	CALL SP_CHANGE_USERSTAMP_AS_ULDID(USERSTAMP,@ULDID);
	SET USERSTAMP_ID = (SELECT @ULDID);
	CALL SP_NON_TERMINATED_CUSTOMER(TERM_USERSTAMP,@TEMP_TERMINATED_CUSTOMER,@TEMP_ACTIVE_CUSTOMER,@FINAL_TERMINATED_CUSTOMER,@NON_TERMINATED_CUSTOMER);	
	SET TEMP_TERMINATED_DATE_CUSTOMER=@TEMP_TERMINATED_CUSTOMER;
	SET TEMP_ACTIVE_DATE_CUSTOMER=@TEMP_ACTIVE_CUSTOMER;
	SET TEMP_FINAL_TERMINATED_DATE_CUSTOMER=@FINAL_TERMINATED_CUSTOMER;
	SET TEMP_NON_TERMINATED_CUSTOMER=@NON_TERMINATED_CUSTOMER;	
	SET TEMP_FINAL_AUTO_TERM_CUSTOMER=(SELECT CONCAT('TEMP_FINAL_AUTO_TERM_CUSTOMER','_',SYSDATE()));
	SET TEMP_FINAL_AUTO_TERM_CUSTOMER=(SELECT REPLACE(TEMP_FINAL_AUTO_TERM_CUSTOMER,' ',''));
	SET TEMP_FINAL_AUTO_TERM_CUSTOMER=(SELECT REPLACE(TEMP_FINAL_AUTO_TERM_CUSTOMER,'-',''));
	SET TEMP_FINAL_AUTO_TERM_CUSTOMER=(SELECT REPLACE(TEMP_FINAL_AUTO_TERM_CUSTOMER,':',''));
	SET TEMP_FINAL_AUTO_TERM_CUSTOMER=(SELECT CONCAT(TEMP_FINAL_AUTO_TERM_CUSTOMER,'_',USERSTAMP_ID));		
	SET @DROP_TEMP_FINAL_AUTO_TERM=(SELECT CONCAT('DROP TABLE IF EXISTS ',TEMP_FINAL_AUTO_TERM_CUSTOMER));
	PREPARE DROP_TEMP_FINAL_AUTO_TERM_STMT FROM @DROP_TEMP_FINAL_AUTO_TERM;
	EXECUTE DROP_TEMP_FINAL_AUTO_TERM_STMT;			
	SET @CREATE_TEMP_AUTO_FINAL_CUS=(SELECT CONCAT('CREATE TABLE ',TEMP_FINAL_AUTO_TERM_CUSTOMER,' AS (SELECT * FROM ',TEMP_FINAL_TERMINATED_DATE_CUSTOMER,' WHERE TFTDC_CUSTOMERID NOT IN(SELECT CUSTOMERID FROM VW_TERMINATION_TERMINATED_CUSTOMER) ORDER BY TFTDC_CUSTOMERID)'));
	PREPARE CREATE_TEMP_AUTO_FINAL_CUS_STMT FROM @CREATE_TEMP_AUTO_FINAL_CUS;
	EXECUTE CREATE_TEMP_AUTO_FINAL_CUS_STMT;
	SET @SET_MIN_CUSTID = (SELECT CONCAT('SELECT MIN(TFTDC_CUSTOMERID)INTO @MINCUSTID FROM ',TEMP_FINAL_AUTO_TERM_CUSTOMER));
	PREPARE SET_MIN_CUSTID_STMT FROM @SET_MIN_CUSTID;
	EXECUTE SET_MIN_CUSTID_STMT;
	SET MIN_CUSTID=@MINCUSTID;
	SET @SET_MAX_CUSTID = (SELECT CONCAT('SELECT MAX(TFTDC_CUSTOMERID)INTO @MAXCUSTID FROM ',TEMP_FINAL_AUTO_TERM_CUSTOMER));
	PREPARE SET_MAX_CUSTID_STMT FROM @SET_MAX_CUSTID;
	EXECUTE SET_MAX_CUSTID_STMT;
	SET MAX_CUSTID=@MAXCUSTID;	
	IF MAX_CUSTID IS NOT NULL AND MIN_CUSTID IS NOT NULL THEN	
	SET NTMONTHS=(SELECT CCN_DATA FROM CUSTOMER_CONFIGURATION WHERE CGN_ID=86);
	WHILE(MIN_CUSTID <= MAX_CUSTID)DO	
		SET @SET_COUNT_FINAL_TERM_CUS=(SELECT CONCAT('SELECT COUNT(*)INTO @FINALTERMCUS FROM ',TEMP_FINAL_AUTO_TERM_CUSTOMER,' WHERE TFTDC_CUSTOMERID=',MIN_CUSTID,' AND
		IF(TFTDC_PRETERMINATEDATE IS NOT NULL,TFTDC_PRETERMINATEDATE BETWEEN SUBDATE(CURDATE(),INTERVAL ',NTMONTHS,' MONTH) AND CURDATE() ,TFTDC_ENDDATE BETWEEN SUBDATE(CURDATE(),INTERVAL ',NTMONTHS,' MONTH) AND CURDATE() )
		AND TFTDC_GUESTFLAG IS NULL'));
		PREPARE SET_COUNT_FINAL_TERM_CUS_STMT FROM @SET_COUNT_FINAL_TERM_CUS;
		EXECUTE SET_COUNT_FINAL_TERM_CUS_STMT;
		SET COUNT_FINAL_TERM_CUS=@FINALTERMCUS;
		SET D_TEMP_AUTO_UNTERM_CUSTOMER=(SELECT CONCAT('TEMP_AUTO_UNTERM_CUSTOMER','_',SYSDATE()));
		SET D_TEMP_AUTO_UNTERM_CUSTOMER=(SELECT REPLACE(D_TEMP_AUTO_UNTERM_CUSTOMER,' ',''));
		SET D_TEMP_AUTO_UNTERM_CUSTOMER=(SELECT REPLACE(D_TEMP_AUTO_UNTERM_CUSTOMER,'-',''));
		SET D_TEMP_AUTO_UNTERM_CUSTOMER=(SELECT REPLACE(D_TEMP_AUTO_UNTERM_CUSTOMER,':',''));
		SET TEMP_AUTO_UNTERM_CUSTOMER=(SELECT CONCAT(D_TEMP_AUTO_UNTERM_CUSTOMER,'_',USERSTAMP_ID));
		IF COUNT_FINAL_TERM_CUS=0 THEN
			SET @DROP_TEMP_AUTO_TERM=(SELECT CONCAT('DROP TABLE IF EXISTS ',TEMP_AUTO_UNTERM_CUSTOMER));
			PREPARE DROP_TEMP_AUTO_TERM_STMT FROM @DROP_TEMP_AUTO_TERM;
			EXECUTE DROP_TEMP_AUTO_TERM_STMT;
			SET @CREATE_TEMP_AUTO_UNTERM_CUS=(SELECT CONCAT('CREATE TABLE ',TEMP_AUTO_UNTERM_CUSTOMER,' AS (SELECT * FROM ',TEMP_FINAL_AUTO_TERM_CUSTOMER,' WHERE 
IF(TFTDC_PRETERMINATEDATE IS NOT NULL,TFTDC_PRETERMINATEDATE BETWEEN SUBDATE(CURDATE(),INTERVAL ',NTMONTHS,' MONTH) AND CURDATE() ,TFTDC_ENDDATE BETWEEN SUBDATE(CURDATE(),INTERVAL ',NTMONTHS,' MONTH) AND CURDATE() ) AND TFTDC_CUSTOMERID=',MIN_CUSTID,')'));
			PREPARE CREATE_TEMP_AUTO_UNTERM_CUS_STMT FROM @CREATE_TEMP_AUTO_UNTERM_CUS;
			EXECUTE CREATE_TEMP_AUTO_UNTERM_CUS_STMT;
		ELSE
			SET @DROP_TEMP_AUTO_TERM=(SELECT CONCAT('DROP TABLE IF EXISTS ',TEMP_AUTO_UNTERM_CUSTOMER));
			PREPARE DROP_TEMP_AUTO_TERM_STMT FROM @DROP_TEMP_AUTO_TERM;
			EXECUTE DROP_TEMP_AUTO_TERM_STMT;
			SET @CR_TEMP_AUTO_UNTERM_CUS=(SELECT CONCAT('CREATE TABLE ',TEMP_AUTO_UNTERM_CUSTOMER,' AS (SELECT * FROM ',TEMP_FINAL_AUTO_TERM_CUSTOMER,' WHERE IF(TFTDC_PRETERMINATEDATE IS NOT NULL,TFTDC_PRETERMINATEDATE<=CURDATE(),TFTDC_ENDDATE<=CURDATE()) AND TFTDC_CUSTOMERID=',MIN_CUSTID,')'));
			PREPARE CR_TEMP_AUTO_UNTERM_CUS_STMT FROM @CR_TEMP_AUTO_UNTERM_CUS;
			EXECUTE CR_TEMP_AUTO_UNTERM_CUS_STMT;
		END IF;
		SET @SET_TFTDC_MINID = (SELECT CONCAT('SELECT MIN(TFTDC_ID)INTO @TFTDCMINID FROM ',TEMP_AUTO_UNTERM_CUSTOMER));
		PREPARE SET_TFTDC_MINID_STMT FROM @SET_TFTDC_MINID;
		EXECUTE SET_TFTDC_MINID_STMT;
		SET TFTDC_MINID=@TFTDCMINID;
		SET @SET_TFTDC_MAXID = (SELECT CONCAT('SELECT MAX(TFTDC_ID)INTO @TFTDCMAXID FROM ',TEMP_AUTO_UNTERM_CUSTOMER));
		PREPARE SET_TFTDC_MAXID_STMT FROM @SET_TFTDC_MAXID;
		EXECUTE SET_TFTDC_MAXID_STMT;
		SET TFTDC_MAXID=@TFTDCMAXID;
		SET @SET_TADC_MAX_RECVER = (SELECT CONCAT('SELECT MAX(TADC_RECVER)INTO @TADCMAXRECVER FROM ',TEMP_ACTIVE_DATE_CUSTOMER,' WHERE TADC_CUSTOMERID=',MIN_CUSTID));
		PREPARE SET_TADC_MAX_RECVER_STMT FROM @SET_TADC_MAX_RECVER;
		EXECUTE SET_TADC_MAX_RECVER_STMT;
		SET TADC_MAX_RECVER=@TADCMAXRECVER;
		SET CCNDATA = (SELECT CCN_DATA FROM CUSTOMER_CONFIGURATION WHERE CGN_ID=54);	
		SET @SET_TADC_COUNT = (SELECT CONCAT('SELECT COUNT(*)INTO @TADCCOUNT FROM ',TEMP_ACTIVE_DATE_CUSTOMER,' WHERE TADC_CUSTOMERID=',MIN_CUSTID));
		PREPARE SET_TADC_COUNT_STMT FROM @SET_TADC_COUNT;
		EXECUTE SET_TADC_COUNT_STMT;
		SET TADC_COUNT=@TADCCOUNT;
		SET @SET_TFTDC_MAX_RECVER =(SELECT CONCAT('SELECT MAX(TFTDC_RECVER)INTO @TFTDCMAXRECVER  FROM ',TEMP_AUTO_UNTERM_CUSTOMER,' WHERE IF(TFTDC_PRETERMINATEDATE IS NOT NULL,TFTDC_STARTDATE<TFTDC_PRETERMINATEDATE,
		TFTDC_STARTDATE<TFTDC_ENDDATE)'));	
		PREPARE SET_TFTDC_MAX_RECVER_STMT FROM @SET_TFTDC_MAX_RECVER;
		EXECUTE SET_TFTDC_MAX_RECVER_STMT;
		SET TFTDC_MAX_RECVER=@TFTDCMAXRECVER;
		WHILE(TFTDC_MINID <= TFTDC_MAXID)DO		
			SET @SET_TICK_UNIT_NO=(SELECT CONCAT('SELECT TFTDC_UNITNO INTO @TICKUNITNO FROM ',TEMP_AUTO_UNTERM_CUSTOMER,' WHERE TFTDC_ID=',TFTDC_MINID));
			PREPARE SET_TICK_UNIT_NO_STMT FROM @SET_TICK_UNIT_NO;
			EXECUTE SET_TICK_UNIT_NO_STMT;
			SET TICK_UNIT_NO=@TICKUNITNO;
			SET @SET_TICK_REC_VER=(SELECT CONCAT('SELECT TFTDC_RECVER INTO @TICKRECVER FROM ',TEMP_AUTO_UNTERM_CUSTOMER,' WHERE TFTDC_ID=',TFTDC_MINID));
			PREPARE SET_TICK_REC_VER_STMT FROM @SET_TICK_REC_VER;
			EXECUTE SET_TICK_REC_VER_STMT;
			SET TICK_REC_VER=@TICKRECVER;
			SET @SET_TICK_GUEST_CARD=(SELECT CONCAT('SELECT TFTDC_GUESTFLAG INTO @TICKGUESTCARD FROM ',TEMP_AUTO_UNTERM_CUSTOMER,' WHERE TFTDC_ID=',TFTDC_MINID));
			PREPARE SET_TICK_GUEST_CARD_STMT FROM @SET_TICK_GUEST_CARD;
			EXECUTE SET_TICK_GUEST_CARD_STMT;
			SET TICK_GUEST_CARD=@TICKGUESTCARD;
			SET @SET_TICK_CARD_NO=(SELECT CONCAT('SELECT TFTDC_CARDNO INTO @TICKCARDNO FROM ',TEMP_AUTO_UNTERM_CUSTOMER,' WHERE TFTDC_ID=',TFTDC_MINID));
			PREPARE SET_TICK_CARD_NO_STMT FROM @SET_TICK_CARD_NO;
			EXECUTE SET_TICK_CARD_NO_STMT;
			SET TICK_CARD_NO=@TICKCARDNO;
			SET @SET_TICK_PTD=(SELECT CONCAT('SELECT TFTDC_PRETERMINATEDATE INTO @TICKPTD FROM ',TEMP_AUTO_UNTERM_CUSTOMER,' WHERE TFTDC_ID=',TFTDC_MINID));
			PREPARE SET_TICK_PTD_STMT FROM @SET_TICK_PTD;
			EXECUTE SET_TICK_PTD_STMT;
			SET COMMENTCARDNO=TICK_CARD_NO;
			SET OLDCOMMENTS = (SELECT CPD_COMMENTS FROM CUSTOMER_PERSONAL_DETAILS WHERE CUSTOMER_ID=MIN_CUSTID);
			SET @SETTFTDCUASDID=(SELECT CONCAT('SELECT TFTDC_UASDID INTO @TERM_UASD_ID FROM ',TEMP_AUTO_UNTERM_CUSTOMER,' WHERE TFTDC_ID=',TFTDC_MINID));
			PREPARE SETTFTDCUASDIDSTMT FROM @SETTFTDCUASDID;
			EXECUTE SETTFTDCUASDIDSTMT;
			SET TFTDCUASDID=@TERM_UASD_ID;
			IF(TICK_CARD_NO IS NOT NULL)THEN
				SET CACDID = (SELECT CACD_ID FROM CUSTOMER_ACCESS_CARD_DETAILS WHERE CUSTOMER_ID=MIN_CUSTID AND UASD_ID = (SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=TICK_CARD_NO));
				SET CTDID = (SELECT CLP_ID FROM CUSTOMER_LP_DETAILS WHERE CUSTOMER_ID=MIN_CUSTID AND CED_REC_VER=TICK_REC_VER AND UASD_ID = (SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=TICK_CARD_NO));
				SET UASDID = (SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=TICK_CARD_NO);
			END IF;
			IF(TICK_CARD_NO IS NULL)THEN
				SET CTDID = (SELECT CLP_ID FROM CUSTOMER_LP_DETAILS WHERE CUSTOMER_ID=MIN_CUSTID AND CED_REC_VER=TICK_REC_VER);
			END IF;
			IF(TICK_GUEST_CARD IS NULL) THEN
				SET TICK_GUEST_CARD=('null');
			END IF;		
			IF(TICK_PTD IS NULL) THEN
				SET TICK_PTD=('null');
			END IF;		
			SET COMMENTS = (SELECT REPLACE(CCNDATA,'[SYSDATE]',TDAYDATE));
			IF COMMENTCARDNO IS NOT NULL THEN
				SET COMMENTS=(SELECT CONCAT(COMMENTCARDNO,'-',COMMENTS));
			END IF;		
			IF (OLDCOMMENTS IS NOT NULL)THEN
				SET NEWCOMMENTS = (SELECT CONCAT(OLDCOMMENTS ,'   ',COMMENTS));
			ELSE
				SET NEWCOMMENTS = COMMENTS;
			END IF;
			IF(OLDCOMMENTS IS NULL) THEN
				SET TICK_OLD_COMTVALUE=('CPD_COMMENTS=null');
			ELSE
				SET TICK_OLD_COMTVALUE=(SELECT CONCAT('CPD_COMMENTS=',OLDCOMMENTS));
			END IF;		
			SET TICK_NEW_COMTVALUE=(SELECT CONCAT('CPD_COMMENTS=',NEWCOMMENTS));
			SET @SET_COUNT_UNTERM_CUS=(SELECT CONCAT('SELECT COUNT(*) INTO @COUNTUNTERMCUS FROM ',TEMP_AUTO_UNTERM_CUSTOMER,' WHERE TFTDC_ID=',TFTDC_MINID));
			PREPARE SET_COUNT_UNTERM_CUS_STMT FROM @SET_COUNT_UNTERM_CUS;
			EXECUTE SET_COUNT_UNTERM_CUS_STMT;
			SET COUNT_UNTERM_CUS=@COUNTUNTERMCUS;
			IF COUNT_UNTERM_CUS>=1 THEN			
				SET @SETPTDDATE = (SELECT CONCAT('SELECT MAX(TFTDC_PRETERMINATEDATE)INTO @PTD_DATE FROM ',TEMP_AUTO_UNTERM_CUSTOMER,' WHERE TFTDC_UASDID=(SELECT TFTDC_UASDID FROM ',TEMP_AUTO_UNTERM_CUSTOMER,' WHERE TFTDC_ID=',TFTDC_MINID,')'));
				PREPARE SETPTDDATESTMT FROM @SETPTDDATE;
				EXECUTE SETPTDDATESTMT;
				SET PTDDATE=@PTD_DATE;
				SET @SETENDDATE = (SELECT CONCAT('SELECT MAX(TFTDC_ENDDATE)INTO @END_DATE FROM ',TEMP_AUTO_UNTERM_CUSTOMER,' WHERE TFTDC_UASDID=(SELECT TFTDC_UASDID FROM ',TEMP_AUTO_UNTERM_CUSTOMER,' WHERE TFTDC_ID=',TFTDC_MINID,')'));
				PREPARE SETENDDATESTMT FROM @SETENDDATE;
				EXECUTE SETENDDATESTMT;
				SET ENDDATE=@END_DATE;
				IF (PTDDATE IS NOT NULL) THEN
					SET ENDDATE = PTDDATE;
				END IF;				
				IF EXISTS(SELECT * FROM CUSTOMER_ACCESS_CARD_DETAILS WHERE CUSTOMER_ID=MIN_CUSTID AND UASD_ID=TFTDCUASDID AND CACD_VALID_TILL IS NULL) THEN						
						SET TICK_NEW_VALUE=(SELECT CONCAT('ACN_ID=4',',CACD_VALID_TILL=',ENDDATE));
						IF (USERSTAMP_ID!=(SELECT ULD_ID FROM CUSTOMER_ACCESS_CARD_DETAILS WHERE CACD_ID=CACDID)) THEN
							SET TICK_OLD_VALUE=(SELECT CONCAT('CACD_ID=',CACDID,',UASD_ID=',UASDID,',ACN_ID=null',',CACD_VALID_TILL=null',',CACD_GUEST_CARD=',TICK_GUEST_CARD,',ULD_ID=',(SELECT ULD_ID FROM CUSTOMER_ACCESS_CARD_DETAILS WHERE CACD_ID=CACDID),',CACD_TIMESTAMP=',(SELECT CACD_TIMESTAMP FROM CUSTOMER_ACCESS_CARD_DETAILS WHERE CACD_ID=CACDID)));
						ELSE
							SET TICK_OLD_VALUE=(SELECT CONCAT('CACD_ID=',CACDID,',UASD_ID=',UASDID,',ACN_ID=null',',CACD_VALID_TILL=null',',CACD_GUEST_CARD=',TICK_GUEST_CARD,',CACD_TIMESTAMP=',(SELECT CACD_TIMESTAMP FROM CUSTOMER_ACCESS_CARD_DETAILS WHERE CACD_ID=CACDID)));
						END IF;	
						INSERT INTO TICKLER_HISTORY(TP_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,ULD_ID,CUSTOMER_ID)values(1,13,TICK_OLD_VALUE,TICK_NEW_VALUE,USERSTAMP_ID,MIN_CUSTID);
						UPDATE CUSTOMER_ACCESS_CARD_DETAILS SET CACD_VALID_TILL=ENDDATE,ACN_ID=4,
						ULD_ID=USERSTAMP_ID WHERE CUSTOMER_ID=MIN_CUSTID AND UASD_ID=TFTDCUASDID AND CACD_VALID_TILL IS NULL;												
						UPDATE UNIT_ACCESS_STAMP_DETAILS SET UASD_ACCESS_ACTIVE=NULL,UASD_ACCESS_INVENTORY='X' WHERE UASD_ID=TFTDCUASDID;						
						UPDATE CUSTOMER_PERSONAL_DETAILS SET CPD_COMMENTS=NEWCOMMENTS WHERE CUSTOMER_ID=MIN_CUSTID;						
						SET @CST_LP_RV=(SELECT CONCAT ('SELECT TFTDC_RECVER INTO @CST_RV FROM ',TEMP_AUTO_UNTERM_CUSTOMER,' WHERE TFTDC_UASDID=',TFTDCUASDID,' AND TFTDC_ID=',TFTDC_MINID));
						PREPARE CST_LP_RV_STMT FROM @CST_LP_RV;
						EXECUTE CST_LP_RV_STMT;
						SET CUST_LP_RV=@CST_RV;						
					IF TFTDCUASDID IS NOT NULL THEN
						SET @ULDIDCOUNT=(SELECT ULD_TS_MAXTIMES FROM CUSTOMER_LP_DETAILS WHERE CUSTOMER_ID=MIN_CUSTID AND CED_REC_VER=CUST_LP_RV AND UASD_ID=TFTDCUASDID);			
						UPDATE CUSTOMER_LP_DETAILS SET ULD_TS_MAXTIMES=(@ULDIDCOUNT+1),ULD_ID=USERSTAMP_ID WHERE CUSTOMER_ID=MIN_CUSTID AND CED_REC_VER=CUST_LP_RV AND UASD_ID=TFTDCUASDID;				
					END IF;	
						INSERT INTO TICKLER_HISTORY(TP_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,ULD_ID,CUSTOMER_ID)VALUES(1,15,TICK_OLD_COMTVALUE,TICK_NEW_COMTVALUE,USERSTAMP_ID,MIN_CUSTID);												
				END IF;			
				IF (TADC_COUNT=0) THEN	
					SET @SET_COUNT_AUTO_UNTERM_CUS=(SELECT CONCAT('SELECT COUNT(*)INTO @COUNTAUTOUNTERMCUS FROM ',TEMP_AUTO_UNTERM_CUSTOMER,' WHERE TFTDC_RECVER=',TFTDC_MAX_RECVER,' AND TFTDC_UASDID IS NOT NULL AND TFTDC_GUESTFLAG IS NULL AND TFTDC_ID=',TFTDC_MINID));
					PREPARE SET_COUNT_AUTO_UNTERM_CUS_STMT FROM @SET_COUNT_AUTO_UNTERM_CUS;
					EXECUTE SET_COUNT_AUTO_UNTERM_CUS_STMT;
					SET COUNT_AUTO_UNTERM_CUS=@COUNTAUTOUNTERMCUS;
					IF COUNT_AUTO_UNTERM_CUS>=1 THEN
						SET OLD_ULD_ID=(SELECT ULD_ID FROM CUSTOMER_LP_DETAILS WHERE CUSTOMER_ID=MIN_CUSTID AND CED_REC_VER=TFTDC_MAX_RECVER AND CLP_GUEST_CARD IS NULL);
						UPDATE CUSTOMER_LP_DETAILS SET CLP_TERMINATE='X',ULD_ID=USERSTAMP_ID WHERE CUSTOMER_ID=MIN_CUSTID AND CED_REC_VER=TFTDC_MAX_RECVER AND CLP_GUEST_CARD IS NULL;
						SET @UPDATE_TEMP_AUTO_TERM=(SELECT CONCAT('UPDATE ',TEMP_AUTO_UNTERM_CUSTOMER,' SET TFTDC_TERMINATEFLAG="X" WHERE TFTDC_CUSTOMERID=',MIN_CUSTID,' AND TFTDC_RECVER=',TFTDC_MAX_RECVER,' AND TFTDC_GUESTFLAG IS NULL'));
						PREPARE UPDATE_TEMP_AUTO_TERM_STMT FROM @UPDATE_TEMP_AUTO_TERM;
						EXECUTE UPDATE_TEMP_AUTO_TERM_STMT;
					ELSE
						SET @SET_COUNT_NULL_CARD=(SELECT CONCAT('SELECT COUNT(*)INTO @COUNTNULLCARD FROM ',TEMP_AUTO_UNTERM_CUSTOMER,' WHERE TFTDC_RECVER=',TFTDC_MAX_RECVER,' AND TFTDC_UASDID IS NULL AND TFTDC_GUESTFLAG IS NULL AND TFTDC_ID=',TFTDC_MINID));
						PREPARE SET_COUNT_NULL_CARD_STMT FROM @SET_COUNT_NULL_CARD;
						EXECUTE SET_COUNT_NULL_CARD_STMT;
						SET COUNT_NULL_CARD=@COUNTNULLCARD ;
						IF COUNT_NULL_CARD >=1 THEN
							SET OLD_ULD_ID=(SELECT ULD_ID FROM CUSTOMER_LP_DETAILS WHERE CUSTOMER_ID=MIN_CUSTID AND CED_REC_VER=TFTDC_MAX_RECVER AND CLP_GUEST_CARD IS NULL);
							UPDATE CUSTOMER_LP_DETAILS SET CLP_TERMINATE='X',ULD_ID=USERSTAMP_ID WHERE CUSTOMER_ID=MIN_CUSTID AND CED_REC_VER=TFTDC_MAX_RECVER AND CLP_GUEST_CARD IS NULL; 
							SET @UPDATE_TEMP_AUTO_TERM_CUS=(SELECT CONCAT('UPDATE ',TEMP_AUTO_UNTERM_CUSTOMER,' SET TFTDC_TERMINATEFLAG="X" WHERE TFTDC_CUSTOMERID=',MIN_CUSTID,' AND TFTDC_RECVER=',TFTDC_MAX_RECVER,' AND TFTDC_GUESTFLAG IS NULL'));
							PREPARE UPDATE_TEMP_AUTO_TERM_CUS_STMT FROM @UPDATE_TEMP_AUTO_TERM_CUS;
							EXECUTE UPDATE_TEMP_AUTO_TERM_CUS_STMT;
							INSERT INTO TICKLER_HISTORY(TP_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,ULD_ID,CUSTOMER_ID)VALUES(1,15,TICK_OLD_COMTVALUE,TICK_NEW_COMTVALUE,USERSTAMP_ID,MIN_CUSTID);
							UPDATE CUSTOMER_PERSONAL_DETAILS SET CPD_COMMENTS=NEWCOMMENTS WHERE CUSTOMER_ID=MIN_CUSTID;
						END IF;
					END IF;
				ELSE
					SET @SET_COUNT_AUTO_TERM=(SELECT CONCAT('SELECT COUNT(*)INTO @COUNTAUTOTERM  FROM ',TEMP_AUTO_UNTERM_CUSTOMER,' WHERE TFTDC_RECVER=',TADC_MAX_RECVER,' AND TFTDC_UASDID IS NOT NULL AND TFTDC_GUESTFLAG IS NULL AND TFTDC_ID=',TFTDC_MINID));
					PREPARE SET_COUNT_AUTO_TERM_STMT FROM @SET_COUNT_AUTO_TERM;
					EXECUTE SET_COUNT_AUTO_TERM_STMT;
					SET COUNT_AUTO_TERM=@COUNTAUTOTERM;
					IF COUNT_AUTO_TERM>=1 THEN
						SET OLD_ULD_ID=(SELECT ULD_ID FROM CUSTOMER_LP_DETAILS WHERE CUSTOMER_ID=MIN_CUSTID AND CED_REC_VER=TADC_MAX_RECVER AND CLP_GUEST_CARD IS NULL);
						UPDATE CUSTOMER_LP_DETAILS SET CLP_TERMINATE='X',ULD_ID=USERSTAMP_ID WHERE CUSTOMER_ID=MIN_CUSTID AND CED_REC_VER=TADC_MAX_RECVER AND CLP_GUEST_CARD IS NULL;
						SET @UPDATE_AUTO_UNTERM_CUS=(SELECT CONCAT('UPDATE ',TEMP_AUTO_UNTERM_CUSTOMER,' SET TFTDC_TERMINATEFLAG="X" WHERE TFTDC_CUSTOMERID=',MIN_CUSTID,' AND TFTDC_RECVER=',TADC_MAX_RECVER,' AND TFTDC_GUESTFLAG IS NULL'));
						PREPARE UPDATE_AUTO_UNTERM_CUS_STMT FROM @UPDATE_AUTO_UNTERM_CUS;
						EXECUTE UPDATE_AUTO_UNTERM_CUS_STMT;
					ELSE 
						SET @SET_COUNT_NULL_AUTO_TERM=(SELECT CONCAT('SELECT COUNT(*)INTO @COUNTNULLAUTOTERM FROM ',TEMP_AUTO_UNTERM_CUSTOMER,' WHERE TFTDC_RECVER=',TADC_MAX_RECVER,' AND TFTDC_UASDID IS NULL AND TFTDC_GUESTFLAG IS NULL AND TFTDC_ID=',TFTDC_MINID));
						PREPARE SET_COUNT_NULL_AUTO_TERM_STMT FROM @SET_COUNT_NULL_AUTO_TERM;
						EXECUTE SET_COUNT_NULL_AUTO_TERM_STMT;
						SET COUNT_NULL_AUTO_TERM=@COUNTNULLAUTOTERM;
						IF COUNT_NULL_AUTO_TERM>=1 THEN
							SET OLD_ULD_ID=(SELECT ULD_ID FROM CUSTOMER_LP_DETAILS WHERE CUSTOMER_ID=MIN_CUSTID AND CED_REC_VER=TADC_MAX_RECVER AND CLP_GUEST_CARD IS NULL);
							UPDATE CUSTOMER_LP_DETAILS SET CLP_TERMINATE='X',ULD_ID=USERSTAMP_ID WHERE CUSTOMER_ID=MIN_CUSTID AND CED_REC_VER=TADC_MAX_RECVER AND CLP_GUEST_CARD IS NULL;
							SET @UP_AUTO_TERM_TERMINATE=(SELECT CONCAT('UPDATE ',TEMP_AUTO_UNTERM_CUSTOMER,' SET TFTDC_TERMINATEFLAG="X" WHERE TFTDC_CUSTOMERID=',MIN_CUSTID,' AND TFTDC_RECVER=',TADC_MAX_RECVER,' AND TFTDC_GUESTFLAG IS NULL'));
							PREPARE UP_AUTO_TERM_TERMINATE_STMT FROM @UP_AUTO_TERM_TERMINATE;
							EXECUTE UP_AUTO_TERM_TERMINATE_STMT;
							INSERT INTO TICKLER_HISTORY(TP_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,ULD_ID,CUSTOMER_ID)VALUES(1,15,TICK_OLD_COMTVALUE,TICK_NEW_COMTVALUE,USERSTAMP_ID,MIN_CUSTID);
							UPDATE CUSTOMER_PERSONAL_DETAILS SET CPD_COMMENTS=NEWCOMMENTS WHERE CUSTOMER_ID=MIN_CUSTID;
						END IF;
					END IF;
				END IF;
			END IF;
				SET TFTDC_MINID = TFTDC_MINID+1;
				SET @CST_RV=NULL;
				SET @ULDIDCOUNT=NULL;	
		END WHILE;
		SET @SET_TUTDC_MINID = (SELECT CONCAT('SELECT MIN(TFTDC_ID)INTO @TUTDCMINID FROM ',TEMP_AUTO_UNTERM_CUSTOMER,' WHERE TFTDC_TERMINATEFLAG IS NOT NULL'));
		PREPARE SET_TUTDC_MINID_STMT FROM @SET_TUTDC_MINID;
		EXECUTE SET_TUTDC_MINID_STMT;
		SET TUTDC_MINID=@TUTDCMINID;
		SET @SET_TUTDC_MAXID = (SELECT CONCAT('SELECT MAX(TFTDC_ID)INTO @TUTDCMAXID FROM ',TEMP_AUTO_UNTERM_CUSTOMER,' WHERE TFTDC_TERMINATEFLAG IS NOT NULL'));
		PREPARE SET_TUTDC_MAXID_STMT FROM @SET_TUTDC_MAXID;
		EXECUTE SET_TUTDC_MAXID_STMT;
		SET TUTDC_MAXID=@TUTDCMAXID;
		WHILE(TUTDC_MINID <= TUTDC_MAXID)DO		
			SET @SET_TICK_UNIT_NO=(SELECT CONCAT('SELECT TFTDC_UNITNO INTO @TICKUNITNO FROM ',TEMP_AUTO_UNTERM_CUSTOMER,' WHERE TFTDC_ID=',TUTDC_MINID));
			PREPARE SET_TICK_UNIT_NO_STMT FROM @SET_TICK_UNIT_NO;
			EXECUTE SET_TICK_UNIT_NO_STMT;
			SET TICK_UNIT_NO=@TICKUNITNO;
			SET @SET_TICK_REC_VER=(SELECT CONCAT('SELECT TFTDC_RECVER INTO @TICKRECVER FROM ',TEMP_AUTO_UNTERM_CUSTOMER,' WHERE TFTDC_ID=',TUTDC_MINID));
			PREPARE SET_TICK_REC_VER_STMT FROM @SET_TICK_REC_VER;
			EXECUTE SET_TICK_REC_VER_STMT;
			SET TICK_REC_VER=@TICKRECVER;
			SET @SET_TICK_GUEST_CARD=(SELECT CONCAT('SELECT TFTDC_GUESTFLAG INTO @TICKGUESTCARD FROM ',TEMP_AUTO_UNTERM_CUSTOMER,' WHERE TFTDC_ID=',TUTDC_MINID));
			PREPARE SET_TICK_GUEST_CARD_STMT FROM @SET_TICK_GUEST_CARD;
			EXECUTE SET_TICK_GUEST_CARD_STMT;
			SET TICK_GUEST_CARD=@TICKGUESTCARD;
			SET @SET_TICK_CARD_NO=(SELECT CONCAT('SELECT TFTDC_CARDNO INTO @TICKCARDNO FROM ',TEMP_AUTO_UNTERM_CUSTOMER,' WHERE TFTDC_ID=',TUTDC_MINID));
			PREPARE SET_TICK_CARD_NO_STMT FROM @SET_TICK_CARD_NO;
			EXECUTE SET_TICK_CARD_NO_STMT;
			SET TICK_CARD_NO=@TICKCARDNO;
			SET @SET_TICK_PTD=(SELECT CONCAT('SELECT TFTDC_PRETERMINATEDATE INTO @TICKPTD FROM ',TEMP_AUTO_UNTERM_CUSTOMER,' WHERE TFTDC_ID=',TUTDC_MINID));
			PREPARE SET_TICK_PTD_STMT FROM @SET_TICK_PTD;
			EXECUTE SET_TICK_PTD_STMT;
			SET TICK_PTD=@TICKPTD;
			SET @SET_TICK_ENDDATE=(SELECT CONCAT('SELECT TFTDC_ENDDATE INTO @TICKENDDATE FROM ',TEMP_AUTO_UNTERM_CUSTOMER,' WHERE TFTDC_ID=',TUTDC_MINID));			
			PREPARE SET_TICK_ENDDATE_STMT FROM @SET_TICK_ENDDATE;
			EXECUTE SET_TICK_ENDDATE_STMT;
			SET TICK_ENDDATE=@TICKENDDATE;
			IF(TICK_CARD_NO IS NOT NULL)THEN
				SET TCTDID = (SELECT CLP_ID FROM CUSTOMER_LP_DETAILS WHERE CUSTOMER_ID=MIN_CUSTID AND CED_REC_VER=TICK_REC_VER AND UASD_ID=(SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=TICK_CARD_NO));
				SET TUASDID = (SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=TICK_CARD_NO);
			END IF;
			IF(TICK_CARD_NO IS NULL)THEN
				SET TCTDID = (SELECT CLP_ID FROM CUSTOMER_LP_DETAILS WHERE CUSTOMER_ID=MIN_CUSTID AND CED_REC_VER=TICK_REC_VER);
			END IF;
			IF(TICK_GUEST_CARD IS NULL) THEN
				SET TICK_GUEST_CARD=('null');
			END IF;
			IF TICK_PTD IS NOT NULL THEN
				IF TICK_CARD_NO IS NOT NULL THEN
					IF (USERSTAMP_ID!=OLD_ULD_ID)THEN
						SET TICK_OLD_TERMVALUE=(SELECT CONCAT('CLP_ID=',TCTDID,',CED_REC_VER=',TICK_REC_VER,',UASD_ID=',TUASDID,',CLP_TERMINATE=null',',CLP_PRETERMINATE_DATE=',TICK_PTD,',CLP_GUEST_CARD=',TICK_GUEST_CARD,',ULD_ID=',OLD_ULD_ID,',CLP_TIMESTAMP=',(SELECT CLP_TIMESTAMP FROM CUSTOMER_LP_DETAILS WHERE CLP_ID=TCTDID)));
					ELSE
						SET TICK_OLD_TERMVALUE=(SELECT CONCAT('CLP_ID=',TCTDID,',CED_REC_VER=',TICK_REC_VER,',UASD_ID=',TUASDID,',CLP_TERMINATE=null',',CLP_PRETERMINATE_DATE=',TICK_PTD,',CLP_GUEST_CARD=',TICK_GUEST_CARD,',CLP_TIMESTAMP=',(SELECT CLP_TIMESTAMP FROM CUSTOMER_LP_DETAILS WHERE CLP_ID=TCTDID)));	
					END IF;	
				END IF;
				IF TICK_CARD_NO IS NULL THEN
					IF (USERSTAMP_ID!=OLD_ULD_ID)THEN	
						SET TICK_OLD_TERMVALUE=(SELECT CONCAT('CLP_ID=',TCTDID,',CED_REC_VER=',TICK_REC_VER,',UASD_ID=null',',CLP_TERMINATE=null',',CLP_PRETERMINATE_DATE=',TICK_PTD,',CLP_GUEST_CARD=',TICK_GUEST_CARD,',ULD_ID=',OLD_ULD_ID,',CLP_TIMESTAMP=',(SELECT CLP_TIMESTAMP FROM CUSTOMER_LP_DETAILS WHERE CLP_ID=TCTDID)));
					ELSE
						SET TICK_OLD_TERMVALUE=(SELECT CONCAT('CLP_ID=',TCTDID,',CED_REC_VER=',TICK_REC_VER,',UASD_ID=null',',CLP_TERMINATE=null',',CLP_PRETERMINATE_DATE=',TICK_PTD,',CLP_GUEST_CARD=',TICK_GUEST_CARD,',CLP_TIMESTAMP=',(SELECT CLP_TIMESTAMP FROM CUSTOMER_LP_DETAILS WHERE CLP_ID=TCTDID)));
					END IF;	
				END IF;
			ELSE
				IF TICK_CARD_NO IS NOT NULL THEN
					IF (USERSTAMP_ID!=OLD_ULD_ID)THEN
						SET TICK_OLD_TERMVALUE=(SELECT CONCAT('CLP_ID=',TCTDID,',CED_REC_VER=',TICK_REC_VER,',UASD_ID=',TUASDID,',CLP_TERMINATE=null',',CLP_ENDDATE=',TICK_ENDDATE,',CLP_GUEST_CARD=',TICK_GUEST_CARD,',ULD_ID=',OLD_ULD_ID,',CLP_TIMESTAMP=',(SELECT CLP_TIMESTAMP FROM CUSTOMER_LP_DETAILS WHERE CLP_ID=TCTDID)));
					ELSE
						SET TICK_OLD_TERMVALUE=(SELECT CONCAT('CLP_ID=',TCTDID,',CED_REC_VER=',TICK_REC_VER,',UASD_ID=',TUASDID,',CLP_TERMINATE=null',',CLP_ENDDATE=',TICK_ENDDATE,',CLP_GUEST_CARD=',TICK_GUEST_CARD,',CLP_TIMESTAMP=',(SELECT CLP_TIMESTAMP FROM CUSTOMER_LP_DETAILS WHERE CLP_ID=TCTDID)));
					END IF;	
				END IF;
				IF TICK_CARD_NO IS NULL THEN
					IF (USERSTAMP_ID!=OLD_ULD_ID)THEN
						SET TICK_OLD_TERMVALUE=(SELECT CONCAT('CLP_ID=',TCTDID,',CED_REC_VER=',TICK_REC_VER,',UASD_ID=null',',CLP_TERMINATE=null',',CLP_ENDDATE=',TICK_ENDDATE,',CLP_GUEST_CARD=',TICK_GUEST_CARD,',ULD_ID=',OLD_ULD_ID,',CLP_TIMESTAMP=',(SELECT CLP_TIMESTAMP FROM CUSTOMER_LP_DETAILS WHERE CLP_ID=TCTDID)));
					ELSE
						SET TICK_OLD_TERMVALUE=(SELECT CONCAT('CLP_ID=',TCTDID,',CED_REC_VER=',TICK_REC_VER,',UASD_ID=null',',CLP_TERMINATE=null',',CLP_ENDDATE=',TICK_ENDDATE,',CLP_GUEST_CARD=',TICK_GUEST_CARD,',CLP_TIMESTAMP=',(SELECT CLP_TIMESTAMP FROM CUSTOMER_LP_DETAILS WHERE CLP_ID=TCTDID)));
					END IF;	
				END IF;
			END IF;
				SET TICK_NEW_TERMVALUE='CLP_TERMINATE=X';
				INSERT INTO TICKLER_HISTORY(TP_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,ULD_ID,CUSTOMER_ID)values(1,14,TICK_OLD_TERMVALUE,TICK_NEW_TERMVALUE,USERSTAMP_ID,MIN_CUSTID);
				SET TUTDC_MINID = TUTDC_MINID+1;
		END WHILE;	
		IF TEMP_AUTO_UNTERM_CUSTOMER IS NOT NULL THEN	
		SET @DROP_TEMP_AUTO_UNTERM=(SELECT CONCAT('DROP TABLE IF EXISTS ',TEMP_AUTO_UNTERM_CUSTOMER));
		PREPARE DROP_TEMP_AUTO_UNTERM_STMT FROM @DROP_TEMP_AUTO_UNTERM;
		EXECUTE DROP_TEMP_AUTO_UNTERM_STMT;
		END IF;
		SET MIN_CUSTID = MIN_CUSTID+1;	
	END WHILE;
	END IF;
	SET @FINALTERMCUS=NULL;
	SET @TICKUNITNO=NULL;
	SET @TICKRECVER=NULL;
	SET @TICKGUESTCARD=NULL;
	SET @TICKCARDNO=NULL;
	SET @TERM_UASD_ID=NULL;
	SET @COUNTUNTERMCUS=NULL;
	SET @PTD_DATE=NULL;
	SET @END_DATE=NULL;
	SET @COUNTNULLCARD=NULL;
	IF TEMP_AUTO_UNTERM_CUSTOMER IS NOT NULL THEN	
		SET @DROP_TEMP_AUTO_UNTERM=(SELECT CONCAT('DROP TABLE IF EXISTS ',TEMP_AUTO_UNTERM_CUSTOMER));
		PREPARE DROP_TEMP_AUTO_UNTERM_STMT FROM @DROP_TEMP_AUTO_UNTERM;
		EXECUTE DROP_TEMP_AUTO_UNTERM_STMT;
	END IF;
	SET @DROP_TEMP_FINAL=(SELECT CONCAT('DROP TABLE IF EXISTS ',TEMP_FINAL_TERMINATED_DATE_CUSTOMER));
	PREPARE DROP_TEMP_FINAL_STMT FROM @DROP_TEMP_FINAL;
	EXECUTE DROP_TEMP_FINAL_STMT;
	SET @DROP_TEMP_TERM_DATE_CUS=(SELECT CONCAT('DROP TABLE IF EXISTS ',TEMP_TERMINATED_DATE_CUSTOMER));
	PREPARE DROP_TEMP_TERM_DATE_CUS_STMT FROM @DROP_TEMP_TERM_DATE_CUS;
	EXECUTE DROP_TEMP_TERM_DATE_CUS_STMT;
	SET @DROP_TEMP_ACTIVE_CUSTOMER=(SELECT CONCAT('DROP TABLE IF EXISTS ',TEMP_ACTIVE_DATE_CUSTOMER));
	PREPARE DROP_TEMP_ACTIVE_CUSTOMER_STMT FROM @DROP_TEMP_ACTIVE_CUSTOMER;
	EXECUTE DROP_TEMP_ACTIVE_CUSTOMER_STMT;
	SET @DROP_TEMP_NON_TERM_CUSTOMER=(SELECT CONCAT('DROP TABLE IF EXISTS ',TEMP_NON_TERMINATED_CUSTOMER));
	PREPARE DROP_TEMP_NON_TERM_CUSTOMER_STMT FROM @DROP_TEMP_NON_TERM_CUSTOMER;
	EXECUTE DROP_TEMP_NON_TERM_CUSTOMER_STMT;
	SET @DROP_TEMP_AUTO_FINAL=(SELECT CONCAT('DROP TABLE IF EXISTS ',TEMP_FINAL_AUTO_TERM_CUSTOMER));
	PREPARE DROP_TEMP_AUTO_FINAL_STMT FROM @DROP_TEMP_AUTO_FINAL;
	EXECUTE DROP_TEMP_AUTO_FINAL_STMT;	
	COMMIT;
END;
