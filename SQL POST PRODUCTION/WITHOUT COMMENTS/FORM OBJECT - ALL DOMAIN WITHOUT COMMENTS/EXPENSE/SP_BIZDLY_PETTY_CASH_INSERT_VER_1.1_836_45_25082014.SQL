DROP PROCEDURE IF EXISTS SP_BIZDLY_PETTY_CASH_INSERT;
CREATE PROCEDURE SP_BIZDLY_PETTY_CASH_INSERT(
IN USERSTAMP VARCHAR(50),
IN PC_DATE DATE,
IN PC_CASH_IN DECIMAL(6,2),
IN PC_CASH_OUT DECIMAL(6,2),
IN PC_INVOICE_ITEMS VARCHAR(500),
IN PC_COMMENTS TEXT,
OUT PETTY_CASH_SUCCESSFLAG INTEGER)
BEGIN
    DECLARE CASH_IN DECIMAL(10,2);
    DECLARE CASH_OUT DECIMAL(10,2);
    DECLARE BALANCE DECIMAL(7,2);
	DECLARE USERSTAMP_ID INTEGER(2);
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN 
		ROLLBACK; 
		SET PETTY_CASH_SUCCESSFLAG=0;
    END;
	SET AUTOCOMMIT=0;
    IF PC_CASH_IN IS NULL THEN
        SET PC_CASH_IN =0;
    END IF;
    IF PC_CASH_OUT IS NULL THEN
        SET PC_CASH_OUT =0;
    END IF;
    SET CASH_IN =(SELECT SUM(EPC_CASH_IN) FROM EXPENSE_PETTY_CASH);
    IF CASH_IN IS NULL THEN
		SET CASH_IN=0;
    END IF;
    SET CASH_OUT =(SELECT SUM(EPC_CASH_OUT) FROM EXPENSE_PETTY_CASH);
    IF CASH_OUT IS NULL THEN
        SET CASH_OUT=0;
    END IF;
    IF CASH_IN IS NOT NULL  THEN
        SET CASH_IN=CASH_IN +PC_CASH_IN  ;
    ELSE
        SET CASH_IN=PC_CASH_IN;
    END IF;
    IF CASH_OUT IS NOT NULL THEN
        SET CASH_OUT=CASH_OUT + PC_CASH_OUT ;
    ELSE
        SET CASH_OUT=PC_CASH_OUT;
    END IF;
    SET BALANCE=CASH_IN-CASH_OUT;
    IF PC_CASH_IN =0 THEN
		SET PC_CASH_IN =NULL;
    END IF;
    IF PC_CASH_OUT =0 THEN
       SET PC_CASH_OUT =NULL;
    END IF;
    START TRANSACTION;
    SET PETTY_CASH_SUCCESSFLAG=0;
	CALL SP_CHANGE_USERSTAMP_AS_ULDID(USERSTAMP,@ULDID);
	SET USERSTAMP_ID = (SELECT @ULDID);
    IF PC_CASH_IN IS NOT NULL OR PC_CASH_OUT IS NOT NULL THEN
        INSERT INTO EXPENSE_PETTY_CASH(ULD_ID,EPC_DATE,EPC_CASH_IN,EPC_CASH_OUT,EPC_BALANCE,EPC_INVOICE_ITEMS,EPC_COMMENTS) VALUES (USERSTAMP_ID,PC_DATE,PC_CASH_IN,PC_CASH_OUT,BALANCE,PC_INVOICE_ITEMS,PC_COMMENTS);
        SET PETTY_CASH_SUCCESSFLAG=1;
    END IF;
    COMMIT;
 END;
