DROP PROCEDURE IF EXISTS SP_BIZDLY_PURCHASE_NEW_CARD_DELETE;
CREATE PROCEDURE SP_BIZDLY_PURCHASE_NEW_CARD_DELETE(
IN TABLE_ID INTEGER,
IN DELETING_ROWID INTEGER,
IN USERSTAMP VARCHAR(50),
OUT FLAG INTEGER)
	BEGIN
		DECLARE RETURNFLAG INTEGER;
		DECLARE USERSTAMP_ID INTEGER(2);
		DECLARE EXIT HANDLER FOR SQLEXCEPTION
		BEGIN
			SET FLAG=0;
			ROLLBACK;			
		END;
		SET AUTOCOMMIT=0;
		START TRANSACTION;
		SET FLAG=0;
		CALL SP_CHANGE_USERSTAMP_AS_ULDID(USERSTAMP,@ULDID);
        SET USERSTAMP_ID = (SELECT @ULDID);
		CALL SP_BIZDLY_PURCHASE_NEW_CARD_CHECK_TRANSACTION(TABLE_ID,DELETING_ROWID,@FLAG);
		SET RETURNFLAG=@FLAG;
		IF RETURNFLAG=1 THEN
		SET @DELFLAG=2;
			CALL SP_SINGLE_TABLE_ROW_DELETION(6,((SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=
			(SELECT EPNC_NUMBER FROM EXPENSE_PURCHASE_NEW_CARD WHERE EPNC_ID = DELETING_ROWID))),USERSTAMP,@UNITFLAG);
			CALL SP_SINGLE_TABLE_ROW_DELETION(TABLE_ID,DELETING_ROWID,USERSTAMP,@SUCCESSFLAG); 			
			SET @RETURNFLAG=@SUCCESSFLAG;
			IF @SUCCESSFLAG=1 AND @UNITFLAG=1 THEN
				SET FLAG=1;
			END IF;
		END IF;
	COMMIT;
END;
