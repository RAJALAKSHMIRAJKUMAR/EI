DROP PROCEDURE IF EXISTS SP_STAFFDLY_STAFF_INSERT;
CREATE PROCEDURE SP_STAFFDLY_STAFF_INSERT(
IN ECNID TEXT,
IN INVOICEDATE TEXT,
IN AMOUNT TEXT,
IN INVOICEITEMS TEXT,
IN INVOICEFROM TEXT,
IN COMMENTS TEXT,
IN USERSTAMP VARCHAR(50),
OUT FINALMESSAGE TEXT)
BEGIN
	DECLARE USERSTAMP_ID INTEGER(2);
	DECLARE ESECNID TEXT;
	DECLARE ESINVOICEDATE DATE;
	DECLARE ESAMOUNT  DECIMAL(5,2);
	DECLARE ESINVOICEITEMS TEXT;
	DECLARE ESINVOICEFROM VARCHAR(200);
	DECLARE ESCOMMENTS TEXT;
	DECLARE SUBSPSUCCESSFLAG INTEGER;
	DECLARE EXIT HANDLER FOR SQLEXCEPTION
	BEGIN 
		ROLLBACK; 
	END;
	SET @TEMP_ECNID = ECNID;
	SET @TEMP_INVOICEDATE = INVOICEDATE;
	SET @TEMP_AMOUNT = AMOUNT;
	SET @TEMP_INVOICEITEMS = INVOICEITEMS;
	SET @TEMP_INVOICEFROM = INVOICEFROM;
	SET @TEMP_COMMENTS = COMMENTS;
	SET FINALMESSAGE = '';
		MAIN_LOOP : LOOP
		CALL SP_GET_SPECIAL_CHARACTER_SEPERATED_VALUES(',',@TEMP_ECNID,@VALUE,@REMAINING_STRING);
		SELECT @VALUE INTO ESECNID;
		SELECT @REMAINING_STRING INTO @TEMP_ECNID;
		CALL SP_GET_SPECIAL_CHARACTER_SEPERATED_VALUES(',',@TEMP_INVOICEDATE,@VALUE,@REMAINING_STRING);
		SELECT @VALUE INTO ESINVOICEDATE;
		SELECT @REMAINING_STRING INTO @TEMP_INVOICEDATE;
		CALL SP_GET_SPECIAL_CHARACTER_SEPERATED_VALUES(',',@TEMP_AMOUNT,@VALUE,@REMAINING_STRING);
		SELECT @VALUE INTO ESAMOUNT;
		SELECT @REMAINING_STRING INTO @TEMP_AMOUNT;
		CALL SP_GET_SPECIAL_CHARACTER_SEPERATED_VALUES('^^',@TEMP_INVOICEITEMS,@VALUE,@REMAINING_STRING);
		SELECT @VALUE INTO ESINVOICEITEMS;
		SELECT @REMAINING_STRING INTO @TEMP_INVOICEITEMS;
		CALL SP_GET_SPECIAL_CHARACTER_SEPERATED_VALUES('^^',@TEMP_INVOICEFROM,@VALUE,@REMAINING_STRING);
		SELECT @VALUE INTO ESINVOICEFROM;
		SELECT @REMAINING_STRING INTO @TEMP_INVOICEFROM;
		CALL SP_GET_SPECIAL_CHARACTER_SEPERATED_VALUES('^^',@TEMP_COMMENTS,@VALUE,@REMAINING_STRING);
		SELECT @VALUE INTO ESCOMMENTS;
		SELECT @REMAINING_STRING INTO @TEMP_COMMENTS;	
		SET AUTOCOMMIT = 0;
		START TRANSACTION;	
		IF(ESECNID IS NOT NULL AND ESINVOICEDATE IS NOT NULL AND ESAMOUNT IS NOT NULL AND ESINVOICEITEMS IS NOT NULL AND ESINVOICEFROM IS NOT NULL AND USERSTAMP IS NOT NULL)THEN 
			CALL SP_STAFFDLY_SUBSTAFF_INSERT(ESECNID,ESINVOICEDATE,ESAMOUNT,ESINVOICEITEMS,ESINVOICEFROM,ESCOMMENTS,USERSTAMP,@SUCCESSFLAG);
			SET SUBSPSUCCESSFLAG = (SELECT @SUCCESSFLAG);
		END IF;
		IF(SUBSPSUCCESSFLAG=0)THEN
			SET FINALMESSAGE = (SELECT CONCAT(FINALMESSAGE,' ','ECN_DATA=',ESECNID,',','INVOICE_DATE=',ESINVOICEDATE,',',
			'AMOUNT=',ESAMOUNT,',','INVOICE_ITEMS=',ESINVOICEITEMS,',','INVOICE_FROM=',ESINVOICEFROM,',',
			'COMMENTS=',ESCOMMENTS,',','USERSTAMP=',USERSTAMP));
		END IF;
		IF @TEMP_ECNID IS NULL THEN
			LEAVE  MAIN_LOOP;
		END IF;
	END LOOP;
	IF(FINALMESSAGE = '')THEN
		SET FINALMESSAGE = 1;
	END IF;
COMMIT;
END;
