DROP PROCEDURE IF EXISTS SP_BIZDLY_HOUSEKEEPING_PAYMENT_INSERT;
CREATE PROCEDURE SP_BIZDLY_HOUSEKEEPING_PAYMENT_INSERT
(IN UNIT_NUMBER SMALLINT(4),
IN FOR_PERIOD DATE,
IN PAID_DATE DATE,
IN AMOUNT DECIMAL(5,2),
IN COMMENTS TEXT,
IN USERSTAMP VARCHAR(50),
OUT HP_FLAG INTEGER(10))
BEGIN
	DECLARE UNITID INTEGER;
	DECLARE HOUSEKEEPINGID INTEGER;
	DECLARE USERSTAMP_ID INTEGER(2);
	DECLARE EXIT HANDLER FOR SQLEXCEPTION
	BEGIN 
		ROLLBACK; 
		SET HP_FLAG=0;
	END;
	SET AUTOCOMMIT=0;
	START TRANSACTION;
	SET HP_FLAG=0;
	CALL SP_CHANGE_USERSTAMP_AS_ULDID(USERSTAMP,@ULDID);
	SET USERSTAMP_ID = (SELECT @ULDID);
	IF COMMENTS ='' THEN
		SET COMMENTS=NULL;
	END IF;
	IF (FOR_PERIOD IS NOT NULL AND PAID_DATE IS NOT NULL AND AMOUNT IS NOT NULL AND USERSTAMP IS NOT NULL) THEN
		IF EXISTS(SELECT UNIT_ID FROM UNIT WHERE UNIT_NO=UNIT_NUMBER) THEN
			SET UNITID = (SELECT UNIT_ID FROM UNIT WHERE UNIT_NO=UNIT_NUMBER);
			INSERT INTO EXPENSE_HOUSEKEEPING_PAYMENT(UNIT_ID,EHKP_FOR_PERIOD,EHKP_PAID_DATE,EHKP_AMOUNT,EHKP_COMMENTS,ULD_ID)values(UNITID,FOR_PERIOD,PAID_DATE,AMOUNT,COMMENTS,USERSTAMP_ID);
			SET HP_FLAG=1;
		END IF;
		IF EXISTS(SELECT EHKU_ID FROM EXPENSE_HOUSEKEEPING_UNIT WHERE EHKU_UNIT_NO=UNIT_NUMBER)THEN
			SET HOUSEKEEPINGID=(SELECT EHKU_ID FROM EXPENSE_HOUSEKEEPING_UNIT WHERE EHKU_UNIT_NO=UNIT_NUMBER);
			INSERT INTO EXPENSE_HOUSEKEEPING_PAYMENT(EHKU_ID,EHKP_FOR_PERIOD,EHKP_PAID_DATE,EHKP_AMOUNT,EHKP_COMMENTS,ULD_ID)values(HOUSEKEEPINGID,FOR_PERIOD,PAID_DATE,AMOUNT,COMMENTS,USERSTAMP_ID);
			SET HP_FLAG=1;
		END IF;
		IF NOT EXISTS(SELECT UNIT_NO FROM UNIT WHERE UNIT_NO=UNIT_NUMBER) THEN
			IF NOT EXISTS(SELECT EHKU_UNIT_NO FROM EXPENSE_HOUSEKEEPING_UNIT WHERE EHKU_UNIT_NO=UNIT_NUMBER)THEN
				INSERT INTO EXPENSE_HOUSEKEEPING_UNIT (EHKU_UNIT_NO,ULD_ID) values (UNIT_NUMBER,USERSTAMP_ID);
				SET HP_FLAG=1;
				SET HOUSEKEEPINGID=(SELECT EHKU_ID FROM EXPENSE_HOUSEKEEPING_UNIT WHERE EHKU_UNIT_NO=UNIT_NUMBER);
				INSERT INTO EXPENSE_HOUSEKEEPING_PAYMENT(EHKU_ID,EHKP_FOR_PERIOD,EHKP_PAID_DATE,EHKP_AMOUNT,EHKP_COMMENTS,ULD_ID)values(HOUSEKEEPINGID,FOR_PERIOD,PAID_DATE,AMOUNT,COMMENTS,USERSTAMP_ID);
				SET HP_FLAG=1;
			END IF;
		END IF;
	END IF;
	COMMIT;
END;
