DROP PROCEDURE IF EXISTS SP_BIZDLY_STARHUB_INSERT;
CREATE PROCEDURE  SP_BIZDLY_STARHUB_INSERT(
IN UNITNO TEXT,
IN ECN_ID_NEW TEXT,
IN INVOICEDATE TEXT,
IN FROMPERIOD TEXT,
IN TOPERIOD TEXT,
IN AMOUNT TEXT,
IN COMMENTS TEXT,
IN USERSTAMP VARCHAR(50),
OUT FINALMESSAGE TEXT)
BEGIN
DECLARE USERSTAMP_ID INTEGER(2);
DECLARE ESUNITNO TEXT;
DECLARE ESINVOICEID TEXT;
DECLARE ESINVOICEDATE DATE;
DECLARE ESFROMPERIOD DATE;
DECLARE ESTOPERIOD  DATE;
DECLARE ESAMOUNT  DECIMAL(7,2);
DECLARE ESCOMMENTS TEXT;
DECLARE SUBSPSUCCESSFLAG INTEGER;
DECLARE ESINVOICECHECK TEXT;
DECLARE ERROR_MSG TEXT;
DECLARE EXIT HANDLER FOR SQLEXCEPTION
BEGIN 
ROLLBACK; 
END;
SET AUTOCOMMIT=0;
START TRANSACTION;	
SET FINALMESSAGE = '';
SET @TEMP_UNITNO = UNITNO;
SET @TEMP_INVOICEID = ECN_ID_NEW;
SET @TEMP_INVOICEDATE = INVOICEDATE;
SET @TEMP_FROMPERIOD = FROMPERIOD;
SET @TEMP_TOPERIOD = TOPERIOD;
SET @TEMP_AMOUNT = AMOUNT;
SET @TEMP_COMMENTS = COMMENTS;
MAIN_LOOP : LOOP
	CALL SP_GET_SPECIAL_CHARACTER_SEPERATED_VALUES(',',@TEMP_UNITNO,@VALUE,@REMAINING_STRING);
	SELECT @VALUE INTO ESUNITNO;
	SELECT @REMAINING_STRING INTO @TEMP_UNITNO;
	CALL SP_GET_SPECIAL_CHARACTER_SEPERATED_VALUES(',',@TEMP_INVOICEID,@VALUE,@REMAINING_STRING);
	SELECT @VALUE INTO ESINVOICEID;
	SELECT @REMAINING_STRING INTO @TEMP_INVOICEID;
	CALL SP_GET_SPECIAL_CHARACTER_SEPERATED_VALUES(',',@TEMP_INVOICEDATE,@VALUE,@REMAINING_STRING);
	SELECT @VALUE INTO ESINVOICEDATE;
	SELECT @REMAINING_STRING INTO @TEMP_INVOICEDATE;
	CALL SP_GET_SPECIAL_CHARACTER_SEPERATED_VALUES(',',@TEMP_FROMPERIOD,@VALUE,@REMAINING_STRING);
	SELECT @VALUE INTO ESFROMPERIOD;
	SELECT @REMAINING_STRING INTO @TEMP_FROMPERIOD;
	CALL SP_GET_SPECIAL_CHARACTER_SEPERATED_VALUES(',',@TEMP_TOPERIOD,@VALUE,@REMAINING_STRING);
	SELECT @VALUE INTO ESTOPERIOD;
	SELECT @REMAINING_STRING INTO @TEMP_TOPERIOD;
	CALL SP_GET_SPECIAL_CHARACTER_SEPERATED_VALUES(',',@TEMP_AMOUNT,@VALUE,@REMAINING_STRING);
	SELECT @VALUE INTO ESAMOUNT;
	SELECT @REMAINING_STRING INTO @TEMP_AMOUNT;
	CALL SP_GET_SPECIAL_CHARACTER_SEPERATED_VALUES('^^',@TEMP_COMMENTS,@VALUE,@REMAINING_STRING);
	SELECT @VALUE INTO ESCOMMENTS;
	SELECT @REMAINING_STRING INTO @TEMP_COMMENTS;
	IF(ESUNITNO IS NOT NULL AND ESINVOICEID IS NOT NULL AND ESINVOICEDATE IS NOT NULL AND ESFROMPERIOD IS NOT NULL AND ESTOPERIOD IS NOT NULL AND ESAMOUNT IS NOT NULL AND USERSTAMP IS NOT NULL)THEN 
		CALL SP_BIZDLY_SUBSTARHUB_INSERT(ESUNITNO,ESINVOICEID,ESINVOICEDATE,ESFROMPERIOD,ESTOPERIOD,ESAMOUNT,ESCOMMENTS,USERSTAMP,@STARHUB_SUCCESSFLAG,@STARHUB_UPDATEFLAG,@OUTPUT_MSG);
		SET SUBSPSUCCESSFLAG = (SELECT @STARHUB_SUCCESSFLAG);
		SET ERROR_MSG=(SELECT @OUTPUT_MSG);
	END IF;
		IF NOT (ESINVOICEID ='SELECT') THEN 
          SET ESINVOICECHECK=(SELECT ECN_DATA FROM EXPENSE_CONFIGURATION WHERE ECN_ID=ESINVOICEID);
         ELSE
          SET ESINVOICECHECK='';
        END IF;
	IF(SUBSPSUCCESSFLAG=0) OR (ERROR_MSG!=' ') THEN
		SET FINALMESSAGE = (SELECT CONCAT(FINALMESSAGE,' ','UNIT_NO=',ESUNITNO,',INVOICETO=',ESINVOICECHECK,',INVOICEDATE=',ESINVOICEDATE,',FROMPERIOD=',ESFROMPERIOD,',TOPERIOD=',ESTOPERIOD,',AMOUNT=',ESAMOUNT,',COMMENTS=',ESCOMMENTS,',USERSTAMP=',USERSTAMP,'/ WARNING: ',ERROR_MSG,'//    '));
	END IF;
	IF @TEMP_UNITNO IS NULL THEN
		LEAVE  MAIN_LOOP;
	END IF;
	END LOOP;
	IF(FINALMESSAGE = '')THEN
		SET FINALMESSAGE = 1;
	END IF;
COMMIT;
END;
