DROP PROCEDURE IF EXISTS SP_BIZDLY_ELECTRICITY_INSERT;
CREATE PROCEDURE SP_BIZDLY_ELECTRICITY_INSERT(
IN UNITNO TEXT,
IN INVOICEDATE TEXT,
IN FROMPERIOD TEXT,
IN TOPERIOD TEXT,
IN ECNID TEXT,
IN AMOUNT TEXT,
IN COMMENTS TEXT,
IN USERSTAMP VARCHAR(50),
OUT FINALMESSAGE TEXT)
BEGIN
	DECLARE USERSTAMP_ID INTEGER(2);
	DECLARE EEUNITNO TEXT;
	DECLARE EEINVOICEDATE DATE;
	DECLARE EEFROMPERIOD DATE;
	DECLARE EETOPERIOD DATE;
	DECLARE EEECNID  TEXT;
	DECLARE EEAMOUNT  DECIMAL(7,2);
	DECLARE EECOMMENTS TEXT;
	DECLARE SUBSPSUCCESSFLAG INTEGER;
	DECLARE ERRORMSG TEXT;
	DECLARE EXIT HANDLER FOR SQLEXCEPTION
	BEGIN 
		ROLLBACK; 
	END;
	SET AUTOCOMMIT=0;
	SET @TEMP_UNITNO = UNITNO;
	SET @TEMP_INVOICEDATE = INVOICEDATE;
	SET @TEMP_FROMPERIOD = FROMPERIOD;
	SET @TEMP_TOPERIOD = TOPERIOD;
	SET @TEMP_ECNID = ECNID;
	SET @TEMP_AMOUNT = AMOUNT;
	SET @TEMP_COMMENTS = COMMENTS;
	SET FINALMESSAGE = '';
	MAIN_LOOP : LOOP
		CALL SP_GET_SPECIAL_CHARACTER_SEPERATED_VALUES(',',@TEMP_UNITNO,@VALUE,@REMAINING_STRING);
		SELECT @VALUE INTO EEUNITNO;
		SELECT @REMAINING_STRING INTO @TEMP_UNITNO;
		CALL SP_GET_SPECIAL_CHARACTER_SEPERATED_VALUES(',',@TEMP_INVOICEDATE,@VALUE,@REMAINING_STRING);
		SELECT @VALUE INTO EEINVOICEDATE;
		SELECT @REMAINING_STRING INTO @TEMP_INVOICEDATE;
		CALL SP_GET_SPECIAL_CHARACTER_SEPERATED_VALUES(',',@TEMP_FROMPERIOD,@VALUE,@REMAINING_STRING);
		SELECT @VALUE INTO EEFROMPERIOD;
		SELECT @REMAINING_STRING INTO @TEMP_FROMPERIOD;
		CALL SP_GET_SPECIAL_CHARACTER_SEPERATED_VALUES(',',@TEMP_TOPERIOD,@VALUE,@REMAINING_STRING);
		SELECT @VALUE INTO EETOPERIOD;
		SELECT @REMAINING_STRING INTO @TEMP_TOPERIOD;
		CALL SP_GET_SPECIAL_CHARACTER_SEPERATED_VALUES(',',@TEMP_ECNID,@VALUE,@REMAINING_STRING);
		SELECT @VALUE INTO EEECNID;
		SELECT @REMAINING_STRING INTO @TEMP_ECNID;
		CALL SP_GET_SPECIAL_CHARACTER_SEPERATED_VALUES(',',@TEMP_AMOUNT,@VALUE,@REMAINING_STRING);
		SELECT @VALUE INTO EEAMOUNT;
		SELECT @REMAINING_STRING INTO @TEMP_AMOUNT;
		CALL SP_GET_SPECIAL_CHARACTER_SEPERATED_VALUES('^^',@TEMP_COMMENTS,@VALUE,@REMAINING_STRING);
		SELECT @VALUE INTO EECOMMENTS;
		SELECT @REMAINING_STRING INTO @TEMP_COMMENTS;	
		START TRANSACTION;	
		IF(EEUNITNO IS NOT NULL AND EEINVOICEDATE IS NOT NULL AND EEFROMPERIOD IS NOT NULL AND EETOPERIOD IS NOT NULL AND EEECNID IS NOT NULL AND EEAMOUNT IS NOT NULL AND USERSTAMP IS NOT NULL)THEN 
			CALL SP_BIZDLY_SUBELECTRICITY_INSERT(EEUNITNO,EEINVOICEDATE,EEFROMPERIOD,EETOPERIOD,EEECNID,EEAMOUNT,EECOMMENTS,USERSTAMP,@EESUCCESSFLAG,@OUTPUT_MSG);
			SET SUBSPSUCCESSFLAG = (SELECT @EESUCCESSFLAG);
			SET ERRORMSG=(SELECT @OUTPUT_MSG);
		END IF;
		IF(SUBSPSUCCESSFLAG=0 OR ERRORMSG!=' ')THEN
			SET FINALMESSAGE = (SELECT CONCAT(FINALMESSAGE,' ','UNIT_NO=',EEUNITNO,',','INVOICE_DATE=',EEINVOICEDATE,',',
			'FROM_PERIOD=',EEFROMPERIOD,',','TO_PERIOD=',EETOPERIOD,',','ECN_ID=',EEECNID,',','AMOUNT=',EEAMOUNT,',',
			'COMMENTS=',EECOMMENTS,',','USERSTAMP=',USERSTAMP,'/ WARNING: ',ERRORMSG,'//    '));
		END IF;
		IF @TEMP_UNITNO IS NULL THEN
			LEAVE  MAIN_LOOP;
		END IF;
	END LOOP;
	IF(FINALMESSAGE = '')THEN
		SET FINALMESSAGE = 1;
	END IF;
COMMIT;
END;
