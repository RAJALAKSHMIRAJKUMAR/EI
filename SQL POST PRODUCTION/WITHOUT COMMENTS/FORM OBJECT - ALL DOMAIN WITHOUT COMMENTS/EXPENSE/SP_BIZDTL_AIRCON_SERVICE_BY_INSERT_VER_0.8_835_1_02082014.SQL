DROP PROCEDURE IF EXISTS SP_BIZDTL_AIRCON_SERVICE_BY_INSERT;
CREATE PROCEDURE SP_BIZDTL_AIRCON_SERVICE_BY_INSERT(
IN UNITNO INTEGER,
IN EASBDATA CHAR(50),
IN COMMENTS TEXT,
IN USERSTAMP VARCHAR(50),
OUT FLAG INTEGER(10))
BEGIN
	DECLARE RECVER INTEGER;
	DECLARE USERSTAMP_ID INTEGER(2);
	DECLARE EXIT HANDLER FOR SQLEXCEPTION
	BEGIN 
		ROLLBACK; 
		SET FLAG=0;
	END;
	SET AUTOCOMMIT=0;
	START TRANSACTION;
	SET FLAG=0;
	CALL SP_CHANGE_USERSTAMP_AS_ULDID(USERSTAMP,@ULDID);
    SET USERSTAMP_ID = (SELECT @ULDID);
	IF COMMENTS='' THEN
		SET COMMENTS=NULL;
	END IF;
	IF EASBDATA IS NOT NULL THEN
		IF NOT EXISTS(SELECT EASB_DATA FROM EXPENSE_AIRCON_SERVICE_BY WHERE EASB_DATA=EASBDATA)THEN
			INSERT INTO EXPENSE_AIRCON_SERVICE_BY(EASB_DATA,ULD_ID)VALUES(EASBDATA,USERSTAMP_ID);
			SET FLAG=1;
		END IF;
	END IF;
	IF(UNITNO IS NOT NULL AND EASBDATA IS NOT NULL AND USERSTAMP IS NOT NULL) THEN
		IF NOT EXISTS (SELECT UNIT_ID FROM EXPENSE_DETAIL_AIRCON_SERVICE WHERE UNIT_ID=(SELECT UNIT_ID FROM UNIT WHERE UNIT_NO=UNITNO)) THEN
			INSERT INTO EXPENSE_DETAIL_AIRCON_SERVICE(UNIT_ID,EASB_ID,EDAS_REC_VER,EDAS_COMMENTS,ULD_ID)VALUES
			((SELECT UNIT_ID FROM UNIT WHERE UNIT_NO=UNITNO),
			(SELECT EASB_ID FROM EXPENSE_AIRCON_SERVICE_BY WHERE EASB_DATA=EASBDATA),1,COMMENTS,USERSTAMP_ID);
			SET FLAG=1;
		ELSE 
			SET RECVER=(SELECT MAX(EDAS_REC_VER) FROM EXPENSE_DETAIL_AIRCON_SERVICE WHERE UNIT_ID=(SELECT UNIT_ID FROM UNIT WHERE UNIT_NO=UNITNO));
			SET RECVER=RECVER+1;
			INSERT INTO EXPENSE_DETAIL_AIRCON_SERVICE(UNIT_ID,EASB_ID,EDAS_REC_VER,EDAS_COMMENTS,ULD_ID)VALUES
			((SELECT UNIT_ID FROM UNIT WHERE UNIT_NO=UNITNO),
			(SELECT EASB_ID FROM EXPENSE_AIRCON_SERVICE_BY WHERE EASB_DATA=EASBDATA),RECVER,COMMENTS,USERSTAMP_ID);
		SET FLAG=1;
		END IF;
	END IF;
COMMIT;
END;
