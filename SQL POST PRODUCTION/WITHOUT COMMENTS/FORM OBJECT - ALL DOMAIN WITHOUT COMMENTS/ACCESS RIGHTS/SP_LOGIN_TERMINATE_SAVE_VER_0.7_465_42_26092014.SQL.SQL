DROP PROCEDURE IF EXISTS SP_LOGIN_TERMINATE_SAVE;
CREATE PROCEDURE SP_LOGIN_TERMINATE_SAVE(
IN LOGINID VARCHAR(40),
IN ENDDATE DATE,
IN REASON TEXT,
IN USERSTAMP VARCHAR(50),
OUT SUCCESS_FLAG INTEGER,
OUT TEMPTBL_OUT_LOGINID TEXT
)
BEGIN
	DECLARE RECVER INTEGER;
	DECLARE MINID INTEGER;
	DECLARE MAXID INTEGER;
	DECLARE TEMPTBL_LOGINID TEXT;
	DECLARE TEMP_LOGINID TEXT;
	DECLARE USERSTAMP_ID INT;
	DECLARE T_ELID INT;
	DECLARE EXIT HANDLER FOR SQLEXCEPTION
	BEGIN
	ROLLBACK;
	SET SUCCESS_FLAG=0;
	IF(TEMPTBL_LOGINID IS NOT NULL)THEN
		SET @DROPQUERY = (SELECT CONCAT('DROP TABLE IF EXISTS ',TEMPTBL_LOGINID));
		PREPARE DROPQUERYSTMT FROM @DROPQUERY;
		EXECUTE DROPQUERYSTMT;
	END IF;
	END;
	START TRANSACTION;
	SET AUTOCOMMIT=0;
	SET SUCCESS_FLAG=0;	
	CALL SP_CHANGE_USERSTAMP_AS_ULDID(USERSTAMP,@ULDID);
	SET USERSTAMP_ID = (SELECT @ULDID);
	SET TEMP_LOGINID=(SELECT CONCAT('TEMP_OUT_TEMINATETBL_LOGINID',SYSDATE()));
	SET TEMP_LOGINID=(SELECT REPLACE(TEMP_LOGINID,' ',''));
	SET TEMP_LOGINID=(SELECT REPLACE(TEMP_LOGINID,'-',''));
	SET TEMP_LOGINID=(SELECT REPLACE(TEMP_LOGINID,':',''));
	SET TEMPTBL_LOGINID=(SELECT CONCAT(TEMP_LOGINID,'_',USERSTAMP_ID));
	SET TEMPTBL_OUT_LOGINID=TEMPTBL_LOGINID;
	SET @CREATE_TEMPTBL_LOGINID=(SELECT CONCAT('CREATE TABLE ',TEMPTBL_LOGINID,'(ID INTEGER AUTO_INCREMENT PRIMARY KEY,ELID VARCHAR(40))'));
		PREPARE CREATE_TEMPTBL_LOGINID_STMT FROM @CREATE_TEMPTBL_LOGINID;
		EXECUTE CREATE_TEMPTBL_LOGINID_STMT;
	IF LOGINID IS NOT NULL AND ENDDATE IS NOT NULL AND REASON IS NOT NULL THEN
		SET RECVER=(SELECT MAX(UA_REC_VER) FROM USER_ACCESS WHERE ULD_ID=(SELECT ULD_ID FROM USER_LOGIN_DETAILS WHERE ULD_LOGINID=LOGINID));
		UPDATE USER_ACCESS SET UA_JOIN=NULL,UA_TERMINATE='X',UA_REASON=REASON,UA_END_DATE=ENDDATE,
		UA_USERSTAMP=USERSTAMP WHERE ULD_ID=(SELECT ULD_ID FROM USER_LOGIN_DETAILS WHERE ULD_LOGINID=LOGINID)AND
		UA_REC_VER=RECVER;
		SET SUCCESS_FLAG=1;		
		SET @INSERT_TEMPTBL_LOGINID=(SELECT CONCAT('INSERT INTO ',TEMPTBL_LOGINID,'(ELID) SELECT EL_ID FROM EMAIL_LIST WHERE EL_EMAIL_ID=','"',LOGINID,'"  AND  EP_ID IN(1,17,15,16,13,14,20,24)'));
		PREPARE INSERT_TEMPTBL_LOGINID_STMT FROM @INSERT_TEMPTBL_LOGINID;
		EXECUTE INSERT_TEMPTBL_LOGINID_STMT;
		SET @MIN_ID=NULL;
		SET @SELECT_MINID=(SELECT CONCAT('SELECT MIN(ID) INTO @MIN_ID FROM ',TEMPTBL_LOGINID));
		PREPARE SELECT_MINID_STMT FROM @SELECT_MINID;
		EXECUTE SELECT_MINID_STMT;
		SET MINID=@MIN_ID;
		SET @MAX_ID=NULL;
		SET @SELECT_MAXID=(SELECT CONCAT('SELECT MAX(ID) INTO @MAX_ID FROM ',TEMPTBL_LOGINID));
		PREPARE SELECT_MAXID_STMT FROM @SELECT_MAXID;
		EXECUTE SELECT_MAXID_STMT;
		SET MAXID=@MAX_ID;
		WHILE MINID<=MAXID DO
			SET @SELECT_ELID=(SELECT CONCAT('SELECT ELID INTO @EID FROM ',TEMPTBL_LOGINID,' WHERE ID=',MINID));
			PREPARE SELECT_ELID_STMT FROM @SELECT_ELID;
			EXECUTE SELECT_ELID_STMT;
			SET T_ELID=@EID;
			INSERT INTO TICKLER_HISTORY(TP_ID,TTIP_ID,TH_OLD_VALUE,ULD_ID) VALUES(2,22,(SELECT CONCAT("EL_ID=",T_ELID,",EP_ID=",(SELECT EP_ID FROM EMAIL_LIST WHERE EL_ID=T_ELID),",EL_EMAIL_ID=",LOGINID,",ULD_ID=",(SELECT ULD_ID FROM EMAIL_LIST WHERE EL_ID=T_ELID),",EL_TIMESTAMP=",(SELECT EL_TIMESTAMP FROM EMAIL_LIST WHERE EL_ID=T_ELID))),USERSTAMP_ID);
			DELETE FROM EMAIL_LIST WHERE EL_ID=T_ELID;
			SET MINID=MINID+1;
		END WHILE;
		SET SUCCESS_FLAG=1;		
	END IF;
END;
