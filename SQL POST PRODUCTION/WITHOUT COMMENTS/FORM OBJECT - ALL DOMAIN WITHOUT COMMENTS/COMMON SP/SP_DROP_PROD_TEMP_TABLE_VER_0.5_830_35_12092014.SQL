DROP PROCEDURE IF EXISTS SP_DROP_PROD_TEMP_TABLE;
CREATE PROCEDURE SP_DROP_PROD_TEMP_TABLE(
IN SCHEMANAME VARCHAR(50),
IN USER_STAMP VARCHAR(50),
OUT FINAL_TEMP_TABLE TEXT)
BEGIN
	DECLARE USERSTAMP_ID INTEGER;
	DECLARE SYSDATEANDTIME VARCHAR(50);
	DECLARE SYSDATEANDULDID VARCHAR(50);
	DECLARE ALL_PROD_TABLE TEXT;
	DECLARE MINID INTEGER;
	DECLARE MAXID INTEGER;
	DECLARE OLDTABLE_FINALDATE DATE;
	DECLARE SYS_DATE_TIME DATETIME;
	DECLARE SYS_DATE DATE;
	DECLARE CONFIG_NO_OF_DAYS INTEGER;
	DECLARE CONFIG_DATE DATE;
	DECLARE FINAL_MINID INTEGER;
	DECLARE FINAL_MAXID INTEGER;
	DECLARE OLDTABLENAMEDATE DATE;
	DECLARE OLD_FTABLENAME TEXT;
	DECLARE DROP_MINID INTEGER;
	DECLARE DROP_MAXID INTEGER;
	DECLARE DROP_TABLE_NAME TEXT;
	DECLARE EXIT HANDLER FOR SQLEXCEPTION
	BEGIN 
		ROLLBACK;
		IF(ALL_PROD_TABLE IS NOT NULL)THEN
			SET @DROP_ALL_PROD_TABLE = (SELECT CONCAT('DROP TABLE IF EXISTS ',ALL_PROD_TABLE,''));
			PREPARE DROP_ALL_PROD_TABLE_STMT FROM @DROP_ALL_PROD_TABLE;
			EXECUTE DROP_ALL_PROD_TABLE_STMT;
		END IF;
	END;
	SET AUTOCOMMIT = 0;
	START TRANSACTION;
	CALL SP_CHANGE_USERSTAMP_AS_ULDID(USER_STAMP,@ULDID);
	SET USERSTAMP_ID=(SELECT @ULDID);
	SET SYSDATEANDTIME=(SELECT SYSDATE());
	SET SYSDATEANDTIME=(SELECT REPLACE(SYSDATEANDTIME,' ',''));
	SET SYSDATEANDTIME=(SELECT REPLACE(SYSDATEANDTIME,'-',''));
	SET SYSDATEANDTIME=(SELECT REPLACE(SYSDATEANDTIME,':',''));
	SET SYSDATEANDULDID=(SELECT CONCAT(SYSDATEANDTIME,'_',USERSTAMP_ID));
	SET ALL_PROD_TABLE = (SELECT CONCAT('TEMP_ALL_PROD_TABLES','_',SYSDATEANDULDID));
	SET @CREATE_ALL_PROD_TABLE = (SELECT CONCAT('CREATE TABLE ',ALL_PROD_TABLE,'(
	ID INTEGER AUTO_INCREMENT,
	OLD_TABLENAME TEXT,
	CREATETIME DATETIME,
	OLD_TABLENAME_DATE DATE,
	PRIMARY KEY(ID))'));
	PREPARE CREATE_ALL_PROD_TABLE_STMT FROM @CREATE_ALL_PROD_TABLE;
	EXECUTE CREATE_ALL_PROD_TABLE_STMT;
	SET @TEMP = 'TEMP_%';
	SET @TEMPALL_PRODTABLES = 'TEMP_ALL_PROD_TABLES_%';
	SET @INSERT_ALL_PROD_TABLE = (SELECT CONCAT('INSERT INTO ',ALL_PROD_TABLE,'(OLD_TABLENAME,CREATETIME)
	(SELECT TABLE_NAME,CREATE_TIME FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = ','"',SCHEMANAME,'"',' AND CREATE_TIME  AND TABLE_NAME LIKE @TEMP AND TABLE_NAME NOT LIKE @TEMPALL_PRODTABLES)'));
	PREPARE INSERT_ALL_PROD_TABLE_STMT FROM @INSERT_ALL_PROD_TABLE;
	EXECUTE INSERT_ALL_PROD_TABLE_STMT;
	SET @MINIMUMID = (SELECT CONCAT('SELECT MIN(ID) INTO @MIN_ID FROM ',ALL_PROD_TABLE,''));
	PREPARE MINIMUMID_STMT FROM @MINIMUMID;
	EXECUTE MINIMUMID_STMT;
	SET @MAXIMUMID = (SELECT CONCAT('SELECT MAX(ID) INTO @MAX_ID FROM ',ALL_PROD_TABLE,''));
	PREPARE MAXIMUMID_STMT FROM @MAXIMUMID;
	EXECUTE MAXIMUMID_STMT;
	SET MINID = @MIN_ID;
	SET MAXID = @MAX_ID;
	WHILE(MINID <= MAXID) DO
		SET @OLDFDATE = (SELECT CONCAT('SELECT DATE(CREATETIME) INTO @OLDF_DATE FROM ',ALL_PROD_TABLE,' WHERE ID = ',MINID,''));
		PREPARE OLDFDATE_STMT FROM @OLDFDATE;
		EXECUTE OLDFDATE_STMT;
		SET OLDTABLE_FINALDATE = @OLDF_DATE;
		SET @UPDATEQUERY = (SELECT CONCAT('UPDATE ',ALL_PROD_TABLE,' SET OLD_TABLENAME_DATE = ','"',OLDTABLE_FINALDATE,'"',' WHERE ID = ',MINID,''));
		PREPARE UPDATEQUERY_STMT FROM @UPDATEQUERY;
		EXECUTE UPDATEQUERY_STMT;
		SET MINID = MINID+1;
	END WHILE;
	SET SYS_DATE_TIME = (SELECT SYSDATE());
	SET SYS_DATE = (SELECT DATE(SYS_DATE_TIME));
	SET CONFIG_NO_OF_DAYS = (SELECT TC_DATA FROM TRIGGER_CONFIGURATION WHERE CGN_ID = 85);
	SET CONFIG_DATE = (SELECT DATE_SUB(SYS_DATE,INTERVAL (SELECT CONFIG_NO_OF_DAYS) DAY));
	SET FINAL_TEMP_TABLE = (SELECT CONCAT('TEMP_DROPPPED_PROD_TABLES','_',SYSDATEANDULDID));
	SET @FINAL_TEMP_TABLE_CREATEQUERY = (SELECT CONCAT('CREATE TABLE ',FINAL_TEMP_TABLE,'(
	ID INTEGER AUTO_INCREMENT,
	DROPTABLENAME TEXT,
	PRIMARY KEY(ID))'));
	PREPARE FINAL_TEMP_TABLE_CREATEQUERY_STMT FROM @FINAL_TEMP_TABLE_CREATEQUERY;
	EXECUTE FINAL_TEMP_TABLE_CREATEQUERY_STMT;
	SET @FINAL_MINIMUMID = (SELECT CONCAT('SELECT MIN(ID) INTO @FINAL_MIN_ID FROM ',ALL_PROD_TABLE,''));
	PREPARE FINAL_MINIMUMID_STMT FROM @FINAL_MINIMUMID;
	EXECUTE FINAL_MINIMUMID_STMT;
	SET @FINAL_MAXIMUMID = (SELECT CONCAT('SELECT MAX(ID) INTO @FINAL_MAX_ID FROM ',ALL_PROD_TABLE,''));
	PREPARE FINAL_MAXIMUMID_STMT FROM @FINAL_MAXIMUMID;
	EXECUTE FINAL_MAXIMUMID_STMT;
	SET FINAL_MINID = @FINAL_MIN_ID;
	SET FINAL_MAXID = @FINAL_MAX_ID;
	WHILE(FINAL_MINID <= FINAL_MAXID)DO	
		SET @OLD_F_DATE = (SELECT CONCAT('SELECT OLD_TABLENAME_DATE INTO @OLD_TABLENAMEDATE FROM ',ALL_PROD_TABLE,' WHERE ID = ',FINAL_MINID,''));
		PREPARE OLD_F_DATE_STMT FROM @OLD_F_DATE;
		EXECUTE OLD_F_DATE_STMT;
		SET OLDTABLENAMEDATE = @OLD_TABLENAMEDATE;
		IF(OLDTABLENAMEDATE <= CONFIG_DATE) THEN
			SET @O_TABLENAME = (SELECT CONCAT('SELECT OLD_TABLENAME INTO @OTABLENAME FROM ',ALL_PROD_TABLE,' WHERE ID = ',FINAL_MINID,''));
			PREPARE O_TABLENAME_STMT FROM @O_TABLENAME;
			EXECUTE O_TABLENAME_STMT;
			SET OLD_FTABLENAME = @OTABLENAME;
			SET @FINAL_TEMP_TABLE_INSERTQUERY = (SELECT CONCAT('INSERT INTO ',FINAL_TEMP_TABLE,' (DROPTABLENAME) VALUES
			(','"',OLD_FTABLENAME,'"',')'));
			PREPARE FINAL_TEMP_TABLE_INSERTQUERY_STMT FROM @FINAL_TEMP_TABLE_INSERTQUERY;
			EXECUTE FINAL_TEMP_TABLE_INSERTQUERY_STMT;
		END IF;
		SET FINAL_MINID = FINAL_MINID+1;
	END WHILE;
	SET @DROP_MINUMUMID = (SELECT CONCAT('SELECT MIN(ID) INTO @DROPMINID FROM ',FINAL_TEMP_TABLE,''));
	PREPARE DROP_MINUMUMID_STMT FROM @DROP_MINUMUMID;
	EXECUTE DROP_MINUMUMID_STMT;
	SET @DROP_MAXIMUMID = (SELECT CONCAT('SELECT MAX(ID) INTO @DROPMAXID FROM ',FINAL_TEMP_TABLE,''));
	PREPARE DROP_MAXIMUMID_STMT FROM @DROP_MAXIMUMID;
	EXECUTE DROP_MAXIMUMID_STMT;
	SET DROP_MINID = @DROPMINID;
	SET DROP_MAXID = @DROPMAXID;
	WHILE(DROP_MINID <= DROP_MAXID)DO
		SET @DROPTABLE_NAME = (SELECT CONCAT('SELECT DROPTABLENAME INTO @DROPFTABLE FROM ',FINAL_TEMP_TABLE,' WHERE ID = ',DROP_MINID,''));
		PREPARE DROPTABLE_NAME_STMT FROM @DROPTABLE_NAME;
		EXECUTE DROPTABLE_NAME_STMT;
		SET DROP_TABLE_NAME = @DROPFTABLE;
		SET @DROPQUERY = (SELECT CONCAT('DROP TABLE IF EXISTS ',DROP_TABLE_NAME,''));
		PREPARE DROPQUERY_STMT FROM @DROPQUERY;
		EXECUTE DROPQUERY_STMT;
		SET DROP_MINID = DROP_MINID+1;
	END WHILE;
	IF(ALL_PROD_TABLE IS NOT NULL)THEN
		SET @DROP_ALL_PROD_TABLE = (SELECT CONCAT('DROP TABLE IF EXISTS ',ALL_PROD_TABLE,''));
		PREPARE DROP_ALL_PROD_TABLE_STMT FROM @DROP_ALL_PROD_TABLE;
		EXECUTE DROP_ALL_PROD_TABLE_STMT;
	END IF;
	COMMIT;
END;	
