DROP PROCEDURE IF EXISTS SP_UNIT_LOGIN_DOORCODE_UPDATE;
CREATE PROCEDURE SP_UNIT_LOGIN_DOORCODE_UPDATE(
IN UNIT_NUMBER SMALLINT(4),
IN DOORCODE VARCHAR(10),
IN WEBLOGIN VARCHAR(20),
IN WEBPWD VARCHAR(6),
IN USERSTAMP VARCHAR(50),
OUT FLAG INTEGER)
BEGIN
	DECLARE USERSTAMP_ID INTEGER(2);
	DECLARE UNITID INTEGER;
	DECLARE OLD_ULDTLDOORCODE TEXT;
    DECLARE OLD_ULDTLWEBLOGIN TEXT;
    DECLARE OLD_ULDTLWEBPWD TEXT;
    DECLARE OLD_ULDID TEXT;
    DECLARE OLD_ULDTLTIMESTAMP TEXT;
	DECLARE ULDTLID INTEGER;
	DECLARE NEW_ULDTLDOORCODE TEXT;
    DECLARE NEW_ULDTLWEBLOGIN TEXT;
    DECLARE NEW_ULDTLWEBPWD TEXT;
    DECLARE NEW_ULDID TEXT;
	DECLARE OLD_UNITLOGINDETAILTABLEDETAILS TEXT;
    DECLARE NEW_UNITLOGINDETAILTABLEDETAILS TEXT;
    DECLARE UNITLOGINDETAIL_HEADNAME TEXT;
    DECLARE UNITLOGINDETAIL_LENGTH INTEGER;
    DECLARE OLDUNITLOGINDETAILPOSITION INTEGER;
    DECLARE OLD_UNITLOGINDETAILS TEXT;
    DECLARE NEWUNITLOGINDETAILPOSITION INTEGER;
    DECLARE NEW_UNITLOGINDETAILS TEXT;
    DECLARE UNITLOGINDETAILHEADPOSITION INTEGER;
    DECLARE UNITLOGINDETAILHEADNAME TEXT;
    DECLARE NEWUNITLOGINDETAILRECORDS TEXT ;
    DECLARE OLDUNITLOGINDETAILRECORDS TEXT ;
    DECLARE UNITLOGINDETAILHEADERNAMES TEXT;
    DECLARE UNITLOGINDETAIL_ID VARCHAR(30);
    DECLARE OLD_UNITLOGINDETAIL TEXT;
    DECLARE NEW_UNITLOGINDETAIL TEXT;
    DECLARE UAHEADERNAME TEXT;
    DECLARE UA_LOCATION INTEGER;
	DECLARE OLDDOORCODE VARCHAR(10);
	DECLARE OLDWEBLOGIN VARCHAR(20);
	DECLARE OLDWEBPWD VARCHAR(6);
	DECLARE EXIT HANDLER FOR SQLEXCEPTION
	BEGIN 
		ROLLBACK; 
    SET FLAG=0;
	END;
	IF DOORCODE='' OR DOORCODE IS NULL THEN
		SET DOORCODE = NULL;
	END IF;
	IF WEBLOGIN='' THEN
	SET WEBLOGIN=NULL;
	END IF;
	IF WEBPWD='' THEN
	SET WEBPWD=NULL;
	END IF;
	SET AUTOCOMMIT = 0;
	START TRANSACTION;
	SET FLAG=0;
	CALL SP_CHANGE_USERSTAMP_AS_ULDID(USERSTAMP,@ULDID);
	SET USERSTAMP_ID = (SELECT @ULDID);
	SET UNITID = (SELECT UNIT_ID FROM UNIT WHERE UNIT_NO = UNIT_NUMBER);
    SET OLDDOORCODE = (SELECT ULDTL_DOORCODE FROM UNIT_LOGIN_DETAILS WHERE UNIT_ID = UNITID);
	IF(OLDDOORCODE IS NULL)THEN
		SET DOORCODE = NULL;
	END IF;
	SET OLDWEBLOGIN = (SELECT ULDTL_WEBLOGIN FROM UNIT_LOGIN_DETAILS WHERE UNIT_ID = UNITID);
	SET OLDWEBPWD = (SELECT ULDTL_WEBPWD FROM UNIT_LOGIN_DETAILS WHERE UNIT_ID = UNITID);
	SET UNITLOGINDETAIL_ID = '';
	SET ULDTLID = (SELECT ULDTL_ID FROM UNIT_LOGIN_DETAILS WHERE UNIT_ID = UNITID);
	SET OLD_ULDTLDOORCODE = (SELECT ULDTL_DOORCODE FROM UNIT_LOGIN_DETAILS WHERE ULDTL_ID = ULDTLID);
	IF OLD_ULDTLDOORCODE IS NULL THEN
		SET OLD_ULDTLDOORCODE = 'NULL';
	END IF;
	SET OLD_ULDTLWEBLOGIN = (SELECT ULDTL_WEBLOGIN FROM UNIT_LOGIN_DETAILS WHERE ULDTL_ID = ULDTLID);
	IF OLD_ULDTLWEBLOGIN IS NULL THEN
		SET OLD_ULDTLWEBLOGIN='NULL';
	END IF;
	SET OLD_ULDTLWEBPWD = (SELECT ULDTL_WEBPWD FROM UNIT_LOGIN_DETAILS WHERE ULDTL_ID = ULDTLID);
	IF OLD_ULDTLWEBPWD IS NULL THEN
		SET OLD_ULDTLWEBPWD='NULL';
	END IF;
	SET OLD_ULDID = (SELECT ULD_ID FROM UNIT_LOGIN_DETAILS WHERE ULDTL_ID = ULDTLID);
	SET OLD_ULDTLTIMESTAMP = (SELECT ULDTL_TIMESTAMP FROM UNIT_LOGIN_DETAILS WHERE ULDTL_ID = ULDTLID);
	SET NEW_ULDTLDOORCODE = DOORCODE;
	IF(NEW_ULDTLDOORCODE IS NULL)THEN
		SET NEW_ULDTLDOORCODE = 'NULL';
	END IF;
	IF(OLD_ULDTLDOORCODE='NULL' AND NEW_ULDTLDOORCODE='NULL')THEN
		SET NEW_ULDTLDOORCODE = 'NULL';
	END IF;
	IF(OLD_ULDTLDOORCODE!='NULL' AND NEW_ULDTLDOORCODE = 'NULL')THEN
		SET NEW_ULDTLDOORCODE = OLD_ULDTLDOORCODE;
	END IF;
	SET NEW_ULDTLWEBLOGIN = WEBLOGIN;
	IF(NEW_ULDTLWEBLOGIN IS NULL)THEN
		SET NEW_ULDTLWEBLOGIN = 'NULL';
	END IF;
	IF(OLD_ULDTLWEBLOGIN='NULL' AND NEW_ULDTLWEBLOGIN IS NOT NULL)THEN
		SET NEW_ULDTLWEBLOGIN = 'NULL';
	END IF;
	IF(NEW_ULDTLDOORCODE IS NOT NULL AND OLD_ULDTLWEBLOGIN='NULL' AND NEW_ULDTLWEBLOGIN IS NOT NULL)THEN
		SET NEW_ULDTLWEBLOGIN = 'NULL';
	END IF;
	SET NEW_ULDTLWEBPWD = WEBPWD;
	IF(NEW_ULDTLWEBPWD IS NULL)THEN
		SET NEW_ULDTLWEBPWD = 'NULL';
	END IF;
	IF(OLD_ULDTLWEBPWD='NULL' AND NEW_ULDTLWEBPWD IS NOT NULL)THEN
		SET NEW_ULDTLWEBPWD = 'NULL';
	END IF;
	IF(NEW_ULDTLDOORCODE IS NOT NULL AND OLD_ULDTLWEBPWD='NULL' AND OLD_ULDTLWEBPWD IS NOT NULL)THEN
		SET NEW_ULDTLWEBPWD = 'NULL';
	END IF;
	SET NEW_ULDID = USERSTAMP_ID;
	SET UNITLOGINDETAILHEADERNAMES = 'ULDTL_ID,UNIT_ID,ULDTL_DOORCODE,ULDTL_WEBLOGIN,ULDTL_WEBPWD';
	SET OLD_UNITLOGINDETAILTABLEDETAILS = (SELECT CONCAT(ULDTLID,'^','^',UNITID,'^','^',OLD_ULDTLDOORCODE,'^','^',OLD_ULDTLWEBLOGIN,'^','^',OLD_ULDTLWEBPWD));
	SET NEW_UNITLOGINDETAILTABLEDETAILS = (SELECT CONCAT(ULDTLID,'^','^',UNITID,'^','^',NEW_ULDTLDOORCODE,'^','^',NEW_ULDTLWEBLOGIN,'^','^',NEW_ULDTLWEBPWD));
	IF(OLD_UNITLOGINDETAILTABLEDETAILS != NEW_UNITLOGINDETAILTABLEDETAILS)THEN
		SET OLDUNITLOGINDETAILRECORDS = OLD_UNITLOGINDETAILTABLEDETAILS;
		SET NEWUNITLOGINDETAILRECORDS = NEW_UNITLOGINDETAILTABLEDETAILS;
		SET UNITLOGINDETAILHEADNAME = UNITLOGINDETAILHEADERNAMES;
		SET OLD_UNITLOGINDETAILS = (SELECT CONCAT('ULDTL_ID=',ULDTLID,',','UNIT_ID=',UNITID));
		SET NEW_UNITLOGINDETAILS = '';
		SET UNITLOGINDETAIL_LENGTH = 1;
		loop_label : LOOP
			SET OLDUNITLOGINDETAILPOSITION = (SELECT LOCATE('^^',OLDUNITLOGINDETAILRECORDS,UNITLOGINDETAIL_LENGTH));
			IF (OLDUNITLOGINDETAILPOSITION=0) THEN
				SET OLD_UNITLOGINDETAIL = OLDUNITLOGINDETAILRECORDS;
			ELSE
				SET OLD_UNITLOGINDETAIL =(SELECT SUBSTRING(OLDUNITLOGINDETAILRECORDS,UNITLOGINDETAIL_LENGTH,OLDUNITLOGINDETAILPOSITION-1));
				SET OLDUNITLOGINDETAILRECORDS=(SELECT SUBSTRING(OLDUNITLOGINDETAILRECORDS,OLDUNITLOGINDETAILPOSITION+2));
			END IF;
			SET NEWUNITLOGINDETAILPOSITION = (SELECT LOCATE('^^',NEWUNITLOGINDETAILRECORDS,UNITLOGINDETAIL_LENGTH));
			IF (NEWUNITLOGINDETAILPOSITION=0) THEN
				SET NEW_UNITLOGINDETAIL = NEWUNITLOGINDETAILRECORDS;
			ELSE
				SET NEW_UNITLOGINDETAIL=(SELECT SUBSTRING(NEWUNITLOGINDETAILRECORDS,UNITLOGINDETAIL_LENGTH,NEWUNITLOGINDETAILPOSITION-1));
				SET NEWUNITLOGINDETAILRECORDS=(SELECT SUBSTRING(NEWUNITLOGINDETAILRECORDS,NEWUNITLOGINDETAILPOSITION+2));
			END IF;
			SET UNITLOGINDETAILHEADPOSITION = (SELECT LOCATE(',',UNITLOGINDETAILHEADNAME,UNITLOGINDETAIL_LENGTH));
			IF (UNITLOGINDETAILHEADPOSITION=0) THEN
				SET UAHEADERNAME = UNITLOGINDETAILHEADNAME;
			ELSE
				SET UAHEADERNAME=(SELECT SUBSTRING(UNITLOGINDETAILHEADNAME,UNITLOGINDETAIL_LENGTH,UNITLOGINDETAILHEADPOSITION-1));
				SET UNITLOGINDETAILHEADNAME=(SELECT SUBSTRING(UNITLOGINDETAILHEADNAME,UNITLOGINDETAILHEADPOSITION+1));
			END IF;
			IF(OLD_UNITLOGINDETAIL != NEW_UNITLOGINDETAIL)THEN
				SET OLD_UNITLOGINDETAIL=(SELECT CONCAT(UAHEADERNAME, '=', OLD_UNITLOGINDETAIL));
				SET NEW_UNITLOGINDETAIL=(SELECT CONCAT(UAHEADERNAME, '=' ,NEW_UNITLOGINDETAIL));
				SET NEW_UNITLOGINDETAILS=(SELECT CONCAT(NEW_UNITLOGINDETAILS,',',NEW_UNITLOGINDETAIL));
				SET OLD_UNITLOGINDETAILS=(SELECT CONCAT(OLD_UNITLOGINDETAILS,',',OLD_UNITLOGINDETAIL));
			END IF;  
			IF (UNITLOGINDETAILHEADPOSITION<=0) THEN
				LEAVE  loop_label;
			END IF;
		END LOOP;
		SET UA_LOCATION=(SELECT LOCATE(',', NEW_UNITLOGINDETAILS,1));
		SET NEW_UNITLOGINDETAILS=(SELECT SUBSTRING(NEW_UNITLOGINDETAILS,UA_LOCATION+1));
		IF EXISTS(SELECT UNIT_ID FROM UNIT_LOGIN_DETAILS WHERE UNIT_ID = UNITID) THEN
			IF(OLD_ULDID!=NEW_ULDID) THEN
				SET OLD_UNITLOGINDETAILS = (SELECT CONCAT(OLD_UNITLOGINDETAILS,',ULD_ID=',OLD_ULDID,',ULDTL_TIMESTAMP=',OLD_ULDTLTIMESTAMP));
			END IF;
			IF(OLD_ULDID=NEW_ULDID) THEN
				SET OLD_UNITLOGINDETAILS = (SELECT CONCAT(OLD_UNITLOGINDETAILS,',ULDTL_TIMESTAMP=',OLD_ULDTLTIMESTAMP));
			END IF;
			UPDATE UNIT_LOGIN_DETAILS SET ULDTL_DOORCODE=(SELECT(IF (DOORCODE IS NULL,OLDDOORCODE,DOORCODE))),
			ULDTL_WEBLOGIN = (SELECT (IF(OLDWEBLOGIN IS NULL,OLDWEBLOGIN,WEBLOGIN))),ULDTL_WEBPWD=(SELECT (IF(OLDWEBPWD IS NULL,OLDWEBPWD,WEBPWD))),ULD_ID=USERSTAMP_ID WHERE UNIT_ID = UNITID;
			SET FLAG=1;
			IF(FLAG = 1) THEN
				INSERT INTO TICKLER_HISTORY(TP_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,ULD_ID)VALUES
				((SELECT TP_ID FROM TICKLER_PROFILE WHERE TP_TYPE='UPDATION'),
				(SELECT TTIP_ID FROM TICKLER_TABID_PROFILE WHERE TTIP_DATA='UNIT_LOGIN_DETAILS'),
				OLD_UNITLOGINDETAILS,NEW_UNITLOGINDETAILS,USERSTAMP_ID);
			END IF;
		END IF;
	END IF;
COMMIT;
END;
