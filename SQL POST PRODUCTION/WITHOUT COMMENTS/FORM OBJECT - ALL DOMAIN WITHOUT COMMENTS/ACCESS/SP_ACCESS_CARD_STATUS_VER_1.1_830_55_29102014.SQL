DROP PROCEDURE IF EXISTS SP_ACCESS_CARD_STATUS;
CREATE PROCEDURE SP_ACCESS_CARD_STATUS(IN CARD_NUMBER INTEGER(7),USERSTAMP VARCHAR(50),OUT TEMP_ACCESS_CARD_STATUS TEXT,OUT SUCCESSFLAG TEXT)
BEGIN
DECLARE ACCESS_CARD_TEMP_TABLE TEXT;
DECLARE USERSTAMP_ID INTEGER;
DECLARE CARD_UNIT_NO INTEGER;
DECLARE CARDID INTEGER;
DECLARE TEMPCARD TEXT;
DECLARE TEMP_CARD TEXT;
DECLARE CUST_COUNT INTEGER;
DECLARE EXIT HANDLER FOR SQLEXCEPTION
BEGIN
    ROLLBACK;
    SET @DROP_QUERY_TEMPCARD=(SELECT CONCAT('DROP TABLE IF EXISTS ',TEMP_CARD));
    PREPARE DROP_QUERY_STMT FROM @DROP_QUERY_TEMPCARD;
    EXECUTE DROP_QUERY_STMT;
END;
START TRANSACTION;
SET @CARDNO=CARD_NUMBER;
CALL SP_CHANGE_USERSTAMP_AS_ULDID(USERSTAMP,@ULDID);
SET USERSTAMP_ID=(SELECT @ULDID);
SET ACCESS_CARD_TEMP_TABLE=(SELECT CONCAT('TEMP_ACCESS_CARD_STATUS','_',SYSDATE()));
SET ACCESS_CARD_TEMP_TABLE=(SELECT REPLACE(ACCESS_CARD_TEMP_TABLE,' ',''));
SET ACCESS_CARD_TEMP_TABLE=(SELECT REPLACE(ACCESS_CARD_TEMP_TABLE,'-',''));
SET ACCESS_CARD_TEMP_TABLE=(SELECT REPLACE(ACCESS_CARD_TEMP_TABLE,':',''));
SET TEMP_ACCESS_CARD_STATUS=(SELECT CONCAT(ACCESS_CARD_TEMP_TABLE,'_',USERSTAMP_ID));
SET TEMPCARD=(SELECT CONCAT('TEMP_CARD','_',SYSDATE()));
SET TEMPCARD=(SELECT REPLACE(TEMPCARD,' ',''));
SET TEMPCARD=(SELECT REPLACE(TEMPCARD,'-',''));
SET TEMPCARD=(SELECT REPLACE(TEMPCARD,':',''));
SET TEMP_CARD=(SELECT CONCAT(TEMPCARD,'_',USERSTAMP_ID));
SET CARDID=(SELECT (UASD_ID) FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=CARD_NUMBER);
SET @CREATE_TEMP_ACCESS_CARD_STATUS=(SELECT CONCAT('CREATE TABLE ',TEMP_ACCESS_CARD_STATUS,'(UNITNO INTEGER(4) UNSIGNED ZEROFILL,ACTIVE_ACCESS_CARD TEXT,INVENTORY_ACCESS_CARD INTEGER(7),LOST_ACCESS_CARD TEXT,ACCESS_REASON TEXT,ACCESS_COMMENTS TEXT)'));
PREPARE CREATE_TEMP_ACCESS_CARD_STATUS_STMT FROM @CREATE_TEMP_ACCESS_CARD_STATUS;
EXECUTE CREATE_TEMP_ACCESS_CARD_STATUS_STMT;
SET @DROP_QUERY_TEMPCARD=(SELECT CONCAT('DROP TABLE IF EXISTS ',TEMP_CARD));
PREPARE DROP_QUERY_STMT FROM @DROP_QUERY_TEMPCARD;
EXECUTE DROP_QUERY_STMT;
SET @CREATE_QUERY_TEMPCARD=(SELECT CONCAT('CREATE TABLE ',TEMP_CARD,'(ID INTEGER NOT NULL AUTO_INCREMENT PRIMARY KEY,CUSTOMERID INTEGER)'));
PREPARE CREATE_QUERY_TEMPCARD FROM @CREATE_QUERY_TEMPCARD;
EXECUTE CREATE_QUERY_TEMPCARD;
SET @INSERT_QUERY_TEMPCARD=(SELECT CONCAT('INSERT INTO ',TEMP_CARD,'(CUSTOMERID)SELECT DISTINCT CUSTOMER_ID FROM  CUSTOMER_ACCESS_CARD_DETAILS WHERE UASD_ID=',CARDID,' AND ACN_ID IS NULL AND CACD_VALID_TILL IS NULL'));
PREPARE INSERT_QUERY_TEMPCARD_STMT FROM @INSERT_QUERY_TEMPCARD;
EXECUTE INSERT_QUERY_TEMPCARD_STMT;
SET @COUNT_TEMPCARD=(SELECT CONCAT('SELECT COUNT(*) INTO @TEMP_CARD_COUNT FROM ',TEMP_CARD));
PREPARE COUNT_TEMPCARD_STMT FROM @COUNT_TEMPCARD;
EXECUTE COUNT_TEMPCARD_STMT;
SET CUST_COUNT= @TEMP_CARD_COUNT;
IF CUST_COUNT>1 THEN
    SET @SET_CUSTOMER_ID=(SELECT CONCAT('SELECT GROUP_CONCAT(CUSTOMER_FIRST_NAME,"-",CUSTOMER_LAST_NAME) INTO @CUSTNAME FROM  CUSTOMER WHERE CUSTOMER_ID IN (SELECT CUSTOMERID FROM ',TEMP_CARD,')'));
    PREPARE SET_CUSTOMER_ID_STMT FROM @SET_CUSTOMER_ID;
    EXECUTE SET_CUSTOMER_ID_STMT;
  SET SUCCESSFLAG=(SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=573);
    SET SUCCESSFLAG=(SELECT REPLACE(SUCCESSFLAG,'[UNIT_NO]',CARD_NUMBER));
    SET SUCCESSFLAG=(SELECT REPLACE(SUCCESSFLAG,'[CARD_NO]',CARD_NUMBER));
  SET SUCCESSFLAG=(SELECT REPLACE(SUCCESSFLAG,'[ACTCUSTNAME]',@CUSTNAME));
END IF;
IF SUCCESSFLAG IS NULL THEN
    SET CARD_UNIT_NO=(SELECT UNIT_NO FROM UNIT WHERE UNIT_ID=(SELECT UNIT_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=CARD_NUMBER));
    IF EXISTS(SELECT UASD_ACCESS_CARD FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=CARD_NUMBER AND UASD_ACCESS_ACTIVE='X')THEN
        IF EXISTS(SELECT UASD_ID FROM CUSTOMER_ACCESS_CARD_DETAILS WHERE UASD_ID=(SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=CARD_NUMBER)
        AND  ACN_ID IS NULL AND CACD_VALID_TILL IS NULL AND CACD_GUEST_CARD IS NOT NULL)THEN
            SET @INSERT_ACTIVE_GUEST=(SELECT CONCAT('INSERT INTO ',TEMP_ACCESS_CARD_STATUS,'(UNITNO,ACTIVE_ACCESS_CARD, ACCESS_COMMENTS)VALUES
            (',CARD_UNIT_NO,',(SELECT CONCAT((SELECT UASD_ACCESS_CARD FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_ACTIVE="X" AND
            UASD_ID=(SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=',CARD_NUMBER,')),"  ",
            (SELECT C.CUSTOMER_FIRST_NAME FROM CUSTOMER C,CUSTOMER_ACCESS_CARD_DETAILS CACD WHERE CACD.UASD_ID=(SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=',CARD_NUMBER,')
            AND (CACD.ACN_ID IS NULL AND CACD.CACD_VALID_TILL IS NULL)  AND C.CUSTOMER_ID=CACD.CUSTOMER_ID),"   ",
            (SELECT C.CUSTOMER_LAST_NAME FROM CUSTOMER C,CUSTOMER_ACCESS_CARD_DETAILS CACD WHERE CACD.UASD_ID=(SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=',CARD_NUMBER,')
            AND (CACD.ACN_ID IS NULL AND CACD.CACD_VALID_TILL IS NULL)  AND C.CUSTOMER_ID=CACD.CUSTOMER_ID),"  ","GUEST","(",
            (SELECT C.CUSTOMER_ID FROM CUSTOMER C,CUSTOMER_ACCESS_CARD_DETAILS CACD WHERE CACD.UASD_ID=(SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=',CARD_NUMBER,')
            AND (CACD.ACN_ID IS NULL AND CACD.CACD_VALID_TILL IS NULL)  AND C.CUSTOMER_ID=CACD.CUSTOMER_ID),")")),
            (SELECT CPD.CPD_COMMENTS FROM CUSTOMER_PERSONAL_DETAILS CPD,CUSTOMER_ACCESS_CARD_DETAILS CACD
            WHERE CACD.UASD_ID=(SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=',CARD_NUMBER,') AND CACD.CUSTOMER_ID=CPD.CUSTOMER_ID AND (CACD.ACN_ID!=4 OR CACD.CACD_VALID_TILL IS NULL)))'));
            PREPARE INSERT_ACTIVE_GUEST_STMT FROM @INSERT_ACTIVE_GUEST;
            EXECUTE INSERT_ACTIVE_GUEST_STMT;
        ELSE
            SET @INSERT_ACTIVE_ORGINAL_CUSTOMER=(SELECT CONCAT('INSERT INTO ',TEMP_ACCESS_CARD_STATUS,'(UNITNO,ACTIVE_ACCESS_CARD, ACCESS_COMMENTS)VALUES
            (',CARD_UNIT_NO,',(SELECT CONCAT((SELECT UASD_ACCESS_CARD FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_ACTIVE="X" AND
            UASD_ID=(SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=@CARDNO)),"  ",
            (SELECT C.CUSTOMER_FIRST_NAME FROM CUSTOMER C,CUSTOMER_ACCESS_CARD_DETAILS CACD WHERE CACD.UASD_ID=(SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=@CARDNO)
            AND (CACD.ACN_ID IS NULL AND CACD.CACD_VALID_TILL IS NULL)  AND C.CUSTOMER_ID=CACD.CUSTOMER_ID),"   ",
            (SELECT C.CUSTOMER_LAST_NAME FROM CUSTOMER C,CUSTOMER_ACCESS_CARD_DETAILS CACD WHERE CACD.UASD_ID=(SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=@CARDNO)
            AND (CACD.ACN_ID IS NULL AND CACD.CACD_VALID_TILL IS NULL)  AND C.CUSTOMER_ID=CACD.CUSTOMER_ID),"  ","(",
            (SELECT C.CUSTOMER_ID FROM CUSTOMER C,CUSTOMER_ACCESS_CARD_DETAILS CACD WHERE CACD.UASD_ID=(SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=@CARDNO)
            AND (CACD.ACN_ID IS NULL AND CACD.CACD_VALID_TILL IS NULL)  AND C.CUSTOMER_ID=CACD.CUSTOMER_ID),")")),
            (SELECT CPD.CPD_COMMENTS FROM CUSTOMER_PERSONAL_DETAILS CPD,CUSTOMER_ACCESS_CARD_DETAILS CACD
            WHERE CACD.UASD_ID=(SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=@CARDNO) AND CACD.CUSTOMER_ID=CPD.CUSTOMER_ID AND (CACD.ACN_ID!=4 OR CACD.CACD_VALID_TILL IS NULL)))'));
            PREPARE INSERT_ACTIVE_ORGINAL_CUSTOMER_STMT FROM @INSERT_ACTIVE_ORGINAL_CUSTOMER;
            EXECUTE INSERT_ACTIVE_ORGINAL_CUSTOMER_STMT;
        END IF;
    END IF;
    IF EXISTS(SELECT UASD_ACCESS_CARD FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=CARD_NUMBER AND UASD_ACCESS_INVENTORY='X')THEN
        SET @INSERT_INVENTORY=(SELECT CONCAT('INSERT INTO ',TEMP_ACCESS_CARD_STATUS,'(UNITNO,INVENTORY_ACCESS_CARD)VALUES
        (',CARD_UNIT_NO,',(SELECT UASD_ACCESS_CARD FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_INVENTORY="X" AND
        UASD_ID=(SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=',CARD_NUMBER,')))'));
        PREPARE INSERT_INVENTORY_STMT FROM @INSERT_INVENTORY;
        EXECUTE INSERT_INVENTORY_STMT;
    END IF;
    IF EXISTS(SELECT UASD_ACCESS_CARD FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=CARD_NUMBER AND UASD_ACCESS_LOST='X')THEN
        IF NOT EXISTS(SELECT UASD_ID FROM CUSTOMER_ACCESS_CARD_DETAILS WHERE ACN_ID IN (SELECT ACN_ID FROM ACCESS_CONFIGURATION WHERE ACN_ID!=4) AND UASD_ID=(SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=CARD_NUMBER))THEN
            SET @INSERT_LOST_EMPLOYEE_CARD=(SELECT CONCAT('INSERT INTO ',TEMP_ACCESS_CARD_STATUS,'(UNITNO,LOST_ACCESS_CARD)VALUES
            (',CARD_UNIT_NO,',(SELECT UASD_ACCESS_CARD FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_LOST="X" AND
            UASD_ID=(SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=',CARD_NUMBER,')))'));
            PREPARE INSERT_LOST_EMPLOYEE_CARD_STMT FROM  @INSERT_LOST_EMPLOYEE_CARD;
            EXECUTE INSERT_LOST_EMPLOYEE_CARD_STMT;
        ELSE
        IF EXISTS(SELECT UASD_ID FROM CUSTOMER_ACCESS_CARD_DETAILS WHERE ACN_ID IN (SELECT ACN_ID FROM ACCESS_CONFIGURATION WHERE ACN_ID!=4) AND UASD_ID=(SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=CARD_NUMBER) AND CACD_GUEST_CARD IS NOT NULL)THEN
            SET @INSERT_LOST_GUEST=(SELECT CONCAT('INSERT INTO ',TEMP_ACCESS_CARD_STATUS,'(UNITNO,LOST_ACCESS_CARD, ACCESS_REASON, ACCESS_COMMENTS)VALUES
            (',CARD_UNIT_NO,',(SELECT CONCAT((SELECT UASD_ACCESS_CARD FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_LOST="X" AND
            UASD_ID=(SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=',CARD_NUMBER,')),"  ",
            (SELECT C.CUSTOMER_FIRST_NAME FROM CUSTOMER C,CUSTOMER_ACCESS_CARD_DETAILS CACD WHERE CACD.UASD_ID=(SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=',CARD_NUMBER,')
            AND CACD.ACN_ID IN (SELECT ACN_ID FROM ACCESS_CONFIGURATION
            WHERE ACN_ID!=4) AND C.CUSTOMER_ID=CACD.CUSTOMER_ID),"  ",
            (SELECT C.CUSTOMER_LAST_NAME FROM CUSTOMER C,CUSTOMER_ACCESS_CARD_DETAILS CACD WHERE CACD.UASD_ID=(SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=',CARD_NUMBER,')
            AND CACD.ACN_ID IN (SELECT ACN_ID FROM ACCESS_CONFIGURATION
            WHERE ACN_ID!=4) AND C.CUSTOMER_ID=CACD.CUSTOMER_ID)," ","GUEST","(",
            (SELECT C.CUSTOMER_ID FROM CUSTOMER C,CUSTOMER_ACCESS_CARD_DETAILS CACD WHERE CACD.UASD_ID=(SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=',CARD_NUMBER,')
            AND CACD.ACN_ID IN (SELECT ACN_ID FROM ACCESS_CONFIGURATION
            WHERE ACN_ID!=4) AND C.CUSTOMER_ID=CACD.CUSTOMER_ID),")")),
            (SELECT AC.ACN_DATA FROM ACCESS_CONFIGURATION AC,CUSTOMER_ACCESS_CARD_DETAILS CACD
            WHERE UASD_ID =(SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=',CARD_NUMBER,') AND CACD.ACN_ID!=4 AND AC.ACN_ID=CACD.ACN_ID ),
            (SELECT CPD.CPD_COMMENTS FROM CUSTOMER_PERSONAL_DETAILS CPD,CUSTOMER_ACCESS_CARD_DETAILS CACD
            WHERE CACD.UASD_ID=(SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=',CARD_NUMBER,') AND CACD.CUSTOMER_ID=CPD.CUSTOMER_ID AND (CACD.ACN_ID!=4 OR CACD.CACD_VALID_TILL IS NULL)))'));
            PREPARE INSERT_LOST_GUEST_STMT FROM @INSERT_LOST_GUEST;
            EXECUTE INSERT_LOST_GUEST_STMT;
        ELSE
            SET @INSERT_LOST_ORIGINAL_CUSTOMER=(SELECT CONCAT('INSERT INTO ',TEMP_ACCESS_CARD_STATUS,'(UNITNO,LOST_ACCESS_CARD, ACCESS_REASON, ACCESS_COMMENTS)VALUES
            (',CARD_UNIT_NO,',(SELECT CONCAT((SELECT UASD_ACCESS_CARD FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_LOST="X" AND
            UASD_ID=(SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=',CARD_NUMBER,')),"  ",
            (SELECT C.CUSTOMER_FIRST_NAME FROM CUSTOMER C,CUSTOMER_ACCESS_CARD_DETAILS CACD WHERE CACD.UASD_ID=(SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=',CARD_NUMBER,')
            AND CACD.ACN_ID IN (SELECT ACN_ID FROM ACCESS_CONFIGURATION
            WHERE ACN_ID!=4) AND C.CUSTOMER_ID=CACD.CUSTOMER_ID),"  ",
            (SELECT C.CUSTOMER_LAST_NAME FROM CUSTOMER C,CUSTOMER_ACCESS_CARD_DETAILS CACD WHERE CACD.UASD_ID=(SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=',CARD_NUMBER,')
            AND CACD.ACN_ID IN (SELECT ACN_ID FROM ACCESS_CONFIGURATION
            WHERE ACN_ID!=4) AND C.CUSTOMER_ID=CACD.CUSTOMER_ID)," ","(",
            (SELECT C.CUSTOMER_ID FROM CUSTOMER C,CUSTOMER_ACCESS_CARD_DETAILS CACD WHERE CACD.UASD_ID=(SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=',CARD_NUMBER,')
            AND CACD.ACN_ID IN (SELECT ACN_ID FROM ACCESS_CONFIGURATION
            WHERE ACN_ID!=4) AND C.CUSTOMER_ID=CACD.CUSTOMER_ID),")")),
            (SELECT AC.ACN_DATA FROM ACCESS_CONFIGURATION AC,CUSTOMER_ACCESS_CARD_DETAILS CACD
            WHERE UASD_ID =(SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=',CARD_NUMBER,') AND CACD.ACN_ID!=4 AND AC.ACN_ID=CACD.ACN_ID ),
            (SELECT CPD.CPD_COMMENTS FROM CUSTOMER_PERSONAL_DETAILS CPD,CUSTOMER_ACCESS_CARD_DETAILS CACD
            WHERE CACD.UASD_ID=(SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=',CARD_NUMBER,') AND CACD.CUSTOMER_ID=CPD.CUSTOMER_ID AND (CACD.ACN_ID!=4 OR CACD.CACD_VALID_TILL IS NULL)))'));
            PREPARE INSERT_LOST_ORIGINAL_CUSTOMER_STMT FROM  @INSERT_LOST_ORIGINAL_CUSTOMER;
            EXECUTE INSERT_LOST_ORIGINAL_CUSTOMER_STMT;
        END IF;
        END IF;
    END IF;
    SET SUCCESSFLAG=1;
END IF;
SET @CUSTNAME=NULL;
SET @TEMP_CARD_COUNT=NULL;
SET @DROP_QUERY_TEMPCARD=(SELECT CONCAT('DROP TABLE IF EXISTS ',TEMP_CARD));
PREPARE DROP_QUERY_STMT FROM @DROP_QUERY_TEMPCARD;
EXECUTE DROP_QUERY_STMT;
COMMIT;
END;
