DROP PROCEDURE IF EXISTS SP_CUSTOMER_TERMINATION_VW;
CREATE PROCEDURE SP_CUSTOMER_TERMINATION_VW(IN FILENAME TEXT,
IN USERSTAMP VARCHAR(50),
OUT SUCCESS_MESSAGE TEXT)
BEGIN
	DECLARE FAILURE_ECN_DATA TEXT;
	DECLARE FAIL_ECNDATA TEXT;
	DECLARE SUCCESS_ECNDATA TEXT;
	DECLARE FAILURE_ECNDATA TEXT;
	DECLARE SUCCESSECNDATA TEXT;
	DECLARE FAILUREECNDATA TEXT;
	DECLARE PATCHFILENAME VARCHAR(100);
	DECLARE PHSTATUS TINYINT;
	DECLARE EXIT HANDLER FOR SQLEXCEPTION
	BEGIN 
	ROLLBACK;
		INSERT INTO PATCH_HISTORY(PO_ID,PH_FILE_NAME,PH_STATUS,ULD_ID) VALUES (5,FILENAME,0,(SELECT ULD_ID FROM USER_LOGIN_DETAILS WHERE ULD_LOGINID=USERSTAMP));
	END;
	SET AUTOCOMMIT = 0;
	START TRANSACTION;
	SET FOREIGN_KEY_CHECKS = 0;
	SET SUCCESS_ECNDATA =  (SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=469);
	SET FAILURE_ECNDATA =  (SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=470);
	SET FAILURE_ECN_DATA = (SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=473);
	SET SUCCESSECNDATA = (SELECT REPLACE(SUCCESS_ECNDATA,'[FILENAME]',FILENAME));
	SET FAILUREECNDATA = (SELECT REPLACE(FAILURE_ECNDATA,'[FILENAME]',FILENAME));
	SET FAIL_ECNDATA = (SELECT REPLACE(FAILURE_ECN_DATA,'[FILENAME]',FILENAME));
	IF EXISTS(SELECT PH_FILE_NAME FROM PATCH_HISTORY WHERE PH_FILE_NAME = FILENAME AND PH_STATUS = 1) THEN
		SET SUCCESS_MESSAGE = FAILUREECNDATA;
	END IF;
	SET PATCHFILENAME = (SELECT PH_FILE_NAME FROM PATCH_HISTORY WHERE PH_FILE_NAME = FILENAME);
	SET PHSTATUS = (SELECT PH_STATUS FROM PATCH_HISTORY WHERE PH_FILE_NAME = FILENAME AND PH_STATUS = 0);
	IF ((PATCHFILENAME IS NOT NULL) AND (PHSTATUS = 0)) OR (PATCHFILENAME IS NULL)THEN	
	CREATE OR REPLACE VIEW VW_TERMINATION_ACTIVE_CUSTOMER AS
	SELECT C1.CUSTOMER_ID AS CUSTOMERID,CONCAT(CUSTOMER_FIRST_NAME,'_',CUSTOMER_LAST_NAME)AS CUSTOMERNAME,C.CED_REC_VER,C.CLP_STARTDATE,C.CLP_ENDDATE,C.CLP_PRETERMINATE_DATE,U.UNIT_NO  
	FROM UNIT U,CUSTOMER C1,CUSTOMER_LP_DETAILS C,CUSTOMER_ENTRY_DETAILS C2,VW_SUB_TERMINATION_ACTIVE_CUSTOMER T WHERE C.CUSTOMER_ID = T.CUSTOMERID
	AND C.CLP_TERMINATE IS NULL AND U.UNIT_ID=C2.UNIT_ID AND C.CLP_STARTDATE<=CURDATE() AND if (C.CLP_PRETERMINATE_DATE IS NOT NULL ,C.CLP_PRETERMINATE_DATE>CURDATE(),C.CLP_ENDDATE>CURDATE())AND C.CUSTOMER_ID=C1.CUSTOMER_ID AND
	C1.CUSTOMER_ID=T.CUSTOMERID  AND C.CLP_GUEST_CARD IS NULL AND C.CUSTOMER_ID=C2.CUSTOMER_ID AND C2.CED_CANCEL_DATE IS NULL AND C.CED_REC_VER=C2.CED_REC_VER AND T.CUSTOMERID=C2.CUSTOMER_ID GROUP BY C.CUSTOMER_ID;
		INSERT INTO PATCH_HISTORY(PO_ID,PH_FILE_NAME,PH_STATUS,ULD_ID) VALUES (5,FILENAME,1,(SELECT ULD_ID FROM USER_LOGIN_DETAILS WHERE ULD_LOGINID=USERSTAMP));
		SET SUCCESS_MESSAGE = SUCCESSECNDATA;
		SET FOREIGN_KEY_CHECKS = 1;
	END IF;
	COMMIT;
END;
CALL SP_CUSTOMER_TERMINATION_VW(FILENAME,USERSTAMP,@SUCCESS_MESSAGE);