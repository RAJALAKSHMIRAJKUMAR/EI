DROP PROCEDURE IF EXISTS SP_TICKLER_HISTORY_SEQUENCE_AUTO_INCREMENT_UPDATE;
CREATE PROCEDURE SP_TICKLER_HISTORY_SEQUENCE_AUTO_INCREMENT_UPDATE(
IN FILENAME TEXT,
IN USERSTAMP VARCHAR(50),
OUT SUCCESS_MESSAGE TEXT)
BEGIN
	DECLARE FAILURE_ECN_DATA TEXT;
	DECLARE FAIL_ECNDATA TEXT;
	DECLARE SUCCESS_ECNDATA TEXT;
	DECLARE FAILURE_ECNDATA TEXT;
	DECLARE SUCCESSECNDATA TEXT;
	DECLARE FAILUREECNDATA TEXT;
	DECLARE PATCHFILENAME VARCHAR(100);
	DECLARE PHSTATUS TINYINT;
	DECLARE MINID INTEGER;
	DECLARE MAXID INTEGER;
	DECLARE MIN_ID INTEGER;
	DECLARE MAX_ID INTEGER;
	DECLARE OLD_TICK_ID INTEGER;
	DECLARE NEW_TICK_ID INTEGER;	
	DECLARE MAXIMUM_ID INTEGER;
	DECLARE EXIT HANDLER FOR SQLEXCEPTION
	BEGIN 
		ROLLBACK;
		DROP TABLE IF EXISTS TEMP_ALL_DOMAIN_TICKLER_HISTORY;
		INSERT INTO PATCH_HISTORY(PO_ID,PH_FILE_NAME,PH_STATUS,ULD_ID) VALUES (10,FILENAME,0,(SELECT ULD_ID 
		FROM USER_LOGIN_DETAILS WHERE ULD_LOGINID=USERSTAMP));
	END;
	SET AUTOCOMMIT = 0;
 	START TRANSACTION;
	SET SUCCESS_ECNDATA =  (SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=469);
	SET FAILURE_ECNDATA =  (SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=470);
	SET FAILURE_ECN_DATA = (SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=473);
	SET SUCCESSECNDATA = (SELECT REPLACE(SUCCESS_ECNDATA,'[FILENAME]',FILENAME));
	SET FAILUREECNDATA = (SELECT REPLACE(FAILURE_ECNDATA,'[FILENAME]',FILENAME));
	SET FAIL_ECNDATA = (SELECT REPLACE(FAILURE_ECN_DATA,'[FILENAME]',FILENAME));
	IF EXISTS(SELECT PH_FILE_NAME FROM PATCH_HISTORY WHERE PH_FILE_NAME = FILENAME AND PH_STATUS = 1) THEN
		SET SUCCESS_MESSAGE = FAILUREECNDATA;
	END IF;
	SET PATCHFILENAME = (SELECT PH_FILE_NAME FROM PATCH_HISTORY WHERE PH_FILE_NAME = FILENAME);
	SET PHSTATUS = (SELECT PH_STATUS FROM PATCH_HISTORY WHERE PH_FILE_NAME = FILENAME AND PH_STATUS = 0);	
	IF ((PATCHFILENAME IS NOT NULL) AND (PHSTATUS = 0)) OR (PATCHFILENAME IS NULL)THEN	
		DROP TABLE IF EXISTS TEMP_ALL_DOMAIN_TICKLER_HISTORY;
		CREATE TABLE TEMP_ALL_DOMAIN_TICKLER_HISTORY(
		ID INTEGER AUTO_INCREMENT,
		OLD_TH_ID INTEGER,
		NEW_TH_ID INTEGER,
		PRIMARY KEY(ID));
		INSERT INTO TEMP_ALL_DOMAIN_TICKLER_HISTORY (OLD_TH_ID) SELECT TH_ID FROM TICKLER_HISTORY ORDER BY 
		TH_ID ASC;
		SET MINID = (SELECT MIN(ID) FROM TEMP_ALL_DOMAIN_TICKLER_HISTORY);
		SET MAXID = (SELECT MAX(ID) FROM TEMP_ALL_DOMAIN_TICKLER_HISTORY);
		SET MIN_ID = (SELECT MIN(ID) FROM TEMP_ALL_DOMAIN_TICKLER_HISTORY);
		SET MAX_ID = (SELECT MAX(ID) FROM TEMP_ALL_DOMAIN_TICKLER_HISTORY);
		WHILE(MINID <= MAXID) DO 
			UPDATE TEMP_ALL_DOMAIN_TICKLER_HISTORY SET NEW_TH_ID = MINID WHERE ID = MINID;
			SET MINID = MINID+1;
		END WHILE;
		WHILE(MIN_ID <= MAX_ID) DO 
			SET OLD_TICK_ID = (SELECT OLD_TH_ID FROM TEMP_ALL_DOMAIN_TICKLER_HISTORY WHERE ID = MIN_ID);
			SET NEW_TICK_ID = (SELECT NEW_TH_ID FROM TEMP_ALL_DOMAIN_TICKLER_HISTORY WHERE ID = MIN_ID);
			UPDATE TICKLER_HISTORY SET TH_ID = NEW_TICK_ID , TH_TIMESTAMP = TH_TIMESTAMP WHERE TH_ID = OLD_TICK_ID;
			SET MIN_ID = MIN_ID+1;
		END WHILE;	
		SET @MAXIMUMID = (SELECT CONCAT('SELECT MAX(TH_ID) INTO @MAXI_ID FROM TICKLER_HISTORY'));
		PREPARE MAXIMUMID_STMT FROM @MAXIMUMID;
		EXECUTE MAXIMUMID_STMT;
		SET MAXIMUM_ID = @MAXI_ID;
		SET @ALTERQUERY = (SELECT CONCAT('ALTER TABLE TICKLER_HISTORY  AUTO_INCREMENT = ',MAXIMUM_ID,''));
		PREPARE ALTERQUERY_STMT FROM @ALTERQUERY;
		EXECUTE ALTERQUERY_STMT;
		UPDATE TICKLER_HISTORY SET TP_ID=1,TH_TIMESTAMP=TH_TIMESTAMP WHERE TH_ID BETWEEN 190 AND 221;
		INSERT INTO PATCH_HISTORY(PO_ID,PH_FILE_NAME,PH_STATUS,ULD_ID) VALUES (10,FILENAME,1,(SELECT ULD_ID 
		FROM USER_LOGIN_DETAILS WHERE ULD_LOGINID=USERSTAMP));
		SET SUCCESS_MESSAGE = SUCCESSECNDATA;	
	END IF;
	DROP TABLE IF EXISTS TEMP_ALL_DOMAIN_TICKLER_HISTORY;
	COMMIT;
END;
CALL SP_TICKLER_HISTORY_SEQUENCE_AUTO_INCREMENT_UPDATE(FILENAME,USERSTAMP,@SUCCESS_MESSAGE);