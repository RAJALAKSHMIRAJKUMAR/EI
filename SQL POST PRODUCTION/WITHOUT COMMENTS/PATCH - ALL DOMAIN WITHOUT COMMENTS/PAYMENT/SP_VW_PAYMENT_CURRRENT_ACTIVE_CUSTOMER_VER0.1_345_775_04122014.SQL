DROP PROCEDURE IF EXISTS SP_VW_PAYMENT_CURRENT_ACTIVE_CUSTOMER;
CREATE PROCEDURE SP_VW_PAYMENT_CURRENT_ACTIVE_CUSTOMER(
IN FILENAME TEXT,
IN USERSTAMP VARCHAR(50),
OUT SUCCESS_MESSAGE TEXT)
BEGIN
	DECLARE SUCCESS_ECNDATA TEXT;
	DECLARE SUCCESSECNDATA TEXT;
	DECLARE FAILURE_ECNDATA TEXT;
	DECLARE FAILUREECNDATA TEXT;
	DECLARE FAILURE_ECN_DATA TEXT;
	DECLARE FAIL_ECNDATA TEXT;
	DECLARE PATCHFILENAME VARCHAR(100);
	DECLARE PHSTATUS TINYINT;
	DECLARE EXIT HANDLER FOR SQLEXCEPTION
	BEGIN
		ROLLBACK;
		INSERT INTO PATCH_HISTORY(PO_ID,PH_FILE_NAME,PH_STATUS,ULD_ID) VALUES (7,FILENAME,0,(SELECT ULD_ID FROM USER_LOGIN_DETAILS WHERE ULD_LOGINID=USERSTAMP));
		SET SUCCESS_MESSAGE=FAIL_ECNDATA;
	END;
	SET AUTOCOMMIT=0;
	START TRANSACTION;
	SET FOREIGN_KEY_CHECKS=0;
	SET SUCCESS_ECNDATA=(SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=469);
	SET FAILURE_ECNDATA=(SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=470);
	SET FAILURE_ECN_DATA=(SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=473);
	SET SUCCESSECNDATA=(SELECT REPLACE(SUCCESS_ECNDATA,'[FILENAME]',FILENAME));
	SET FAILUREECNDATA=(SELECT REPLACE(FAILURE_ECNDATA,'[FILENAME]',FILENAME));
	SET FAIL_ECNDATA=(SELECT REPLACE(FAILURE_ECN_DATA,'[FILENAME]',FILENAME));
	IF EXISTS(SELECT PH_FILE_NAME FROM PATCH_HISTORY WHERE PH_FILE_NAME=FILENAME AND PH_STATUS=1)THEN
		SET SUCCESS_MESSAGE=FAILUREECNDATA;
	END IF;
	SET PATCHFILENAME=(SELECT PH_FILE_NAME FROM PATCH_HISTORY WHERE PH_FILE_NAME=FILENAME);
	SET PHSTATUS=(SELECT PH_STATUS FROM PATCH_HISTORY WHERE PH_FILE_NAME=FILENAME AND PH_STATUS=0);
	IF ((PATCHFILENAME IS NOT NULL) AND (PHSTATUS=0)) OR (PATCHFILENAME IS NULL)THEN
		CREATE OR REPLACE VIEW VW_SUB_ACTIVE_CUSTOMER_LIST AS
		SELECT C1.CUSTOMER_ID ,CONCAT(CUSTOMER_FIRST_NAME,'_',CUSTOMER_LAST_NAME)AS CUSTOMERNAME ,U.UNIT_NO,U.UNIT_ID,C.CED_REC_VER
		FROM CUSTOMER C1 JOIN CUSTOMER_LP_DETAILS C JOIN CUSTOMER_ENTRY_DETAILS C2,UNIT U  WHERE
		 C.CLP_TERMINATE IS NULL AND (C.CLP_STARTDATE<=CURDATE() OR C.CLP_STARTDATE>CURDATE()) AND IF (C.CLP_PRETERMINATE_DATE IS NOT NULL ,C.CLP_PRETERMINATE_DATE>CURDATE(),C.CLP_ENDDATE>CURDATE())AND C.CUSTOMER_ID=C1.CUSTOMER_ID AND
		C.CLP_GUEST_CARD IS NULL AND C.CUSTOMER_ID=C2.CUSTOMER_ID AND C2.CED_CANCEL_DATE IS NULL AND C.CED_REC_VER=C2.CED_REC_VER AND U.UNIT_ID=C2.UNIT_ID GROUP BY C.CUSTOMER_ID;
		CREATE OR REPLACE VIEW VW_CURRENT_ACTIVE_CUSTOMER AS
		SELECT C.CUSTOMER_ID,C.CUSTOMER_FIRST_NAME,C.CUSTOMER_LAST_NAME,CONCAT(CUSTOMER_FIRST_NAME,' ',CUSTOMER_LAST_NAME)AS CUSTOMERNAME ,CED.CED_REC_VER,U.UNIT_NO,CTD.CLP_STARTDATE,CTD.CLP_ENDDATE,CTD.CLP_PRETERMINATE_DATE,
		CED.CED_PRETERMINATE,CPD.CPD_EMAIL FROM CUSTOMER_ENTRY_DETAILS CED,CUSTOMER_LP_DETAILS CTD,CUSTOMER C,UNIT U,VW_SUB_ACTIVE_CUSTOMER_LIST V,CUSTOMER_PERSONAL_DETAILS CPD WHERE
		C.CUSTOMER_ID=CED.CUSTOMER_ID AND C.CUSTOMER_ID=CTD.CUSTOMER_ID AND C.CUSTOMER_ID=V.CUSTOMER_ID AND U.UNIT_ID=CED.UNIT_ID AND CTD.CUSTOMER_ID=CED.CUSTOMER_ID AND
		 CTD.CUSTOMER_ID=V.CUSTOMER_ID AND  CED.CUSTOMER_ID=V.CUSTOMER_ID AND   CTD.CLP_GUEST_CARD IS NULL AND C.CUSTOMER_ID=CPD.CUSTOMER_ID AND
		CED.CED_REC_VER=CTD.CED_REC_VER AND CPD.CUSTOMER_ID=CTD.CUSTOMER_ID AND CPD.CUSTOMER_ID=CED.CUSTOMER_ID AND  V.CUSTOMER_ID=CPD.CUSTOMER_ID AND CTD.CLP_TERMINATE IS NULL
		 AND IF(CTD.CLP_PRETERMINATE_DATE IS NOT NULL,CTD.CLP_STARTDATE<CTD.CLP_PRETERMINATE_DATE,CTD.CLP_STARTDATE<CTD.CLP_ENDDATE)AND CED.CED_CANCEL_DATE IS NULL;
		 CREATE OR REPLACE VIEW VW_SUB_PAYMENT_ACTIVE_CUSTOMER_LIST AS
		SELECT C1.CUSTOMER_ID ,CONCAT(CUSTOMER_FIRST_NAME,'_',CUSTOMER_LAST_NAME)AS CUSTOMERNAME ,U.UNIT_NO,U.UNIT_ID,C.CED_REC_VER
		FROM CUSTOMER C1 JOIN CUSTOMER_LP_DETAILS C JOIN CUSTOMER_ENTRY_DETAILS C2,UNIT U  WHERE
		 C.CLP_TERMINATE IS NULL AND (C.CLP_STARTDATE<=CURDATE() OR C.CLP_STARTDATE>CURDATE()) AND if (C.CLP_PRETERMINATE_DATE IS NOT NULL ,C.CLP_PRETERMINATE_DATE>CURDATE(),C.CLP_ENDDATE>CURDATE())AND C.CUSTOMER_ID=C1.CUSTOMER_ID AND
		C.CLP_GUEST_CARD IS NULL AND C.CUSTOMER_ID=C2.CUSTOMER_ID AND C2.CED_CANCEL_DATE IS NULL AND C.CED_REC_VER=C2.CED_REC_VER AND U.UNIT_ID=C2.UNIT_ID;
		CREATE OR REPLACE VIEW VW_PAYMENT_CURRENT_ACTIVE_CUSTOMER AS
		SELECT C.CUSTOMER_ID,C.CUSTOMER_FIRST_NAME,C.CUSTOMER_LAST_NAME,CONCAT(CUSTOMER_FIRST_NAME,' ',CUSTOMER_LAST_NAME)AS CUSTOMERNAME ,CED.CED_REC_VER,U.UNIT_NO,CTD.CLP_STARTDATE,CTD.CLP_ENDDATE,CTD.CLP_PRETERMINATE_DATE,
		CED.CED_PRETERMINATE,CFD.CFD_AMOUNT AS PAYMENT,CPD.CPD_EMAIL FROM CUSTOMER_ENTRY_DETAILS CED,CUSTOMER_LP_DETAILS CTD,CUSTOMER C,UNIT U,CUSTOMER_FEE_DETAILS CFD,VW_SUB_PAYMENT_ACTIVE_CUSTOMER_LIST V,CUSTOMER_PERSONAL_DETAILS CPD WHERE
		C.CUSTOMER_ID=CED.CUSTOMER_ID AND C.CUSTOMER_ID=CTD.CUSTOMER_ID AND C.CUSTOMER_ID=CFD.CUSTOMER_ID AND C.CUSTOMER_ID=V.CUSTOMER_ID AND U.UNIT_ID=CED.UNIT_ID AND CTD.CUSTOMER_ID=CED.CUSTOMER_ID AND
		CTD.CUSTOMER_ID=CFD.CUSTOMER_ID AND CTD.CUSTOMER_ID=V.CUSTOMER_ID AND CED.CUSTOMER_ID=CFD.CUSTOMER_ID AND CED.CUSTOMER_ID=V.CUSTOMER_ID AND CFD.CUSTOMER_ID=CTD.CUSTOMER_ID AND CFD.CUSTOMER_ID=CED.CUSTOMER_ID AND CTD.CLP_GUEST_CARD IS NULL AND C.CUSTOMER_ID=CPD.CUSTOMER_ID AND
		CPD.CUSTOMER_ID=CTD.CUSTOMER_ID AND CPD.CUSTOMER_ID=CED.CUSTOMER_ID AND CFD.CUSTOMER_ID=CPD.CUSTOMER_ID AND V.CUSTOMER_ID=CPD.CUSTOMER_ID AND CFD.CPP_ID=1 AND CFD.CED_REC_VER=CTD.CED_REC_VER AND CFD.CED_REC_VER=CED.CED_REC_VER AND IF(CTD.CLP_PRETERMINATE_DATE IS NOT NULL,
		CTD.CLP_STARTDATE<CTD.CLP_PRETERMINATE_DATE,CTD.CLP_STARTDATE<CTD.CLP_ENDDATE) AND CPD.CUSTOMER_ID=C.CUSTOMER_ID AND CED.CED_CANCEL_DATE IS NULL AND (V.UNIT_ID=CED.UNIT_ID OR CED.CED_REC_VER>V.CED_REC_VER)GROUP BY CTD.CUSTOMER_ID,CTD.CED_REC_VER;
	END IF;
	INSERT INTO PATCH_HISTORY(PO_ID,PH_FILE_NAME,PH_STATUS,ULD_ID) VALUES (7,FILENAME,1,(SELECT ULD_ID FROM USER_LOGIN_DETAILS WHERE ULD_LOGINID=USERSTAMP));
	SET SUCCESS_MESSAGE = SUCCESSECNDATA;
	SET FOREIGN_KEY_CHECKS = 1;
	COMMIT;
END;
CALL  SP_VW_PAYMENT_CURRENT_ACTIVE_CUSTOMER(FILENAME,USERSTAMP,@SUCCESS_MESSAGE);