-- version 0.8 --sadte:07/08/2014 --edate:07/08/2014 --issue:835 --commentno:49 --desc:implementing auto commit n removed commit --done by : RL
--version 0.7 --sdate:17/07/2014 --edate:17/07/2014 --desc: contact no datatype BIGINT(15) changed as VARCHAR(20) --doneby:kumar	
--version 0.6 --sdate:28/02/2014 --edate:28/02/2014 --issue:754 --comment:36 --doneby:RL	
--version 0.5 --sdate:27/02/2014 --edate:27/02/2014 --issue:754 --comment:22 --doneby:RL	
-->version 0.4 -->startdate:18/02/2014 endate:18/02/2014 -->issue no:749 comment no:#46 desc:Implementation of flag for success message and check the updation done by:Bhavani.R
--version 0.3-->startdate:09/11/2013 enddate:09/11/2013 -->issue no:636 comment no:#47 desc:changed sp name and file name done by:DHIVYA.A
--> version 0.2 -->startdate:11/10/2013  enddate:11/10/2013-->issueno:636 -->desc:added comments
-->doneby:DHIVYA.A
---version 0.1 issue no:627 start date:21/09/2013 and end date:23/09/2013 desc:sp for ERM_UPDATION done by:DHIVYA.A

DROP PROCEDURE IF EXISTS SP_ERM_INSERT;
CREATE PROCEDURE SP_ERM_INSERT(
CUSTOMERNAME VARCHAR(40),
RENT DECIMAL(7,2),
MOVINGDATE DATE,
MINSTAY VARCHAR(10),
ERMODATA VARCHAR(40),
NCDATA TEXT,
NOOFGUESTS VARCHAR(10),
AGE VARCHAR(10),
CONTACTNO VARCHAR(20),
EMAILID VARCHAR(40),
COMMENTS TEXT,
USERSTAMP VARCHAR(50),
OUT ERM_SUCCESSFLAG INTEGER)
BEGIN
	DECLARE USERSTAMP_ID INTEGER(2);
	DECLARE EXIT HANDLER FOR SQLEXCEPTION
	BEGIN 
		ROLLBACK;
		SET ERM_SUCCESSFLAG=0;
	END;
	SET AUTOCOMMIT = 0;
	START TRANSACTION;
	SET ERM_SUCCESSFLAG=0;
	CALL SP_CHANGE_USERSTAMP_AS_ULDID(USERSTAMP,@ULDID);
	SET USERSTAMP_ID = (SELECT @ULDID);
	IF (CUSTOMERNAME IS NOT NULL AND RENT IS NOT NULL AND MOVINGDATE IS NOT NULL AND MINSTAY IS NOT NULL AND ERMODATA IS NOT NULL AND COMMENTS IS NOT NULL AND USERSTAMP IS NOT NULL)THEN
		IF NOT EXISTS(SELECT ERMO_DATA FROM ERM_OCCUPATION_DETAILS WHERE ERMO_DATA=ERMODATA)THEN
			INSERT INTO ERM_OCCUPATION_DETAILS(ERMO_DATA,ULD_ID)VALUES(ERMODATA,USERSTAMP_ID);
			SET ERM_SUCCESSFLAG=1;
		END IF;
		INSERT INTO ERM_ENTRY_DETAILS(ERM_CUST_NAME,ERM_RENT,ERM_MOVING_DATE,ERM_MIN_STAY,ERMO_ID,NC_ID,ERM_NO_OF_GUESTS,ERM_AGE,ERM_CONTACT_NO,ERM_EMAIL_ID,ERM_COMMENTS,ULD_ID)VALUES(CUSTOMERNAME,RENT,
		MOVINGDATE,MINSTAY,(SELECT ERMO_ID FROM ERM_OCCUPATION_DETAILS WHERE ERMO_DATA=ERMODATA),(SELECT NC_ID FROM NATIONALITY_CONFIGURATION WHERE NC_DATA=NCDATA),
		NOOFGUESTS,AGE,CONTACTNO,EMAILID,COMMENTS,USERSTAMP_ID);
		SET ERM_SUCCESSFLAG=1;
	END IF;
END;