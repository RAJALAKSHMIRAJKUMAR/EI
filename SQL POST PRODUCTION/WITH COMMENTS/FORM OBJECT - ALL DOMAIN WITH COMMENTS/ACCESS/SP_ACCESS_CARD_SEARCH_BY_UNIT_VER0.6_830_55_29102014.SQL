-- VERSION 0.6 STARTDATE:25/10/2014 ENDDATE:29/10/2014 ISSUE NO:830 COMMENT NO:55 DESC:ADDED UNITNO IN ERRORMSG,IF ALL DATA INSERTED CORRECTLY MEANS FLAG LL RETURN 1. IF ANY ISSUE MEANS FLAG LL RETURN ERRORMSG & TABLE LL TRUNCATE. DONE BY :DHIVYA
-- VER 0.5 STARTDATE:04/07/2014 ENDDATE:04/07/2014 ISSUE NO:303 COMMENT NO:416 DESC:CHANGING HADRCODED CONFIGURATION DATA INTO ID DONEBY:BHAVANI.R
-- version 0.4-->startdate:21/06/2014 enDdate:21/06/2014---issue no:817--desc:dropped temp table if rollback occur
-- VER 0.3 STARTDATE:09/06/2014 ENDDATE:09/06/2014 ISSUE NO:566 COMMENT NO:12 DESC:ADDED ROLLBACK AND COMMIT BY:SASIKALA
-- VER 0.2 STARTDATE:03/06/2014 ENDDATE:04/06/2014 ISSUE NO:817 COMMENT NO:132 DESC:SPLITTED INTO THREE PARTS DONE BY:DHIVYA.A
-- VER 0.1 STARTDATE:21/05/2014 ENDDATE:24/05/2014 ISSUE NO:807 DESC:ADDED TERMINATED CUSTOMER CARD DONE BY:DHIVYA.A


DROP PROCEDURE IF EXISTS SP_ACCESS_CARD_SEARCH_BY_UNIT;
CREATE PROCEDURE SP_ACCESS_CARD_SEARCH_BY_UNIT(UNIT_NUMBER INTEGER,USERSTAMP VARCHAR(50),OUT TEMPACCESSUNIT TEXT,OUT ACCESSSEARCHSUCCESSMSG TEXT)
BEGIN
DECLARE MINID INTEGER;
DECLARE MAXID INTEGER;
DECLARE MINTERMID INTEGER;
DECLARE MAXTERMID INTEGER;
DECLARE ACCESSCARD INTEGER;
DECLARE CUSTOMERNAME VARCHAR(60);
DECLARE CUSTID INTEGER;
DECLARE GUESTCARD CHAR(1);
DECLARE CUSTOMERLOSTCARD TEXT;
DECLARE MIN_TERM_ID INTEGER;
DECLARE MAX_TERM_ID INTEGER;
DECLARE TEMP_TERMINATED_CARD TEXT;
DECLARE D_TEMP_TERMINATED_CARD TEXT;
DECLARE USERSTAMP_ID INTEGER;
DECLARE EXIT HANDLER FOR SQLEXCEPTION
BEGIN
ROLLBACK;
IF TEMP_TERMINATED_CARD IS NOT NULL THEN
SET @DR_TEMP_TERM_CARD=(SELECT CONCAT('DROP TABLE IF EXISTS ',TEMP_TERMINATED_CARD));
PREPARE DR_TEMP_TERM_CARD_STMT FROM @DR_TEMP_TERM_CARD;
EXECUTE DR_TEMP_TERM_CARD_STMT;
END IF;
IF ACCESSSEARCHSUCCESSMSG!=' ' THEN
SET @TRUNCATE_TEMPACCESS=(SELECT CONCAT('TRUNCATE ',TEMPACCESSUNIT));
PREPARE TRUNCATE_TEMPACCESS_STMT FROM @TRUNCATE_TEMPACCESS;
EXECUTE TRUNCATE_TEMPACCESS_STMT;
END IF;
END;
CALL SP_CHANGE_USERSTAMP_AS_ULDID(USERSTAMP,@ULDID);
SET USERSTAMP_ID=(SELECT @ULDID);
CALL SP_SUB_ACCESS_CARD_SEARCH_BY_UNIT(UNIT_NUMBER,USERSTAMP,@TEMP_ACCESS_UNIT,@ACCESS_SEARCH_SUCCESSMSG);
SET ACCESSSEARCHSUCCESSMSG=(SELECT @ACCESS_SEARCH_SUCCESSMSG);
SET TEMPACCESSUNIT=(SELECT @TEMP_ACCESS_UNIT);
IF ACCESSSEARCHSUCCESSMSG=' ' THEN
IF LENGTH(ACCESSSEARCHSUCCESSMSG)=1 AND (ACCESSSEARCHSUCCESSMSG!=0)THEN
SET D_TEMP_TERMINATED_CARD=(SELECT CONCAT('TEMP_TERMINATED_CARD','_',SYSDATE()));
SET D_TEMP_TERMINATED_CARD=(SELECT REPLACE(D_TEMP_TERMINATED_CARD,' ',''));
SET D_TEMP_TERMINATED_CARD=(SELECT REPLACE(D_TEMP_TERMINATED_CARD,'-',''));
SET D_TEMP_TERMINATED_CARD=(SELECT REPLACE(D_TEMP_TERMINATED_CARD,':',''));
SET TEMP_TERMINATED_CARD=(SELECT CONCAT(D_TEMP_TERMINATED_CARD,'_',USERSTAMP_ID));
SET @DR_TEMP_TERM_CARD=(SELECT CONCAT('DROP TABLE IF EXISTS ',TEMP_TERMINATED_CARD));
PREPARE DR_TEMP_TERM_CARD_STMT FROM @DR_TEMP_TERM_CARD;
EXECUTE DR_TEMP_TERM_CARD_STMT;
SET @CR_TEMP_TERM_CARD=(SELECT CONCAT('CREATE TABLE ',TEMP_TERMINATED_CARD,'(ID INTEGER NOT NULL AUTO_INCREMENT PRIMARY KEY,CUSTOMERID INTEGER,CARDNO INTEGER,GUESTFLAG CHAR(1))'));
PREPARE CR_TEMP_TERM_CARD_STMT FROM @CR_TEMP_TERM_CARD;
EXECUTE CR_TEMP_TERM_CARD_STMT;
SET @IN_TERMINATE_CARD=(SELECT CONCAT('INSERT INTO ',TEMP_TERMINATED_CARD,'(CUSTOMERID,CARDNO,GUESTFLAG)SELECT CUSTOMER_ID,UASD_ID,CACD_GUEST_CARD FROM CUSTOMER_ACCESS_CARD_DETAILS WHERE UASD_ID IN (SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UNIT_ID=(SELECT UNIT_ID FROM UNIT WHERE UNIT_NO=',UNIT_NUMBER,')) AND ACN_ID=4'));
PREPARE IN_TERMINATE_CARD_STMT FROM @IN_TERMINATE_CARD;
EXECUTE IN_TERMINATE_CARD_STMT;
SET @SET_MINID=(SELECT CONCAT('SELECT MIN(ID) INTO @MIN_ID FROM ',TEMPACCESSUNIT,' WHERE CUSTOMER_OLD_CARD IS NULL'));
PREPARE SET_MINID_STMT FROM @SET_MINID;
EXECUTE SET_MINID_STMT;
SET MINID=@MIN_ID;
IF MINID IS NULL THEN
SET MINID=0;
END IF;
SET @SET_MAXID=(SELECT CONCAT('SELECT MAX(ID) INTO @MAX_ID FROM ',TEMPACCESSUNIT,' WHERE CUSTOMER_OLD_CARD IS NULL'));
PREPARE SET_MAXID_STMT FROM @SET_MAXID;
EXECUTE SET_MAXID_STMT;
SET MAXID=@MAX_ID;
IF MAXID IS NULL THEN
SET MAXID=0;
END IF;
SET MIN_TERM_ID=MINID;
SET MAX_TERM_ID=MAXID;
SET @SETMINTERMID=(SELECT CONCAT('SELECT MIN(ID) INTO @MIN_TE_ID FROM ',TEMP_TERMINATED_CARD));
PREPARE SETMINTERMIDSTMT FROM @SETMINTERMID;
EXECUTE SETMINTERMIDSTMT;
SET MINTERMID=@MIN_TE_ID;
SET @SETMAXTERMID=(SELECT CONCAT('SELECT MAX(ID) INTO @MAX_TE_ID FROM ',TEMP_TERMINATED_CARD));
PREPARE SETMAXTERMIDSTMT FROM @SETMAXTERMID;
EXECUTE SETMAXTERMIDSTMT;
SET MAXTERMID=@MAX_TE_ID;
IF MINID!=0 AND MAXID!=0 THEN
	WHILE MINTERMID<=MAXTERMID DO
		SET @SETACCESSCARD=(SELECT CONCAT('SELECT UASD_ACCESS_CARD INTO @AC_CARD FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ID=(SELECT CARDNO FROM ',TEMP_TERMINATED_CARD,' WHERE ID=',MINTERMID,')'));
		PREPARE SETACCESSCARDSTMT FROM @SETACCESSCARD;
		EXECUTE SETACCESSCARDSTMT;
		SET ACCESSCARD=@AC_CARD;
		SET @SETCUSTID=(SELECT CONCAT('SELECT CUSTOMERID INTO @CUST_ID FROM ',TEMP_TERMINATED_CARD,' WHERE ID=',MINTERMID));
		PREPARE SETCUSTIDSTMT FROM @SETCUSTID;
		EXECUTE SETCUSTIDSTMT;
		SET CUSTID=@CUST_ID;
		SET @SETCUSTOMERNAME=(SELECT CONCAT('SELECT CONCAT(CUSTOMER_FIRST_NAME," ",CUSTOMER_LAST_NAME) INTO @CUST_NAME FROM CUSTOMER WHERE CUSTOMER_ID=',CUSTID));
		PREPARE SETCUSTOMERNAMESTMT FROM @SETCUSTOMERNAME;
		EXECUTE SETCUSTOMERNAMESTMT;
		SET CUSTOMERNAME=@CUST_NAME;
		SET @SETGUESTCARD=(SELECT CONCAT('SELECT GUESTFLAG INTO @GUEST_CARD FROM ',TEMP_TERMINATED_CARD,' WHERE ID=',MINTERMID));
		PREPARE SETGUESTCARDSTMT FROM @SETGUESTCARD;
		EXECUTE SETGUESTCARDSTMT;
		SET GUESTCARD=@GUEST_CARD;
		IF GUESTCARD IS NOT NULL THEN
			SET CUSTOMERLOSTCARD=(SELECT CONCAT(ACCESSCARD,' ',CUSTOMERNAME,' ','GUEST','(',CUSTID,')'));
		ELSE
			SET CUSTOMERLOSTCARD=(SELECT CONCAT(ACCESSCARD,' ',CUSTOMERNAME,' ','(',CUSTID,')'));
		END IF;
		SET @UPDATE_TEMP_ACCESS=(SELECT CONCAT('UPDATE ',TEMPACCESSUNIT,' SET CUSTOMER_OLD_CARD=','"',CUSTOMERLOSTCARD,'"',',REASON=(SELECT ACN_DATA FROM ACCESS_CONFIGURATION WHERE ACN_ID=4) WHERE ID=',MINID));
		PREPARE UPDATE_TEMP_ACCESS_STMT FROM @UPDATE_TEMP_ACCESS;
		EXECUTE UPDATE_TEMP_ACCESS_STMT;
		SET ACCESSSEARCHSUCCESSMSG=1;
		SET @GUEST_CARD=NULL;
		SET MINID=MINID+1;
		SET MINTERMID=MINTERMID+1;
	END WHILE;
END IF;
IF MINID=0 AND MAXID=0 THEN
SET MINTERMID=(MAX_TERM_ID-MIN_TERM_ID)+1;
ELSE
SET MINTERMID=(MAX_TERM_ID-MIN_TERM_ID)+2;
END IF;
WHILE MINTERMID<=MAXTERMID DO
		SET @SETACCESSCARDTERM=(SELECT CONCAT('SELECT UASD_ACCESS_CARD INTO @ACTERM_CARD FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ID=(SELECT CARDNO FROM ',TEMP_TERMINATED_CARD,' WHERE ID=',MINTERMID,')'));
		PREPARE SETACCESSCARDTERM_STMT FROM @SETACCESSCARDTERM;
		EXECUTE SETACCESSCARDTERM_STMT;
		SET ACCESSCARD=@ACTERM_CARD ;
		SET @SETTERMCUSTID=(SELECT CONCAT('SELECT CUSTOMERID INTO @TERM_CUST_ID FROM ',TEMP_TERMINATED_CARD,' WHERE ID=',MINTERMID));
		PREPARE SETTERMCUSTIDSTMT FROM @SETTERMCUSTID;
		EXECUTE SETTERMCUSTIDSTMT;
		SET CUSTID=@TERM_CUST_ID;
		SET @SETTERMCUSTOMERNAME=(SELECT CONCAT('SELECT CONCAT(CUSTOMER_FIRST_NAME," ",CUSTOMER_LAST_NAME) INTO @TERM_CUST_NAME FROM CUSTOMER WHERE CUSTOMER_ID=',CUSTID));
		PREPARE SETTERMCUSTOMERNAMESTMT FROM @SETTERMCUSTOMERNAME;
		EXECUTE SETTERMCUSTOMERNAMESTMT;
		SET CUSTOMERNAME=@TERM_CUST_NAME;
		SET @SETTERMGUESTCARD=(SELECT CONCAT('SELECT GUESTFLAG INTO @TERM_GUEST_CARD FROM ',TEMP_TERMINATED_CARD,' WHERE ID=',MINTERMID));
		PREPARE SETTERMGUESTCARDSTMT FROM @SETTERMGUESTCARD;
		EXECUTE SETTERMGUESTCARDSTMT;
		SET GUESTCARD=@TERM_GUEST_CARD;
	IF GUESTCARD IS NOT NULL THEN
			SET CUSTOMERLOSTCARD=(SELECT CONCAT(ACCESSCARD,' ',CUSTOMERNAME,' ','GUEST','(',CUSTID,')'));
		ELSE
			SET CUSTOMERLOSTCARD=(SELECT CONCAT(ACCESSCARD,' ',CUSTOMERNAME,' ','(',CUSTID,')'));
	END IF;
		SET @INSERT_TEMP_ACCESS_TERM=(SELECT CONCAT('INSERT INTO ',TEMPACCESSUNIT,'(CUSTOMER_OLD_CARD,REASON)VALUES(','"',CUSTOMERLOSTCARD,'"',',(SELECT ACN_DATA FROM ACCESS_CONFIGURATION WHERE ACN_ID=4))'));
		PREPARE INSERT_TEMP_ACCESS_TERM_STMT FROM @INSERT_TEMP_ACCESS_TERM;
		EXECUTE INSERT_TEMP_ACCESS_TERM_STMT;
		SET @GUEST_CARD=NULL;
	SET MINTERMID=MINTERMID+1;
	END WHILE;
END IF;
SET ACCESSSEARCHSUCCESSMSG=1;
	IF TEMP_TERMINATED_CARD IS NOT NULL THEN
	SET @DROP_TERMINATED_CARD=(SELECT CONCAT('DROP TABLE IF EXISTS ',TEMP_TERMINATED_CARD));
	PREPARE DROP_TERMINATED_CARD_STMT FROM @DROP_TERMINATED_CARD;
	EXECUTE DROP_TERMINATED_CARD_STMT;
	END IF;
END IF;
	 COMMIT; 
END;
