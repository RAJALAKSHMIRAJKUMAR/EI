-- VER 0.6 TRACKER NO:595 COMMENT #116 STARTDATE:18/08/2014 ENDDATE:18/08/2014 DESC: CHANGED DECIMAL AS 10,2 BY SARADAMBAL
-- VER 0.5 ISSUE NO:817 COMMENT #139 STARTDATE:21/06/2014 ENDDATE:21/06/2014 DESC:DROPPING TEMP TABLE IF ROLLBACK OCCURS DONE BY:SASIKALA
-- VER 0.4 ISSUE NO:566 COMMENT #12 STARTDATE:09/06/2014 ENDDATE:09/06/2014 DESC:ADDED ROLLBACK AND COMMIIT DONE BY:SASIKALA
-- VER 0.3 ISSUE NO:817 COMMENT #35 STARTDATE:06/05/2014 ENDDATE:06/05/2014 DESC:CHANGES IN TEMP TABLE FOR DYNAMIC PURPOSE DONE BY:BHAVANI.R
-- VER 0.2 ISSUE NO:595 COMMENT # STARTDATE:29/01/2014 ENDDATE:29/01/2014 DESC:INCLUDED CONDITION FOR GETTING ACTIVE UNIT ONLY. DONE BY:MANIKANDAN.S
-- VER 0.1 ISSUE NO:595 COMMENT #51 STARTDATE:27/01/2014 ENDDATE:27/01/2014 DESC:THIS PROCEDURE IS CALLED IN SP_CHARTS_PERSONAL_NET_REVENUE. DONE BY:MANIKANDAN.S
DROP PROCEDURE IF EXISTS SP_CHARTS_BIZ_EXPENSE;
CREATE PROCEDURE SP_CHARTS_BIZ_EXPENSE(IN FROM_DATE VARCHAR(20), IN TO_DATE VARCHAR(20),IN USERSTAMP VARCHAR(50),OUT TEMP_MAIN_CHARTS_BIZ_EXPENSE TEXT)
BEGIN

 DECLARE FINAL_FROM_DATE VARCHAR(20);
 DECLARE FINAL_TO_DATE VARCHAR(20);
 DECLARE USERSTAMP_ID INT;
DECLARE MAIN_BIZ_EXPENSE_TEMPTBL TEXT;
DECLARE INTERMEDIATE_BIZ_EXPENSE TEXT;
DECLARE INTERMEDIATE_BIZ_EXPENSE_TEMPTBL TEXT;

DECLARE EXIT HANDLER FOR SQLEXCEPTION
BEGIN
 ROLLBACK;
  IF (INTERMEDIATE_BIZ_EXPENSE_TEMPTBL IS NOT NULL) THEN
    SET @DROP_INTERMEDIATE_BIZ_EXPENSE_TEMPTBL=(SELECT CONCAT('DROP TABLE IF EXISTS ',INTERMEDIATE_BIZ_EXPENSE_TEMPTBL));
		PREPARE DROP_INTERMEDIATE_BIZ_EXPENSE_TEMPTBL_STMT FROM @DROP_INTERMEDIATE_BIZ_EXPENSE_TEMPTBL;
		EXECUTE DROP_INTERMEDIATE_BIZ_EXPENSE_TEMPTBL_STMT;
  END IF;
END; 
START TRANSACTION;
--   TEMP TABLE NAME START
	CALL SP_CHANGE_USERSTAMP_AS_ULDID(USERSTAMP,@ULDID);
	SET USERSTAMP_ID=(SELECT @ULDID);
	SET MAIN_BIZ_EXPENSE_TEMPTBL=(SELECT CONCAT('TEMP_CHARTS_BIZ_EXPENSE',SYSDATE()));
	SET INTERMEDIATE_BIZ_EXPENSE=(SELECT CONCAT('TEMP_INTERMEDIATE_CHARTS_BIZ',SYSDATE()));
--    NAME FOR MAIN TEMP TABLE
	SET MAIN_BIZ_EXPENSE_TEMPTBL=(SELECT REPLACE(MAIN_BIZ_EXPENSE_TEMPTBL,' ',''));
	SET MAIN_BIZ_EXPENSE_TEMPTBL=(SELECT REPLACE(MAIN_BIZ_EXPENSE_TEMPTBL,'-',''));
	SET MAIN_BIZ_EXPENSE_TEMPTBL=(SELECT REPLACE(MAIN_BIZ_EXPENSE_TEMPTBL,':',''));
	SET TEMP_MAIN_CHARTS_BIZ_EXPENSE=(SELECT CONCAT(MAIN_BIZ_EXPENSE_TEMPTBL,'_',USERSTAMP_ID)); 
-- NAME FOR INTERMEDIATE TEMP TABLE
	SET INTERMEDIATE_BIZ_EXPENSE=(SELECT REPLACE(INTERMEDIATE_BIZ_EXPENSE,' ',''));
	SET INTERMEDIATE_BIZ_EXPENSE=(SELECT REPLACE(INTERMEDIATE_BIZ_EXPENSE,'-',''));
	SET INTERMEDIATE_BIZ_EXPENSE=(SELECT REPLACE(INTERMEDIATE_BIZ_EXPENSE,':',''));
	SET INTERMEDIATE_BIZ_EXPENSE_TEMPTBL=(SELECT CONCAT(INTERMEDIATE_BIZ_EXPENSE,'_',USERSTAMP_ID));
--   TEMP TABLE NAME END     
  
  -- Format the input date into proper date format.
  CALL SP_FORMAT_DATE(FROM_DATE,TO_DATE,@fd,@td);
  SELECT @fd INTO FINAL_FROM_DATE;
  SELECT @td INTO FINAL_TO_DATE;
  
  -- CREATING MAIN TEMP TABLE FOR FINAL OUTPUT
  
    SET @CREATE_TEMP_CHARTS_BIZ_EXPENSE=(SELECT CONCAT('CREATE TABLE ',TEMP_MAIN_CHARTS_BIZ_EXPENSE,'(MONTH_YEAR VARCHAR(20),CAR_PARK DECIMAL(10,2),DIGITAL_VOICE DECIMAL(10,2),ELECTRICITY DECIMAL(10,2),FACILITY_USE DECIMAL(10,2),MOVE_IN_OUT DECIMAL(10,2),STARHUB DECIMAL(10,2),UNIT_EXPENSE DECIMAL(10,2))'));
	PREPARE CREATE_TEMP_CHARTS_BIZ_EXPENSE_STMT FROM @CREATE_TEMP_CHARTS_BIZ_EXPENSE;
	EXECUTE CREATE_TEMP_CHARTS_BIZ_EXPENSE_STMT;

  
  -- CREATING INTERMEDIATE TEMP TABLE 
  
      SET @CREATE_TEMP_INTERMEDIATE_CHARTS_BIZ=(SELECT CONCAT('CREATE TABLE ',INTERMEDIATE_BIZ_EXPENSE_TEMPTBL,'(MONTH_YEAR VARCHAR(20),CAR_PARK DECIMAL(10,2),DIGITAL_VOICE DECIMAL(10,2),ELECTRICITY DECIMAL(10,2),FACILITY_USE DECIMAL(10,2),MOVE_IN_OUT DECIMAL(10,2),STARHUB DECIMAL(10,2),UNIT_EXPENSE DECIMAL(10,2), DATE DATE)'));
	PREPARE CREATE_TEMP_INTERMEDIATE_CHARTS_BIZ_STMT FROM @CREATE_TEMP_INTERMEDIATE_CHARTS_BIZ;
	EXECUTE CREATE_TEMP_INTERMEDIATE_CHARTS_BIZ_STMT;
  
		SET @INSERT_INTERMEDIATE_BIZ_EXPENSE_TEMPTBL=(SELECT CONCAT('INSERT INTO ',INTERMEDIATE_BIZ_EXPENSE_TEMPTBL,' (MONTH_YEAR, CAR_PARK, DATE)SELECT DATE_FORMAT(ECP.ECP_INVOICE_DATE,"%M-%Y"),ECP.ECP_AMOUNT, ECP.ECP_INVOICE_DATE FROM EXPENSE_CARPARK ECP,EXPENSE_DETAIL_CARPARK EDCP,UNIT UN,UNIT_DETAILS UD WHERE UD.UD_OBSOLETE IS NULL AND UD.UD_NON_EI IS NULL AND UD.UD_END_DATE>CURDATE() AND UD.UNIT_ID=UN.UNIT_ID AND UN.UNIT_ID = EDCP.UNIT_ID AND EDCP.EDCP_ID = ECP.EDCP_ID AND  ECP.ECP_INVOICE_DATE BETWEEN ','"',FINAL_FROM_DATE,'"', ' AND ','"',FINAL_TO_DATE,'"'));
		PREPARE INSERT_INTERMEDIATE_BIZ_EXPENSE_TEMPTBL_STMT FROM @INSERT_INTERMEDIATE_BIZ_EXPENSE_TEMPTBL;
		EXECUTE INSERT_INTERMEDIATE_BIZ_EXPENSE_TEMPTBL_STMT;

		SET @INSERT_INTERMEDIATE_BIZ_EXPENSE_TEMPTBL=(SELECT CONCAT('INSERT INTO ',INTERMEDIATE_BIZ_EXPENSE_TEMPTBL,' (MONTH_YEAR, DIGITAL_VOICE, DATE)SELECT DATE_FORMAT(EDV.EDV_INVOICE_DATE,"%M-%Y"),EDV.EDV_AMOUNT, EDV.EDV_INVOICE_DATE FROM EXPENSE_DIGITAL_VOICE EDV,EXPENSE_DETAIL_DIGITAL_VOICE EDDV,UNIT UN,UNIT_DETAILS UD WHERE  UD.UD_OBSOLETE IS NULL AND UD.UD_NON_EI IS NULL AND UD.UD_END_DATE>CURDATE() AND UD.UNIT_ID=UN.UNIT_ID AND UN.UNIT_ID = EDDV.UNIT_ID AND EDDV.EDDV_ID = EDV.EDDV_ID AND EDV.EDV_INVOICE_DATE BETWEEN ','"',FINAL_FROM_DATE,'"', ' AND ','"',FINAL_TO_DATE,'"'));
		PREPARE INSERT_INTERMEDIATE_BIZ_EXPENSE_TEMPTBL_STMT FROM @INSERT_INTERMEDIATE_BIZ_EXPENSE_TEMPTBL;
		EXECUTE INSERT_INTERMEDIATE_BIZ_EXPENSE_TEMPTBL_STMT;
		
		SET @INSERT_INTERMEDIATE_BIZ_EXPENSE_TEMPTBL=(SELECT CONCAT('INSERT INTO ',INTERMEDIATE_BIZ_EXPENSE_TEMPTBL,' (MONTH_YEAR, ELECTRICITY, DATE)SELECT DATE_FORMAT(EE.EE_INVOICE_DATE,"%M-%Y"),EE.EE_AMOUNT, EE.EE_INVOICE_DATE FROM EXPENSE_ELECTRICITY EE,EXPENSE_DETAIL_ELECTRICITY EDE,UNIT UN ,UNIT_DETAILS UD WHERE UD.UD_OBSOLETE IS NULL AND UD.UD_NON_EI IS NULL AND UD.UD_END_DATE>CURDATE() AND UD.UNIT_ID=UN.UNIT_ID AND UN.UNIT_ID = EDE.UNIT_ID AND EDE.EDE_ID = EE.EDE_ID AND  EE.EE_INVOICE_DATE BETWEEN ','"',FINAL_FROM_DATE,'"', ' AND ','"',FINAL_TO_DATE,'"'));
		PREPARE INSERT_INTERMEDIATE_BIZ_EXPENSE_TEMPTBL_STMT FROM @INSERT_INTERMEDIATE_BIZ_EXPENSE_TEMPTBL;
		EXECUTE INSERT_INTERMEDIATE_BIZ_EXPENSE_TEMPTBL_STMT;

		SET @INSERT_INTERMEDIATE_BIZ_EXPENSE_TEMPTBL=(SELECT CONCAT('INSERT INTO ',INTERMEDIATE_BIZ_EXPENSE_TEMPTBL,' (MONTH_YEAR, FACILITY_USE, DATE)    SELECT DATE_FORMAT(EFU.EFU_INVOICE_DATE,"%M-%Y"),EFU.EFU_AMOUNT, EFU.EFU_INVOICE_DATE FROM EXPENSE_FACILITY_USE EFU,UNIT UN ,UNIT_DETAILS UD WHERE UD.UD_OBSOLETE IS NULL AND UD.UD_NON_EI IS NULL AND UD.UD_END_DATE>CURDATE() AND UD.UNIT_ID=UN.UNIT_ID AND  UN.UNIT_ID = EFU.UNIT_ID AND  EFU.EFU_INVOICE_DATE BETWEEN ','"',FINAL_FROM_DATE,'"', ' AND ','"',FINAL_TO_DATE,'"'));
		PREPARE INSERT_INTERMEDIATE_BIZ_EXPENSE_TEMPTBL_STMT FROM @INSERT_INTERMEDIATE_BIZ_EXPENSE_TEMPTBL;
		EXECUTE INSERT_INTERMEDIATE_BIZ_EXPENSE_TEMPTBL_STMT;

		SET @INSERT_INTERMEDIATE_BIZ_EXPENSE_TEMPTBL=(SELECT CONCAT('INSERT INTO ',INTERMEDIATE_BIZ_EXPENSE_TEMPTBL,' (MONTH_YEAR, MOVE_IN_OUT, DATE)    SELECT DATE_FORMAT(EMIO.EMIO_INVOICE_DATE,"%M-%Y"),EMIO.EMIO_AMOUNT, EMIO.EMIO_INVOICE_DATE FROM EXPENSE_MOVING_IN_AND_OUT EMIO,UNIT UN ,UNIT_DETAILS UD WHERE UD.UD_OBSOLETE IS NULL AND UD.UD_NON_EI IS NULL AND UD.UD_END_DATE>CURDATE() AND UD.UNIT_ID=UN.UNIT_ID AND  UN.UNIT_ID = EMIO.UNIT_ID AND  EMIO.EMIO_INVOICE_DATE BETWEEN ','"',FINAL_FROM_DATE,'"', ' AND ','"',FINAL_TO_DATE,'"'));
		PREPARE INSERT_INTERMEDIATE_BIZ_EXPENSE_TEMPTBL_STMT FROM @INSERT_INTERMEDIATE_BIZ_EXPENSE_TEMPTBL;
		EXECUTE INSERT_INTERMEDIATE_BIZ_EXPENSE_TEMPTBL_STMT;

		SET @INSERT_INTERMEDIATE_BIZ_EXPENSE_TEMPTBL=(SELECT CONCAT('INSERT INTO ',INTERMEDIATE_BIZ_EXPENSE_TEMPTBL,' (MONTH_YEAR, STARHUB, DATE)    SELECT DATE_FORMAT(ESH.ESH_INVOICE_DATE,"%M-%Y"),ESH.ESH_AMOUNT, ESH.ESH_INVOICE_DATE FROM EXPENSE_STARHUB ESH,EXPENSE_DETAIL_STARHUB EDSH,UNIT UN ,UNIT_DETAILS UD WHERE UD.UD_OBSOLETE IS NULL AND UD.UD_NON_EI IS NULL AND UD.UD_END_DATE>CURDATE() AND UD.UNIT_ID=UN.UNIT_ID AND UN.UNIT_ID = EDSH.UNIT_ID AND EDSH.EDSH_ID = ESH.EDSH_ID AND  ESH.ESH_INVOICE_DATE BETWEEN ','"',FINAL_FROM_DATE,'"', ' AND ','"',FINAL_TO_DATE,'"'));
		PREPARE INSERT_INTERMEDIATE_BIZ_EXPENSE_TEMPTBL_STMT FROM @INSERT_INTERMEDIATE_BIZ_EXPENSE_TEMPTBL;
		EXECUTE INSERT_INTERMEDIATE_BIZ_EXPENSE_TEMPTBL_STMT;

		SET @INSERT_INTERMEDIATE_BIZ_EXPENSE_TEMPTBL=(SELECT CONCAT('INSERT INTO ',INTERMEDIATE_BIZ_EXPENSE_TEMPTBL,' (MONTH_YEAR, UNIT_EXPENSE, DATE)    SELECT DATE_FORMAT(EU.EU_INVOICE_DATE,"%M-%Y"),EU.EU_AMOUNT, EU.EU_INVOICE_DATE FROM EXPENSE_UNIT EU,UNIT UN ,UNIT_DETAILS UD WHERE UD.UD_OBSOLETE IS NULL AND UD.UD_NON_EI IS NULL AND UD.UD_END_DATE>CURDATE() AND UD.UNIT_ID=UN.UNIT_ID AND UN.UNIT_ID = EU.UNIT_ID AND  EU.EU_INVOICE_DATE BETWEEN ','"',FINAL_FROM_DATE,'"', ' AND ','"',FINAL_TO_DATE,'"'));
		PREPARE INSERT_INTERMEDIATE_BIZ_EXPENSE_TEMPTBL_STMT FROM @INSERT_INTERMEDIATE_BIZ_EXPENSE_TEMPTBL;
		EXECUTE INSERT_INTERMEDIATE_BIZ_EXPENSE_TEMPTBL_STMT;


      -- INSERTING INTO FINAL TEMP TABLE GROUPING BY MONTH AND YEAR
  	SET @INSERT_TEMP_MAIN_CHARTS_BIZ_EXPENSE=(SELECT CONCAT('INSERT INTO ',TEMP_MAIN_CHARTS_BIZ_EXPENSE,' (MONTH_YEAR ,CAR_PARK ,DIGITAL_VOICE ,ELECTRICITY ,FACILITY_USE ,MOVE_IN_OUT ,STARHUB ,UNIT_EXPENSE)(SELECT MONTH_YEAR,SUM(COALESCE(CAR_PARK,'"0"')),SUM(COALESCE(DIGITAL_VOICE,'"0"')), SUM(COALESCE(ELECTRICITY,'"0"')), SUM(COALESCE(FACILITY_USE,'"0"')), SUM(COALESCE(MOVE_IN_OUT,'"0"')), SUM(COALESCE(STARHUB,'"0"')), SUM(COALESCE(UNIT_EXPENSE,'"0"')) FROM ',INTERMEDIATE_BIZ_EXPENSE_TEMPTBL,' GROUP BY MONTH_YEAR ORDER BY DATE)'));
		PREPARE INSERT_TEMP_MAIN_CHARTS_BIZ_EXPENSE_STMT FROM @INSERT_TEMP_MAIN_CHARTS_BIZ_EXPENSE;
		EXECUTE INSERT_TEMP_MAIN_CHARTS_BIZ_EXPENSE_STMT;
  
		SET @DROP_INTERMEDIATE_BIZ_EXPENSE_TEMPTBL=(SELECT CONCAT('DROP TABLE IF EXISTS ',INTERMEDIATE_BIZ_EXPENSE_TEMPTBL));
		PREPARE DROP_INTERMEDIATE_BIZ_EXPENSE_TEMPTBL_STMT FROM @DROP_INTERMEDIATE_BIZ_EXPENSE_TEMPTBL;
		EXECUTE DROP_INTERMEDIATE_BIZ_EXPENSE_TEMPTBL_STMT;
 COMMIT;
END; 
/* 
  CALL SP_CHARTS_BIZ_EXPENSE('March-2013' , 'January-2014','EXPATSINTEGRATED@GMAIL.COM',@TEMP_MAIN_CHARTS_BIZ_EXPENSE);
  select @TEMP_MAIN_CHARTS_BIZ_EXPENSE
*/

