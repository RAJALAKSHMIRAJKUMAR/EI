-- version:0.2 --sdate:06-08-2014 --edate:06-08-2014 --issue:836 --commentno#1 --desc:GETTING ERROR MSG FROM CONFIG TABLE --donebY:SASIKALA
-- version:0.1 --sdate:25-06-2014 --edate:25-06-2014 --issue:593 --commentno#75 --desc:forperiod,paiddate,unitid,ehkuid validation --doneby:RL

DROP PROCEDURE IF EXISTS SP_TRG_BIZDLY_HOUSEKEEPING_PAYMENT_VALIDATION;
CREATE PROCEDURE SP_TRG_BIZDLY_HOUSEKEEPING_PAYMENT_VALIDATION(
IN UNITID INTEGER,
IN EHKUID INTEGER,
IN FORPERIOD DATE,
IN PAIDDATE DATE,
IN PROCESS TEXT)
BEGIN
    DECLARE MESSAGE_TEXT VARCHAR(50);
	DECLARE ERROR_MSG TEXT;
	IF (PROCESS='INSERT') OR (PROCESS='UPDATE') THEN
		IF(UNITID IS NULL AND EHKUID IS NULL) THEN
			SET ERROR_MSG = (SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID = 540);
			SIGNAL SQLSTATE '45000'
			SET MESSAGE_TEXT = ERROR_MSG;
		END IF;
		IF(UNITID IS NOT NULL AND EHKUID IS NOT NULL) THEN
			SET ERROR_MSG = (SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID = 541);
			SIGNAL SQLSTATE '45000'
			SET MESSAGE_TEXT = ERROR_MSG;
		END IF;
		IF(UNITID IS NOT NULL)THEN
			IF NOT EXISTS(SELECT UNIT_ID FROM UNIT WHERE UNIT_ID = UNITID)THEN
				SET ERROR_MSG = (SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID = 542);
				SIGNAL SQLSTATE '45000'
				SET MESSAGE_TEXT = ERROR_MSG;
			END IF;
		END IF;
		IF(EHKUID IS NOT NULL)THEN
			IF NOT EXISTS(SELECT EHKU_ID FROM EXPENSE_HOUSEKEEPING_UNIT WHERE EHKU_ID = EHKUID)THEN
				SET ERROR_MSG = (SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID = 543);
				SIGNAL SQLSTATE '45000'
				SET MESSAGE_TEXT = ERROR_MSG;
			END IF;
		END IF;
		IF FORPERIOD > CURDATE() THEN
			SET ERROR_MSG = (SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID = 544);
			SIGNAL SQLSTATE '45000'
			SET MESSAGE_TEXT = ERROR_MSG;
		END IF;
		IF PAIDDATE > CURDATE() THEN
			SET ERROR_MSG = (SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID = 545);
			SIGNAL SQLSTATE '45000'
			SET MESSAGE_TEXT= ERROR_MSG;
		END IF;
	END IF;
END;