-- VER_0.3 --issue no:836 startdate:06/08/2014 enddate:06/08/2014 DESC:VALIDATION FOR CUSTOMER_LP_DETAILS REPLACING HARDCOADEDMESSAGE INTO ID DONE BY:BHAVANI.R
--VER0.2 STARTDATE:15/07/2014 ENDDATE:15/07/2014 ISSUE NO:593 DESC:CHENGED SOME CONDITIONS FOR GUEST CARD DONE BY:DHIVYA
--issue no:593 startdate:26/06/2014 enddate:27/06/2014 COMMENT NO:100 DESC:CUSTOMER_LP_DETAILS DONE BY:DHIVYA
DROP PROCEDURE IF EXISTS SP_TRG_CUSTOMER_LP_DETAILS_VALIDATION;
CREATE PROCEDURE SP_TRG_CUSTOMER_LP_DETAILS_VALIDATION(
IN NEWCLPID INTEGER,
IN NEWCUSTOMERID INTEGER,
IN NEWRECVER INTEGER,
IN NEWUASDID INTEGER,
IN NEWSTARTDATE DATE,
IN NEWENDDATE DATE,
IN NEWPRETERMINATEDATE DATE,
IN NEWTERMINATE CHAR(1),
IN NEWGUESTCARD CHAR(1),
IN PROCESS TEXT)
BEGIN
	DECLARE UNITID INTEGER;
	DECLARE UNITSTARTDATE DATE;
	DECLARE ENDDATE DATE;
	DECLARE UNITENDDATE DATE;
	DECLARE MESSAGE_TEXT VARCHAR(50);
	DECLARE OLDRECVER INTEGER;
	DECLARE RECVER INTEGER;
	DECLARE ERRORMSG_UASDID TEXT;
	DECLARE ERRORMSG_DATE TEXT;
	DECLARE ERRORMSG_STARTDATE TEXT;
	DECLARE ERRORMSG_ENDDATE TEXT;
	DECLARE ERRORMSG_INVALIDPERIOD TEXT;
	DECLARE ERRORMSG_VALIDRECVER TEXT;
	SET OLDRECVER = (SELECT CED_REC_VER FROM CUSTOMER_LP_DETAILS WHERE CLP_ID = NEWCLPID);
	SET UNITID = (SELECT UNIT_ID FROM CUSTOMER_ENTRY_DETAILS WHERE CUSTOMER_ID = NEWCUSTOMERID AND CED_REC_VER = NEWRECVER);
	SET UNITSTARTDATE = (SELECT UD_START_DATE FROM UNIT_DETAILS WHERE UNIT_ID = UNITID);
	SET ENDDATE = (SELECT UD_END_DATE FROM UNIT_DETAILS WHERE UNIT_ID = UNITID);
	SET UNITENDDATE = (SELECT DATE_SUB(ENDDATE,INTERVAL 1 DAY));
	SET RECVER=(SELECT CED_REC_VER FROM  CUSTOMER_LP_DETAILS WHERE CUSTOMER_ID=NEWCUSTOMERID AND CED_REC_VER=NEWRECVER AND CLP_GUEST_CARD IS NULL);
	SET ERRORMSG_UASDID=(SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=497);
	SET ERRORMSG_DATE=(SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=498);
	SET ERRORMSG_STARTDATE=(SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=499);
	SET ERRORMSG_ENDDATE=(SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=500);
	SET ERRORMSG_INVALIDPERIOD=(SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=501);
	SET ERRORMSG_VALIDRECVER=(SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=502);
	SET ERRORMSG_VALIDRECVER=(SELECT REPLACE(ERRORMSG_VALIDRECVER,'[RECVER]',NEWRECVER));
    IF(PROCESS = 'INSERT') OR (PROCESS='UPDATE') THEN
        IF NEWUASDID IS NOT NULL THEN
            IF NOT EXISTS(SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ID = NEWUASDID) THEN
                SIGNAL SQLSTATE '45000'
                SET MESSAGE_TEXT = ERRORMSG_UASDID;
            END IF;
        END IF;
        IF NEWENDDATE <= NEWSTARTDATE THEN
            SIGNAL SQLSTATE '45000'
            SET MESSAGE_TEXT = ERRORMSG_DATE;
        END IF;    
        IF NEWSTARTDATE < UNITSTARTDATE THEN
            SIGNAL SQLSTATE '45000'
            SET MESSAGE_TEXT = ERRORMSG_STARTDATE;
        END IF;    
        IF NEWENDDATE > UNITENDDATE THEN
            SIGNAL SQLSTATE '45000'
            SET MESSAGE_TEXT = ERRORMSG_ENDDATE;
        END IF;    
        IF NEWSTARTDATE > NEWPRETERMINATEDATE THEN
            IF NEWTERMINATE = 'X' THEN
                SIGNAL SQLSTATE '45000'
				SET MESSAGE_TEXT = ERRORMSG_INVALIDPERIOD;
            END IF;    
        END IF;
	END IF;
	IF PROCESS = 'UPDATE' THEN
		IF OLDRECVER != NEWRECVER THEN
			IF (RECVER IS NOT NULL) OR (RECVER != ' ') THEN	
				IF NEWGUESTCARD IS NULL THEN
				SIGNAL SQLSTATE '45000'
				SET MESSAGE_TEXT = ERRORMSG_VALIDRECVER;
				END IF;
			END IF;
		END IF; 
	END IF;
	IF PROCESS = 'INSERT' THEN
		IF (RECVER IS NOT NULL) OR (RECVER != ' ') THEN	
			IF NEWGUESTCARD IS NULL THEN
			SIGNAL SQLSTATE '45000'
			SET MESSAGE_TEXT = ERRORMSG_VALIDRECVER;
			END IF;
		END IF; 
	END IF;
END;