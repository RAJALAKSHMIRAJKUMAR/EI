-- ver0.7 date:06/05/2015 desc: added room type in temp table done by:dhivya

DROP PROCEDURE IF EXISTS SP_CUSTOMER_SEARCH_TEMP_FEE_DETAIL;
CREATE PROCEDURE SP_CUSTOMER_SEARCH_TEMP_FEE_DETAIL(IN CUSTOMERID INTEGER,IN USERSTAMP VARCHAR(50),OUT CUSTOMER_SEARCH_FEE_TEMPTBLNAME TEXT)
BEGIN
DECLARE REC_VER INT;
DECLARE CID INTEGER;
DECLARE CUSTOMER_SEARCH_TEMPTBLNAME TEXT;
DECLARE USERSTAMP_ID INT;
DECLARE ROOMTYPE VARCHAR(30);
DECLARE EXIT HANDLER FOR SQLEXCEPTION
BEGIN 
ROLLBACK; 
END;
SET CID = CUSTOMERID;
START TRANSACTION;
CALL SP_CHANGE_USERSTAMP_AS_ULDID(USERSTAMP,@ULDID);
SET USERSTAMP_ID=(SELECT @ULDID);
SET CUSTOMER_SEARCH_TEMPTBLNAME=(SELECT CONCAT('TEMP_CUSTOMER_SEARCH_FEE_DETAIL',SYSDATE()));
SET CUSTOMER_SEARCH_TEMPTBLNAME=(SELECT REPLACE(CUSTOMER_SEARCH_TEMPTBLNAME,' ',''));
SET CUSTOMER_SEARCH_TEMPTBLNAME=(SELECT REPLACE(CUSTOMER_SEARCH_TEMPTBLNAME,'-',''));
SET CUSTOMER_SEARCH_TEMPTBLNAME=(SELECT REPLACE(CUSTOMER_SEARCH_TEMPTBLNAME,':',''));
SET CUSTOMER_SEARCH_FEE_TEMPTBLNAME=(SELECT CONCAT(CUSTOMER_SEARCH_TEMPTBLNAME,'_',USERSTAMP_ID)); 
SET @CREATE_TEMP_CUSTOMER_SEARCH_FEE_DETAIL=(SELECT CONCAT('CREATE TABLE ',CUSTOMER_SEARCH_FEE_TEMPTBLNAME,'
(
CS_SNO INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
CUSTOMER_ID INT,
CUSTOMER_VER INT,
CC_PAYMENT_AMOUNT DECIMAL(7,2),
CC_DEPOSIT DECIMAL(7,2),
CC_PROCESSING_FEE DECIMAL(7,2),
CC_AIRCON_FIXED_FEE DECIMAL(7,2),
CC_ELECTRICITY_CAP DECIMAL(7,2),
CC_DRYCLEAN_FEE DECIMAL(7,2),
CC_AIRCON_QUARTERLY_FEE DECIMAL(7,2),
CC_CHECKOUT_CLEANING_FEE DECIMAL(7,2),
CC_ROOM_TYPE VARCHAR(30))'));
PREPARE CREATE_TEMP_CUSTOMER_SEARCH_FEE_DETAIL_STMT FROM @CREATE_TEMP_CUSTOMER_SEARCH_FEE_DETAIL;
EXECUTE CREATE_TEMP_CUSTOMER_SEARCH_FEE_DETAIL_STMT;
SET REC_VER = (SELECT MAX(CED_REC_VER) FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=CID);
WHILE REC_VER !=0 DO
IF EXISTS (SELECT CED_REC_VER FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=CID AND CED_REC_VER=REC_VER) THEN
SET @INSERT_TEMP_CUSTOMER_SEARCH_FEE_DETAIL=(SELECT CONCAT('INSERT INTO ',CUSTOMER_SEARCH_FEE_TEMPTBLNAME,' (CUSTOMER_ID,CUSTOMER_VER,CC_PAYMENT_AMOUNT,CC_DEPOSIT,CC_PROCESSING_FEE,
CC_AIRCON_FIXED_FEE,CC_ELECTRICITY_CAP,CC_DRYCLEAN_FEE,CC_AIRCON_QUARTERLY_FEE,CC_CHECKOUT_CLEANING_FEE)
VALUES (',CID,',',REC_VER,',
(SELECT CFD_AMOUNT FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=',CID,' AND CED_REC_VER=',REC_VER,' AND CPP_ID=1),
(SELECT CFD_AMOUNT FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=',CID,' AND CED_REC_VER=',REC_VER,' AND CPP_ID=2),
(SELECT CFD_AMOUNT FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=',CID,' AND CED_REC_VER=',REC_VER,' AND CPP_ID=3),
(SELECT CFD_AMOUNT FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=',CID,' AND CED_REC_VER=',REC_VER,' AND CPP_ID=4),
(SELECT CFD_AMOUNT FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=',CID,' AND CED_REC_VER=',REC_VER,' AND CPP_ID=5),
(SELECT CFD_AMOUNT FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=',CID,' AND CED_REC_VER=',REC_VER,' AND CPP_ID=6),
(SELECT CFD_AMOUNT FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=',CID,' AND CED_REC_VER=',REC_VER,' AND CPP_ID=7),
(SELECT CFD_AMOUNT FROM CUSTOMER_FEE_DETAILS WHERE CUSTOMER_ID=',CID,' AND CED_REC_VER=',REC_VER,' AND CPP_ID=8))'));
PREPARE INSERT_TEMP_CUSTOMER_SEARCH_FEE_DETAIL_STMT FROM @INSERT_TEMP_CUSTOMER_SEARCH_FEE_DETAIL;
EXECUTE INSERT_TEMP_CUSTOMER_SEARCH_FEE_DETAIL_STMT;

SET @SET_ROOMTYPE=(SELECT CONCAT('SELECT URTD_ROOM_TYPE into @R_TYPE FROM UNIT_ROOM_TYPE_DETAILS URTD,CUSTOMER_ENTRY_DETAILS CED,',CUSTOMER_SEARCH_FEE_TEMPTBLNAME,' T,UNIT_ACCESS_STAMP_DETAILS UASD WHERE
URTD.URTD_ID=UASD.URTD_ID AND CED.UASD_ID=UASD.UASD_ID AND CED.CUSTOMER_ID=T.CUSTOMER_ID AND CED.CED_REC_VER=T.CUSTOMER_VER AND CED.CED_REC_VER=',REC_VER,' and CED.CUSTOMER_ID=',CUSTOMERID));
PREPARE SET_ROOMTYPE_STMT FROM @SET_ROOMTYPE;
EXECUTE SET_ROOMTYPE_STMT;
SET ROOMTYPE=@R_TYPE;
SET @SET_UPDATE_QUERY=(SELECT CONCAT('UPDATE ',CUSTOMER_SEARCH_FEE_TEMPTBLNAME,' SET CC_ROOM_TYPE=','"',ROOMTYPE,'"',' WHERE CUSTOMER_VER=',REC_VER));
PREPARE SET_UPDATE_QUERY_STMT FROM @SET_UPDATE_QUERY;
EXECUTE SET_UPDATE_QUERY_STMT;
END IF;
SET REC_VER=REC_VER-1;
END WHILE;
COMMIT;
END;