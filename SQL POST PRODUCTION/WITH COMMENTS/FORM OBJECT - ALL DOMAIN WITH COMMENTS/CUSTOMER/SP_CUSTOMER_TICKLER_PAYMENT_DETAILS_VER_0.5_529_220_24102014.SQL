-- VER 0.5 ISSUE:529 COMMENT #220 STARTDATE:24/10/2014 ENDDATE:24/10/2014 DESC: TIMESTAMP CHANGES IN OLD VALUE OF TEMP TICKLER HISTORY DONE BY:BHAVANI.R
-- VER 0.4 ISSUE:345 COMMENT #754 STARTDATE:13/06/2014 ENDDATE:16/09/2014 DESC: DELETED CUSTOMERS FROM CUSTOMER TABLES ALSO SHOWN IN TEMP TICKLER HISTORY TABLE DONE BY:BHAVANI.R
-- VER 0.3, STARTDATE:14/07/2014,ENDDATE:14/07/2014,TRACKER NO:694,COMMENTNO:#33 DESC:UPDATED UNSIGNED ZERO FOR UNIT NUMBER(3)
-- VER 0.2, STARTDATE:09/06/2014, END DATE:09/06/2014, TRACKER NO:566  COMMENTNO:#12, DESC:ADDED ROLLBACK AND COMMIT DONE BY:SASIKALA
-- VER 0.1, STARTDATE:17/05/2014, END DATE:17/05/2014, TRACKER NO:743  COMMENTNO:#168, DESC:SPLITTED THE SP CUSTOMER_TICKLER_DATA FOR DYNAMIC RUNNING PROCESS DONE BY:BHAVANI.R
DROP PROCEDURE IF EXISTS SP_CUSTOMER_TICKLER_PAYMENT_DETAILS;
CREATE PROCEDURE SP_CUSTOMER_TICKLER_PAYMENT_DETAILS()
BEGIN 
DECLARE FINAL_UNITNOPYMT SMALLINT(4) UNSIGNED ZEROFILL;
DECLARE NEWFINAL_UNITNO SMALLINT(4) UNSIGNED ZEROFILL;
DECLARE FIRST_NAME_VALUE TEXT;
DECLARE CONFIGDATA TEXT;
DECLARE CONFIGVALUE TEXT;
DECLARE TIMESTAMP_VALUE VARCHAR(50);
DECLARE EXIT HANDLER FOR SQLEXCEPTION
BEGIN
ROLLBACK;
END;
START TRANSACTION;
				PD_OV_CS_LOOP : LOOP
              
					CALL SP_GET_SPECIAL_CHARACTER_SEPERATED_VALUES(',',@TH_OLD_VALUE,@VALUE,@REMAINING_STRING);
					SELECT @REMAINING_STRING INTO @TH_OLD_VALUE;
              
					-- SEPERATING COLUMN NAME AND COLUMN VALUE 
					CALL SP_GET_SPECIAL_CHARACTER_SEPERATED_VALUES('=',@VALUE,@COLUMN_NAME,@COLUMN_VALUE);
              
            
					IF UPPER(@COLUMN_NAME) = 'UNIT_ID' THEN
						SELECT UNIT_NO INTO @UNIT_NO FROM UNIT WHERE UNIT_ID = @COLUMN_VALUE;
						IF(LENGTH (@UNIT_NO)=3 )THEN
						SET FINAL_UNITNOPYMT=(SELECT CONCAT ('0',@UNIT_NO));
						ELSE
						SET FINAL_UNITNOPYMT=@UNIT_NO;
						END IF;
						SET @REPLACE_STRING = CONCAT('UNIT_NO=',@UNIT_NO);
						SELECT REPLACE(@V_TEMP_OLD_VALUE,@VALUE,@REPLACE_STRING) INTO @V_TEMP_OLD_VALUE;
					END IF;
			  
					IF UPPER(@COLUMN_NAME) = 'CUSTOMER_ID' THEN
						IF EXISTS (SELECT CUSTOMER_FIRST_NAME FROM CUSTOMER WHERE CUSTOMER_ID = @COLUMN_VALUE) THEN
							SELECT CUSTOMER_FIRST_NAME,CUSTOMER_LAST_NAME INTO @FIRST_NAME_VALUE,@LAST_NAME_VALUE FROM CUSTOMER WHERE CUSTOMER_ID = @COLUMN_VALUE;
        				END IF;
        				SET @SELECT_CUSTOMER_FIRST_NAME=(SELECT CONCAT('SELECT CUSTOMER_FIRST_NAME INTO @FIRSTNAMEVALUE FROM ',TEMP_CUSTOMER,' WHERE CUSTOMER_ID = @COLUMN_VALUE'));
        				PREPARE SELECT_CUSTOMER_FIRST_NAME_STMT FROM @SELECT_CUSTOMER_FIRST_NAME;
        				EXECUTE SELECT_CUSTOMER_FIRST_NAME_STMT;
        				SET FIRST_NAME_VALUE=@FIRSTNAMEVALUE;
        				IF (FIRST_NAME_VALUE IS NOT NULL) THEN
							SET @SELECT_CUSTOMER_NAME=(SELECT CONCAT ('SELECT CUSTOMER_FIRST_NAME,CUSTOMER_LAST_NAME INTO @FIRST_NAME_VALUE,@LAST_NAME_VALUE FROM ',TEMP_CUSTOMER,' WHERE CUSTOMER_ID = @COLUMN_VALUE'));
							PREPARE SELECT_CUSTOMER_NAME_STMT FROM @SELECT_CUSTOMER_NAME;
        					EXECUTE SELECT_CUSTOMER_NAME_STMT;
        				END IF;
						SET @REPLACE_STRING = CONCAT('CUSTOMER_FIRST_NAME=',@FIRST_NAME_VALUE,',CUSTOMER_LAST_NAME=',@LAST_NAME_VALUE);
						SELECT REPLACE(@V_TEMP_OLD_VALUE,@VALUE,@REPLACE_STRING) INTO @V_TEMP_OLD_VALUE;
					END IF;
              
					IF UPPER(@COLUMN_NAME) = 'PP_ID' THEN
						SELECT PP_DATA INTO @PPDATA FROM PAYMENT_PROFILE WHERE PP_ID = @COLUMN_VALUE;
						SET @REPLACE_STRING = CONCAT('PP_DATA=',@PPDATA);
						SELECT REPLACE(@V_TEMP_OLD_VALUE,@VALUE,@REPLACE_STRING) INTO @V_TEMP_OLD_VALUE;
					END IF;
                       
					IF UPPER(@COLUMN_NAME) = 'ULD_ID' THEN
						SELECT ULD_LOGINID INTO @OLDPAYMENTDETAILID FROM USER_LOGIN_DETAILS WHERE ULD_ID = @COLUMN_VALUE;
						SET @REPLACE_STRING = CONCAT('ULD_LOGINID=',@OLDPAYMENTDETAILID);
						SELECT REPLACE(@V_TEMP_OLD_VALUE,@VALUE,@REPLACE_STRING) INTO @V_TEMP_OLD_VALUE;
					END IF;	
     
     				IF UPPER(@COLUMN_NAME) = 'PD_TIMESTAMP' THEN
     					SET @SELECT_CONFIG_DATA=(SELECT CONCAT('SELECT CCN_DATA INTO @CONFIG_DATA FROM CUSTOMER_CONFIGURATION WHERE CCN_ID = 44'));
						PREPARE SELECT_CONFIG_DATA_STMT FROM @SELECT_CONFIG_DATA;
						EXECUTE SELECT_CONFIG_DATA_STMT;
						SET CONFIGDATA = @CONFIG_DATA;
     					SET @SELECT_STR_DATA=(SELECT CONCAT('SELECT SUBSTRING_INDEX("',CONFIGDATA,'","+","-1") INTO @STR_DATA'));
						PREPARE SELECT_STR_DATA_STMT FROM @SELECT_STR_DATA;
						EXECUTE SELECT_STR_DATA_STMT;
     					SET CONFIGVALUE = @STR_DATA;
     					SET @SELECT_STR_VALUE=(SELECT CONCAT('SELECT REPLACE("',CONFIGVALUE,'","'"'"'","") INTO @STR_VALUE'));
						PREPARE SELECT_STR_VALUE_STMT FROM @SELECT_STR_VALUE;
						EXECUTE SELECT_STR_VALUE_STMT;
     					SET TIMESTAMP_VALUE = @STR_VALUE;
     					SET @UPDATETIMESTAMP=(SELECT CONCAT('SELECT CONVERT_TZ(@COLUMN_VALUE, "+0:00","+',TIMESTAMP_VALUE,'") INTO @TIMESTAMP_VALUE'));
     					PREPARE UPDATETIMESTAMPSTMT FROM @UPDATETIMESTAMP;
     					EXECUTE UPDATETIMESTAMPSTMT;   
                  		SET @REPLACE_STRING = CONCAT('PD_TIMESTAMP=',@TIMESTAMP_VALUE);
						SELECT REPLACE(@V_TEMP_OLD_VALUE,@VALUE,@REPLACE_STRING) INTO @V_TEMP_OLD_VALUE;
     					LEAVE PD_OV_CS_LOOP;
     				END IF;
              
					IF @TH_OLD_VALUE IS NULL THEN
						LEAVE  PD_OV_CS_LOOP;
					END IF;
	           END LOOP;             
           
           IF @TH_NEW_VALUE IS NOT NULL THEN
				SET @V_TEMP_NEW_VALUE = @TH_NEW_VALUE;
				PD_NV_CS_LOOP : LOOP
					CALL SP_GET_SPECIAL_CHARACTER_SEPERATED_VALUES(',',@TH_NEW_VALUE,@VALUE,@REMAINING_STRING);
					SELECT @REMAINING_STRING INTO @TH_NEW_VALUE;
					-- SEPERATING COLUMN NAME AND COLUMN VALUE 
					CALL SP_GET_SPECIAL_CHARACTER_SEPERATED_VALUES('=',@VALUE,@COLUMN_NAME,@COLUMN_VALUE);
              
					IF UPPER(@COLUMN_NAME) = 'UNIT_ID' THEN
						SELECT UNIT_NO INTO @NEWUNIT_NO FROM UNIT WHERE UNIT_ID = @COLUMN_VALUE;
						IF(LENGTH (@NEWUNIT_NO)=3 )THEN
						SET NEWFINAL_UNITNO=(SELECT CONCAT ('0',@NEWUNIT_NO));
						ELSE
						SET NEWFINAL_UNITNO=@NEWUNIT_NO;
						END IF;
						SET @REPLACE_STRING = CONCAT('UNIT_NO=',@NEWUNIT_NO);
						SELECT REPLACE(@V_TEMP_NEW_VALUE,@VALUE,@REPLACE_STRING) INTO @V_TEMP_NEW_VALUE;
					END IF;
			  
					IF UPPER(@COLUMN_NAME) = 'CUSTOMER_ID' THEN
						IF EXISTS (SELECT CUSTOMER_FIRST_NAME FROM CUSTOMER WHERE CUSTOMER_ID = @COLUMN_VALUE) THEN
							SET @SELECT_CUSTOMER_NAME=(SELECT CONCAT ('SELECT CUSTOMER_FIRST_NAME,CUSTOMER_LAST_NAME INTO @FIRST_NAME_VALUE,@LAST_NAME_VALUE FROM ',TEMP_CUSTOMER,' WHERE CUSTOMER_ID = @COLUMN_VALUE'));
							PREPARE SELECT_CUSTOMER_NAME_STMT FROM @SELECT_CUSTOMER_NAME;
        					EXECUTE SELECT_CUSTOMER_NAME_STMT;
        		 		END IF;
        				SET @SELECT_CUSTOMER_FIRST_NAME=(SELECT CONCAT('SELECT CUSTOMER_FIRST_NAME INTO @FIRSTNAMEVALUE FROM ',TEMP_CUSTOMER,' WHERE CUSTOMER_ID = @COLUMN_VALUE'));
        				PREPARE SELECT_CUSTOMER_FIRST_NAME_STMT FROM @SELECT_CUSTOMER_FIRST_NAME;
        				EXECUTE SELECT_CUSTOMER_FIRST_NAME_STMT;
        				SET FIRST_NAME_VALUE=@FIRSTNAMEVALUE;
        				IF (FIRST_NAME_VALUE IS NOT NULL) THEN
							SELECT CUSTOMER_FIRST_NAME,CUSTOMER_LAST_NAME INTO @FIRST_NAME_VALUE,@LAST_NAME_VALUE FROM TEMP_CUSTOMER WHERE CUSTOMER_ID = @COLUMN_VALUE;
        				END IF;
						SET @REPLACE_STRING = CONCAT('CUSTOMER_FIRST_NAME=',@FIRST_NAME_VALUE,',CUSTOMER_LAST_NAME=',@LAST_NAME_VALUE);
						SELECT REPLACE(@V_TEMP_NEW_VALUE,@VALUE,@REPLACE_STRING) INTO @V_TEMP_NEW_VALUE;
					END IF;
              
					IF UPPER(@COLUMN_NAME) = 'PP_ID' THEN
						SELECT PP_DATA INTO @NEWPPDATA FROM PAYMENT_PROFILE WHERE PP_ID = @COLUMN_VALUE;
						SET @REPLACE_STRING = CONCAT('PP_DATA=',@NEWPPDATA);
						SELECT REPLACE(@V_TEMP_NEW_VALUE,@VALUE,@REPLACE_STRING) INTO @V_TEMP_NEW_VALUE;
					END IF;
                       
					IF UPPER(@COLUMN_NAME) = 'ULD_ID' THEN
						SELECT ULD_LOGINID INTO @NEWPAYMENTDETAILID FROM USER_LOGIN_DETAILS WHERE ULD_ID = @COLUMN_VALUE;
						SET @REPLACE_STRING = CONCAT('ULD_LOGINID=',@NEWPAYMENTDETAILID);
						SELECT REPLACE(@V_TEMP_NEW_VALUE,@VALUE,@REPLACE_STRING) INTO @V_TEMP_NEW_VALUE;
						LEAVE PD_NV_CS_LOOP;
					END IF;
              
					IF @TH_NEW_VALUE IS NULL THEN
						LEAVE  PD_NV_CS_LOOP; 
					END IF;
				END LOOP;  
           ELSE
				SET @V_TEMP_NEW_VALUE = NULL;
           END IF;
           COMMIT;
		   END;
     
 