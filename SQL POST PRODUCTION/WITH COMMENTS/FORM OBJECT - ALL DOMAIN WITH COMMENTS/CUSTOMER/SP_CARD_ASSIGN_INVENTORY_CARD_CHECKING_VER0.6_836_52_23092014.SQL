-- VER 0.6 ISSUE 836 COMMENT:52 STARTDATE:23/09/2014 ENDDATE:23/09/2014 DESC:INVENTORY CARD CHECKING ERRORMSG GET FROM DB DONE BY:DHIVYA.A

-- VER 0.5 ISSUE 835 COMMENT:#1 DESC:IMPLEMENTED AUTOCOMMIT DONE BY:DHIVYA.A


DROP PROCEDURE IF EXISTS SP_CARD_ASSIGN_INVENTORY_CARD_CHECKING;
CREATE PROCEDURE SP_CARD_ASSIGN_INVENTORY_CARD_CHECKING(IN CA_CUSTOMER_ID INTEGER,
IN CA_UNIT_NO INTEGER(4),
IN CA_REC_VER INTEGER,
IN CA_CARD_NO TEXT,IN USERSTAMP VARCHAR(50),
IN TEMPTABLEDROPPING TEXT,OUT FLAG TEXT)
BEGIN
    DECLARE CHECK_OLDCARD VARCHAR(7);
    DECLARE CHECK_NEWCARD VARCHAR(7);
    DECLARE CARD_MINID INTEGER;
    DECLARE CARD_ASSIGN_FLAG TEXT;
    DECLARE CARD_MAXID INTEGER;
	DECLARE TEMP_CA_CARD_NO TEXT;
    DECLARE CHECK_CARD_LENGTH INTEGER;
    DECLARE CHECK_OLD_CARD_POSITION INTEGER;
    DECLARE CHECK_NEW_CARD_POSITION INTEGER;
    DECLARE CHECK_OLD_ACTIVE_CARD INTEGER;
    DECLARE CHECK_NEW_INVENTORY_CARD INTEGER;
    DECLARE INVENTORYCARD CHAR(1);
    DECLARE ACTIVECARD INTEGER;
    DECLARE LOCATION INTEGER;
	DECLARE TEMPCARDASSIGNCHECKING TEXT;
	DECLARE USERSTAMP_ID INTEGER;
	DECLARE TEMP_CARD_ASSIGN_CHECKING TEXT;
    DECLARE ERRORMSG TEXT;
    SET AUTOCOMMIT=0;
SET CARD_ASSIGN_FLAG=' ';
CALL SP_CHANGE_USERSTAMP_AS_ULDID(USERSTAMP,@ULDID);
    SET USERSTAMP_ID = (SELECT @ULDID);
SET TEMPCARDASSIGNCHECKING=(SELECT CONCAT('TEMP_CARD_ASSIGN_CHECKING_',SYSDATE()));
SET TEMPCARDASSIGNCHECKING=(SELECT REPLACE(TEMPCARDASSIGNCHECKING,' ',''));
SET TEMPCARDASSIGNCHECKING=(SELECT REPLACE(TEMPCARDASSIGNCHECKING,'-',''));
SET TEMPCARDASSIGNCHECKING=(SELECT REPLACE(TEMPCARDASSIGNCHECKING,':',''));
SET TEMP_CARD_ASSIGN_CHECKING=(SELECT CONCAT(TEMPCARDASSIGNCHECKING,'_',USERSTAMP_ID));
SET @CREATE_TEMP_CARD_ASSIGN_CHECKING=(SELECT CONCAT('CREATE TABLE ',TEMP_CARD_ASSIGN_CHECKING,'(
ID INTEGER AUTO_INCREMENT PRIMARY KEY,
CARD_CUSTOMERID INTEGER,
CARD_REC_VER INTEGER,
OLDCARD INTEGER,
NEWCARD INTEGER
)'));
PREPARE CREATE_TEMP_CARD_ASSIGN_CHECKING_STMT FROM @CREATE_TEMP_CARD_ASSIGN_CHECKING;
EXECUTE CREATE_TEMP_CARD_ASSIGN_CHECKING_STMT; 
SET @INSERT_TEMP_TABLE_DROPPING=(SELECT CONCAT('INSERT INTO ',TEMPTABLEDROPPING,'(TABLE_NAME)VALUES(','"',TEMP_CARD_ASSIGN_CHECKING,'"',')'));
PREPARE INSERT_TEMP_TABLE_DROPPING_STMT FROM @INSERT_TEMP_TABLE_DROPPING;
EXECUTE INSERT_TEMP_TABLE_DROPPING_STMT;    
IF CA_CARD_NO IS NOT NULL THEN
SET TEMP_CA_CARD_NO=CA_CARD_NO;
SET CHECK_CARD_LENGTH=1;
    loop_label : LOOP
        SET CHECK_OLD_CARD_POSITION=(SELECT LOCATE(',',TEMP_CA_CARD_NO,CHECK_CARD_LENGTH));
        SET CHECK_OLDCARD=(SELECT SUBSTRING(TEMP_CA_CARD_NO,CHECK_CARD_LENGTH,CHECK_OLD_CARD_POSITION-1));
        SET TEMP_CA_CARD_NO=(SELECT SUBSTRING(TEMP_CA_CARD_NO,CHECK_OLD_CARD_POSITION+1));
        SET CHECK_NEW_CARD_POSITION=(SELECT LOCATE(',',TEMP_CA_CARD_NO,CHECK_CARD_LENGTH));
        IF CHECK_NEW_CARD_POSITION=0 THEN
            SET CHECK_NEWCARD=TEMP_CA_CARD_NO;
        ELSE
            SET CHECK_NEWCARD=(SELECT SUBSTRING(TEMP_CA_CARD_NO,CHECK_CARD_LENGTH,CHECK_NEW_CARD_POSITION-1));
        END IF;
        SET TEMP_CA_CARD_NO=(SELECT SUBSTRING(TEMP_CA_CARD_NO,CHECK_NEW_CARD_POSITION+1));
        IF CHECK_OLDCARD=' ' THEN
            SET CHECK_OLDCARD='NULL';
        END IF;
        IF CHECK_NEWCARD=' ' THEN
            SET CHECK_NEWCARD='NULL';
        END IF;
            SET @INSERT_TCAC=(SELECT CONCAT('INSERT INTO ',TEMP_CARD_ASSIGN_CHECKING,'(CARD_CUSTOMERID,CARD_REC_VER,OLDCARD,NEWCARD)
            VALUES(',CA_CUSTOMER_ID,',',CA_REC_VER,',',CHECK_OLDCARD,',',CHECK_NEWCARD,')'));
			PREPARE INSERT_TCAC_STMT FROM @INSERT_TCAC;
            EXECUTE INSERT_TCAC_STMT;     
        IF CHECK_NEW_CARD_POSITION<=0 THEN
            LEAVE  loop_label;
        END IF;
    END LOOP;
END IF;
SET @TEMP_MINID=NULL;
SET @CARDMINID=(SELECT CONCAT('SELECT MIN(ID) INTO @TEMP_MINID FROM ',TEMP_CARD_ASSIGN_CHECKING));
PREPARE CARD_MINID_STMT FROM @CARDMINID;
EXECUTE CARD_MINID_STMT; 
SET @TEMP_MAXID=NULL;
SET @CARDMAXID=(SELECT CONCAT('SELECT MAX(ID) INTO @TEMP_MAXID FROM ',TEMP_CARD_ASSIGN_CHECKING));
PREPARE CARD_MAXID_STMT FROM @CARDMAXID;
EXECUTE CARD_MAXID_STMT;
SET CARD_MINID=@TEMP_MINID;
SET CARD_MAXID=@TEMP_MAXID;
WHILE CARD_MINID<=CARD_MAXID DO
    SET @TEMP_OLDCARD=NULL;
    SET @CHECKOLD_ACTIVE_CARD=(SELECT CONCAT('SELECT OLDCARD INTO @TEMP_OLDCARD FROM ',TEMP_CARD_ASSIGN_CHECKING,' WHERE ID=',CARD_MINID));
	PREPARE CHECKOLD_ACTIVE_CARD_STMT FROM @CHECKOLD_ACTIVE_CARD;
    EXECUTE CHECKOLD_ACTIVE_CARD_STMT;
	SET CHECK_OLD_ACTIVE_CARD=@TEMP_OLDCARD;
	SET @TEMP_NEWCARD=NULL;
    SET @CHECKNEW_INVENTORY_CARD=(SELECT CONCAT('SELECT NEWCARD INTO @TEMP_NEWCARD FROM ',TEMP_CARD_ASSIGN_CHECKING,' WHERE ID=',CARD_MINID));
	PREPARE CHECKNEW_INVENTORY_CARD_STMT FROM @CHECKNEW_INVENTORY_CARD;
    EXECUTE CHECKNEW_INVENTORY_CARD_STMT;
	SET CHECK_NEW_INVENTORY_CARD=@TEMP_NEWCARD;
        IF (CHECK_OLD_ACTIVE_CARD IS NULL) AND (CHECK_NEW_INVENTORY_CARD IS NOT NULL) THEN
            SET INVENTORYCARD=(SELECT UASD_ACCESS_INVENTORY FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=CHECK_NEW_INVENTORY_CARD);
                IF INVENTORYCARD IS NULL THEN
                    SET CARD_ASSIGN_FLAG=(SELECT CONCAT(CARD_ASSIGN_FLAG,',',CHECK_NEW_INVENTORY_CARD));
                END IF;
        END IF;        
        IF (CHECK_OLD_ACTIVE_CARD IS NOT NULL) AND (CHECK_NEW_INVENTORY_CARD IS NOT NULL) THEN
            SET ACTIVECARD=(SELECT UASD_ID FROM CUSTOMER_LP_DETAILS WHERE UASD_ID=(SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=CHECK_NEW_INVENTORY_CARD) AND CUSTOMER_ID=CA_CUSTOMER_ID AND CED_REC_VER=CA_REC_VER);
            IF ACTIVECARD IS NULL THEN
                SET INVENTORYCARD=(SELECT UASD_ACCESS_INVENTORY FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=CHECK_NEW_INVENTORY_CARD);
                    IF INVENTORYCARD IS NULL THEN
                        SET CARD_ASSIGN_FLAG=(SELECT CONCAT(CARD_ASSIGN_FLAG,',',CHECK_NEW_INVENTORY_CARD));
                    END IF;
            END IF;
        END IF;
    SET CARD_MINID=CARD_MINID+1;
END WHILE;
IF CARD_ASSIGN_FLAG!=' ' THEN
    SET ERRORMSG=(SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=571);
    SET FLAG=CARD_ASSIGN_FLAG;
    SET LOCATION=(SELECT LOCATE(',', FLAG,CHECK_CARD_LENGTH));
    SET FLAG=(SELECT SUBSTRING(FLAG,LOCATION+1));
    SET FLAG = (SELECT REPLACE(ERRORMSG,'[CARD NO]',FLAG));
ELSE
    SET FLAG=NULL;
END IF;
END;
