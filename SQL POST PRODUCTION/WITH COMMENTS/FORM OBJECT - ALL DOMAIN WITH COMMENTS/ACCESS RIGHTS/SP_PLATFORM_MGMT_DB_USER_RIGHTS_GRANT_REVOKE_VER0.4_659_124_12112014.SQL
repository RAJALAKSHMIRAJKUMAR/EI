-- VER 0.4 STARTDATE:1/11/2014 ENDDATE:12/11/2014 DESC:ADDED 3 INPUT FOR DYNAMIC TEMP TABLES DONE BY:DHIVYA
-- VER0.3 STARTDATE:2014/11/01 ENDDATE:2014/11/12  ISSUE 659 CMT:124 DESC: CHANGED GRANT & REVOKE PERMISSION QUERY FOR SP,VIEW & TRIGGERS DONE BY:DHIVYA


DROP PROCEDURE IF EXISTS SP_PLATFORM_MGMT_DB_USER_RIGHTS_GRANT_REVOKE;
CREATE PROCEDURE SP_PLATFORM_MGMT_DB_USER_RIGHTS_GRANT_REVOKE
(IN DB_NAME VARCHAR(20), IN USER_NAME VARCHAR(50), IN USER_MENUS TEXT,IN ACTION VARCHAR(10),USERID INTEGER,OUT TEMP_PM_UNIQUE_TABLE_NAMES TEXT,OUT TEMP_UNIQUE_TABLE_NAMES TEXT,OUT TEMP_PM_UNIQUE_SP_NAMES TEXT)
BEGIN
-- VARIABLE DECLARATION
DECLARE COUNT1        INT;
DECLARE COUNT2        INT;
DECLARE COUNT3        INT;
DECLARE V_POSTAP_ID   INT;
DECLARE V_SPP_ID      INT;
DECLARE V_VP_ID       INT;
DECLARE V_MENU_ID INT;
DECLARE V_TABLE_NAME  VARCHAR(100);
DECLARE V_SP_NAME     VARCHAR(100);
DECLARE V_VP_NAME     VARCHAR(100);
DECLARE MIN_ID        INT;
DECLARE temptable INT;
DECLARE SELECT_PRIVILEGE CHAR(1);
DECLARE UPDATE_PRIVILEGE CHAR(1);
DECLARE INSERT_PRIVILEGE CHAR(1);
DECLARE DELETE_PRIVILEGE CHAR(1);
DECLARE FINAL_PRIVILEGE VARCHAR(50);
DECLARE MINID INTEGER;
DECLARE MAXID INTEGER;
DECLARE TABLEID INTEGER;
DECLARE TEMP_TABLE TEXT;
DECLARE MIN_PMID INTEGER;
DECLARE MAX_PMID INTEGER;
SET TEMP_TABLE=(SELECT CONCAT('TEMP_UNIQUE_TABLE_NAMES',SYSDATE()));
SET TEMP_TABLE=(SELECT REPLACE(TEMP_TABLE,' ',''));
SET TEMP_TABLE=(SELECT REPLACE(TEMP_TABLE,'-',''));
SET TEMP_TABLE=(SELECT REPLACE(TEMP_TABLE,':',''));
SET TEMP_UNIQUE_TABLE_NAMES=(SELECT CONCAT(TEMP_TABLE,'_',USERID));
SET TEMP_TABLE=(SELECT CONCAT('TEMP_PM_UNIQUE_TABLE_NAMES',SYSDATE()));
SET TEMP_TABLE=(SELECT REPLACE(TEMP_TABLE,' ',''));
SET TEMP_TABLE=(SELECT REPLACE(TEMP_TABLE,'-',''));
SET TEMP_TABLE=(SELECT REPLACE(TEMP_TABLE,':',''));
SET TEMP_PM_UNIQUE_TABLE_NAMES=(SELECT CONCAT(TEMP_TABLE,'_',USERID));
SET TEMP_TABLE=(SELECT CONCAT('TEMP_PM_UNIQUE_SP_NAMES',SYSDATE()));
SET TEMP_TABLE=(SELECT REPLACE(TEMP_TABLE,' ',''));
SET TEMP_TABLE=(SELECT REPLACE(TEMP_TABLE,'-',''));
SET TEMP_TABLE=(SELECT REPLACE(TEMP_TABLE,':',''));
SET TEMP_PM_UNIQUE_SP_NAMES=(SELECT CONCAT(TEMP_TABLE,'_',USERID));
SET @A=1;
-- IF CREATING SP NEED TO GIVE PERMISSION IN THIS SP MEANS,NEED TO SET RECURSIVE DEPTH
 SET @@SESSION.max_sp_recursion_depth = 15 ;
 -- GRANT PERMISSION FOR VIEWING ALL TABLES DATAS IN DB
SET @SET_SELECT_PERMISSION=(SELECT CONCAT('GRANT SELECT ON ',DB_NAME,'.* TO ','"',USER_NAME ,'"','@','"%"'));
PREPARE SET_SELECT_PERMISSION_STMT FROM @SET_SELECT_PERMISSION;
EXECUTE SET_SELECT_PERMISSION_STMT;
DEALLOCATE PREPARE SET_SELECT_PERMISSION_STMT;
SET @A=2;
SET @DROP_TEMP_PM=(SELECT CONCAT('DROP TABLE IF EXISTS ',TEMP_UNIQUE_TABLE_NAMES));
PREPARE DROP_TEMP_PM_STMT FROM @DROP_TEMP_PM;
EXECUTE DROP_TEMP_PM_STMT;
-- TEMP TABLE FOR STORING ALL TABLES FOR PASSING MENUS
SET @CREATE_TEMP_UNIQUE=(SELECT CONCAT('CREATE TABLE ',TEMP_UNIQUE_TABLE_NAMES,' (ID INT NOT NULL AUTO_INCREMENT, POSTAP_ID INT,PRIMARY KEY (ID))'));
PREPARE CREATE_TEMP_UNIQUE FROM @CREATE_TEMP_UNIQUE;
EXECUTE CREATE_TEMP_UNIQUE;	             
SET @TEMP_SQL = CONCAT('INSERT INTO ',TEMP_UNIQUE_TABLE_NAMES,'(POSTAP_ID) SELECT DISTINCT TTIP_ID FROM PLATFORM_MANAGEMENT WHERE MP_ID IN (',USER_MENUS,') AND TTIP_ID IS NOT NULL');
PREPARE S1 FROM @TEMP_SQL;
EXECUTE S1;
DEALLOCATE PREPARE S1;
SET @DROP_TEMP_UNIQUE=(SELECT CONCAT('DROP TABLE IF EXISTS ',TEMP_PM_UNIQUE_TABLE_NAMES));
PREPARE DROP_TEMP_UNIQUE_STMT FROM @DROP_TEMP_UNIQUE;
EXECUTE DROP_TEMP_UNIQUE_STMT;
-- TEMP TABLE FOR STORING ALL TABLES PRIVILEGES
SET @CREATE_TEMP_PM_UNIQUE=(SELECT CONCAT('CREATE TABLE ',TEMP_PM_UNIQUE_TABLE_NAMES,' (ID INT NOT NULL AUTO_INCREMENT, POSTAP_ID INT,PRIMARY KEY (ID),UPDATE_PRIV CHAR(1),INSERT_PRIV CHAR(1),DELETE_PRIV CHAR(1))'));
PREPARE CREATE_TEMP_PM_UNIQUE_STMT FROM @CREATE_TEMP_PM_UNIQUE;
EXECUTE CREATE_TEMP_PM_UNIQUE_STMT;
SET @SETMINID=(SELECT CONCAT('SELECT MIN(ID) INTO @PFMINID FROM ',TEMP_UNIQUE_TABLE_NAMES ));
PREPARE SETMINIDSTMT FROM @SETMINID;
EXECUTE SETMINIDSTMT;
SET MINID=@PFMINID;
SET @SETMAXID=(SELECT CONCAT('SELECT MAX(ID) INTO @PFMAXID FROM ',TEMP_UNIQUE_TABLE_NAMES));
PREPARE SETMAXIDSTMT FROM @SETMAXID;
EXECUTE SETMAXIDSTMT;
SET MAXID=@PFMAXID;
WHILE MINID<=MAXID DO  
	SET @SETTABLEID=(SELECT CONCAT('SELECT POSTAP_ID INTO @TAB_ID FROM ',TEMP_UNIQUE_TABLE_NAMES,' WHERE ID=',MINID));
	PREPARE SETTABLEIDSTMT FROM @SETTABLEID;
	EXECUTE SETTABLEIDSTMT;
	SET TABLEID= @TAB_ID;
	-- QUERY FOR SELECTING DISTINCT UPDATE PRIVELEGE FOR A PARTICULAT TABLE
	SET @SET_UPDATE_PRIVILEGE=(SELECT CONCAT('SELECT DISTINCT PM_UPDATE_PRIV INTO @UP_PRIV FROM PLATFORM_MANAGEMENT WHERE MP_ID IN (',USER_MENUS,') AND PM_UPDATE_PRIV IS NOT NULL AND TTIP_ID=',TABLEID));
	PREPARE SET_UPDATE_PRIVILEGE_STMT FROM @SET_UPDATE_PRIVILEGE;
	EXECUTE SET_UPDATE_PRIVILEGE_STMT;
	-- QUERY FOR SELECTING DISTINCT INSERT PRIVELEGE FOR A PARTICULAT TABLE
	SET @SET_INSERT_PRIVILEGE=(SELECT CONCAT('SELECT DISTINCT PM_INSERT_PRIV INTO @IN_PRIV FROM PLATFORM_MANAGEMENT  WHERE MP_ID IN (',USER_MENUS,') AND PM_INSERT_PRIV IS NOT NULL AND TTIP_ID=',TABLEID));
	PREPARE SET_INSERT_PRIVILEGE_STMT FROM @SET_INSERT_PRIVILEGE;
	EXECUTE SET_INSERT_PRIVILEGE_STMT;
	-- QUERY FOR SELECTING DISTINCT DELETE PRIVILEGE FOR A PARTICULAR TABLE
	SET @SET_DELETE_PRIVILEGE=(SELECT CONCAT('SELECT DISTINCT PM_DELETE_PRIV INTO @DEL_PRIV FROM PLATFORM_MANAGEMENT WHERE  MP_ID IN (',USER_MENUS,') AND PM_DELETE_PRIV IS NOT NULL AND TTIP_ID=',TABLEID));
	PREPARE SET_DELETE_PRIVILEGE_STMT FROM @SET_DELETE_PRIVILEGE;
	EXECUTE SET_DELETE_PRIVILEGE_STMT;
	-- INSERT QUERY FOR A TABLE INSERT,UPDATE & DELETE PRIVILEGE FOR PASSING MENUS
	SET @INSERT_TEMP_PM_UNIQUE=(SELECT CONCAT('INSERT INTO ',TEMP_PM_UNIQUE_TABLE_NAMES,'(POSTAP_ID,UPDATE_PRIV,INSERT_PRIV,DELETE_PRIV)VALUES( @TAB_ID,@UP_PRIV,@IN_PRIV,@DEL_PRIV)'));
	PREPARE INSERT_TEMP_PM_UNIQUE_STMT FROM @INSERT_TEMP_PM_UNIQUE;
	EXECUTE INSERT_TEMP_PM_UNIQUE_STMT;
	SET @TABLEID=NULL;
	SET @UP_PRIV=NULL;
	SET @IN_PRIV=NULL;
	SET @DEL_PRIV=NULL;
	SET MINID=MINID+1;
END WHILE;
SET @SET_PM_MINID=(SELECT CONCAT('SELECT MIN(ID) INTO @PMMINID FROM ',TEMP_PM_UNIQUE_TABLE_NAMES));
PREPARE SET_PM_MINID_STMT FROM @SET_PM_MINID;
EXECUTE SET_PM_MINID_STMT;
SET MIN_PMID=@PMMINID;
SET @SET_PM_MAXID=(SELECT CONCAT('SELECT MAX(ID) INTO @PMMAXID FROM ',TEMP_PM_UNIQUE_TABLE_NAMES));
PREPARE SET_PM_MAXID_STMT FROM @SET_PM_MAXID;
EXECUTE SET_PM_MAXID_STMT;
SET MAX_PMID=@PMMAXID;
WHILE MIN_PMID<=MAX_PMID DO
		-- QUERY FOR GETTING TABLEID FROM TEMP_PM_UNIQUE_TABLE_NAMES
		SET @SET_POSTAPID=(SELECT CONCAT('SELECT POSTAP_ID INTO @VPOSTAP_ID FROM ',TEMP_PM_UNIQUE_TABLE_NAMES,' WHERE ID =', MIN_PMID));
		 PREPARE SET_POSTAPID_STMT FROM @SET_POSTAPID;
		 EXECUTE SET_POSTAPID_STMT;
		 SET V_POSTAP_ID=@VPOSTAP_ID;
		SELECT TTIP_DATA INTO V_TABLE_NAME FROM TICKLER_TABID_PROFILE WHERE TTIP_ID = V_POSTAP_ID;
		SET @SET_UPDATE_PRIVILEGE=(SELECT CONCAT('SELECT UPDATE_PRIV INTO @UPPRIV FROM ',TEMP_PM_UNIQUE_TABLE_NAMES,' WHERE ID= ',MIN_PMID));
		PREPARE SET_UPDATE_PRIVILEGE_STMT FROM @SET_UPDATE_PRIVILEGE;
		EXECUTE SET_UPDATE_PRIVILEGE_STMT;
		SET UPDATE_PRIVILEGE=@UPPRIV;
		SET @SET_INSERT_PRIVILEGE=(SELECT CONCAT('SELECT INSERT_PRIV INTO @INPRIV FROM ',TEMP_PM_UNIQUE_TABLE_NAMES,' WHERE ID= ',MIN_PMID));
		PREPARE SET_INSERT_PRIVILEGE_STMT FROM @SET_INSERT_PRIVILEGE;
		EXECUTE SET_INSERT_PRIVILEGE_STMT;
		SET INSERT_PRIVILEGE=@INPRIV;
		SET @SET_DELETE_PRIVILEGE=(SELECT CONCAT('SELECT DELETE_PRIV INTO @DELPRIV FROM ',TEMP_PM_UNIQUE_TABLE_NAMES,' WHERE ID=',MIN_PMID));
		PREPARE SET_DELETE_PRIVILEGE_STMT FROM @SET_DELETE_PRIVILEGE;
		EXECUTE SET_DELETE_PRIVILEGE_STMT;
		SET DELETE_PRIVILEGE=@DELPRIV;
		IF UPDATE_PRIVILEGE IS NOT NULL AND INSERT_PRIVILEGE IS NOT NULL AND DELETE_PRIVILEGE IS NOT NULL THEN
	        SET FINAL_PRIVILEGE = (SELECT CONCAT('UPDATE,INSERT,DELETE'));
	    END IF;
		IF INSERT_PRIVILEGE IS NOT NULL AND UPDATE_PRIVILEGE IS NULL AND DELETE_PRIVILEGE IS NULL THEN
	        SET FINAL_PRIVILEGE = (SELECT CONCAT('INSERT'));
	    END IF;
        IF DELETE_PRIVILEGE IS NOT NULL  AND INSERT_PRIVILEGE IS NULL AND UPDATE_PRIVILEGE IS NULL THEN
	        SET FINAL_PRIVILEGE = (SELECT CONCAT('DELETE'));
	    END IF;
	    IF  UPDATE_PRIVILEGE IS NOT NULL  AND INSERT_PRIVILEGE IS NULL AND DELETE_PRIVILEGE IS NULL THEN
	        SET FINAL_PRIVILEGE = (SELECT CONCAT('UPDATE'));
	    END IF;
	    IF UPDATE_PRIVILEGE IS NOT NULL AND INSERT_PRIVILEGE IS NOT NULL AND DELETE_PRIVILEGE IS NULL THEN
	    	SET FINAL_PRIVILEGE = (SELECT CONCAT('UPDATE,INSERT'));
	    END IF;
	    IF INSERT_PRIVILEGE IS NOT NULL AND DELETE_PRIVILEGE IS NOT NULL AND UPDATE_PRIVILEGE IS  NULL THEN
			SET FINAL_PRIVILEGE = (SELECT CONCAT('INSERT,DELETE'));
	    END IF;
	    IF DELETE_PRIVILEGE IS NOT NULL AND UPDATE_PRIVILEGE IS NOT  NULL AND INSERT_PRIVILEGE IS  NULL THEN
	    	SET FINAL_PRIVILEGE = (SELECT CONCAT('DELETE,UPDATE'));
	    END IF;
		IF V_TABLE_NAME IS NOT NULL  THEN
			IF FINAL_PRIVILEGE IS NOT NULL THEN
		    	IF ACTION = 'GRANT' THEN
		    	-- QUERY FOR GIVING GRANT PRIVELEGE TO A TABLE
		    		SET @GRANT_UPDATE_INSERT_DEL = (SELECT CONCAT('GRANT ',FINAL_PRIVILEGE,' ON ',DB_NAME,'.',V_TABLE_NAME,' TO ''',USER_NAME ,'''@','''%'''));
		    		PREPARE UPDATE_INSERT_DEL_STMT FROM @GRANT_UPDATE_INSERT_DEL;
		    		EXECUTE UPDATE_INSERT_DEL_STMT;
		    	
		    		SET @SET_TRG_PERMISSION=(SELECT CONCAT('GRANT trigger ON ',DB_NAME,'.',V_TABLE_NAME,' TO ''',USER_NAME ,'''@','''%'''));
		    		PREPARE SET_TRG_PERMISSION_STMT FROM @SET_TRG_PERMISSION;
		    		EXECUTE SET_TRG_PERMISSION_STMT;
		    	ELSE
		    	-- QUERY FOR REVOKE PRIVELEGE FROM A TABLE
		   			SET @REVOKE_UPDATE_INSERT_DEL =(SELECT CONCAT('REVOKE ',FINAL_PRIVILEGE,' ON ',DB_NAME,'.',V_TABLE_NAME,' FROM ''',USER_NAME ,'''@','''%'''));
		    		PREPARE REVOKE_UPDATE_INSERT_DEL_STMT FROM @REVOKE_UPDATE_INSERT_DEL;
		    		EXECUTE REVOKE_UPDATE_INSERT_DEL_STMT;
		    		SET @SET_REVOKE_PERMISSION=(SELECT CONCAT('REVOKE  TRIGGER ON ',DB_NAME,'.',V_TABLE_NAME,' FROM ''',USER_NAME ,'''@','''%'''));
		    		PREPARE SET_REVOKE_PERMISSION_STMT FROM @SET_REVOKE_PERMISSION;
		    		EXECUTE SET_REVOKE_PERMISSION_STMT;
		    	END IF;
		    END IF;
		END IF;
	SET MIN_PMID = MIN_PMID + 1;
END WHILE;
SET @DROP_TEMP_PM_SP_TABLE=(SELECT CONCAT('DROP TABLE IF EXISTS ',TEMP_PM_UNIQUE_SP_NAMES));
PREPARE DROP_TEMP_PM_SP_TABLE_STMT FROM @DROP_TEMP_PM_SP_TABLE;
EXECUTE DROP_TEMP_PM_SP_TABLE_STMT;
-- TEMP TABLE FOR STORING ALL SP'S NAMES FOR A PASSING MENUS
SET @CREATE_SP_NAMES=(SELECT CONCAT('CREATE TABLE ',TEMP_PM_UNIQUE_SP_NAMES,' (ID INT NOT NULL AUTO_INCREMENT, SPP_ID INT,PRIMARY KEY (ID))'));
PREPARE CREATE_SP_NAMES_STMT FROM @CREATE_SP_NAMES;
EXECUTE CREATE_SP_NAMES_STMT;
-- INSERT QUERY TO STORE ALL SP'S NAMES FOR A PASSING MENUS
SET @SQL = CONCAT('INSERT INTO ',TEMP_PM_UNIQUE_SP_NAMES,'(SPP_ID) SELECT DISTINCT SPP_ID FROM PLATFORM_MANAGEMENT WHERE MP_ID IN (',USER_MENUS,') AND SPP_ID IS NOT NULL');
PREPARE S1 FROM @SQL;
PREPARE S1 FROM @SQL;
EXECUTE S1;
DEALLOCATE PREPARE S1;
	SET @SETCOUNT2=(SELECT CONCAT('SELECT COUNT(*) INTO @COUNT_2 FROM ',TEMP_PM_UNIQUE_SP_NAMES));
	PREPARE SETCOUNT2STMT FROM @SETCOUNT2;
	EXECUTE SETCOUNT2STMT;
	SET COUNT2=@COUNT_2;
	IF COUNT2 > 0 THEN
		L_SP:
		LOOP
		 	SET @SETSPPID=(SELECT CONCAT('SELECT SPP_ID INTO @VSPP_ID FROM ',TEMP_PM_UNIQUE_SP_NAMES,' WHERE ID = ',COUNT2));
		 	PREPARE SETSPPIDSTMT FROM @SETSPPID;
		 	EXECUTE SETSPPIDSTMT;
	 		SET V_SPP_ID=@VSPP_ID;
    		SELECT SPP_NAME INTO V_SP_NAME FROM STORED_PROCEDURE_PROFILE WHERE SPP_ID = V_SPP_ID;
	    	IF V_SP_NAME IS NOT NULL THEN
	    	 	 SET @SPNAME=V_SP_NAME;
	    	 	 	IF ACTION = 'GRANT' THEN
	    	 	 		-- GRANT EXECUTE PERMISSION TO A SP
	      				SET @SET_GRANT_PROCEDURE = (SELECT CONCAT('GRANT EXECUTE ON PROCEDURE ',DB_NAME,'.',V_SP_NAME,' TO ''',USER_NAME ,'''@','''%'''));
	      				PREPARE SET_GRANT_PROCEDURE_STMT FROM @SET_GRANT_PROCEDURE;
	      				EXECUTE SET_GRANT_PROCEDURE_STMT;
	      				DEALLOCATE PREPARE SET_GRANT_PROCEDURE_STMT; 
	    			ELSE
	    				-- REVOKE EXECUTE PERMISSION TO A SP

	      				SET @SET_REVOKE_PROCEDURE = (SELECT CONCAT('REVOKE EXECUTE ON PROCEDURE ',DB_NAME,'.',V_SP_NAME,' FROM ''',USER_NAME ,'''@','''%'''));
	      				PREPARE SET_REVOKE_PROCEDURE_STMT FROM @SET_REVOKE_PROCEDURE;
	      				EXECUTE SET_REVOKE_PROCEDURE_STMT;
	      				DEALLOCATE PREPARE SET_REVOKE_PROCEDURE_STMT;
	   				END IF;
	   		END IF;
	   				 SET COUNT2 = COUNT2 - 1;

		   			IF COUNT2 = 0 THEN
		      			LEAVE L_SP;
		    		END IF;
		END LOOP L_SP;
 	 END IF;
END;
