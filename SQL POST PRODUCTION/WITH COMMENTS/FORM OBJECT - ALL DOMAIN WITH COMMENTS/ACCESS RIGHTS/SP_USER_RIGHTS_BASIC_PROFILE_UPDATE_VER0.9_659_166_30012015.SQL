-- VERSION 0.9 STARTDATE:30/01/2015 ENDDATE:30/01/2015 ISSUE NO:659 COMMENTNO :166 DESC:ADDED ONE EXTRA CONDITION FOR CHECKING COUNT OF THE MENUS  DONE BY :DHIVYA
-- VERSION 0.8 STARTDATE:1/12/08/2014 ENDDATE:11/08/2014 ISSUE NO:659 COMMENTNO :160 DESC:IMPLEMENTED IF BASIC MENUS REMOVED IN BASIC MENU PROFLE,THAT ROLE MENUS REMOVED IN USER_MENU_DETAILS TABLE DONE BY :DHIVYA
-- VERSION 0.7 STARTDATE:11/08/2014 ENDDATE:11/08/2014 ISSUE NO:835 COMMENTNO :66 DESC:IMPLEMENTED SET AUTOCOMMIT=0 BEFORE TRANSACTION. DONE BY :RAJA
-- version 0.6 startdate:10/06/2014 -- enddate:10/06/2014-- - issueno 566 commentno:12-- >desc: ADDED ROLLBACK AND COMMIT-SASIKALA
-- version 0.5 startdate:28/02/2014 -- enddate:28/02/2014-- - issueno 754 commentno:36-- >desc: APPLIED SUB_SP TO REPLACE USERSTAMP AS ID-SAFI
-- version 0.4 -- sdate:27/02/2014 -- edate:27/02/2014 -- issue:754 -- comment:22 -- doneby:RL  
-- VER 0.3 ISSUE NO:659 COMMENT #48 STARTDATE:13/01/2014 ENDDATE:13/01/2014 DESC:SP FOR USER RIGHTS BASIC PROFILE. FIXED THE ISSUE OF DELETE SCRIPT NOT WORKED PROPERLY IN SP BECAUSE OF IN CONDITION. SO USED 'EXECUTE' STATEMENT FOR EXECUTING THE SCRIPT. UPDATE DONE BY:MANIKANDAN.S


DROP PROCEDURE IF EXISTS SP_USER_RIGHTS_BASIC_PROFILE_UPDATE;
CREATE PROCEDURE SP_USER_RIGHTS_BASIC_PROFILE_UPDATE (IN USER_STAMP VARCHAR(50), IN ROLE VARCHAR(255),IN BASIC_ROLES VARCHAR(255), IN MENUS TEXT,OUT UR_FLAG INTEGER, OUT TEMPTABLEDROP TEXT ) 
BEGIN
  -- VARAIBALE DECLARATION
  DECLARE V_URC_ID  INT;
  DECLARE V_STRLEN1    INT DEFAULT 0;
  DECLARE V_STRLEN2    INT DEFAULT 0;
  DECLARE V_STRLEN3    INT DEFAULT 0;
  DECLARE V_SUBSTRLEN1 INT DEFAULT 0;
  DECLARE V_SUBSTRLEN2 INT DEFAULT 0;
  DECLARE V_SUBSTRLEN3 INT DEFAULT 0;
  DECLARE V_MENU_ID   INT;
  DECLARE V_COUNT_1   INT;
  DECLARE V_COUNT_2   INT;
  DECLARE V_BASIC_ROLES_ID2 INT;
  DECLARE V_BASIC_ROLES_ID1 INT;
  DECLARE V_BASIC_ROLE2 VARCHAR(255);  
  DECLARE V_BASIC_ROLE1 VARCHAR(255); 
  DECLARE V_BS_ID TEXT(100) DEFAULT '';
  DECLARE BASIC_ROLES1 VARCHAR(255);
  DECLARE BASIC_ROLES2 VARCHAR(255);
  DECLARE query1 VARCHAR(200);
  DECLARE query2 VARCHAR(300);
  DECLARE USERSTAMP_ID INTEGER(2);
  DECLARE MINID INTEGER;
  DECLARE MAXID INTEGER;
  DECLARE TEMP_TABLE TEXT;
  DECLARE USERNAME VARCHAR(15);
  DECLARE DELETE_MENUS TEXT;
  DECLARE FILEID TEXT;
  DECLARE GRANT_MENUS TEXT;
  DECLARE TEMPTABLE TEXT;
  DECLARE GRANT_TEMP_PM_TABLE TEXT;
  DECLARE GRANT_TEMP_PM_UNIQUE_TABLE TEXT;
  DECLARE GRANT_TEMP_PM_SP_TABLE TEXT;
  DECLARE REVOKE_TEMP_PM_TABLE TEXT;
  DECLARE REVOKE_TEMP_PM_UNIQUE_TABLE TEXT;
  DECLARE REVOKE_TEMP_PM_SP_TABLE TEXT;
  DECLARE G_TEMP_PM_TABLE TEXT;
  DECLARE G_TEMP_PM_UNIQUE_TABLE TEXT;
  DECLARE G_TEMP_PM_SP_TABLE TEXT;
  DECLARE TEMP_DROP TEXT;
  DECLARE MINDROPID INTEGER;
  DECLARE MAXDROPID INTEGER;
  DECLARE TABLENAME TEXT;
  DECLARE DBNAME TEXT;
  DECLARE V_USER_COUNT INTEGER;
  DECLARE MENU_COUNT INTEGER;
  DECLARE EMAILULDID TEXT;
  DECLARE EMAILEPID TEXT;
  DECLARE T_ELID INTEGER;
  DECLARE TEMPTBL_LOGINID TEXT;
  DECLARE TEMP_LOGINID TEXT;
  -- ROLLBACK COMMAND
  DECLARE EXIT HANDLER FOR SQLEXCEPTION
  BEGIN
   ROLLBACK;
   SET UR_FLAG=0;
   -- DROPPING TEMP TABLE INSIDE ROLLBACK
   SET @SETMINDROPID=(SELECT CONCAT('SELECT MIN(ID) INTO @MIN_DROP FROM ',TEMPTABLEDROP));
   PREPARE SETMINDROPIDSTMT FROM @SETMINDROPID;
   EXECUTE SETMINDROPIDSTMT;
   SET MINDROPID=@MIN_DROP;
   SET @SETMAXDROPID=(SELECT CONCAT('SELECT MAX(ID) INTO @MAX_DROP FROM ',TEMPTABLEDROP));
   PREPARE SETMAXDROPIDSTMT FROM @SETMAXDROPID;
   EXECUTE SETMAXDROPIDSTMT;
   SET MAXDROPID=@MAX_DROP;
   WHILE MINDROPID<=MAXDROPID DO
    SET @SETTABLENAME=(SELECT CONCAT('SELECT TABLENAME INTO @TABNAME FROM ',TEMPTABLEDROP,' WHERE ID=',MINDROPID));
    PREPARE SETTABLENAMESTMT FROM @SETTABLENAME;
    EXECUTE SETTABLENAMESTMT;
    SET TABLENAME=@TABNAME;
    IF TABLENAME IS NOT NULL THEN
      SET @DROP_QUERY=(SELECT CONCAT('DROP TABLE IF EXISTS ',TABLENAME));
      PREPARE DROP_QUERY_STMT FROM @DROP_QUERY;
      EXECUTE DROP_QUERY_STMT;
    END IF;
    SET @TABNAME=NULL;
    SET MINDROPID=MINDROPID+1;
  END WHILE;
  IF TEMPTABLEDROP IS NOT NULL THEN
    SET @DROP_QUERY=(SELECT CONCAT('DROP TABLE IF EXISTS ',TEMPTABLEDROP));
      PREPARE DROP_QUERY_STMT FROM @DROP_QUERY;
      EXECUTE DROP_QUERY_STMT;
  END IF;
  SET TEMPTABLEDROP=NULL;
END;
START TRANSACTION;
SET AUTOCOMMIT = 0;
SET V_URC_ID = (SELECT URC_ID FROM USER_RIGHTS_CONFIGURATION WHERE URC_DATA = ROLE);
-- SUB SP FOR CONVERTING USERSTAMP INTO ULD_ID
CALL SP_CHANGE_USERSTAMP_AS_ULDID(USER_STAMP,@ULDID);
SET USERSTAMP_ID = (SELECT @ULDID);
SET UR_FLAG=0;
IF BASIC_ROLES IS NULL THEN
    SET BASIC_ROLES = '';
END IF;
  SET BASIC_ROLES1 = BASIC_ROLES;
  DO_THIS_DELETE:
  LOOP
    SET V_STRLEN1 = CHAR_LENGTH(BASIC_ROLES1); 
    SET V_BASIC_ROLE1 = SUBSTRING_INDEX(BASIC_ROLES1, ',', 1); 
    SET V_BASIC_ROLES_ID1 = (SELECT URC_ID FROM USER_RIGHTS_CONFIGURATION WHERE URC_DATA = V_BASIC_ROLE1);
    SET V_BS_ID = CONCAT (V_BS_ID,"'",V_BASIC_ROLES_ID1,"',");
    SET V_SUBSTRLEN1 = CHAR_LENGTH(SUBSTRING_INDEX(BASIC_ROLES1, ',', 1)) + 2;
    SET BASIC_ROLES1 = MID(BASIC_ROLES1, V_SUBSTRLEN1, V_STRLEN1);
    IF BASIC_ROLES1 = '' THEN
      LEAVE DO_THIS_DELETE;
    END IF;
  END LOOP DO_THIS_DELETE;
  SET V_BS_ID = SUBSTRING(V_BS_ID,1,(CHAR_LENGTH(V_BS_ID)-1) );
  -- DELETE QUERY FOR BASIC_MENU_PROFILE
  SET @query1 = CONCAT('DELETE FROM BASIC_ROLE_PROFILE WHERE BRP_BR_ID NOT IN (', V_BS_ID ,') AND URC_ID =',V_URC_ID);
  PREPARE stmt1 FROM @query1;
  EXECUTE stmt1;
  DEALLOCATE PREPARE stmt1;
  SET UR_FLAG=1;
  DO_THIS_FIRST:
  LOOP
    SET V_STRLEN2 = CHAR_LENGTH(BASIC_ROLES); 
    SET V_BASIC_ROLE2 = SUBSTRING_INDEX(BASIC_ROLES, ',', 1); 
    SET V_BASIC_ROLES_ID2 = (SELECT URC_ID FROM USER_RIGHTS_CONFIGURATION WHERE URC_DATA = V_BASIC_ROLE2);
    SELECT COUNT(BRP_ID) INTO V_COUNT_1 FROM BASIC_ROLE_PROFILE WHERE BRP_BR_ID = V_BASIC_ROLES_ID2 AND URC_ID = V_URC_ID;
     IF (V_COUNT_1 = 0) THEN
     -- INSERT QUERY FOR BASIC_ROLE_PROFILE
     INSERT INTO BASIC_ROLE_PROFILE (URC_ID, BRP_BR_ID, ULD_ID) VALUES (V_URC_ID, V_BASIC_ROLES_ID2, USERSTAMP_ID);
     END IF;
     SET UR_FLAG=1;
    SET V_SUBSTRLEN2 = CHAR_LENGTH(SUBSTRING_INDEX(BASIC_ROLES, ',', 1)) + 2;
    SET BASIC_ROLES = MID(BASIC_ROLES, V_SUBSTRLEN2, V_STRLEN2);
    IF BASIC_ROLES = '' THEN
      LEAVE DO_THIS_FIRST;
    END IF;
  END LOOP DO_THIS_FIRST;
  IF MENUS IS NULL THEN
    SET MENUS = '';
  END IF;
  SET @CHECK_COUNT=(SELECT CONCAT('SELECT COUNT(*) INTO @MENUCOUNT FROM BASIC_MENU_PROFILE WHERE MP_ID NOT IN (',MENUS,') AND URC_ID =', V_URC_ID));
  PREPARE CHECK_COUNT_STMT FROM @CHECK_COUNT;
  EXECUTE CHECK_COUNT_STMT;
  SET MENU_COUNT=@MENUCOUNT;
  -- DELETE QUERY FOR BASIC_MENU_PROFILE
   SET @query2 = CONCAT('DELETE FROM BASIC_MENU_PROFILE WHERE MP_ID NOT IN (',MENUS,') AND URC_ID =', V_URC_ID);
   PREPARE stmt2 FROM @query2;
   EXECUTE stmt2;
   DEALLOCATE PREPARE stmt2;
   SET @CHECKFLAG=1;
IF MENU_COUNT>0 THEN
  SET TEMP_TABLE=(SELECT CONCAT('TEMP_DELETE_MENUS',SYSDATE()));
  SET TEMP_TABLE=(SELECT REPLACE(TEMP_TABLE,' ',''));
  SET TEMP_TABLE=(SELECT REPLACE(TEMP_TABLE,'-',''));
  SET TEMP_TABLE=(SELECT REPLACE(TEMP_TABLE,':',''));
  SET TEMPTABLE=(SELECT CONCAT(TEMP_TABLE,'_',USERSTAMP_ID));
  SET TEMP_DROP=(SELECT CONCAT('TEMP_DROP_TABLE',SYSDATE()));
  SET TEMP_DROP=(SELECT REPLACE(TEMP_DROP,' ',''));
  SET TEMP_DROP=(SELECT REPLACE(TEMP_DROP,'-',''));
  SET TEMP_DROP=(SELECT REPLACE(TEMP_DROP,':',''));
  SET TEMP_DROP=(SELECT CONCAT(TEMP_DROP,'_',USERSTAMP_ID));
  SET TEMPTABLEDROP=(SELECT CONCAT(TEMP_DROP,'_',USERSTAMP_ID));
  SET @CREATE_QUERY=(SELECT CONCAT('CREATE TABLE ',TEMPTABLEDROP,'(ID INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,TABLENAME TEXT)'));
  PREPARE CREATE_QUERY_STMT FROM @CREATE_QUERY;
  EXECUTE CREATE_QUERY_STMT;
  SET @CREATE_QUERY=(SELECT CONCAT('CREATE TABLE ',TEMPTABLE,'(ID INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,RCID INTEGER NOT NULL)'));
  PREPARE CREATE_QUERY_STMT FROM @CREATE_QUERY;
  EXECUTE CREATE_QUERY_STMT;
  DEALLOCATE PREPARE CREATE_QUERY_STMT;
  -- QUERY FOR STORING DYNAMIC TEMP TABLE IN A TABLE
  SET @INSERT_TEMP_QUERY=(SELECT CONCAT('INSERT INTO ',TEMPTABLEDROP,'(TABLENAME)VALUES(','"',TEMPTABLE,'"',')'));
  PREPARE INSERT_TEMP_QUERY_STMT FROM @INSERT_TEMP_QUERY;
  EXECUTE INSERT_TEMP_QUERY_STMT;
  SET @INSERT_QUERY=(SELECT CONCAT('INSERT INTO ',TEMPTABLE,'(RCID)SELECT DISTINCT RC_ID FROM ROLE_CREATION WHERE URC_ID=',V_URC_ID));
  PREPARE INSERT_QUERY_STMT FROM @INSERT_QUERY;
  EXECUTE INSERT_QUERY_STMT;
  DEALLOCATE PREPARE INSERT_QUERY_STMT;
  SET @SETMINID=(SELECT CONCAT('SELECT MIN(ID) INTO @MIN_ID FROM ',TEMPTABLE));
  PREPARE SETMINIDSTMT FROM @SETMINID;
  EXECUTE SETMINIDSTMT;
  SET MINID=@MIN_ID;
  SET @SETMAXID=(SELECT CONCAT('SELECT MAX(ID) INTO @MAX_ID FROM ',TEMPTABLE));
  PREPARE SETMAXID FROM @SETMAXID;
  EXECUTE SETMAXID;
  SET MAXID=@MAX_ID;
   SET @CHECKFLAG=2;
  SET @COUNT=0;
  WHILE MINID<=MAXID DO 
    SET @SETRCID=(SELECT CONCAT('SELECT RCID INTO @USERID FROM ',TEMPTABLE,' WHERE ID=',MINID));
    PREPARE SETRCIDSTMT FROM @SETRCID;
    EXECUTE SETRCIDSTMT;
    DEALLOCATE PREPARE SETRCIDSTMT;
    SET USERNAME=(SELECT RC_NAME FROM ROLE_CREATION WHERE RC_ID=@USERID);
    SET @SETDELETE_MENUS=(SELECT CONCAT('SELECT GROUP_CONCAT(DISTINCT MP_ID ORDER BY MP_ID ASC SEPARATOR ",") INTO @G_MENUS FROM USER_MENU_DETAILS WHERE RC_ID=@USERID AND MP_ID  IN (',MENUS,')'));
    PREPARE SETDELETE_MENUS_STMT FROM @SETDELETE_MENUS;
    EXECUTE SETDELETE_MENUS_STMT;
    SET GRANT_MENUS=@G_MENUS ;
     SET @CHECKFLAG=3;
  select count(user) into V_USER_COUNT from mysql.user WHERE USER = USERNAME;
  IF V_USER_COUNT>0 THEN
    SET @DROP_QUERY=(SELECT CONCAT('DROP USER ''',USERNAME,'''@','''%'''));
    PREPARE DROP_QUERY_STMT FROM @DROP_QUERY;
    EXECUTE DROP_QUERY_STMT;
  END IF;
  -- CREATE USER QUERY
  SET @sql = CONCAT('CREATE USER ''',USERNAME,'''@','''%''',' IDENTIFIED BY ''',USERNAME,"'");
  PREPARE s1 FROM @sql;
  EXECUTE s1;
  DEALLOCATE PREPARE s1;
  SET @CHECKFLAG=4;
  IF GRANT_MENUS IS NOT NULL THEN
      CALL SP_PLATFORM_MGMT_DB_USER_RIGHTS_GRANT_REVOKE((SELECT DATABASE()), USERNAME, GRANT_MENUS,'GRANT',USERSTAMP_ID,@G_TEMP_PM_UNIQUE_TABLE_NAMES,@G_TEMP_UNIQUE_TABLE_NAMES,@G_TEMP_PM_UNIQUE_SP_NAMES);
      SET G_TEMP_PM_TABLE=@G_TEMP_UNIQUE_TABLE_NAMES;
      SET G_TEMP_PM_UNIQUE_TABLE =@G_TEMP_PM_UNIQUE_TABLE_NAMES;
      SET G_TEMP_PM_SP_TABLE=@G_TEMP_PM_UNIQUE_SP_NAMES;
      IF G_TEMP_PM_TABLE IS NOT NULL THEN
      SET @INSERT_TEMP_QUERY=(SELECT CONCAT('INSERT INTO ',TEMPTABLEDROP,'(TABLENAME)VALUES(','"',G_TEMP_PM_TABLE,'"',')'));
      PREPARE INSERT_TEMP_QUERY_STMT FROM @INSERT_TEMP_QUERY;
      EXECUTE INSERT_TEMP_QUERY_STMT;
      END IF;
      IF G_TEMP_PM_UNIQUE_TABLE IS NOT NULL THEN
      SET @INSERT_TEMP_QUERY=(SELECT CONCAT('INSERT INTO ',TEMPTABLEDROP,'(TABLENAME)VALUES(','"',G_TEMP_PM_UNIQUE_TABLE,'"',')'));
      PREPARE INSERT_TEMP_QUERY_STMT FROM @INSERT_TEMP_QUERY;
      EXECUTE INSERT_TEMP_QUERY_STMT;
      END IF;
      IF G_TEMP_PM_SP_TABLE IS NOT NULL THEN
      SET @INSERT_TEMP_QUERY=(SELECT CONCAT('INSERT INTO ',TEMPTABLEDROP,'(TABLENAME)VALUES(','"',G_TEMP_PM_SP_TABLE,'"',')'));
      PREPARE INSERT_TEMP_QUERY_STMT FROM @INSERT_TEMP_QUERY;
      EXECUTE INSERT_TEMP_QUERY_STMT;
      END IF;
  END IF;
    SET @USERID=NULL;
    SET @DEL_MENUS=NULL;
    SET @G_MENUS=NULL;
     SET @COUNT=@COUNT+1;
    SET MINID=MINID+1;
  END WHILE;
END IF;
  SET @SETFILEID=(SELECT CONCAT('SELECT GROUP_CONCAT(FP_ID)INTO @FILE_ID FROM MENU_PROFILE WHERE MP_ID IN (',MENUS,') AND FP_ID IS NOT NULL'));
  PREPARE SETFILEIDSTMT FROM @SETFILEID;
  EXECUTE SETFILEIDSTMT;
  SET FILEID=@FILE_ID;
  IF FILEID IS NOT NULL THEN
  -- QUERY FOR REMOVING FILEID FROM USER_FILE_DETAILS
  SET @SQL_UFD=(SELECT CONCAT('DELETE FROM USER_FILE_DETAILS WHERE RC_ID IN (SELECT RC_ID FROM ROLE_CREATION WHERE URC_ID=',V_URC_ID,') AND FP_ID NOT IN (',FILEID,')'));
  PREPARE SQLSTMT  FROM @SQL_UFD;
  EXECUTE SQLSTMT;
  END IF;
  -- QUERY FOR REMOVING MENUID IN USER_MENU_DETAILS
  SET @SQLUMD=(SELECT CONCAT('DELETE FROM USER_MENU_DETAILS WHERE RC_ID IN (SELECT RC_ID FROM ROLE_CREATION WHERE URC_ID=',V_URC_ID,') AND MP_ID NOT IN (',MENUS,')'));
  PREPARE SQL1STMT FROM @SQLUMD;
  EXECUTE SQL1STMT;
SET @CHECKFLAG=5;
 DO_THIS:
  LOOP
    SET V_STRLEN3 = CHAR_LENGTH(MENUS);
    SET V_MENU_ID = SUBSTRING_INDEX(MENUS, ',', 1);
    SELECT COUNT(BMP_ID) INTO V_COUNT_2 FROM BASIC_MENU_PROFILE WHERE MP_ID = V_MENU_ID AND URC_ID = V_URC_ID;
    IF (V_COUNT_2 = 0) THEN
    -- INSERT QUERY FOR BASIC_MENU_PROFILE
    INSERT INTO BASIC_MENU_PROFILE (URC_ID, MP_ID, ULD_ID) VALUES (V_URC_ID, V_MENU_ID, USERSTAMP_ID);    
    END IF;
    SET UR_FLAG=1;
    SET V_SUBSTRLEN3 = CHAR_LENGTH(SUBSTRING_INDEX(MENUS, ',', 1)) + 2;
    SET MENUS = MID(MENUS, V_SUBSTRLEN3, V_STRLEN3);
    IF MENUS = '' THEN
      LEAVE DO_THIS;
    END IF;
  END LOOP DO_THIS;
SET UR_FLAG=1;
END;
