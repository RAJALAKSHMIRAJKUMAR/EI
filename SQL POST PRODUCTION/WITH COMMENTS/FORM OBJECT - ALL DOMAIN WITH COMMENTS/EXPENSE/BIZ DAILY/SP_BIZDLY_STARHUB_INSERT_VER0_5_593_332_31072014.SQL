--version:0.5 --sdate:31/07/2014 --edate:31/07/2014 --issue:593 --comment no#332 --desc:CHANGED CONDITIONS FOR TO PERIOD  --doneby:DHIVYA
-- > VERSION:0.4 -->STARTDATE:20/03/2014 -->ENDDATE20/03/2014 -->ISSUE NO:535 -->COMMENT NO:#280-->DESC:REPLACED ECN_DATA INTO ECN_ID IN PASSING PARAMETER,BUT SHOW ECN_DATA WHEN THE RECORD IS NOT SAVED-->DONE BY SARADAMBAL
-- > VERSION:0.3 -- >STARTDATE:17/03/2014 -- >ENDDATE17/03/2014 -- >ISSUE NO:762 -- >COMMENT NO:#8 -- >DESC:IMPLEMENTING THE UPDATE SUCCESS FLAG  -- >DONEBY:BHAVANI.R
-- > VERSION:0.2 -- >STARTDATE:15/03/2014 -- >ENDDATE15/03/2014 -- >ISSUE NO:535 -- >COMMENT NO:#253 -- >DESC:CHECKING MANDATORY FIELDS NULL OR NOT NULL IN SUB SP -- >DONEBY:BHAVANI.R
-- > VERSION:0.1 -- >STARTDATE:13/03/2014 -- >ENDDATE14/03/2014 -- >ISSUE NO:535 -- >COMMENT NO:232 -- >DESC:CREATION OF SP SP_EXPENSE_BIZDLY_STARHUB_INSERT FOR MULTIROW INSERTION  -- >DONEBY:BHAVANI.R
DROP PROCEDURE IF EXISTS SP_BIZDLY_STARHUB_INSERT;
CREATE PROCEDURE  SP_BIZDLY_STARHUB_INSERT(
IN UNITNO TEXT,
IN ECN_ID_NEW TEXT,
IN INVOICEDATE TEXT,
IN FROMPERIOD TEXT,
IN TOPERIOD TEXT,
IN AMOUNT TEXT,
IN COMMENTS TEXT,
IN USERSTAMP VARCHAR(50),
OUT FINALMESSAGE TEXT)

BEGIN
--  VARIABLE DECLARATION
DECLARE USERSTAMP_ID INTEGER(2);
DECLARE ESUNITNO TEXT;
DECLARE ESINVOICEID TEXT;
DECLARE ESINVOICEDATE DATE;
DECLARE ESFROMPERIOD DATE;
DECLARE ESTOPERIOD  DATE;
DECLARE ESAMOUNT  DECIMAL(7,2);
DECLARE ESCOMMENTS TEXT;
DECLARE SUBSPSUCCESSFLAG INTEGER;
DECLARE ESINVOICECHECK TEXT;
DECLARE ERROR_MSG TEXT;
--  QUERY FOR ROLLBACK COMMAND
DECLARE EXIT HANDLER FOR SQLEXCEPTION
BEGIN 
ROLLBACK; 
END;
SET AUTOCOMMIT=0;
START TRANSACTION;	
SET FINALMESSAGE = '';
--  QUERY FOR SET PASSING VALUES IN TEMP VARIABLE
SET @TEMP_UNITNO = UNITNO;
SET @TEMP_INVOICEID = ECN_ID_NEW;
SET @TEMP_INVOICEDATE = INVOICEDATE;
SET @TEMP_FROMPERIOD = FROMPERIOD;
SET @TEMP_TOPERIOD = TOPERIOD;
SET @TEMP_AMOUNT = AMOUNT;
SET @TEMP_COMMENTS = COMMENTS;
--  LOOP FOR CALLING SP FOR SEPERATING SPECIAL CHARACTER VALUES
MAIN_LOOP : LOOP
--  UNITNO
	CALL SP_GET_SPECIAL_CHARACTER_SEPERATED_VALUES(',',@TEMP_UNITNO,@VALUE,@REMAINING_STRING);
	SELECT @VALUE INTO ESUNITNO;
	SELECT @REMAINING_STRING INTO @TEMP_UNITNO;
--  INVOICEID
	CALL SP_GET_SPECIAL_CHARACTER_SEPERATED_VALUES(',',@TEMP_INVOICEID,@VALUE,@REMAINING_STRING);
	SELECT @VALUE INTO ESINVOICEID;
	SELECT @REMAINING_STRING INTO @TEMP_INVOICEID;
--  INVOICEDATE
	CALL SP_GET_SPECIAL_CHARACTER_SEPERATED_VALUES(',',@TEMP_INVOICEDATE,@VALUE,@REMAINING_STRING);
	SELECT @VALUE INTO ESINVOICEDATE;
	SELECT @REMAINING_STRING INTO @TEMP_INVOICEDATE;
--  FROMPERIOD
	CALL SP_GET_SPECIAL_CHARACTER_SEPERATED_VALUES(',',@TEMP_FROMPERIOD,@VALUE,@REMAINING_STRING);
	SELECT @VALUE INTO ESFROMPERIOD;
	SELECT @REMAINING_STRING INTO @TEMP_FROMPERIOD;
--  TOPERIOD
	CALL SP_GET_SPECIAL_CHARACTER_SEPERATED_VALUES(',',@TEMP_TOPERIOD,@VALUE,@REMAINING_STRING);
	SELECT @VALUE INTO ESTOPERIOD;
	SELECT @REMAINING_STRING INTO @TEMP_TOPERIOD;
--  AMOUNT
	CALL SP_GET_SPECIAL_CHARACTER_SEPERATED_VALUES(',',@TEMP_AMOUNT,@VALUE,@REMAINING_STRING);
	SELECT @VALUE INTO ESAMOUNT;
	SELECT @REMAINING_STRING INTO @TEMP_AMOUNT;
--  COMMENTS
	CALL SP_GET_SPECIAL_CHARACTER_SEPERATED_VALUES('^^',@TEMP_COMMENTS,@VALUE,@REMAINING_STRING);
	SELECT @VALUE INTO ESCOMMENTS;
	SELECT @REMAINING_STRING INTO @TEMP_COMMENTS;
	
--  QUERY FOR CALLING SUB SP FOR INSERT
	IF(ESUNITNO IS NOT NULL AND ESINVOICEID IS NOT NULL AND ESINVOICEDATE IS NOT NULL AND ESFROMPERIOD IS NOT NULL AND ESTOPERIOD IS NOT NULL AND ESAMOUNT IS NOT NULL AND USERSTAMP IS NOT NULL)THEN 
		CALL SP_BIZDLY_SUBSTARHUB_INSERT(ESUNITNO,ESINVOICEID,ESINVOICEDATE,ESFROMPERIOD,ESTOPERIOD,ESAMOUNT,ESCOMMENTS,USERSTAMP,@STARHUB_SUCCESSFLAG,@STARHUB_UPDATEFLAG,@OUTPUT_MSG);
		SET SUBSPSUCCESSFLAG = (SELECT @STARHUB_SUCCESSFLAG);
		SET ERROR_MSG=(SELECT @OUTPUT_MSG);
	END IF;
--  QUERY FOR THROWING ERROR MESSAGE
        -- INSTEAD OF SHOWING ECN_DATA WHILE ERROR OCCURING
        IF NOT (ESINVOICEID ='SELECT') THEN 
          SET ESINVOICECHECK=(SELECT ECN_DATA FROM EXPENSE_CONFIGURATION WHERE ECN_ID=ESINVOICEID);
         ELSE
          SET ESINVOICECHECK='';
        END IF;
	IF(SUBSPSUCCESSFLAG=0) OR (ERROR_MSG!=' ') THEN
		SET FINALMESSAGE = (SELECT CONCAT(FINALMESSAGE,' ','UNIT_NO=',ESUNITNO,',INVOICETO=',ESINVOICECHECK,',INVOICEDATE=',ESINVOICEDATE,',FROMPERIOD=',ESFROMPERIOD,',TOPERIOD=',ESTOPERIOD,',AMOUNT=',ESAMOUNT,',COMMENTS=',ESCOMMENTS,',USERSTAMP=',USERSTAMP,'/ WARNING: ',ERROR_MSG,'//    '));
	END IF;
	IF @TEMP_UNITNO IS NULL THEN
		LEAVE  MAIN_LOOP;
	END IF;
	END LOOP;
	IF(FINALMESSAGE = '')THEN
		SET FINALMESSAGE = 1;
	END IF;
COMMIT;
END;