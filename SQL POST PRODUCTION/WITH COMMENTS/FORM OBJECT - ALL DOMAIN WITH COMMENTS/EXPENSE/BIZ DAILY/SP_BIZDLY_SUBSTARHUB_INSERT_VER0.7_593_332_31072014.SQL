--version:0.7 --sdate:31/07/2014 --edate:31/07/2014 --issue:593 --comment no#332 --desc:CHANGED CONDITIONS FOR TO PERIOD  --doneby:DHIVYA
--version:0.6--sdate:22/07/2014 --edate:25/07/2014 --issue:593 --comment no#314 --desc:IMPLEMENTED ALL CHECK CONSTRAINTS CONDITIONS  --doneby:DHIVYA
--> VERSION:0.5 -->STARTDATE:05/04/2014 -->ENDDATE05/04/2014 -->ISSUE NO:535 -->COMMENT NO:#300-->DESC:CORRECTED UPDATE QUERY-->DONE BY SARADAMBAL
--> VERSION:0.4 -->STARTDATE:20/03/2014 -->ENDDATE20/03/2014 -->ISSUE NO:535 -->COMMENT NO:#280-->DESC:REPLACED ECN_DATA INTO ECN_ID IN PASSING PARAMETER,BUT SHOW ECN_DATA WHEN THE RECORD IS NOT SAVED-->DONE BY SARADAMBAL
--> VERSION:0.3 -->STARTDATE:17/03/2014 -->ENDDATE17/03/2014 -->ISSUE NO:762 -->COMMENT NO:#8 -->DESC:IMPLEMENTING THE UPDATE SUCCESS FLAG  -->DONEBY:BHAVANI.R
--> VERSION:0.2 -->STARTDATE:15/03/2014 -->ENDDATE15/03/2014 -->ISSUE NO:535 -->COMMENT NO:253 -->DESC:CHECKING MANDATORY FIELDS ARE NULL OR NOT NULL  -->DONEBY:BHAVANI.R
--> VERSION:0.1 -->STARTDATE:13/03/2014 -->ENDDATE14/03/2014 -->ISSUE NO:535 -->COMMENT NO:232 -->DESC:CREATION OF SP SP_SUB_EXPENSE_BIZDLY_STARHUB_INSERT FOR MULTIROW INSERTION  -->DONEBY:BHAVANI.R

DROP PROCEDURE IF EXISTS SP_BIZDLY_SUBSTARHUB_INSERT;
CREATE PROCEDURE SP_BIZDLY_SUBSTARHUB_INSERT(
IN UNIT_NUMBER TEXT,
IN ECN_ID_NEW TEXT,
IN INVOICE_DATE DATE,
IN FROM_PERIOD DATE,
IN TO_PERIOD DATE,
IN AMOUNT DECIMAL(7,2),
IN COMMENTS TEXT,
IN USERSTAMP VARCHAR(50),
OUT STARHUB_SUCCESSFLAG INTEGER,
OUT STARHUB_UPDATEFLAG INTEGER,
OUT OUTPUT_MSG TEXT)
BEGIN
-- DECLARING VARIABLES
DECLARE ECNID TEXT;
DECLARE EDSHID TEXT;
DECLARE USERSTAMP_ID INTEGER(2);
DECLARE YEAR_INVDATE INTEGER;
DECLARE MONTHNAME VARCHAR(20);
DECLARE MONTH_YEAR VARCHAR(25);
DECLARE OLDINVDATE DATE;
DECLARE ERRORMSG TEXT;
DECLARE MONTH_INVDATE INTEGER;
DECLARE TODAYDATE DATE;
DECLARE UNITID INTEGER;
DECLARE UNITSTARTDATE DATE;
DECLARE SHUB_UNITNO INTEGER(4) UNSIGNED ZEROFILL;
DECLARE UNITMONTH INTEGER;
DECLARE MINDATE DATE;
DECLARE MAXDATE DATE;
DECLARE UNITENDDATE DATE;
DECLARE TO_PERIOD_ENDDATE DATE;
-- QUERY FOR ROLLBACK COMMAND
DECLARE EXIT HANDLER FOR SQLEXCEPTION
BEGIN 
ROLLBACK; 
SET STARHUB_SUCCESSFLAG=0;
SET STARHUB_UPDATEFLAG=0;
END;
SET AUTOCOMMIT=0;
SET MONTH_INVDATE=(SELECT MONTH(INVOICE_DATE));
SET YEAR_INVDATE=(SELECT YEAR(INVOICE_DATE));
SET MONTHNAME=(SELECT UCASE(MONTHNAME(STR_TO_DATE(MONTH_INVDATE, '%m'))));
SET MONTH_YEAR=(SELECT CONCAT(MONTHNAME,'-',YEAR_INVDATE));
SET ERRORMSG=(SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=472);
SET UNITID=(SELECT UNIT_ID FROM UNIT WHERE UNIT_NO=UNIT_NUMBER); 
SET SHUB_UNITNO=(SELECT UNIT_NO FROM UNIT WHERE UNIT_ID=UNITID);
SET ERRORMSG=(SELECT REPLACE(ERRORMSG,'[UNITNO]',SHUB_UNITNO));
SET ERRORMSG=(SELECT REPLACE(ERRORMSG,'[MONTH]',MONTH_YEAR));
SET TO_PERIOD_ENDDATE=(SELECT DATE_ADD(FROM_PERIOD,INTERVAL 2 MONTH));
SET TO_PERIOD_ENDDATE=(SELECT LAST_DAY(TO_PERIOD_ENDDATE));
CALL SP_CONFIG_SDATE_EDATE(UNITID,@S_CONFIGDATE,@E_CONFIGDATE,@INVOICE_DATE);
SET UNITSTARTDATE=@S_CONFIGDATE;
SET UNITENDDATE=@E_CONFIGDATE;
SET MAXDATE=@INVOICE_DATE;
SET TODAYDATE=CURDATE();
SET OUTPUT_MSG=' ';
IF (INVOICE_DATE>TODAYDATE) THEN
    SET OUTPUT_MSG=(SELECT CONCAT(OUTPUT_MSG,',',(SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=474)));
END IF;
SET MINDATE=UNITSTARTDATE;
IF TO_PERIOD_ENDDATE>UNITENDDATE THEN
SET TO_PERIOD_ENDDATE=UNITENDDATE;
END IF;
IF INVOICE_DATE NOT BETWEEN MINDATE AND MAXDATE THEN 
    SET OUTPUT_MSG=(SELECT CONCAT(OUTPUT_MSG,',',(SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=475)));
END IF;
IF FROM_PERIOD NOT BETWEEN MINDATE AND UNITENDDATE THEN
    SET OUTPUT_MSG=(SELECT CONCAT(OUTPUT_MSG,',',(SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=476)));
END IF;
IF TO_PERIOD NOT BETWEEN FROM_PERIOD AND TO_PERIOD_ENDDATE THEN
    SET OUTPUT_MSG=(SELECT CONCAT(OUTPUT_MSG,',',(SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=477)));
END IF;
IF EXISTS(SELECT * FROM EXPENSE_STARHUB WHERE MONTH(ESH_INVOICE_DATE)=MONTH_INVDATE AND YEAR(ESH_INVOICE_DATE)=YEAR_INVDATE AND EDSH_ID IN(SELECT EDSH_ID FROM EXPENSE_DETAIL_STARHUB WHERE UNIT_ID=UNITID))THEN
SET @FLAG=1;
SET OUTPUT_MSG=(SELECT CONCAT(OUTPUT_MSG,',',ERRORMSG));
END IF;
SET OUTPUT_MSG=(SELECT SUBSTRING(OUTPUT_MSG,2));
-- QUERY FOR SET NULL FOR UNIT_NUMBER
	IF(UNIT_NUMBER='' OR UNIT_NUMBER IS NULL)THEN
		SET UNIT_NUMBER = NULL;
	END IF;
-- QUERY FOR SET NULL FOR ECN_ID_NEW
	IF(ECN_ID_NEW='' OR ECN_ID_NEW IS NULL OR ECN_ID_NEW='SELECT')THEN
		SET ECN_ID_NEW = NULL;
	END IF;
-- QUERY FOR SET NULL FOR INVOICE_DATE
	IF(INVOICE_DATE='' OR INVOICE_DATE IS NULL)THEN
		SET INVOICE_DATE = NULL;
	END IF;
-- QUERY FOR SET NULL FOR FROM_PERIOD
	IF(FROM_PERIOD='' OR FROM_PERIOD IS NULL)THEN
		SET FROM_PERIOD = NULL;
	END IF;
-- QUERY FOR SET NULL FOR UNIT_NUMBER	
	IF(TO_PERIOD='' OR TO_PERIOD IS NULL)THEN
		SET TO_PERIOD = NULL;
	END IF;
-- QUERY FOR SET NULL FOR AMOUNT	
	IF(AMOUNT='' OR AMOUNT IS NULL)THEN
		SET AMOUNT = NULL;
	END IF;
-- QUERY FOR SET NULL FOR COMMENTS	
	IF(COMMENTS='' OR COMMENTS IS NULL)THEN
		SET COMMENTS = NULL;
	END IF;
-- QUERY FOR SET NULL FOR USERSTAMP	
	IF(USERSTAMP='' OR USERSTAMP IS NULL)THEN
		SET USERSTAMP = NULL;
	END IF;
-- QUERY FOR START TRANSACTION
-- START TRANSACTION;
SET STARHUB_SUCCESSFLAG=0;
SET STARHUB_UPDATEFLAG=0;
-- SP FOR CHANGING USERSTAMP INTO ULD_ID
	CALL SP_CHANGE_USERSTAMP_AS_ULDID(USERSTAMP,@ULDID);
    SET USERSTAMP_ID = (SELECT @ULDID);
-- QUERY FOR GETTING ECN_ID AND EDSH_ID
	SET EDSHID = (SELECT MAX(EDSH_ID) FROM EXPENSE_DETAIL_STARHUB WHERE UNIT_ID = (SELECT UNIT_ID FROM UNIT WHERE UNIT_NO=UNIT_NUMBER));
	SET ECNID = (SELECT ECN_ID FROM EXPENSE_DETAIL_STARHUB WHERE EDSH_ID = EDSHID);
-- UPDATE QUERY FOR EXPENSE_DETAIL_STARHUB TABLE
        IF  ECNID IS NULL THEN
			IF OUTPUT_MSG=' ' THEN
            UPDATE EXPENSE_DETAIL_STARHUB SET ECN_ID=ECN_ID_NEW , ULD_ID=USERSTAMP_ID WHERE EDSH_ID=EDSHID ;
            SET STARHUB_UPDATEFLAG=1;
			END IF;
        END IF;
-- INSERT QUERY FOR EXPENSE_STARHUB TABLE
		IF(UNIT_NUMBER IS NOT NULL AND ECN_ID_NEW IS NOT NULL AND INVOICE_DATE IS NOT NULL AND FROM_PERIOD IS NOT NULL AND TO_PERIOD IS NOT NULL AND USERSTAMP IS NOT NULL) THEN  
			IF OUTPUT_MSG=' ' THEN
			INSERT INTO EXPENSE_STARHUB (EDSH_ID,ESH_INVOICE_DATE,ESH_FROM_PERIOD,ESH_TO_PERIOD,ESH_AMOUNT,ESH_COMMENTS,ULD_ID)VALUES (EDSHID,INVOICE_DATE,FROM_PERIOD,TO_PERIOD,AMOUNT,COMMENTS,USERSTAMP_ID);
			SET STARHUB_SUCCESSFLAG=1;
			ELSE
			SET STARHUB_SUCCESSFLAG=0;
			END IF;
        END IF;
END;