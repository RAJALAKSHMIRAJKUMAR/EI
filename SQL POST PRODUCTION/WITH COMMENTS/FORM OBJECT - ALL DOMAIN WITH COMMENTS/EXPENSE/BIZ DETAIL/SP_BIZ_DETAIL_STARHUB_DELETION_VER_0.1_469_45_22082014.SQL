-- version 0.1 --sadte:22/08/2014 --edate:22/08/2014 --issue:469 --commentno:45 --desc:DELETION FOR EXPENSE_DETAIL_STARHUB --done by :SARADAMBAL
DROP PROCEDURE IF EXISTS SP_BIZ_DETAIL_STARHUB_DELETION;
CREATE PROCEDURE SP_BIZ_DETAIL_STARHUB_DELETION(IN TABLE_ID INT, IN ROW_ID INT,IN V_USERSTAMP VARCHAR(50))
BEGIN
DECLARE UNITID INT DEFAULT NOT NULL;
DECLARE ECNID TEXT DEFAULT NULL;
DECLARE EDSH_RECVER INT DEFAULT NOT NULL;
DECLARE EDSH_ACCOUNTNO varchar(11) DEFAULT NOT NULL;
DECLARE EDSH_APPLDATE TEXT DEFAULT NULL;
DECLARE EDSH_CABLE_STARTDATE TEXT DEFAULT NULL;
DECLARE EDSH_CABLE_ENDDATE TEXT DEFAULT NULL;
DECLARE EDSH_INTERNET_STARTDATE TEXT DEFAULT NULL;
DECLARE EDSH_INTERNET_ENDDATE TEXT DEFAULT NULL;
DECLARE EDSHSSID varchar(25) DEFAULT NULL;
DECLARE EDSHPWD varchar(25) DEFAULT NULL;
DECLARE EDSH_CABLEBOXSERIALNO varchar(50) DEFAULT NULL;
DECLARE EDSH_MODEMSERIALNO varchar(50) DEFAULT NULL;
DECLARE EDSH_BASICGROUP TEXT DEFAULT NULL;
DECLARE EDSH_ADDTNLCH TEXT DEFAULT NULL;
DECLARE EDSHCOMMENTS TEXT DEFAULT NULL;
DECLARE STARHUB_DETAILS TEXT;
DECLARE EDSHTIMESTAMP TIMESTAMP;
DECLARE USERSTAMP_ID INT;
-- GET OLD VALUES FOR GIVEN ID
	SET UNITID=(SELECT UNIT_ID FROM EXPENSE_DETAIL_STARHUB WHERE EDSH_ID=ROW_ID);
	SET ECNID=(SELECT ECN_ID FROM EXPENSE_DETAIL_STARHUB WHERE EDSH_ID=ROW_ID);
	SET EDSH_RECVER=(SELECT EDSH_REC_VER FROM EXPENSE_DETAIL_STARHUB WHERE EDSH_ID=ROW_ID);
	SET EDSH_ACCOUNTNO=(SELECT EDSH_ACCOUNT_NO FROM EXPENSE_DETAIL_STARHUB WHERE EDSH_ID=ROW_ID);	
	SET EDSH_APPLDATE=(SELECT EDSH_APPL_DATE FROM EXPENSE_DETAIL_STARHUB WHERE EDSH_ID=ROW_ID);
	SET EDSH_CABLE_STARTDATE=(SELECT EDSH_CABLE_START_DATE FROM EXPENSE_DETAIL_STARHUB WHERE EDSH_ID=ROW_ID);
	SET EDSH_CABLE_ENDDATE=(SELECT EDSH_CABLE_END_DATE FROM EXPENSE_DETAIL_STARHUB WHERE EDSH_ID=ROW_ID);
	SET EDSH_INTERNET_STARTDATE=(SELECT EDSH_INTERNET_START_DATE FROM EXPENSE_DETAIL_STARHUB WHERE EDSH_ID=ROW_ID);
	SET EDSH_INTERNET_ENDDATE=(SELECT EDSH_INTERNET_END_DATE FROM EXPENSE_DETAIL_STARHUB WHERE EDSH_ID=ROW_ID);
	SET EDSHSSID=(SELECT EDSH_SSID FROM EXPENSE_DETAIL_STARHUB WHERE EDSH_ID=ROW_ID);
	SET EDSHPWD=(SELECT EDSH_PWD FROM EXPENSE_DETAIL_STARHUB WHERE EDSH_ID=ROW_ID);
	SET EDSH_CABLEBOXSERIALNO=(SELECT EDSH_CABLE_BOX_SERIAL_NO FROM EXPENSE_DETAIL_STARHUB WHERE EDSH_ID=ROW_ID);
	SET EDSH_MODEMSERIALNO=(SELECT EDSH_MODEM_SERIAL_NO FROM EXPENSE_DETAIL_STARHUB WHERE EDSH_ID=ROW_ID);	
	SET EDSH_BASICGROUP=(SELECT EDSH_BASIC_GROUP FROM EXPENSE_DETAIL_STARHUB WHERE EDSH_ID=ROW_ID);
	SET EDSH_ADDTNLCH=(SELECT EDSH_ADDTNL_CH FROM EXPENSE_DETAIL_STARHUB WHERE EDSH_ID=ROW_ID);
	SET EDSHCOMMENTS=(SELECT EDSH_COMMENTS FROM EXPENSE_DETAIL_STARHUB WHERE EDSH_ID=ROW_ID);
	SET EDSHTIMESTAMP=(SELECT EDSH_TIMESTAMP FROM EXPENSE_DETAIL_STARHUB WHERE EDSH_ID=ROW_ID);	
	IF ECNID IS NULL THEN
		SET ECNID='null';
	END IF;	
	IF EDSH_APPLDATE IS NULL THEN
		SET EDSH_APPLDATE='null';
	END IF;
	IF EDSH_CABLE_STARTDATE IS NULL THEN
		SET EDSH_CABLE_STARTDATE='null';
	END IF;
	IF EDSH_CABLE_ENDDATE IS NULL THEN
		SET EDSH_CABLE_ENDDATE='null';
	END IF;
	IF EDSH_INTERNET_STARTDATE IS NULL THEN
		SET EDSH_INTERNET_STARTDATE='null';
	END IF;
	IF EDSH_INTERNET_ENDDATE IS NULL THEN
		SET EDSH_INTERNET_ENDDATE='null';
	END IF;	
	IF EDSHSSID IS NULL THEN
		SET EDSHSSID='null';
	END IF;
	IF EDSHPWD IS NULL THEN
		SET EDSHPWD='null';
	END IF;
	IF EDSH_CABLEBOXSERIALNO IS NULL THEN
		SET EDSH_CABLEBOXSERIALNO='null';
	END IF;	
	IF EDSH_MODEMSERIALNO IS NULL THEN
		SET EDSH_MODEMSERIALNO='null';
	END IF;
	IF EDSH_BASICGROUP IS NULL THEN
		SET EDSH_BASICGROUP='null';
	END IF;
	IF EDSH_ADDTNLCH IS NULL THEN
		SET EDSH_ADDTNLCH='null';
	END IF;
	IF EDSHCOMMENTS IS NULL THEN
		SET EDSHCOMMENTS='null';
	END IF;
-- TRANSACTION START FOR INSERTING TICKLER N DELETING THE ROW	
	SET AUTOCOMMIT = 0;	
	START TRANSACTION;
	CALL SP_CHANGE_USERSTAMP_AS_ULDID(V_USERSTAMP,@ULDID);
	SET USERSTAMP_ID = (SELECT @ULDID);
	SET STARHUB_DETAILS=(CONCAT('EDSH_ID=',ROW_ID,',UNIT_ID=',UNITID,',ECN_ID=',ECNID,',EDSH_REC_VER=',EDSH_RECVER,',EDSH_ACCOUNT_NO=',EDSH_ACCOUNTNO
	,',EDSH_APPL_DATE=',EDSH_APPLDATE,',EDSH_CABLE_START_DATE=',EDSH_CABLE_STARTDATE,',EDSH_CABLE_END_DATE=',EDSH_CABLE_ENDDATE,',EDSH_INTERNET_START_DATE=',EDSH_INTERNET_STARTDATE,',EDSH_INTERNET_END_DATE=',EDSH_INTERNET_ENDDATE
	,',EDSH_SSID=',EDSHSSID,',EDSH_PWD=',EDSHPWD,',EDSH_CABLE_BOX_SERIAL_NO=',EDSH_CABLEBOXSERIALNO,',EDSH_MODEM_SERIAL_NO=',EDSH_MODEMSERIALNO,',EDSH_BASIC_GROUP=',EDSH_BASICGROUP
	,',EDSH_ADDTNL_CH=',EDSH_ADDTNLCH,',EDSH_COMMENTS=',EDSHCOMMENTS,',ULD_ID=',USERSTAMP_ID,',EDSH_TIMESTAMP=',EDSHTIMESTAMP));
	INSERT INTO TICKLER_HISTORY (TP_ID, TTIP_ID,TH_OLD_VALUE, ULD_ID)VALUES (2, TABLE_ID,STARHUB_DETAILS, USERSTAMP_ID);	
	DELETE FROM EXPENSE_DETAIL_STARHUB WHERE EDSH_ID=ROW_ID;
END;