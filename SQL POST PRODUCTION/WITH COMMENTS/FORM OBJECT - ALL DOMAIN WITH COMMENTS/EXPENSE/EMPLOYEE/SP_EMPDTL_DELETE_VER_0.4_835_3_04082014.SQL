-- version 0.4 --sadte:04/08/2014 --edate:04/08/2014 --issue:835 --commentno:3 --desc:implementing auto commit --done by : RL
--version:0.3 --sdate:21/06/2014 --edate:21/06/2014 --issue:817 --commentno#139 --desc:DROPped TEMP TABLE IF ROLLBACK OCCUR --DONEBY:RL
--version:0.2 --sdate:16/05/2014 --edate:16/05/2014 --issue:817 --commentno#55 --desc:changed temp table as dynamic --doneby:RL
--version:0.1 --sdate:12/03/2014 --edate:12/03/2014 --issue:535 --commentno#243 --desc:deletion sp for employee dtl --doneby:RL
DROP PROCEDURE IF EXISTS SP_EMPDTL_DELETE;
CREATE PROCEDURE SP_EMPDTL_DELETE(
EMPID INTEGER,
USERSTAMP VARCHAR(50),
OUT SUCCESSFLAG INTEGER)

BEGIN

-- VARIABLE DECLARATION
	
	DECLARE STAFFDTLEMPID INTEGER;
	DECLARE STAFFTRANSACTIONFLAG INTEGER;
	DECLARE HOUSEKEEPINGEMPID INTEGER;
	DECLARE HOUSEKEEPINGTRANSACTIONFLAG INTEGER;
	DECLARE MINID INTEGER;
	DECLARE MAXID INTEGER;
	
	DECLARE USERSTAMP_ID INTEGER;
	DECLARE SYSDATEANDTIME VARCHAR(50);
	DECLARE SYSDATEANDULDID VARCHAR(50);
	
	DECLARE EMP_CARDDETAILS TEXT;
	DECLARE EMP_CARD_ID INTEGER;
	DECLARE USER_STAMP VARCHAR(50);
	
-- QUERY FOR ROLLBACK COMMAND
	DECLARE EXIT HANDLER FOR SQLEXCEPTION
	BEGIN 
	ROLLBACK; 
		IF(EMP_CARDDETAILS IS NOT NULL)THEN
			SET @CARDDETAILS_DROPQUERY = (SELECT CONCAT('DROP TABLE IF EXISTS ',EMP_CARDDETAILS,''));
			PREPARE CARDDETAILS_DROPQUERY_STMT FROM @CARDDETAILS_DROPQUERY;
			EXECUTE CARDDETAILS_DROPQUERY_STMT;
		END IF;
		SET SUCCESSFLAG = 0;
	END;

-- QUERY FOR START TRANSACTION

	SET AUTOCOMMIT = 0;
	
	START TRANSACTION;
	
SET SUCCESSFLAG = 0;
	
	SET STAFFTRANSACTIONFLAG = 1;
	SET HOUSEKEEPINGTRANSACTIONFLAG = 1;
	SET USER_STAMP = USERSTAMP;
	
	CALL SP_CHANGE_USERSTAMP_AS_ULDID(USER_STAMP,@ULDID);
	SET USERSTAMP_ID=(SELECT @ULDID);
	
	SET SYSDATEANDTIME=(SELECT SYSDATE());
	SET SYSDATEANDTIME=(SELECT REPLACE(SYSDATEANDTIME,' ',''));
	SET SYSDATEANDTIME=(SELECT REPLACE(SYSDATEANDTIME,'-',''));
	SET SYSDATEANDTIME=(SELECT REPLACE(SYSDATEANDTIME,':',''));
	SET SYSDATEANDULDID=(SELECT CONCAT(SYSDATEANDTIME,'_',USERSTAMP_ID));	
	
-- QUERY FOR SET STAFFDETLEMPID COUNT , HOUSEKEEPINGEMPID COUNT	
	
	SET STAFFDTLEMPID = (SELECT COUNT(EMP_ID) FROM EXPENSE_DETAIL_STAFF_SALARY WHERE EMP_ID = EMPID);
	SET HOUSEKEEPINGEMPID = (SELECT COUNT(EMP_ID) FROM EXPENSE_HOUSEKEEPING WHERE EMP_ID = EMPID);

-- QUERY FOR CHECK PASSING EMPID IS IN STAFFDTL TABLE STAFFTRANSACTIONFLAG=0 OTHERWISE STAFFTRANSACTIONFLAG=1
	
	IF(STAFFDTLEMPID >= 1)THEN
		SET STAFFTRANSACTIONFLAG = 0;
	ELSE
		SET STAFFTRANSACTIONFLAG = 1;
	END IF;

-- QUERY FOR CHECK PASSING EMPID IS IN HOUSEKEEPING TABLE HOUSEKEEPINGTRANSACTIONFLAG=0 OTHERWISE HOUSEKEEPINGTRANSACTIONFLAG=1	
	
	IF(HOUSEKEEPINGEMPID >= 1)THEN
		SET HOUSEKEEPINGTRANSACTIONFLAG = 0;
	ELSE
		SET HOUSEKEEPINGTRANSACTIONFLAG = 1;
	END IF;

-- HOUSEKEEPINGTRANSACTIONFLAG AND 	STAFFTRANSACTIONFLAG BOTH FLAG=1 BELOW PART WILL EXECUTED
	
	IF(STAFFTRANSACTIONFLAG=1 AND HOUSEKEEPINGTRANSACTIONFLAG=1)THEN		

-- QUERY FOR CREATE TEMP_EMP_CARDDETAILS TABLE


		SET EMP_CARDDETAILS=(SELECT CONCAT('TEMP_EMP_CARDDETAILS','_',SYSDATEANDULDID));
		
		SET @CARDDETAILS_CREATEQUERY = (SELECT CONCAT('CREATE TABLE ',EMP_CARDDETAILS,'(
		ID INTEGER AUTO_INCREMENT,
		ECDID INTEGER,
		PRIMARY KEY(ID))'));
		PREPARE CARDDETAILS_CREATEQUERY_STMT FROM @CARDDETAILS_CREATEQUERY;
		EXECUTE CARDDETAILS_CREATEQUERY_STMT;

-- QUERY FOR INSERT VALUES IN TEMP_EMP_CARDDETAILS TABLE

		SET @CARDDETAILS_INSERTQUERY = (SELECT CONCAT('INSERT INTO ',EMP_CARDDETAILS,'(ECDID) 
		(SELECT ECD_ID FROM EMPLOYEE_CARD_DETAILS WHERE EMP_ID = ',EMPID,')'));
		PREPARE CARDDETAILS_INSERTQUERY_STMT FROM @CARDDETAILS_INSERTQUERY;
		EXECUTE CARDDETAILS_INSERTQUERY_STMT;
		
		SET @MIN_ID = (SELECT CONCAT('SELECT MIN(ID) INTO @MINIMUMID FROM ',EMP_CARDDETAILS,''));
		PREPARE MIN_ID_STMT FROM @MIN_ID;
		EXECUTE MIN_ID_STMT;
		
		SET @MAX_ID = (SELECT CONCAT('SELECT MAX(ID) INTO @MAXIMUMID FROM ',EMP_CARDDETAILS,''));
		PREPARE MAX_ID_STMT FROM @MAX_ID;
		EXECUTE MAX_ID_STMT;
		
		SET MINID = @MINIMUMID;
		SET MAXID = @MAXIMUMID;
		
		WHILE(MINID<=MAXID)DO
		
			SET @CARDID = (SELECT CONCAT('SELECT ECDID INTO @CARD_ID FROM ',EMP_CARDDETAILS,' WHERE ID = ',MINID,''));
			PREPARE CARDID_STMT FROM @CARDID;
			EXECUTE CARDID_STMT;
			
			SET EMP_CARD_ID = @CARD_ID;
			
			CALL SP_SINGLE_TABLE_ROW_DELETION(40,EMP_CARD_ID,USERSTAMP,@FLAG);
			SET SUCCESSFLAG = 1;
			
			SET MINID=MINID+1;
		
		END WHILE;
		
		CALL SP_SINGLE_TABLE_ROW_DELETION(39,EMPID,USERSTAMP,@FLAG);
		SET SUCCESSFLAG = 1;
		
	END IF;
	
	IF(EMP_CARDDETAILS IS NOT NULL)THEN

		SET @CARDDETAILS_DROPQUERY = (SELECT CONCAT('DROP TABLE IF EXISTS ',EMP_CARDDETAILS,''));
		PREPARE CARDDETAILS_DROPQUERY_STMT FROM @CARDDETAILS_DROPQUERY;
		EXECUTE CARDDETAILS_DROPQUERY_STMT;
		
	END IF;

	COMMIT;

END;