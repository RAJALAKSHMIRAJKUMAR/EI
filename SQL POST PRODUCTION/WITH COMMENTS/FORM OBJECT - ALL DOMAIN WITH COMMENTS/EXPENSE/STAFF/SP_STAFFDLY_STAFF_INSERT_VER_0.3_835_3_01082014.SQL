-- version 0.3 --sadte:01/08/2014 --edate:01/08/2014 --issue:835 --commentno:3 --desc:implementing auto commit n invoice item , from comma changed as cap(^^) --done by : RL
--version:0.2 --sdate:14/03/2014 --edate:14/03/2014 --issue:535 --comment no#253 --desc:removed comments in cheking mandatory fields --doneby:RL
--version:0.1 --sdate:12/03/2014 --edate:12/03/2014 --issue:535 --comment no#237 --desc:create sp for save values in expense staff table --doneby:RL 
DROP PROCEDURE IF EXISTS SP_STAFFDLY_STAFF_INSERT;
CREATE PROCEDURE SP_STAFFDLY_STAFF_INSERT(
IN ECNID TEXT,
IN INVOICEDATE TEXT,
IN AMOUNT TEXT,
IN INVOICEITEMS TEXT,
IN INVOICEFROM TEXT,
IN COMMENTS TEXT,
IN USERSTAMP VARCHAR(50),
OUT FINALMESSAGE TEXT)
BEGIN
-- VARIABLE DECLARATION
	DECLARE USERSTAMP_ID INTEGER(2);
	DECLARE ESECNID TEXT;
	DECLARE ESINVOICEDATE DATE;
	DECLARE ESAMOUNT  DECIMAL(5,2);
	DECLARE ESINVOICEITEMS TEXT;
	DECLARE ESINVOICEFROM VARCHAR(200);
	DECLARE ESCOMMENTS TEXT;
	DECLARE SUBSPSUCCESSFLAG INTEGER;
-- QUERY FOR ROLLBACK COMMAND
	DECLARE EXIT HANDLER FOR SQLEXCEPTION
	BEGIN 
		ROLLBACK; 
	END;
-- QUERY FOR SET PASSING VALUES IN TEMP VARIABLE
	SET @TEMP_ECNID = ECNID;
	SET @TEMP_INVOICEDATE = INVOICEDATE;
	SET @TEMP_AMOUNT = AMOUNT;
	SET @TEMP_INVOICEITEMS = INVOICEITEMS;
	SET @TEMP_INVOICEFROM = INVOICEFROM;
	SET @TEMP_COMMENTS = COMMENTS;
-- QUERY FOR CHECK PASSING ALL MANDATORY FIELDS IS NOT NULL
	SET FINALMESSAGE = '';
		MAIN_LOOP : LOOP
-- QUERY FOR SET PASSING ECNID VALUES IN TEMP VARIABLE		
		CALL SP_GET_SPECIAL_CHARACTER_SEPERATED_VALUES(',',@TEMP_ECNID,@VALUE,@REMAINING_STRING);
		SELECT @VALUE INTO ESECNID;
		SELECT @REMAINING_STRING INTO @TEMP_ECNID;
-- QUERY FOR SET PASSING INVOICEDATE VALUES IN TEMP VARIABLE			
		CALL SP_GET_SPECIAL_CHARACTER_SEPERATED_VALUES(',',@TEMP_INVOICEDATE,@VALUE,@REMAINING_STRING);
		SELECT @VALUE INTO ESINVOICEDATE;
		SELECT @REMAINING_STRING INTO @TEMP_INVOICEDATE;
-- QUERY FOR SET PASSING AMOUNT VALUES IN TEMP VARIABLE			
		CALL SP_GET_SPECIAL_CHARACTER_SEPERATED_VALUES(',',@TEMP_AMOUNT,@VALUE,@REMAINING_STRING);
		SELECT @VALUE INTO ESAMOUNT;
		SELECT @REMAINING_STRING INTO @TEMP_AMOUNT;
-- QUERY FOR SET PASSING INVOICE ITEMS VALUES IN TEMP VARIABLE			
		CALL SP_GET_SPECIAL_CHARACTER_SEPERATED_VALUES('^^',@TEMP_INVOICEITEMS,@VALUE,@REMAINING_STRING);
		SELECT @VALUE INTO ESINVOICEITEMS;
		SELECT @REMAINING_STRING INTO @TEMP_INVOICEITEMS;
-- QUERY FOR SET PASSING INVOICE FROM VALUES IN TEMP VARIABLE			
		CALL SP_GET_SPECIAL_CHARACTER_SEPERATED_VALUES('^^',@TEMP_INVOICEFROM,@VALUE,@REMAINING_STRING);
		SELECT @VALUE INTO ESINVOICEFROM;
		SELECT @REMAINING_STRING INTO @TEMP_INVOICEFROM;
-- QUERY FOR SET PASSING COMMENTS VALUES IN TEMP VARIABLE			
		CALL SP_GET_SPECIAL_CHARACTER_SEPERATED_VALUES('^^',@TEMP_COMMENTS,@VALUE,@REMAINING_STRING);
		SELECT @VALUE INTO ESCOMMENTS;
		SELECT @REMAINING_STRING INTO @TEMP_COMMENTS;	
-- QUERY FOR START TRASACTION	
		SET AUTOCOMMIT = 0;
		START TRANSACTION;	
		IF(ESECNID IS NOT NULL AND ESINVOICEDATE IS NOT NULL AND ESAMOUNT IS NOT NULL AND ESINVOICEITEMS IS NOT NULL AND ESINVOICEFROM IS NOT NULL AND USERSTAMP IS NOT NULL)THEN 
-- QUERY FOR CALL SP_STAFFDLY_SUBSTAFF_INSERT TO SAVE VALUES IN EXPENSE_STAFF TABLE		
			CALL SP_STAFFDLY_SUBSTAFF_INSERT(ESECNID,ESINVOICEDATE,ESAMOUNT,ESINVOICEITEMS,ESINVOICEFROM,ESCOMMENTS,USERSTAMP,@SUCCESSFLAG);
			SET SUBSPSUCCESSFLAG = (SELECT @SUCCESSFLAG);
		END IF;
-- SUBSPSUCCESSFLAG = 0 THEN THROW ERROR MSG
		IF(SUBSPSUCCESSFLAG=0)THEN
			SET FINALMESSAGE = (SELECT CONCAT(FINALMESSAGE,' ','ECN_DATA=',ESECNID,',','INVOICE_DATE=',ESINVOICEDATE,',',
			'AMOUNT=',ESAMOUNT,',','INVOICE_ITEMS=',ESINVOICEITEMS,',','INVOICE_FROM=',ESINVOICEFROM,',',
			'COMMENTS=',ESCOMMENTS,',','USERSTAMP=',USERSTAMP));
		END IF;
		IF @TEMP_ECNID IS NULL THEN
			LEAVE  MAIN_LOOP;
		END IF;
	END LOOP;
	IF(FINALMESSAGE = '')THEN
		SET FINALMESSAGE = 1;
	END IF;
COMMIT;
END;