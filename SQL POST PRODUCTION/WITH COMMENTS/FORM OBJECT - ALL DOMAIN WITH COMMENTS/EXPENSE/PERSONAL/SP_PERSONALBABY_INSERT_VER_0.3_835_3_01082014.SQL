-- version 0.3 --sadte:01/08/2014 --edate:01/08/2014 --issue:835 --commentno:3 --desc:implementing auto commit , for invoice items & invoice from comma chnaged as cap(^^)
-- version:0.2 --sdate:14/03/2014 --edate:14/03/2014 --issue:535 --comment no#253 --desc:removed comments in cheking mandatory fields --doneby:RL
-- version:0.1 --sdate:12/03/2014 --edate:12/03/2014 --issue:535 --comment no#237 --desc:create sp for save values in expense baby table --doneby:RL 

DROP PROCEDURE IF EXISTS SP_PERSONALBABY_INSERT;
CREATE PROCEDURE SP_PERSONALBABY_INSERT(
IN ECNID TEXT,
IN INVOICEDATE TEXT,
IN AMOUNT TEXT,
IN INVOICEITEMS TEXT,
IN INVOICEFROM TEXT,
IN COMMENTS TEXT,
IN USERSTAMP VARCHAR(50),
OUT FINALMESSAGE TEXT)
BEGIN
-- VARIABLE DECLARATION
	DECLARE USERSTAMP_ID INTEGER(2);
	DECLARE EBECNID TEXT;
	DECLARE EBINVOICEDATE DATE;
	DECLARE EBAMOUNT  DECIMAL(7,2);
	DECLARE EBINVOICEITEMS TEXT;
	DECLARE EBINVOICEFROM VARCHAR(200);
	DECLARE EBCOMMENTS TEXT;
	DECLARE SUBSPSUCCESSFLAG INTEGER;
	DECLARE ERRORMSG TEXT;
-- QUERY FOR ROLLBACK COMMAND
	DECLARE EXIT HANDLER FOR SQLEXCEPTION
	BEGIN 
		ROLLBACK; 
	END;
	SET AUTOCOMMIT = 0;
-- QUERY FOR SET PASSING VALUES IN TEMP VARIABLE
	SET @TEMP_ECNID = ECNID;
	SET @TEMP_INVOICEDATE = INVOICEDATE;
	SET @TEMP_AMOUNT = AMOUNT;
	SET @TEMP_INVOICEITEMS = INVOICEITEMS;
	SET @TEMP_INVOICEFROM = INVOICEFROM;
	SET @TEMP_COMMENTS = COMMENTS;
	SET FINALMESSAGE = '';
-- QUERY FOR CHECK PASSING ALL MANDATORY FIELDS IS NOT NULL
	MAIN_LOOP : LOOP
-- QUERY FOR SET PASSING ECNID VALUES IN TEMP VARIABLE		
		CALL SP_GET_SPECIAL_CHARACTER_SEPERATED_VALUES(',',@TEMP_ECNID,@VALUE,@REMAINING_STRING);
		SELECT @VALUE INTO EBECNID;
		SELECT @REMAINING_STRING INTO @TEMP_ECNID;
-- QUERY FOR SET PASSING INVOICEDATE VALUES IN TEMP VARIABLE			
		CALL SP_GET_SPECIAL_CHARACTER_SEPERATED_VALUES(',',@TEMP_INVOICEDATE,@VALUE,@REMAINING_STRING);
		SELECT @VALUE INTO EBINVOICEDATE;
		SELECT @REMAINING_STRING INTO @TEMP_INVOICEDATE;
-- QUERY FOR SET PASSING AMOUNT VALUES IN TEMP VARIABLE			
		CALL SP_GET_SPECIAL_CHARACTER_SEPERATED_VALUES(',',@TEMP_AMOUNT,@VALUE,@REMAINING_STRING);
		SELECT @VALUE INTO EBAMOUNT;
		SELECT @REMAINING_STRING INTO @TEMP_AMOUNT;
-- QUERY FOR SET PASSING INVOICE ITEMS VALUES IN TEMP VARIABLE			
		CALL SP_GET_SPECIAL_CHARACTER_SEPERATED_VALUES('^^',@TEMP_INVOICEITEMS,@VALUE,@REMAINING_STRING);
		SELECT @VALUE INTO EBINVOICEITEMS;
		SELECT @REMAINING_STRING INTO @TEMP_INVOICEITEMS;
-- QUERY FOR SET PASSING INVOICE FROM VALUES IN TEMP VARIABLE			
		CALL SP_GET_SPECIAL_CHARACTER_SEPERATED_VALUES('^^',@TEMP_INVOICEFROM,@VALUE,@REMAINING_STRING);
		SELECT @VALUE INTO EBINVOICEFROM;
		SELECT @REMAINING_STRING INTO @TEMP_INVOICEFROM;
-- QUERY FOR SET PASSING COMMENTS VALUES IN TEMP VARIABLE			
		CALL SP_GET_SPECIAL_CHARACTER_SEPERATED_VALUES('^^',@TEMP_COMMENTS,@VALUE,@REMAINING_STRING);
		SELECT @VALUE INTO EBCOMMENTS;
		SELECT @REMAINING_STRING INTO @TEMP_COMMENTS;	
-- QUERY FOR START TRASACTION	
		START TRANSACTION;	
		IF(EBECNID IS NOT NULL AND EBINVOICEDATE IS NOT NULL AND EBAMOUNT IS NOT NULL AND EBINVOICEITEMS IS NOT NULL AND EBINVOICEFROM IS NOT NULL  AND USERSTAMP IS NOT NULL)THEN 
-- QUERY FOR CALL SP_SUBPERSONAL_BABY_INSERT TO SAVE VALUES IN EXPENSE_STAFF TABLE		
			CALL SP_SUBPERSONAL_BABY_INSERT(EBECNID,EBINVOICEDATE,EBAMOUNT,EBINVOICEITEMS,EBINVOICEFROM,EBCOMMENTS,USERSTAMP,@SUCCESSFLAG,@OUTPUT_MSG);
			SET SUBSPSUCCESSFLAG = (SELECT @SUCCESSFLAG);
			SET ERRORMSG = (SELECT @OUTPUT_MSG);
		END IF;
-- SUBSPSUCCESSFLAG = 0 THEN THROW ERROR MSG
		IF(SUBSPSUCCESSFLAG=0 OR ERRORMSG!=' ')THEN
			SET FINALMESSAGE = (SELECT CONCAT(FINALMESSAGE,' ','ECN_DATA=',EBECNID,',','INVOICE_DATE=',EBINVOICEDATE,',',
			'AMOUNT=',EBAMOUNT,',','INVOICE_ITEMS=',EBINVOICEITEMS,',','INVOICE_FROM=',EBINVOICEFROM,',',
			'COMMENTS=',EBCOMMENTS,',','USERSTAMP=',USERSTAMP));
		END IF;
		IF @TEMP_ECNID IS NULL THEN
			LEAVE  MAIN_LOOP;
		END IF;
	END LOOP;
	IF(FINALMESSAGE = '')THEN
		SET FINALMESSAGE = 1;
	END IF;
COMMIT;
END;
