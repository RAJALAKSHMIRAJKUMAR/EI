DROP PROCEDURE IF EXISTS SP_PATCH_HISTORY;
CREATE PROCEDURE SP_PATCH_HISTORY(
IN MODULENAME VARCHAR(50),
IN FILENAME VARCHAR(100),
IN USERSTAMP VARCHAR(40),
OUT SUCCESS_MESSAGE TEXT)
BEGIN
	DECLARE USERSTAMP_ID INTEGER;
	DECLARE SUCCESS_ECNDATA TEXT;
	DECLARE FAILURE_ECNDATA TEXT;
	DECLARE SUCCESSECNDATA TEXT;
	DECLARE FAILUREECNDATA TEXT;
	DECLARE EXIT HANDLER FOR SQLEXCEPTION
	BEGIN
		ROLLBACK;
	END;
	START TRANSACTION;
	SET SUCCESS_ECNDATA =  (SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=469);
	SET FAILURE_ECNDATA =  (SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=470);		   
	SET SUCCESSECNDATA = (SELECT REPLACE(SUCCESS_ECNDATA,'[FILENAME]',FILENAME));
	SET FAILUREECNDATA = (SELECT REPLACE(FAILURE_ECNDATA,'[FILENAME]',FILENAME));
	SET USERSTAMP_ID=(SELECT ULD_ID FROM USER_LOGIN_DETAILS WHERE ULD_LOGINID=USERSTAMP);
	IF EXISTS(SELECT PH_FILE_NAME FROM PATCH_HISTORY WHERE PH_FILE_NAME = FILENAME AND PH_STATUS = 1) THEN
		SET SUCCESS_MESSAGE =FAILUREECNDATA;
	END IF;
	IF NOT EXISTS(SELECT PH_FILE_NAME FROM PATCH_HISTORY WHERE PH_FILE_NAME = FILENAME AND PH_STATUS = 1) THEN					   
		INSERT INTO PATCH_HISTORY(PO_ID,PH_FILE_NAME,PH_STATUS,ULD_ID)VALUES((SELECT PO_ID FROM PATCH_OBJECTS WHERE PO_MODULE_NAME=MODULENAME),FILENAME,1,USERSTAMP_ID);
		SET SUCCESS_MESSAGE = SUCCESSECNDATA;				
	END IF;	
	COMMIT;
END;
