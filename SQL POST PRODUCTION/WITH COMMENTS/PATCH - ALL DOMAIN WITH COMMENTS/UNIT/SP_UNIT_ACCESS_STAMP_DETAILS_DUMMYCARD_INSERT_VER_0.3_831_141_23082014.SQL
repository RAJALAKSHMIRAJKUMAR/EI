-- VER:0.2 --SDATE:08/08/2014 --EDATE:08/08/2014 --ISSUE:831 --DESC:INSERTING NEW DUMMY CARD PATCH FOR UNIT_ACCESS_STAMP_DETAILS --DONEBY:BHAVANI.R
-- VER:0.1 --SDATE:06/08/2014 --EDATE:06/08/2014 --ISSUE:831 --DESC:PATCH FOR UNIT_ACCESS_STAMP_DETAILS FOR INSERTING DUMMY CARD --DONEBY:BHAVANI.R
DROP PROCEDURE IF EXISTS SP_UNIT_ACCESS_STAMP_DETAILS_DUMMYCARD_INSERT;
CREATE PROCEDURE SP_UNIT_ACCESS_STAMP_DETAILS_DUMMYCARD_INSERT(
IN FILENAME TEXT,
IN USERSTAMP VARCHAR(50),
OUT SUCCESS_MESSAGE TEXT)
BEGIN
--  VARIABLE DECLARATION
	DECLARE FAILURE_ECN_DATA TEXT;
	DECLARE FAIL_ECNDATA TEXT;
	DECLARE SUCCESS_ECNDATA TEXT;
	DECLARE FAILURE_ECNDATA TEXT;
	DECLARE SUCCESSECNDATA TEXT;
	DECLARE FAILUREECNDATA TEXT;
	DECLARE PATCHFILENAME VARCHAR(100);
	DECLARE PHSTATUS TINYINT;
	DECLARE NEWULDID INTEGER;
--  QUERY FOR ROLLBACK COMMAND
	DECLARE EXIT HANDLER FOR SQLEXCEPTION
	BEGIN 
		ROLLBACK;
		INSERT INTO PATCH_HISTORY(PO_ID,PH_FILE_NAME,PH_STATUS,ULD_ID) VALUES (4,FILENAME,0,(SELECT ULD_ID FROM USER_LOGIN_DETAILS WHERE ULD_LOGINID=USERSTAMP));
	END;
	SET AUTOCOMMIT=0;
	START TRANSACTION;
	SET FOREIGN_KEY_CHECKS = 0;
--  QUERY FOR GET ERROR MESSGAE FROM ERROR_MESSAGE_CONFIGURATION TABLE
	SET SUCCESS_ECNDATA =  (SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=469);
	SET FAILURE_ECNDATA =  (SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=470);
	SET FAILURE_ECN_DATA = (SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=473);
--  QUERY FOR REPLACE [FILENAME]
	SET SUCCESSECNDATA = (SELECT REPLACE(SUCCESS_ECNDATA,'[FILENAME]',FILENAME));
	SET FAILUREECNDATA = (SELECT REPLACE(FAILURE_ECNDATA,'[FILENAME]',FILENAME));
	SET FAIL_ECNDATA = (SELECT REPLACE(FAILURE_ECN_DATA,'[FILENAME]',FILENAME));
--  QUERY FOR CHECK THE PASSING FILE NAME EXISTS IN PATCH_HISTORY TABLE
	IF EXISTS(SELECT PH_FILE_NAME FROM PATCH_HISTORY WHERE PH_FILE_NAME = FILENAME AND PH_STATUS = 1) THEN
		SET SUCCESS_MESSAGE = FAILUREECNDATA;
	END IF;
--  QUERY FOR CHECK THE PASSING FILE NAME NOT EXISTS IN PATCH_HISTORY TABLE
	SET PATCHFILENAME = (SELECT PH_FILE_NAME FROM PATCH_HISTORY WHERE PH_FILE_NAME = FILENAME);
	SET PHSTATUS = (SELECT PH_STATUS FROM PATCH_HISTORY WHERE PH_FILE_NAME = FILENAME AND PH_STATUS = 0);
  	SET NEWULDID = (SELECT ULD_ID FROM USER_LOGIN_DETAILS WHERE ULD_LOGINID=USERSTAMP);
	IF ((PATCHFILENAME IS NOT NULL) AND (PHSTATUS = 0)) OR (PATCHFILENAME IS NULL)THEN
		INSERT INTO UNIT_ACCESS_STAMP_DETAILS ( UNIT_ID, UASD_ACCESS_CARD, UASD_ACCESS_LOST, UASD_COMMENTS, ULD_ID)VALUES(29,7777,'X','DUMMY CARD',2);   
		INSERT INTO UNIT_ACCESS_STAMP_DETAILS ( UNIT_ID, UASD_ACCESS_CARD, UASD_ACCESS_LOST, UASD_COMMENTS, ULD_ID)VALUES(29,8888,'X','DUMMY CARD',2);   
		INSERT INTO UNIT_ACCESS_STAMP_DETAILS ( UNIT_ID, UASD_ACCESS_CARD, UASD_ACCESS_LOST, UASD_COMMENTS, ULD_ID)VALUES(29,9999,'X','DUMMY CARD',2);  
		INSERT INTO UNIT_ACCESS_STAMP_DETAILS ( UNIT_ID, UASD_ACCESS_CARD, UASD_ACCESS_LOST, UASD_COMMENTS, ULD_ID)VALUES(29,11111,'X','DUMMY CARD',2);  
		INSERT INTO UNIT_ACCESS_STAMP_DETAILS ( UNIT_ID, UASD_ACCESS_CARD, UASD_ACCESS_LOST, UASD_COMMENTS, ULD_ID)VALUES(29,22222,'X','DUMMY CARD',2);  
		INSERT INTO UNIT_ACCESS_STAMP_DETAILS ( UNIT_ID, UASD_ACCESS_CARD, UASD_ACCESS_LOST, UASD_COMMENTS, ULD_ID)VALUES(29,33333,'X','DUMMY CARD',2);   
		INSERT INTO UNIT_ACCESS_STAMP_DETAILS ( UNIT_ID, UASD_ACCESS_CARD, UASD_ACCESS_LOST, UASD_COMMENTS, ULD_ID)VALUES(29,44444,'X','DUMMY CARD',2);  
		INSERT INTO UNIT_ACCESS_STAMP_DETAILS ( UNIT_ID, UASD_ACCESS_CARD, UASD_ACCESS_LOST, UASD_COMMENTS, ULD_ID)VALUES(3,55555,'X','DUMMY CARD',2);    
		INSERT INTO UNIT_ACCESS_STAMP_DETAILS ( UNIT_ID, UASD_ACCESS_CARD, UASD_ACCESS_LOST, UASD_COMMENTS, ULD_ID)VALUES(29,77777,'X','DUMMY CARD',2);   
		INSERT INTO UNIT_ACCESS_STAMP_DETAILS ( UNIT_ID, UASD_ACCESS_CARD, UASD_ACCESS_LOST, UASD_COMMENTS, ULD_ID)VALUES(29,88888,'X','DUMMY CARD',2);  
		INSERT INTO UNIT_ACCESS_STAMP_DETAILS ( UNIT_ID, UASD_ACCESS_CARD, UASD_ACCESS_LOST, UASD_COMMENTS, ULD_ID)VALUES(19,111111,'X','DUMMY CARD',2);  
		INSERT INTO UNIT_ACCESS_STAMP_DETAILS ( UNIT_ID, UASD_ACCESS_CARD, UASD_ACCESS_LOST, UASD_COMMENTS, ULD_ID)VALUES(37,222222,'X','DUMMY CARD',2);  
		INSERT INTO UNIT_ACCESS_STAMP_DETAILS ( UNIT_ID, UASD_ACCESS_CARD, UASD_ACCESS_LOST, UASD_COMMENTS, ULD_ID)VALUES(37,333333,'X','DUMMY CARD',2);  
		INSERT INTO UNIT_ACCESS_STAMP_DETAILS ( UNIT_ID, UASD_ACCESS_CARD, UASD_ACCESS_LOST, UASD_COMMENTS, ULD_ID)VALUES(37,444444,'X','DUMMY CARD',2); 
		INSERT INTO UNIT_ACCESS_STAMP_DETAILS ( UNIT_ID, UASD_ACCESS_CARD, UASD_ACCESS_LOST, UASD_COMMENTS, ULD_ID)VALUES(18,555555,'X','DUMMY CARD',2);
		INSERT INTO UNIT_ACCESS_STAMP_DETAILS ( UNIT_ID, UASD_ACCESS_CARD, UASD_ACCESS_LOST, UASD_COMMENTS, ULD_ID)VALUES(6,7777777,'X','DUMMY CARD',2);
		INSERT INTO UNIT_ACCESS_STAMP_DETAILS ( UNIT_ID, UASD_ACCESS_CARD, UASD_ACCESS_LOST, UASD_COMMENTS, ULD_ID)VALUES(37,8888888,'X','DUMMY CARD',2);
		INSERT INTO UNIT_ACCESS_STAMP_DETAILS ( UNIT_ID, UASD_ACCESS_CARD, UASD_ACCESS_LOST, UASD_COMMENTS, ULD_ID)VALUES(26,6666666,'X','DUMMY CARD',2); 
		INSERT INTO UNIT_ACCESS_STAMP_DETAILS ( UNIT_ID, UASD_ACCESS_CARD, UASD_ACCESS_LOST, UASD_COMMENTS, ULD_ID)VALUES(37,1111111,'X','DUMMY CARD',2);     
		INSERT INTO UNIT_ACCESS_STAMP_DETAILS ( UNIT_ID, UASD_ACCESS_CARD, UASD_ACCESS_LOST, UASD_COMMENTS, ULD_ID)VALUES(19,2222222,'X','DUMMY CARD',2);
		INSERT INTO UNIT_ACCESS_STAMP_DETAILS ( UNIT_ID, UASD_ACCESS_CARD, UASD_ACCESS_LOST, UASD_COMMENTS, ULD_ID)VALUES(43,3333333,'X','DUMMY CARD',2);
		INSERT INTO UNIT_ACCESS_STAMP_DETAILS ( UNIT_ID, UASD_ACCESS_CARD, UASD_ACCESS_LOST, UASD_COMMENTS, ULD_ID)VALUES(36,4444444,'X','DUMMY CARD',2);
--  QUERY FOR INSERT VALUES IN PATCH_HISTORY
		INSERT INTO PATCH_HISTORY(PO_ID,PH_FILE_NAME,PH_STATUS,ULD_ID) VALUES (4,FILENAME,1,(SELECT ULD_ID FROM USER_LOGIN_DETAILS WHERE ULD_LOGINID=USERSTAMP));
		SET SUCCESS_MESSAGE = SUCCESSECNDATA;
		SET FOREIGN_KEY_CHECKS = 1;
	END IF;
	COMMIT;
END;
CALL SP_UNIT_ACCESS_STAMP_DETAILS_DUMMYCARD_INSERT(FILENAME,USERSTAMP,@SUCCESS_MESSAGE);