-- version:0.1 --sdate:30/08/2014 --edate:30/08/2014 --issue:837 -- comment:#6 --done by:RL
DROP PROCEDURE IF EXISTS SP_UPDATE_CUSTOMER_ACCESS_CARD_DTLS;
CREATE PROCEDURE SP_UPDATE_CUSTOMER_ACCESS_CARD_DTLS(
IN FILENAME TEXT,
IN USERSTAMP VARCHAR(50),
OUT SUCCESS_MESSAGE TEXT)
BEGIN
--  VARIABLE DECLARATION
	DECLARE FAILURE_ECN_DATA TEXT;
	DECLARE FAIL_ECNDATA TEXT;
	DECLARE SUCCESS_ECNDATA TEXT;
	DECLARE FAILURE_ECNDATA TEXT;
	DECLARE SUCCESSECNDATA TEXT;
	DECLARE FAILUREECNDATA TEXT;
	DECLARE PATCHFILENAME VARCHAR(100);
	DECLARE PHSTATUS TINYINT;
	DECLARE OLDVALUE_ACCESS_TICKLER TEXT;
	DECLARE NEWVALUE_ACCESS_TICKLER TEXT;
	DECLARE OLD_UASDID INTEGER;
	DECLARE NEW_UASDID INTEGER;
	DECLARE OLD_COMMENTS TEXT;
	DECLARE NEW_COMMENTS TEXT;
	DECLARE CACDID TEXT;
--  QUERY FOR ROLLBACK COMMAND
	DECLARE EXIT HANDLER FOR SQLEXCEPTION
	BEGIN 
	ROLLBACK;
		INSERT INTO PATCH_HISTORY(PO_ID,PH_FILE_NAME,PH_STATUS,ULD_ID) VALUES (6,FILENAME,0,(SELECT ULD_ID FROM USER_LOGIN_DETAILS WHERE ULD_LOGINID=USERSTAMP));
	END;
	SET AUTOCOMMIT = 0;
 	START TRANSACTION;
	SET FOREIGN_KEY_CHECKS = 0;
--  QUERY FOR GET ERROR MESSGAE FROM ERROR_MESSAGE_CONFIGURATION TABLE
	SET SUCCESS_ECNDATA =  (SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=469);
	SET FAILURE_ECNDATA =  (SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=470);
	SET FAILURE_ECN_DATA = (SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=473);
--  QUERY FOR REPLACE [FILENAME]
	SET SUCCESSECNDATA = (SELECT REPLACE(SUCCESS_ECNDATA,'[FILENAME]',FILENAME));
	SET FAILUREECNDATA = (SELECT REPLACE(FAILURE_ECNDATA,'[FILENAME]',FILENAME));
	SET FAIL_ECNDATA = (SELECT REPLACE(FAILURE_ECN_DATA,'[FILENAME]',FILENAME));
--  QUERY FOR CHECK THE PASSING FILE NAME EXISTS IN PATCH_HISTORY TABLE
	IF EXISTS(SELECT PH_FILE_NAME FROM PATCH_HISTORY WHERE PH_FILE_NAME = FILENAME AND PH_STATUS = 1) THEN
		SET SUCCESS_MESSAGE = FAILUREECNDATA;
	END IF;
--  QUERY FOR CHECK THE PASSING FILE NAME NOT EXISTS IN PATCH_HISTORY TABLE
	SET PATCHFILENAME = (SELECT PH_FILE_NAME FROM PATCH_HISTORY WHERE PH_FILE_NAME = FILENAME);
	SET PHSTATUS = (SELECT PH_STATUS FROM PATCH_HISTORY WHERE PH_FILE_NAME = FILENAME AND PH_STATUS = 0);
	IF ((PATCHFILENAME IS NOT NULL) AND (PHSTATUS = 0)) OR (PATCHFILENAME IS NULL)THEN
-- CUSTOMER_ID = 45
		CALL SP_ACCESS_CARD_TICKLER_HISTORY_OLDVALUE(45,518,USERSTAMP,@OLDVALUE_ACCESS,@OLDUASDID);
		SET OLDVALUE_ACCESS_TICKLER = @OLDVALUE_ACCESS;
		SET OLD_UASDID = @OLDUASDID;
		UPDATE CUSTOMER_ACCESS_CARD_DETAILS SET UASD_ID = 149,CACD_TIMESTAMP = CACD_TIMESTAMP WHERE CACD_ID = 518;
		CALL SP_ACCESS_CARD_TICKLER_HISTORY_NEWVALUE(45,518,USERSTAMP,@NEWVALUE_ACCESS,@NEWUASDID);
		SET NEWVALUE_ACCESS_TICKLER=@NEWVALUE_ACCESS;
		SET NEW_UASDID = @NEWUASDID;
		IF(OLD_UASDID != NEW_UASDID)THEN
			INSERT INTO TICKLER_HISTORY(TP_ID,CUSTOMER_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,ULD_ID)VALUES
			(1,45,13,OLDVALUE_ACCESS_TICKLER, NEWVALUE_ACCESS_TICKLER ,(SELECT ULD_ID FROM USER_LOGIN_DETAILS WHERE ULD_LOGINID=USERSTAMP));
		END IF;
-- CUSTOMER_ID = 119
		CALL SP_ACCESS_CARD_TICKLER_HISTORY_OLDVALUE(119,209,USERSTAMP,@OLDVALUE_ACCESS,@OLDUASDID);
		SET OLDVALUE_ACCESS_TICKLER = @OLDVALUE_ACCESS;
		SET OLD_UASDID = @OLDUASDID;
		UPDATE CUSTOMER_ACCESS_CARD_DETAILS SET UASD_ID = 275,CACD_TIMESTAMP = CACD_TIMESTAMP WHERE CACD_ID = 209;
		CALL SP_ACCESS_CARD_TICKLER_HISTORY_NEWVALUE(119,209,USERSTAMP,@NEWVALUE_ACCESS,@NEWUASDID);
		SET NEWVALUE_ACCESS_TICKLER=@NEWVALUE_ACCESS;
		SET NEW_UASDID = @NEWUASDID;
		IF(OLD_UASDID != NEW_UASDID)THEN
			INSERT INTO TICKLER_HISTORY(TP_ID,CUSTOMER_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,ULD_ID)VALUES
			(1,119,13,OLDVALUE_ACCESS_TICKLER, NEWVALUE_ACCESS_TICKLER ,(SELECT ULD_ID FROM USER_LOGIN_DETAILS WHERE ULD_LOGINID=USERSTAMP));
		END IF;
-- CUSTOMER_ID = 257
		CALL SP_ACCESS_CARD_TICKLER_HISTORY_OLDVALUE(257,336,USERSTAMP,@OLDVALUE_ACCESS,@OLDUASDID);
		SET OLDVALUE_ACCESS_TICKLER = @OLDVALUE_ACCESS;
		SET OLD_UASDID = @OLDUASDID;
		UPDATE CUSTOMER_ACCESS_CARD_DETAILS SET UASD_ID = 106,CACD_TIMESTAMP = CACD_TIMESTAMP WHERE CACD_ID = 336;
		CALL SP_ACCESS_CARD_TICKLER_HISTORY_NEWVALUE(257,336,USERSTAMP,@NEWVALUE_ACCESS,@NEWUASDID);
		SET NEWVALUE_ACCESS_TICKLER=@NEWVALUE_ACCESS;
		SET NEW_UASDID = @NEWUASDID;
		IF(OLD_UASDID != NEW_UASDID)THEN
			INSERT INTO TICKLER_HISTORY(TP_ID,CUSTOMER_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,ULD_ID)VALUES
			(1,257,13,OLDVALUE_ACCESS_TICKLER, NEWVALUE_ACCESS_TICKLER ,(SELECT ULD_ID FROM USER_LOGIN_DETAILS WHERE ULD_LOGINID=USERSTAMP));
		END IF;
-- CUSTOMER_ID = 274
		CALL SP_ACCESS_CARD_TICKLER_HISTORY_OLDVALUE(274,381,USERSTAMP,@OLDVALUE_ACCESS,@OLDUASDID);
		SET OLDVALUE_ACCESS_TICKLER = @OLDVALUE_ACCESS;
		SET OLD_UASDID = @OLDUASDID;
		UPDATE CUSTOMER_ACCESS_CARD_DETAILS SET UASD_ID = (SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=8888),CACD_VALID_FROM='2010-11-30',CACD_VALID_TILL='2010-12-31',CACD_TIMESTAMP = CACD_TIMESTAMP WHERE CACD_ID = 381;
		CALL SP_ACCESS_CARD_TICKLER_HISTORY_NEWVALUE(274,381,USERSTAMP,@NEWVALUE_ACCESS,@NEWUASDID);
		SET NEWVALUE_ACCESS_TICKLER=@NEWVALUE_ACCESS;
		SET NEW_UASDID = @NEWUASDID;
		IF(OLD_UASDID != NEW_UASDID)THEN
			INSERT INTO TICKLER_HISTORY(TP_ID,CUSTOMER_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,ULD_ID)VALUES
			(1,274,13,(SELECT CONCAT(OLDVALUE_ACCESS_TICKLER,',CACD_VALID_FROM=2012-04-06',',CACD_VALID_TILL=2012-10-31')), (SELECT CONCAT(NEWVALUE_ACCESS_TICKLER,',CACD_VALID_FROM=2010-11-30',',CACD_VALID_TILL=2010-12-31')),(SELECT ULD_ID FROM USER_LOGIN_DETAILS WHERE ULD_LOGINID=USERSTAMP));
		END IF;
-- CUSTOMER_ID = 28
		SET @OLDCOMMENTS = (SELECT CPD_COMMENTS FROM CUSTOMER_PERSONAL_DETAILS WHERE CUSTOMER_ID = 28);
		SET OLD_COMMENTS = @OLDCOMMENTS;
		UPDATE CUSTOMER_ACCESS_CARD_DETAILS SET CACD_VALID_TILL = '2012-05-08',CACD_TIMESTAMP = CACD_TIMESTAMP WHERE CACD_ID = 276;
		UPDATE CUSTOMER_PERSONAL_DETAILS SET CPD_COMMENTS = 'net price.For customer LP-1 card no:12876 is changed into 14077.Till date 2012-05-07 changed as 2012-05-08' WHERE CPD_ID = 28;
		SET @NEWCOMMENTS = (SELECT CPD_COMMENTS FROM CUSTOMER_PERSONAL_DETAILS WHERE CUSTOMER_ID = 28);
		SET NEW_COMMENTS = @NEWCOMMENTS;
		IF(OLD_COMMENTS != NEW_COMMENTS)THEN
			INSERT INTO TICKLER_HISTORY(TP_ID,CUSTOMER_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,ULD_ID)VALUES
			(1,28,13,(SELECT CONCAT('CACD_ID = 276',',CACD_VALID_TILL = 2012-05-07')),(SELECT CONCAT('CACD_VALID_TILL = 2012-05-08')),(SELECT ULD_ID FROM USER_LOGIN_DETAILS WHERE ULD_LOGINID=USERSTAMP));
			INSERT INTO TICKLER_HISTORY(TP_ID,CUSTOMER_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,ULD_ID)VALUES
			(1,28,15,(SELECT CONCAT('CPD_ID=105',',CPD_COMMENTS=',OLD_COMMENTS)),(SELECT CONCAT('CPD_COMMENTS=',NEW_COMMENTS)),(SELECT ULD_ID FROM USER_LOGIN_DETAILS WHERE ULD_LOGINID=USERSTAMP));
		END IF;	
-- CUSTOMER_ID = 219
		SET @OLDCOMMENTS = (SELECT CPD_COMMENTS FROM CUSTOMER_PERSONAL_DETAILS WHERE CUSTOMER_ID = 219);
		SET OLD_COMMENTS = @OLDCOMMENTS;
		UPDATE CUSTOMER_ACCESS_CARD_DETAILS SET CACD_VALID_TILL = '2011-10-31',CACD_TIMESTAMP = CACD_TIMESTAMP WHERE CACD_ID = 57;
		UPDATE CUSTOMER_PERSONAL_DETAILS SET CPD_COMMENTS = ' net price,1st,internetthis customer is not in customer but in the rental source sheet so inserted in customer.For customer LP-1 card no:7604 is changed into 1111111.For customer LP-2 card no:13734 is changed into 1111111.Till date 2011-08-30 changed as 2011-10-31' WHERE CPD_ID = 218;
		SET @NEWCOMMENTS = (SELECT CPD_COMMENTS FROM CUSTOMER_PERSONAL_DETAILS WHERE CUSTOMER_ID = 219);
		SET NEW_COMMENTS = @NEWCOMMENTS;
		IF(OLD_COMMENTS != NEW_COMMENTS)THEN
			INSERT INTO TICKLER_HISTORY(TP_ID,CUSTOMER_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,ULD_ID)VALUES
			(1,219,13,(SELECT CONCAT('CACD_ID = 57',',CACD_VALID_TILL = 2011-08-30')),(SELECT CONCAT('CACD_VALID_TILL = 2011-10-31')),(SELECT ULD_ID FROM USER_LOGIN_DETAILS WHERE ULD_LOGINID=USERSTAMP));
			INSERT INTO TICKLER_HISTORY(TP_ID,CUSTOMER_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,ULD_ID)VALUES
			(1,219,15,(SELECT CONCAT('CPD_ID=218',',CPD_COMMENTS=',OLD_COMMENTS)),(SELECT CONCAT('CPD_COMMENTS=',NEW_COMMENTS)),(SELECT ULD_ID FROM USER_LOGIN_DETAILS WHERE ULD_LOGINID=USERSTAMP));
		END IF;	
-- CUSTOMER_ID = 219
		SET CACDID = (SELECT CACD_ID FROM CUSTOMER_ACCESS_CARD_DETAILS WHERE CUSTOMER_ID = 219 AND UASD_ID = 215 AND ACN_ID = 4);
		IF(CACDID IS NOT NULL)THEN
			INSERT INTO TICKLER_HISTORY(TP_ID,CUSTOMER_ID,TTIP_ID,TH_OLD_VALUE,ULD_ID)VALUES
			(2,219,13,(SELECT CONCAT('CACD_ID = 315',',UASD_ID=215',',ACN_ID=4',',CACD_VALID_FROM=2011-08-30',',CACD_VALID_TILL=2011-10-31',',CACD_GUEST_CARD=NULL',',ULD_ID=2',',CACD_TIMESTAMP=2011-08-29 16:00:00')),(SELECT ULD_ID FROM USER_LOGIN_DETAILS WHERE ULD_LOGINID=USERSTAMP));
			DELETE FROM CUSTOMER_ACCESS_CARD_DETAILS WHERE CACD_ID = CACDID;
		END IF;
-- CUSTOMER_ID = 227
		SET @OLDCOMMENTS = (SELECT CPD_COMMENTS FROM CUSTOMER_PERSONAL_DETAILS WHERE CUSTOMER_ID = 227);
		SET OLD_COMMENTS = @OLDCOMMENTS;
		UPDATE CUSTOMER_ACCESS_CARD_DETAILS SET CACD_GUEST_CARD = 'X',CACD_TIMESTAMP = CACD_TIMESTAMP WHERE CACD_ID = 234;
		UPDATE CUSTOMER_PERSONAL_DETAILS SET CPD_COMMENTS = ' net + weekly cleaning,1st,Bank Transfer of 20184(9k Depo +9k Rent +1k fee+1184 prorate rent).For customer LP-1 card no:609998 is changed into 624145.Updated guest card(609837) = X in access card dtls' WHERE CPD_ID = 226;
		SET @NEWCOMMENTS = (SELECT CPD_COMMENTS FROM CUSTOMER_PERSONAL_DETAILS WHERE CUSTOMER_ID = 227);
		SET NEW_COMMENTS = @NEWCOMMENTS;
		IF(OLD_COMMENTS != NEW_COMMENTS)THEN
			INSERT INTO TICKLER_HISTORY(TP_ID,CUSTOMER_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,ULD_ID)VALUES
			(1,227,13,(SELECT CONCAT('CACD_ID = 234',',CACD_GUEST_CARD = NULL')),(SELECT CONCAT('CACD_GUEST_CARD = X')),(SELECT ULD_ID FROM USER_LOGIN_DETAILS WHERE ULD_LOGINID=USERSTAMP));
			INSERT INTO TICKLER_HISTORY(TP_ID,CUSTOMER_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,ULD_ID)VALUES
			(1,227,15,(SELECT CONCAT('CPD_ID=226',',CPD_COMMENTS=',OLD_COMMENTS)),(SELECT CONCAT('CPD_COMMENTS=',NEW_COMMENTS)),(SELECT ULD_ID FROM USER_LOGIN_DETAILS WHERE ULD_LOGINID=USERSTAMP));
		END IF;	
--  QUERY FOR INSERT VALUES IN PATCH_HISTORY
		INSERT INTO PATCH_HISTORY(PO_ID,PH_FILE_NAME,PH_STATUS,ULD_ID) VALUES (6,FILENAME,1,(SELECT ULD_ID FROM USER_LOGIN_DETAILS WHERE ULD_LOGINID=USERSTAMP));
		SET SUCCESS_MESSAGE = SUCCESSECNDATA;
		SET FOREIGN_KEY_CHECKS = 1;
	END IF;
	COMMIT;
END;
CALL SP_UPDATE_CUSTOMER_ACCESS_CARD_DTLS(FILENAME,USERSTAMP,@SUCCESS_MESSAGE);