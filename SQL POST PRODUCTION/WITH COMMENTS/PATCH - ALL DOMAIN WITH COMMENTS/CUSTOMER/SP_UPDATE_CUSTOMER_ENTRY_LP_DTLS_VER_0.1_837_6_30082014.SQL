-- version:0.1 --sdate:30/08/2014 --edate:30/08/2014 --issue:837 -- comment:#6 --done by:RL
DROP PROCEDURE IF EXISTS SP_UPDATE_CUSTOMER_ENTRY_LP_DTLS;
CREATE PROCEDURE SP_UPDATE_CUSTOMER_ENTRY_LP_DTLS(
IN FILENAME TEXT,
IN USERSTAMP VARCHAR(50),
OUT SUCCESS_MESSAGE TEXT)
BEGIN
--  VARIABLE DECLARATION
	DECLARE FAILURE_ECN_DATA TEXT;
	DECLARE FAIL_ECNDATA TEXT;
	DECLARE SUCCESS_ECNDATA TEXT;
	DECLARE FAILURE_ECNDATA TEXT;
	DECLARE SUCCESSECNDATA TEXT;
	DECLARE FAILUREECNDATA TEXT;
	DECLARE PATCHFILENAME VARCHAR(100);
	DECLARE PHSTATUS TINYINT;
	DECLARE OLDVALUE_LP_TICKLER TEXT;
	DECLARE NEWVALUE_LP_TICKLER TEXT;
	DECLARE OLDVALUE_PERSONAL_TICKLER TEXT;
	DECLARE NEWVALUE_PERSONAL_TICKLER TEXT;
	DECLARE OLD_UASDID INTEGER;
	DECLARE NEW_UASDID INTEGER;
	DECLARE OLD_COMMENTS TEXT;
	DECLARE NEW_COMMENTS TEXT;
--  QUERY FOR ROLLBACK COMMAND
	DECLARE EXIT HANDLER FOR SQLEXCEPTION
	BEGIN 
	ROLLBACK;
		INSERT INTO PATCH_HISTORY(PO_ID,PH_FILE_NAME,PH_STATUS,ULD_ID) VALUES (5,FILENAME,0,(SELECT ULD_ID FROM USER_LOGIN_DETAILS WHERE ULD_LOGINID=USERSTAMP));
	END;
	SET AUTOCOMMIT = 0;
 	START TRANSACTION;
	SET FOREIGN_KEY_CHECKS = 0;
--  QUERY FOR GET ERROR MESSGAE FROM ERROR_MESSAGE_CONFIGURATION TABLE
	SET SUCCESS_ECNDATA =  (SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=469);
	SET FAILURE_ECNDATA =  (SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=470);
	SET FAILURE_ECN_DATA = (SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=473);
--  QUERY FOR REPLACE [FILENAME]
	SET SUCCESSECNDATA = (SELECT REPLACE(SUCCESS_ECNDATA,'[FILENAME]',FILENAME));
	SET FAILUREECNDATA = (SELECT REPLACE(FAILURE_ECNDATA,'[FILENAME]',FILENAME));
	SET FAIL_ECNDATA = (SELECT REPLACE(FAILURE_ECN_DATA,'[FILENAME]',FILENAME));
--  QUERY FOR CHECK THE PASSING FILE NAME EXISTS IN PATCH_HISTORY TABLE
	IF EXISTS(SELECT PH_FILE_NAME FROM PATCH_HISTORY WHERE PH_FILE_NAME = FILENAME AND PH_STATUS = 1) THEN
		SET SUCCESS_MESSAGE = FAILUREECNDATA;
	END IF;
--  QUERY FOR CHECK THE PASSING FILE NAME NOT EXISTS IN PATCH_HISTORY TABLE
	SET PATCHFILENAME = (SELECT PH_FILE_NAME FROM PATCH_HISTORY WHERE PH_FILE_NAME = FILENAME);
	SET PHSTATUS = (SELECT PH_STATUS FROM PATCH_HISTORY WHERE PH_FILE_NAME = FILENAME AND PH_STATUS = 0);
	IF ((PATCHFILENAME IS NOT NULL) AND (PHSTATUS = 0)) OR (PATCHFILENAME IS NULL)THEN
-- CUSTOMER_ID = 45
		CALL SP_CUSTOMER_LP_TICKLER_OLDVALUE (45,90,45,USERSTAMP,@OLDVALUE_LP,@OLDVALUE_PERSONAL,@OLDUASDID,@OLDCOMMENTS);
		SET OLDVALUE_LP_TICKLER=@OLDVALUE_LP;
		SET OLDVALUE_PERSONAL_TICKLER = @OLDVALUE_PERSONAL;
		SET OLD_UASDID = @OLDUASDID;
		SET OLD_COMMENTS = @OLDCOMMENTS;
		UPDATE CUSTOMER_LP_DETAILS SET UASD_ID = 149,CLP_TIMESTAMP = CLP_TIMESTAMP WHERE CLP_ID = 90;
		UPDATE CUSTOMER_PERSONAL_DETAILS SET CPD_COMMENTS = 'net, 1st, Recd. Cheque PR FEE 700$ & Depo 2200$ on 15/3. Wrong unit card updated for LP-1. So Customer LP-1 Card no: 3826 changed into 13176' WHERE CPD_ID = 45;
		CALL SP_CUSTOMER_LP_TICKLER_NEWVALUE (45,90,45,USERSTAMP,@NEWVALUE_LP,@NEWVALUE_PERSONAL,@NEWUASDID,@NEWCOMMENTS);
		SET NEWVALUE_LP_TICKLER=@NEWVALUE_LP;
		SET NEWVALUE_PERSONAL_TICKLER = @NEWVALUE_PERSONAL;
		SET NEW_UASDID = @NEWUASDID;
		SET NEW_COMMENTS = @NEWCOMMENTS;
		IF(OLD_UASDID != NEW_UASDID) AND (OLD_COMMENTS!= NEW_COMMENTS) THEN
			INSERT INTO TICKLER_HISTORY
			(TP_ID,CUSTOMER_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,ULD_ID)VALUES
			(1,45,14,OLDVALUE_LP_TICKLER,NEWVALUE_LP_TICKLER ,(SELECT ULD_ID FROM USER_LOGIN_DETAILS WHERE ULD_LOGINID=USERSTAMP));
			INSERT INTO TICKLER_HISTORY
			(TP_ID,CUSTOMER_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,ULD_ID)VALUES
			(1,45,15,OLDVALUE_PERSONAL_TICKLER, NEWVALUE_PERSONAL_TICKLER  ,(SELECT ULD_ID FROM USER_LOGIN_DETAILS WHERE ULD_LOGINID=USERSTAMP));
		END IF;
-- CUSTOMER_ID = 119
		CALL SP_CUSTOMER_LP_TICKLER_OLDVALUE (119,212,119,USERSTAMP,@OLDVALUE_LP,@OLDVALUE_PERSONAL,@OLDUASDID,@OLDCOMMENTS);
		SET OLDVALUE_LP_TICKLER=@OLDVALUE_LP;
		SET OLDVALUE_PERSONAL_TICKLER = @OLDVALUE_PERSONAL;
		SET OLD_UASDID = @OLDUASDID;
		SET OLD_COMMENTS = @OLDCOMMENTS;
		UPDATE CUSTOMER_LP_DETAILS SET UASD_ID = 275,CLP_TIMESTAMP = CLP_TIMESTAMP WHERE CLP_ID = 212;
		UPDATE CUSTOMER_PERSONAL_DETAILS SET CPD_COMMENTS = 'net price, 1st, Cash Depo. 1800 + Rent 1800 Recd. on 04/7/11. Wrong unit card updated for LP-1. So Customer LP-1 Card no: 13632 changed into 14276' WHERE CPD_ID = 119;
		CALL SP_CUSTOMER_LP_TICKLER_NEWVALUE (119,212,119,USERSTAMP,@NEWVALUE_LP,@NEWVALUE_PERSONAL,@NEWUASDID,@NEWCOMMENTS);
		SET NEWVALUE_LP_TICKLER=@NEWVALUE_LP;
		SET NEWVALUE_PERSONAL_TICKLER = @NEWVALUE_PERSONAL;
		SET NEW_UASDID = @NEWUASDID;
		SET NEW_COMMENTS = @NEWCOMMENTS;
		IF(OLD_UASDID != NEW_UASDID) AND (OLD_COMMENTS!= NEW_COMMENTS) THEN
			INSERT INTO TICKLER_HISTORY
			(TP_ID,CUSTOMER_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,ULD_ID)VALUES
			(1,119,14,OLDVALUE_LP_TICKLER,NEWVALUE_LP_TICKLER ,(SELECT ULD_ID FROM USER_LOGIN_DETAILS WHERE ULD_LOGINID=USERSTAMP));
			INSERT INTO TICKLER_HISTORY
			(TP_ID,CUSTOMER_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,ULD_ID)VALUES
			(1,119,15,OLDVALUE_PERSONAL_TICKLER, NEWVALUE_PERSONAL_TICKLER  ,(SELECT ULD_ID FROM USER_LOGIN_DETAILS WHERE ULD_LOGINID=USERSTAMP));
		END IF;
-- CUSTOMER_ID = 257
		CALL SP_CUSTOMER_LP_TICKLER_OLDVALUE (257,478,256,USERSTAMP,@OLDVALUE_LP,@OLDVALUE_PERSONAL,@OLDUASDID,@OLDCOMMENTS);
		SET OLDVALUE_LP_TICKLER=@OLDVALUE_LP;
		SET OLDVALUE_PERSONAL_TICKLER = @OLDVALUE_PERSONAL;
		SET OLD_UASDID = @OLDUASDID;
		SET OLD_COMMENTS = @OLDCOMMENTS;
		UPDATE CUSTOMER_LP_DETAILS SET UASD_ID = 106,CLP_TIMESTAMP = CLP_TIMESTAMP WHERE CLP_ID = 478;
		UPDATE CUSTOMER_PERSONAL_DETAILS SET CPD_COMMENTS = 'net, 1st, BT 2800$ depo on 31/8/11 net, 1st, $500 PF. Deposit $2200. net, 1st, $500 PF. Deposit $2200.. Wrong unit card updated for LP-1. So Customer LP-1 Card no: 3601 changed into 13585' WHERE CPD_ID = 256;
		CALL SP_CUSTOMER_LP_TICKLER_NEWVALUE (257,478,256,USERSTAMP,@NEWVALUE_LP,@NEWVALUE_PERSONAL,@NEWUASDID,@NEWCOMMENTS);
		SET NEWVALUE_LP_TICKLER=@NEWVALUE_LP;
		SET NEWVALUE_PERSONAL_TICKLER = @NEWVALUE_PERSONAL;
		SET NEW_UASDID = @NEWUASDID;
		SET NEW_COMMENTS = @NEWCOMMENTS;
		IF(OLD_UASDID != NEW_UASDID) AND (OLD_COMMENTS!= NEW_COMMENTS) THEN
			INSERT INTO TICKLER_HISTORY
			(TP_ID,CUSTOMER_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,ULD_ID)VALUES
			(1,257,14,OLDVALUE_LP_TICKLER,NEWVALUE_LP_TICKLER ,(SELECT ULD_ID FROM USER_LOGIN_DETAILS WHERE ULD_LOGINID=USERSTAMP));
			INSERT INTO TICKLER_HISTORY
			(TP_ID,CUSTOMER_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,ULD_ID)VALUES
			(1,257,15,OLDVALUE_PERSONAL_TICKLER, NEWVALUE_PERSONAL_TICKLER  ,(SELECT ULD_ID FROM USER_LOGIN_DETAILS WHERE ULD_LOGINID=USERSTAMP));
		END IF;
-- CUSTOMER_ID = 274
		CALL SP_CUSTOMER_LP_TICKLER_OLDVALUE (274,506,273,USERSTAMP,@OLDVALUE_LP,@OLDVALUE_PERSONAL,@OLDUASDID,@OLDCOMMENTS);
		SET OLDVALUE_LP_TICKLER=@OLDVALUE_LP;
		SET OLDVALUE_PERSONAL_TICKLER = @OLDVALUE_PERSONAL;
		SET OLD_UASDID = @OLDUASDID;
		SET OLD_COMMENTS = @OLDCOMMENTS;
		UPDATE CUSTOMER_LP_DETAILS SET UASD_ID = (SELECT UASD_ID FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=8888),CLP_TIMESTAMP = CLP_TIMESTAMP WHERE CLP_ID = 506;
		UPDATE CUSTOMER_PERSONAL_DETAILS SET CPD_COMMENTS = ' $40 cleaning. Exclude bills, 15th each mth, Internet net price.For customer LP-1 card no:12370 is changed into 14274. Wrong unit card updated for LP-2. So Customer LP-2 Card no: 609543 changed into 8888. Valid from date = 2012-04-06 changed as 2010-11-30 & valid till date = 2012-10-31 changed as 2010-12-31 in access card dtls' WHERE CPD_ID = 273;
		CALL SP_CUSTOMER_LP_TICKLER_NEWVALUE (274,506,273,USERSTAMP,@NEWVALUE_LP,@NEWVALUE_PERSONAL,@NEWUASDID,@NEWCOMMENTS);
		SET NEWVALUE_LP_TICKLER=@NEWVALUE_LP;
		SET NEWVALUE_PERSONAL_TICKLER = @NEWVALUE_PERSONAL;
		SET NEW_UASDID = @NEWUASDID;
		SET NEW_COMMENTS = @NEWCOMMENTS;
		IF(OLD_UASDID != NEW_UASDID) AND (OLD_COMMENTS!= NEW_COMMENTS) THEN
			INSERT INTO TICKLER_HISTORY
			(TP_ID,CUSTOMER_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,ULD_ID)VALUES
			(1,274,14,OLDVALUE_LP_TICKLER,NEWVALUE_LP_TICKLER ,(SELECT ULD_ID FROM USER_LOGIN_DETAILS WHERE ULD_LOGINID=USERSTAMP));
			INSERT INTO TICKLER_HISTORY
			(TP_ID,CUSTOMER_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,ULD_ID)VALUES
			(1,274,15,OLDVALUE_PERSONAL_TICKLER, NEWVALUE_PERSONAL_TICKLER  ,(SELECT ULD_ID FROM USER_LOGIN_DETAILS WHERE ULD_LOGINID=USERSTAMP));
		END IF;
-- CUSTOMER_ID = 105
		SET OLD_COMMENTS = (SELECT CPD_COMMENTS FROM CUSTOMER_PERSONAL_DETAILS WHERE CUSTOMER_ID = 105);
		UPDATE CUSTOMER_ENTRY_DETAILS SET CED_PRETERMINATE = 'X' WHERE CED_ID = 188;
		UPDATE CUSTOMER_PERSONAL_DETAILS SET CPD_COMMENTS = 'net inclu cleaning,1st net inclu cleaning,1st Hicham lossed his card. For customer LP-2 card no:14747 is changed into 14087.For customer LP-1 updated preterminate="X"' WHERE CPD_ID = 105;
		SET NEW_COMMENTS = (SELECT CPD_COMMENTS FROM CUSTOMER_PERSONAL_DETAILS WHERE CUSTOMER_ID = 105);
		IF(OLD_COMMENTS!= NEW_COMMENTS) THEN
			INSERT INTO TICKLER_HISTORY
			(TP_ID,CUSTOMER_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,ULD_ID)VALUES
			(1,105,10,(SELECT CONCAT('CED_ID=188',',CED_REC_VER=1',',CED_PRETERMINATE=NULL')),(SELECT CONCAT('CED_PRETERMINATE=X')),(SELECT ULD_ID FROM USER_LOGIN_DETAILS WHERE ULD_LOGINID=USERSTAMP));
			INSERT INTO TICKLER_HISTORY(TP_ID,CUSTOMER_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,ULD_ID)VALUES
			(1,105,15,(SELECT CONCAT('CPD_ID=105',',CPD_COMMENTS=',OLD_COMMENTS)),(SELECT CONCAT('CPD_COMMENTS=',NEW_COMMENTS)),(SELECT ULD_ID FROM USER_LOGIN_DETAILS WHERE ULD_LOGINID=USERSTAMP));
		END IF;
--  QUERY FOR INSERT VALUES IN PATCH_HISTORY
		INSERT INTO PATCH_HISTORY(PO_ID,PH_FILE_NAME,PH_STATUS,ULD_ID) VALUES (5,FILENAME,1,(SELECT ULD_ID FROM USER_LOGIN_DETAILS WHERE ULD_LOGINID=USERSTAMP));
		SET SUCCESS_MESSAGE = SUCCESSECNDATA;
		SET FOREIGN_KEY_CHECKS = 1;
	END IF;
	COMMIT;
END;
CALL SP_UPDATE_CUSTOMER_ENTRY_LP_DTLS(FILENAME,USERSTAMP,@SUCCESS_MESSAGE);