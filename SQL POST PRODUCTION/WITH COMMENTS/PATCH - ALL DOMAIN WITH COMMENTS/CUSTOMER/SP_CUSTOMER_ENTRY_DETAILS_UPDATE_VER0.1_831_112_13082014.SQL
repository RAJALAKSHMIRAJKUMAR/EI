-- version:0.1 --sdate:13/08/2014 --edate:13/08/2014 --issue:831 COMT:112 --desc:CUSTOMER_ENTRY-DETAILS TIME UPDATION PATCH  --comment no#457 --done by:DHIVYA

DROP PROCEDURE IF EXISTS SP_CUSTOMER_ENTRY_DETAILS_UPDATE;
CREATE PROCEDURE SP_CUSTOMER_ENTRY_DETAILS_UPDATE(
IN FILENAME TEXT,
IN USERSTAMP VARCHAR(50),
OUT SUCCESS_MESSAGE TEXT)
BEGIN

-- VARIABLE DECLARATION
	DECLARE FAILURE_ECN_DATA TEXT;
	DECLARE FAIL_ECNDATA TEXT;
    DECLARE SUCCESS_ECNDATA TEXT;
	DECLARE FAILURE_ECNDATA TEXT;
	DECLARE SUCCESSECNDATA TEXT;
	DECLARE FAILUREECNDATA TEXT;
	DECLARE PATCHFILENAME VARCHAR(100);
	DECLARE PHSTATUS TINYINT;
	
-- QUERY FOR ROLLBACK COMMAND
	DECLARE EXIT HANDLER FOR SQLEXCEPTION
	BEGIN 
		ROLLBACK;
		INSERT INTO PATCH_HISTORY(PO_ID,PH_FILE_NAME,PH_STATUS,ULD_ID) VALUES (5,FILENAME,0,(SELECT ULD_ID FROM USER_LOGIN_DETAILS WHERE ULD_LOGINID=USERSTAMP));
		SET SUCCESS_MESSAGE = FAIL_ECNDATA;
	END;
	SET AUTOCOMMIT=0;
	START TRANSACTION;
	SET FOREIGN_KEY_CHECKS = 0;
	
-- QUERY FOR GET ERROR MESSGAE FROM ERROR_MESSAGE_CONFIGURATION TABLE
	SET SUCCESS_ECNDATA =  (SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=469);
	SET FAILURE_ECNDATA =  (SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=470);
	SET FAILURE_ECN_DATA = (SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=473);
	
-- QUERY FOR REPLACE [FILENAME]
	SET SUCCESSECNDATA = (SELECT REPLACE(SUCCESS_ECNDATA,'[FILENAME]',FILENAME));
	SET FAILUREECNDATA = (SELECT REPLACE(FAILURE_ECNDATA,'[FILENAME]',FILENAME));
	SET FAIL_ECNDATA = (SELECT REPLACE(FAILURE_ECN_DATA,'[FILENAME]',FILENAME));
	
-- QUERY FOR CHECK THE PASSING FILE NAME EXISTS IN PATCH_HISTORY TABLE
	IF EXISTS(SELECT PH_FILE_NAME FROM PATCH_HISTORY WHERE PH_FILE_NAME = FILENAME AND PH_STATUS = 1) THEN
		SET SUCCESS_MESSAGE = FAILUREECNDATA;
	END IF;
	
-- QUERY FOR CHECK THE PASSING FILE NAME NOT EXISTS IN PATCH_HISTORY TABLE
	SET PATCHFILENAME = (SELECT PH_FILE_NAME FROM PATCH_HISTORY WHERE PH_FILE_NAME = FILENAME);
	SET PHSTATUS = (SELECT PH_STATUS FROM PATCH_HISTORY WHERE PH_FILE_NAME = FILENAME AND PH_STATUS = 0);
	
	IF ((PATCHFILENAME IS NOT NULL) AND (PHSTATUS = 0)) OR (PATCHFILENAME IS NULL)THEN
	
-- QUERY FOR INSERT VALUES IN ERROR_MESSAGE_CONFIGURATION
		CALL SP_TICKLER_PART_CUSTOMER_ENTRY_DETAILS(568,24,25,NULL,NULL,USERSTAMP);
		UPDATE CUSTOMER_ENTRY_DETAILS SET CED_SD_STIME=24,CED_SD_ETIME=25 WHERE CED_ID=568;
		
		CALL SP_TICKLER_PART_CUSTOMER_ENTRY_DETAILS(766,23,24,NULL,NULL,USERSTAMP);
		UPDATE CUSTOMER_ENTRY_DETAILS SET CED_SD_STIME=23,CED_SD_ETIME=24 WHERE CED_ID=766;
		
		CALL SP_TICKLER_PART_CUSTOMER_ENTRY_DETAILS(753,25,26,NULL,NULL,USERSTAMP);
		UPDATE CUSTOMER_ENTRY_DETAILS SET CED_SD_STIME=25,CED_SD_ETIME=26 WHERE CED_ID=753;
		
		CALL SP_TICKLER_PART_CUSTOMER_ENTRY_DETAILS(877,37,38,NULL,NULL,USERSTAMP);
		UPDATE CUSTOMER_ENTRY_DETAILS SET CED_SD_STIME=37,CED_SD_ETIME=38 WHERE CED_ID=877;
		
		CALL SP_TICKLER_PART_CUSTOMER_ENTRY_DETAILS(525,23,24,NULL,NULL,USERSTAMP);
		UPDATE CUSTOMER_ENTRY_DETAILS SET CED_SD_STIME=23,CED_SD_ETIME=24 WHERE CED_ID=525;
		
		CALL SP_TICKLER_PART_CUSTOMER_ENTRY_DETAILS(780,39,40,NULL,NULL,USERSTAMP);
		UPDATE CUSTOMER_ENTRY_DETAILS SET CED_SD_STIME=39,CED_SD_ETIME=40 WHERE CED_ID=780;
		
		CALL SP_TICKLER_PART_CUSTOMER_ENTRY_DETAILS(800,47,48,NULL,NULL,USERSTAMP);
		UPDATE CUSTOMER_ENTRY_DETAILS SET CED_SD_STIME=47,CED_SD_ETIME=48 WHERE CED_ID=800;
		
		CALL SP_TICKLER_PART_CUSTOMER_ENTRY_DETAILS(837,41,42,NULL,NULL,USERSTAMP);
		UPDATE CUSTOMER_ENTRY_DETAILS SET CED_SD_STIME=41,CED_SD_ETIME=42 WHERE CED_ID=837;
		
		CALL SP_TICKLER_PART_CUSTOMER_ENTRY_DETAILS(719,23,24,NULL,NULL,USERSTAMP);
		UPDATE CUSTOMER_ENTRY_DETAILS SET CED_SD_STIME=23,CED_SD_ETIME=24 WHERE CED_ID=719;
		
		CALL SP_TICKLER_PART_CUSTOMER_ENTRY_DETAILS(770,NULL,NULL,12,13,USERSTAMP);
		UPDATE CUSTOMER_ENTRY_DETAILS SET CED_ED_STIME=12,CED_ED_ETIME=13 WHERE CED_ID=770;
		
		CALL SP_TICKLER_PART_CUSTOMER_ENTRY_DETAILS(875,19,20,NULL,NULL,USERSTAMP);
		UPDATE CUSTOMER_ENTRY_DETAILS SET CED_SD_STIME=19,CED_SD_ETIME=20 WHERE CED_ID=875;
		
		CALL SP_TICKLER_PART_CUSTOMER_ENTRY_DETAILS(853,31,32,NULL,NULL,USERSTAMP);
		UPDATE CUSTOMER_ENTRY_DETAILS SET CED_SD_STIME=31,CED_SD_ETIME=32 WHERE CED_ID=853;
		
		CALL SP_TICKLER_PART_CUSTOMER_ENTRY_DETAILS(841,34,35,NULL,NULL,USERSTAMP);
		UPDATE CUSTOMER_ENTRY_DETAILS SET CED_SD_STIME=34,CED_SD_ETIME=35 WHERE CED_ID=841;
		
		CALL SP_TICKLER_PART_CUSTOMER_ENTRY_DETAILS(757,38,39,NULL,NULL,USERSTAMP);
		UPDATE CUSTOMER_ENTRY_DETAILS SET CED_SD_STIME=38,CED_SD_ETIME=39 WHERE CED_ID=757;
		
		CALL SP_TICKLER_PART_CUSTOMER_ENTRY_DETAILS(829,21,22,NULL,NULL,USERSTAMP);
		UPDATE CUSTOMER_ENTRY_DETAILS SET CED_SD_STIME=21,CED_SD_ETIME=22 WHERE CED_ID=829;
		
		CALL SP_TICKLER_PART_CUSTOMER_ENTRY_DETAILS(872,19,20,NULL,NULL,USERSTAMP);
		UPDATE CUSTOMER_ENTRY_DETAILS SET CED_SD_STIME=19,CED_SD_ETIME=20 WHERE CED_ID=872;
		
		CALL SP_TICKLER_PART_CUSTOMER_ENTRY_DETAILS(304,NULL,NULL,25,26,USERSTAMP);
		UPDATE CUSTOMER_ENTRY_DETAILS SET CED_ED_STIME=25,CED_ED_ETIME=26 WHERE CED_ID=304;
		
		CALL SP_TICKLER_PART_CUSTOMER_ENTRY_DETAILS(879,19,20,NULL,NULL,USERSTAMP);
		UPDATE CUSTOMER_ENTRY_DETAILS SET CED_SD_STIME=19,CED_SD_ETIME=20 WHERE CED_ID=879;
		
		CALL SP_TICKLER_PART_CUSTOMER_ENTRY_DETAILS(847,35,36,NULL,NULL,USERSTAMP);
		UPDATE CUSTOMER_ENTRY_DETAILS SET CED_SD_STIME=35,CED_SD_ETIME=36 WHERE CED_ID=847;
		
		CALL SP_TICKLER_PART_CUSTOMER_ENTRY_DETAILS(741,33,34,NULL,NULL,USERSTAMP);
		UPDATE CUSTOMER_ENTRY_DETAILS SET CED_SD_STIME=33,CED_SD_ETIME=34 WHERE CED_ID=741;
		
		CALL SP_TICKLER_PART_CUSTOMER_ENTRY_DETAILS(750,25,26,NULL,NULL,USERSTAMP);
		UPDATE CUSTOMER_ENTRY_DETAILS SET CED_SD_STIME=25,CED_SD_ETIME=26 WHERE CED_ID=750;
		
		CALL SP_TICKLER_PART_CUSTOMER_ENTRY_DETAILS(724,36,37,12,13,USERSTAMP);
		UPDATE CUSTOMER_ENTRY_DETAILS SET CED_SD_STIME=36,CED_SD_ETIME=37,CED_ED_STIME=12,CED_ED_ETIME=13 WHERE CED_ID=724;
		
		CALL SP_TICKLER_PART_CUSTOMER_ENTRY_DETAILS(876,36,37,NULL,NULL,USERSTAMP);
		UPDATE CUSTOMER_ENTRY_DETAILS SET CED_SD_STIME=36,CED_SD_ETIME=37 WHERE CED_ID=876;
		
		CALL SP_TICKLER_PART_CUSTOMER_ENTRY_DETAILS(867,19,20,NULL,NULL,USERSTAMP);
		UPDATE CUSTOMER_ENTRY_DETAILS SET CED_SD_STIME=19,CED_SD_ETIME=20 WHERE CED_ID=867;
		
		CALL SP_TICKLER_PART_CUSTOMER_ENTRY_DETAILS(777,29,30,NULL,NULL,USERSTAMP);
		UPDATE CUSTOMER_ENTRY_DETAILS SET CED_SD_STIME=29,CED_SD_ETIME=30 WHERE CED_ID=777;
		
		CALL SP_TICKLER_PART_CUSTOMER_ENTRY_DETAILS(842,32,33,NULL,NULL,USERSTAMP);
		UPDATE CUSTOMER_ENTRY_DETAILS SET CED_SD_STIME=32,CED_SD_ETIME=33 WHERE CED_ID=842;
		
		CALL SP_TICKLER_PART_CUSTOMER_ENTRY_DETAILS(862,25,26,NULL,NULL,USERSTAMP);
		UPDATE CUSTOMER_ENTRY_DETAILS SET CED_SD_STIME=25,CED_SD_ETIME=26 WHERE CED_ID=862;
		
		CALL SP_TICKLER_PART_CUSTOMER_ENTRY_DETAILS(838,40,41,NULL,NULL,USERSTAMP);
		UPDATE CUSTOMER_ENTRY_DETAILS SET CED_SD_STIME=40,CED_SD_ETIME=41 WHERE CED_ID=838;
		
		CALL SP_TICKLER_PART_CUSTOMER_ENTRY_DETAILS(840,32,33,NULL,NULL,USERSTAMP);
		UPDATE CUSTOMER_ENTRY_DETAILS SET CED_SD_STIME=32,CED_SD_ETIME=33 WHERE CED_ID=840;
		
		CALL SP_TICKLER_PART_CUSTOMER_ENTRY_DETAILS(782,21,22,NULL,NULL,USERSTAMP);
		UPDATE CUSTOMER_ENTRY_DETAILS SET CED_SD_STIME=21,CED_SD_ETIME=22 WHERE CED_ID=782;
		
		CALL SP_TICKLER_PART_CUSTOMER_ENTRY_DETAILS(802,25,26,NULL,NULL,USERSTAMP);
		UPDATE CUSTOMER_ENTRY_DETAILS SET CED_SD_STIME=25,CED_SD_ETIME=26 WHERE CED_ID=802;
		
		CALL SP_TICKLER_PART_CUSTOMER_ENTRY_DETAILS(587,21,22,NULL,NULL,USERSTAMP);
		UPDATE CUSTOMER_ENTRY_DETAILS SET CED_SD_STIME=21,CED_SD_ETIME=22 WHERE CED_ID=587;
		
		
		-- QUERY FOR INSERT VALUES IN PATCH_HISTORY
		INSERT INTO PATCH_HISTORY(PO_ID,PH_FILE_NAME,PH_STATUS,ULD_ID) VALUES (5,FILENAME,1,(SELECT ULD_ID FROM USER_LOGIN_DETAILS WHERE ULD_LOGINID=USERSTAMP));
		SET SUCCESS_MESSAGE = SUCCESSECNDATA;
		
		SET FOREIGN_KEY_CHECKS = 1;
	
	END IF;
	
	COMMIT;
END;

CALL SP_CUSTOMER_ENTRY_DETAILS_UPDATE(FILENAME,USERSTAMP,@SUCCESS_MESSAGE);