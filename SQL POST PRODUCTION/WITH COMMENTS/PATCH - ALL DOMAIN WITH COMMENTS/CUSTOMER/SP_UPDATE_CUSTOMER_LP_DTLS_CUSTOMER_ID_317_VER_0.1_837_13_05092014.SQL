-- VERSION:0.1 --SDATE:05/09/2014 --EDATE:05/09/2014 --ISSUE:837 --COMMENTNO:13 --DESC: NEED TO UPDATE PTDDATE=NULL FOR 2ND LP--DONEBY:RL
DROP PROCEDURE IF EXISTS SP_UPDATE_CUSTOMER_LP_DTLS_CUSTOMER_ID_317;
CREATE PROCEDURE SP_UPDATE_CUSTOMER_LP_DTLS_CUSTOMER_ID_317(
IN FILENAME TEXT,
IN USERSTAMP VARCHAR(50),
OUT SUCCESS_MESSAGE TEXT)
BEGIN
--  VARIABLE DECLARATION
	DECLARE FAILURE_ECN_DATA TEXT;
	DECLARE FAIL_ECNDATA TEXT;
	DECLARE SUCCESS_ECNDATA TEXT;
	DECLARE FAILURE_ECNDATA TEXT;
	DECLARE SUCCESSECNDATA TEXT;
	DECLARE FAILUREECNDATA TEXT;
	DECLARE PATCHFILENAME VARCHAR(100);
	DECLARE PHSTATUS TINYINT;
	DECLARE OLDCOMMENTS TEXT;
	DECLARE NEWCOMMENTS TEXT;
--  QUERY FOR ROLLBACK COMMAND
	DECLARE EXIT HANDLER FOR SQLEXCEPTION
	BEGIN 
	ROLLBACK;
		INSERT INTO PATCH_HISTORY(PO_ID,PH_FILE_NAME,PH_STATUS,ULD_ID) VALUES (5,FILENAME,0,(SELECT ULD_ID FROM USER_LOGIN_DETAILS WHERE ULD_LOGINID=USERSTAMP));
	END;
	SET AUTOCOMMIT = 0;
 	START TRANSACTION;
	SET FOREIGN_KEY_CHECKS = 0;
--  QUERY FOR GET ERROR MESSGAE FROM ERROR_MESSAGE_CONFIGURATION TABLE
	SET SUCCESS_ECNDATA =  (SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=469);
	SET FAILURE_ECNDATA =  (SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=470);
	SET FAILURE_ECN_DATA = (SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=473);
--  QUERY FOR REPLACE [FILENAME]
	SET SUCCESSECNDATA = (SELECT REPLACE(SUCCESS_ECNDATA,'[FILENAME]',FILENAME));
	SET FAILUREECNDATA = (SELECT REPLACE(FAILURE_ECNDATA,'[FILENAME]',FILENAME));
	SET FAIL_ECNDATA = (SELECT REPLACE(FAILURE_ECN_DATA,'[FILENAME]',FILENAME));
--  QUERY FOR CHECK THE PASSING FILE NAME EXISTS IN PATCH_HISTORY TABLE
	IF EXISTS(SELECT PH_FILE_NAME FROM PATCH_HISTORY WHERE PH_FILE_NAME = FILENAME AND PH_STATUS = 1) THEN
		SET SUCCESS_MESSAGE = FAILUREECNDATA;
	END IF;
--  QUERY FOR CHECK THE PASSING FILE NAME NOT EXISTS IN PATCH_HISTORY TABLE
	SET PATCHFILENAME = (SELECT PH_FILE_NAME FROM PATCH_HISTORY WHERE PH_FILE_NAME = FILENAME);
	SET PHSTATUS = (SELECT PH_STATUS FROM PATCH_HISTORY WHERE PH_FILE_NAME = FILENAME AND PH_STATUS = 0);
	IF ((PATCHFILENAME IS NOT NULL) AND (PHSTATUS = 0)) OR (PATCHFILENAME IS NULL)THEN
		SET OLDCOMMENTS = (SELECT CPD_COMMENTS FROM CUSTOMER_PERSONAL_DETAILS WHERE CUSTOMER_ID = 317);
		UPDATE CUSTOMER_LP_DETAILS SET CLP_PRETERMINATE_DATE = NULL, CLP_TIMESTAMP = CLP_TIMESTAMP WHERE CLP_ID = 590;
		UPDATE CUSTOMER_PERSONAL_DETAILS SET CPD_COMMENTS = ' net. Cash only,US$300 deposit cash recd. $1k rent received. pending $1200 PTD TO 24/7 PTD TO 24/7.For Customer LP-1,LP-2,LP-3 CARD NO 12360 CHANGED INTO 13868. For Customer LP-2 preterminate date 2013-07-24 updated as null because this lp ptd date not between sdate & edate' WHERE CPD_ID=316;
		SET NEWCOMMENTS = (SELECT CPD_COMMENTS FROM CUSTOMER_PERSONAL_DETAILS WHERE CUSTOMER_ID = 317);
		IF(OLDCOMMENTS != NEWCOMMENTS)THEN
			INSERT INTO TICKLER_HISTORY
			(TP_ID,CUSTOMER_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,ULD_ID)VALUES
			(1,317,14,(SELECT CONCAT('CLP_ID=590',',CUSTOMER_ID=317',',CED_REC_VER=2',',CLP_PRETERMINATE_DATE=2013-07-24')),
			(SELECT CONCAT('CLP_PRETERMINATE_DATE=NULL')),(SELECT ULD_ID FROM USER_LOGIN_DETAILS WHERE ULD_LOGINID=USERSTAMP));
			INSERT INTO TICKLER_HISTORY(TP_ID,CUSTOMER_ID,TTIP_ID,TH_OLD_VALUE,TH_NEW_VALUE,ULD_ID)VALUES
			(1,317,15,(SELECT CONCAT('CPD_ID=316',',CUSTOMER_ID=317',',CPD_COMMENTS=',OLDCOMMENTS)),
			(SELECT CONCAT('CPD_COMMENTS=',NEWCOMMENTS)),(SELECT ULD_ID FROM USER_LOGIN_DETAILS WHERE ULD_LOGINID=USERSTAMP));
		END IF;
--  QUERY FOR INSERT VALUES IN PATCH_HISTORY
		INSERT INTO PATCH_HISTORY(PO_ID,PH_FILE_NAME,PH_STATUS,ULD_ID) VALUES (5,FILENAME,1,(SELECT ULD_ID FROM USER_LOGIN_DETAILS WHERE ULD_LOGINID=USERSTAMP));
		SET SUCCESS_MESSAGE = SUCCESSECNDATA;
		SET FOREIGN_KEY_CHECKS = 1;
	END IF;
	COMMIT;
END;
CALL SP_UPDATE_CUSTOMER_LP_DTLS_CUSTOMER_ID_317(FILENAME,USERSTAMP,@SUCCESS_MESSAGE);