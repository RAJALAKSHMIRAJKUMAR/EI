DROP PROCEDURE IF EXISTS SP_CUSTOMER_SEARCH_UPDATE;
CREATE PROCEDURE SP_CUSTOMER_SEARCH_UPDATE(
IN CUST_ID INTEGER,
IN FIRST_NAME CHAR(30),
IN LAST_NAME CHAR(30),
IN COMPANY_NAME VARCHAR(50),
IN COMPANY_ADDRESS VARCHAR(50),
IN POSTAL_CODE VARCHAR(6),
IN OFFICE_NO VARCHAR(8),
IN UNIT_NUMBER INTEGER,
IN CUSTOMER_RECORD_VERSION INTEGER,
IN ROOM_TYPE VARCHAR(30),
IN SD_STIME TIME,
IN SD_ETIME TIME,
IN ED_STIME TIME,
IN ED_ETIME TIME,
IN LEASE_PERIOD VARCHAR(30),
IN QUARTERS DECIMAL(5,2),
IN PROCESSING_WAIVED CHAR(1),
IN PRORATED CHAR(1),
IN NOTICE_PERIOD TINYINT(1),
IN NOTICE_START_DATE DATE,
IN RENT DECIMAL(7,2),
IN DEPOSIT DECIMAL(7,2),
IN PROCESSING_FEE DECIMAL(7,2),
IN AIRCON_FIXED_FEE DECIMAL(7,2),
IN AIRCON_QUARTELY_FEE DECIMAL(7,2),
IN ELECTRICITY_CAP DECIMAL(7,2),
IN CHECKOUT_CLEANING_FEE DECIMAL(7,2),
IN DRYCLEAN_FEE DECIMAL(7,2),
IN USERSTAMP VARCHAR(50),
IN START_DATE DATE,
IN END_DATE DATE,
IN NATIONALITY TEXT,
IN MOBILE VARCHAR(8),
IN INTL_MOBILE VARCHAR(20),
IN EMAIL VARCHAR(40),
IN PASSPORT_NO VARCHAR(15),
IN PASSPORT_DATE DATE,
IN DOB DATE,
IN EP_NO VARCHAR(15),    
IN EP_DATE DATE,
IN COMMENTS TEXT,
IN ACCESS_CARD TEXT,
IN ACCESS_CARD_DATES TEXT,
OUT SUCCESS_FLAG INTEGER)
BEGIN	
	DECLARE USERSTAMP_ID INTEGER;
	DECLARE EXIT HANDLER FOR SQLEXCEPTION
	BEGIN 
		ROLLBACK;
		SET SUCCESS_FLAG=0;
	END;
	START TRANSACTION;
	SET AUTOCOMMIT=0;
	CALL SP_CHANGE_USERSTAMP_AS_ULDID(USERSTAMP,@ULDID);
	SET USERSTAMP_ID=(SELECT @ULDID);
	CALL SP_CUSTOMER_SEARCH_CUSTOMER_TABLE_UPDATE(CUST_ID,FIRST_NAME,LAST_NAME,USERSTAMP,@SUCCESS_FLAG);
	CALL SP_CUSTOMER_SEARCH_COMPANY_DTLS_UPDATE(CUST_ID,COMPANY_NAME,COMPANY_ADDRESS,POSTAL_CODE,OFFICE_NO,USERSTAMP,@SUCCESS_FLAG);
	CALL SP_CUSTOMER_SEARCH_ENTRY_DTLS_UPDATE(CUST_ID,UNIT_NUMBER,CUSTOMER_RECORD_VERSION,ROOM_TYPE,SD_STIME,
	SD_ETIME,ED_STIME,ED_ETIME,LEASE_PERIOD,QUARTERS,PROCESSING_WAIVED,PRORATED,NOTICE_PERIOD,NOTICE_START_DATE,
	USERSTAMP,@SUCCESS_FLAG);
	CALL SP_CUSTOMER_SEARCH_FEE_DTLS_UPDATE(CUST_ID,CUSTOMER_RECORD_VERSION,RENT,DEPOSIT,PROCESSING_FEE,
	AIRCON_FIXED_FEE,AIRCON_QUARTELY_FEE,ELECTRICITY_CAP,CHECKOUT_CLEANING_FEE,DRYCLEAN_FEE,USERSTAMP,
	@SUCCESS_FLAG);
	CALL SP_CUSTOMER_SEARCH_PERSONAL_DTLS_UPDATE(CUST_ID,NATIONALITY,MOBILE,INTL_MOBILE,EMAIL,PASSPORT_NO,
	PASSPORT_DATE,DOB,EP_NO,EP_DATE,COMMENTS,USERSTAMP,SUCCESS_FLAG);
	CALL SP_CUSTOMER_SEARCH_ACCESS_TERMINATION_DTLS_UPDATE(CUST_ID,CUSTOMER_RECORD_VERSION,UNIT_NUMBER,
	START_DATE,END_DATE,ACCESS_CARD,ACCESS_CARD_DATES,USERSTAMP,SUCCESS_FLAG);
	SET SUCCESS_FLAG = 1;
	COMMIT;
END;
